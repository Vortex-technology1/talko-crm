<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALKO CRM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:#22c55e;--pd:#16a34a;--pl:#f0fdf4;--r:#ef4444;--rl:#fef2f2;--o:#f97316;--ol:#fff7ed;--b:#3b82f6;--bl:#eff6ff;--g:#6b7280;--gl:#f3f4f6;--t:#1a1a1a;--ts:#525252;--bg:#f9fafb;--w:#fff}
        body{font-family:Inter,-apple-system,sans-serif;background:var(--bg);color:var(--t);min-height:100vh}
        
        /* Auth Screen - Premium */
        .auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%)}
        .auth-container{text-align:center;width:100%;max-width:500px}
        .auth-logo-wrap{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:48px}
        .auth-logo-icon{width:48px;height:48px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px;display:flex;align-items:center;justify-content:center}
        .auth-logo-icon svg{width:28px;height:28px;color:#fff}
        .auth-logo-text{font-size:24px;font-weight:700;color:#fff}
        .auth-headline{font-size:42px;font-weight:700;line-height:1.2;margin-bottom:24px}
        .auth-headline .green{color:#22c55e}
        .auth-headline .white{color:#fff}
        .auth-subtitle{font-size:18px;color:#94a3b8;line-height:1.6;margin-bottom:16px}
        .auth-tagline{font-size:16px;color:#e2e8f0;margin-bottom:48px}
        .auth-buttons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:48px}
        .auth-btn-primary{padding:16px 32px;background:#22c55e;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s}
        .auth-btn-primary:hover{background:#16a34a;transform:translateY(-2px)}
        .auth-btn-secondary{padding:16px 32px;background:transparent;color:#fff;border:1px solid #475569;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s}
        .auth-btn-secondary:hover{border-color:#22c55e;background:rgba(34,197,94,.1)}
        .auth-features{display:flex;gap:32px;justify-content:center;flex-wrap:wrap;margin-bottom:48px}
        .auth-feature{display:flex;align-items:center;gap:8px;color:#94a3b8;font-size:14px}
        .auth-feature svg{color:#22c55e}
        
        /* Auth Modal */
        .auth-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px}
        .auth-modal.active{display:flex}
        .auth-box{background:#1e293b;padding:40px;border-radius:20px;width:100%;max-width:400px;border:1px solid #334155}
        .auth-box-title{font-size:24px;font-weight:700;color:#fff;text-align:center;margin-bottom:8px}
        .auth-box-subtitle{text-align:center;color:#94a3b8;margin-bottom:32px;font-size:14px}
        .auth-input{width:100%;padding:14px 16px;background:#0f172a;border:1px solid #334155;border-radius:10px;font-size:15px;color:#fff;margin-bottom:12px}
        .auth-input::placeholder{color:#64748b}
        .auth-input:focus{outline:none;border-color:#22c55e}
        .auth-submit{width:100%;padding:14px;background:#22c55e;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:8px}
        .auth-submit:hover{background:#16a34a}
        .auth-submit:disabled{background:#475569;cursor:not-allowed}
        .auth-error{background:rgba(239,68,68,.2);color:#f87171;padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none;border:1px solid rgba(239,68,68,.3)}
        .auth-switch{text-align:center;margin-top:24px;font-size:14px;color:#94a3b8}
        .auth-switch a{color:#22c55e;cursor:pointer;text-decoration:none;font-weight:500}
        .auth-switch a:hover{text-decoration:underline}
        .auth-close{position:absolute;top:20px;right:20px;background:none;border:none;color:#64748b;cursor:pointer;font-size:24px}
        .auth-close:hover{color:#fff}
        .spinner{width:40px;height:40px;border:3px solid var(--gl);border-top-color:var(--p);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* User menu */
        .user-menu{display:flex;align-items:center;gap:8px}
        .user-email{font-size:12px;color:var(--g);max-width:150px;overflow:hidden;text-overflow:ellipsis}
        .user-btn{padding:6px 10px;font-size:12px}
        
        /* Admin Panel */
        .admin-panel{display:flex;align-items:center;gap:8px;padding-right:12px;margin-right:12px;border-right:1px solid #e5e7eb}
        .admin-badge{background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:0.5px}
        .org-dropdown{position:absolute;top:100%;left:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.15);min-width:240px;z-index:200;margin-top:4px;overflow:hidden}
        .org-dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 14px;width:100%;border:none;background:none;font-size:13px;color:#374151;cursor:pointer;text-align:left}
        .org-dropdown-item:hover{background:#f3f4f6}
        .org-dropdown-item.active{background:#f0fdf4;color:#16a34a;font-weight:500}
        .org-dropdown-item.create{color:#22c55e;font-weight:500;border-top:1px solid #e5e7eb}
        .org-dropdown-item.create:hover{background:#f0fdf4}
        .org-dropdown-divider{height:1px;background:#e5e7eb;margin:0}
        .org-item-count{margin-left:auto;background:#e5e7eb;color:#6b7280;font-size:11px;padding:2px 6px;border-radius:10px}
        #org-selector-btn{position:relative}
        
        /* Team Modal */
        .team-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:20px}
        .team-modal.active{display:flex}
        .team-modal-content{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}
        .team-modal-header{padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .team-modal-title{font-size:18px;font-weight:600}
        .team-modal-body{padding:20px;overflow-y:auto;flex:1}
        .team-member{display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:8px}
        .team-member-avatar{width:40px;height:40px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:600}
        .team-member-info{flex:1;min-width:0}
        .team-member-email{font-size:14px;font-weight:500;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .team-member-role{font-size:12px;font-weight:500}
        .team-invite-section{margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb}
        .team-invite-title{font-size:14px;font-weight:600;margin-bottom:12px;color:#374151}
        .team-invite-btns{display:flex;gap:8px;flex-wrap:wrap}
        
        /* Sync indicator */
        .sync-status{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--g);padding:4px 8px;background:var(--gl);border-radius:4px}
        .sync-dot{width:6px;height:6px;border-radius:50%;background:var(--p)}
        .sync-dot.syncing{background:var(--o);animation:pulse 1s infinite}
        .sync-dot.error{background:var(--r)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        
        .header{background:var(--w);padding:8px 16px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:100}
        .header-content{max-width:1600px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
        .logo{font-size:18px;font-weight:700;color:var(--p)}
        .nav{display:flex;gap:2px;background:var(--gl);padding:3px;border-radius:6px}
        .nav-btn{padding:6px 12px;border:none;background:0;border-radius:5px;font-size:13px;cursor:pointer;color:var(--g)}
        .nav-btn:hover{color:var(--t)}
        .nav-btn.active{background:var(--w);color:var(--p);box-shadow:0 1px 2px rgba(0,0,0,.1)}
        .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .btn{padding:6px 10px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
        .btn-p{background:var(--p);color:#fff}
        .btn-p:hover{background:var(--pd)}
        .btn-s{background:var(--gl);color:var(--t)}
        .btn-s:hover{background:#e5e7eb}
        .btn-d{background:var(--r);color:#fff}
        .container{max-width:1600px;margin:0 auto;padding:12px 16px}
        .view{display:none}
        .view.active{display:block}
        
        /* Tasks - Focus on Date/Time/Action */
        .tasks-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
        .tasks-title{font-size:20px;font-weight:600;color:#1d1d1f}
        .tasks-count{background:#007aff;color:#fff;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;margin-left:8px}
        
        .tasks-filters{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
        .tasks-filters::-webkit-scrollbar{display:none}
        .filter-pill{padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;border:none;background:#f5f5f7;color:#1d1d1f;white-space:nowrap;transition:all .2s}
        .filter-pill:hover{background:#e8e8ed}
        .filter-pill.active{background:#007aff;color:#fff}
        
        .tasks-list{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        
        /* Task Row - Compact single line */
        .task-row{display:grid;grid-template-columns:65px 1fr auto auto;gap:12px;padding:10px 16px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background .15s;align-items:center}
        .task-row:last-child{border-bottom:none}
        .task-row:hover{background:#fafafa}
        .task-row.overdue{background:#fff5f5}
        .task-row.now{background:#f0f9ff}
        
        /* Time Column */
        .task-time{text-align:center}
        .task-time-value{font-size:14px;font-weight:600;color:#1d1d1f}
        .task-time-date{font-size:10px;color:#8e8e93}
        .task-time.overdue .task-time-value{color:#ff3b30}
        .task-time.overdue .task-time-date{color:#ff3b30}
        .task-time.today .task-time-value{color:#007aff}
        .task-time.now .task-time-value{color:#34c759;font-size:12px}
        
        /* Main Info - Single line */
        .task-main-info{min-width:0;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .task-action-text{font-size:14px;font-weight:500;color:#1d1d1f;white-space:nowrap}
        .task-contact-link{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500;text-decoration:none;transition:all .15s}
        .task-contact-link.tg{background:#e3f2fd;color:#0088cc}
        .task-contact-link.tg:hover{background:#bbdefb}
        .task-contact-link.phone{background:#f3f4f6;color:#1d1d1f}
        .task-contact-link.phone:hover{background:#e5e7eb}
        .task-contact-link.viber{background:#f3e5f5;color:#7360f2}
        .task-contact-link.viber:hover{background:#e1bee7}
        .task-contact-link.whatsapp{background:#e8f5e9;color:#25d366}
        .task-contact-link.whatsapp:hover{background:#c8e6c9}
        .task-contact-link.email{background:#fff3e0;color:#f57c00}
        .task-contact-link.email:hover{background:#ffe0b2}
        .task-biz{font-size:12px;color:#8e8e93}
        .task-score{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
        .task-score.hot{background:#ffebee;color:#c62828}
        .task-score.warm{background:#fff3e0;color:#ef6c00}
        .task-score.cold{background:#e3f2fd;color:#1565c0}
        
        /* Status dropdown */
        .task-status-wrap{position:relative}
        .task-status-btn{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;text-transform:uppercase}
        .task-status-btn:hover{filter:brightness(0.95)}
        .task-status-btn svg{width:12px;height:12px;opacity:0.6}
        .task-status-btn.st-new{background:#e3f2fd;color:#1565c0}
        .task-status-btn.st-contacted{background:#e8eaf6;color:#3949ab}
        .task-status-btn.st-scheduled{background:#e8f5e9;color:#2e7d32}
        .task-status-btn.st-completed{background:#f3e5f5;color:#7b1fa2}
        .task-status-btn.st-report_sent{background:#e0f2f1;color:#00695c}
        .task-status-btn.st-deposit{background:#fff8e1;color:#f57f17}
        .task-status-btn.st-paid{background:#e8f5e9;color:#1b5e20}
        .task-status-btn.st-failed{background:#ffebee;color:#c62828}
        .task-status-btn.st-repeat{background:#ede7f6;color:#512da8}
        .task-status-btn.st-frozen{background:#eceff1;color:#546e7a}
        
        .task-status-dropdown{position:absolute;top:100%;right:0;margin-top:4px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);z-index:50;min-width:160px;padding:6px 0;display:none}
        .task-status-dropdown.active{display:block}
        .task-status-option{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:12px;cursor:pointer;transition:background .1s}
        .task-status-option:hover{background:#f5f5f5}
        .task-status-option .dot{width:8px;height:8px;border-radius:50%}
        .task-status-option .dot.new{background:#1565c0}
        .task-status-option .dot.contacted{background:#3949ab}
        .task-status-option .dot.scheduled{background:#2e7d32}
        .task-status-option .dot.completed{background:#7b1fa2}
        .task-status-option .dot.report_sent{background:#00695c}
        .task-status-option .dot.deposit{background:#f57f17}
        .task-status-option .dot.paid{background:#1b5e20}
        .task-status-option .dot.failed{background:#c62828}
        .task-status-option .dot.repeat{background:#512da8}
        .task-status-option .dot.frozen{background:#546e7a}
        
        /* Actions */
        .task-actions{display:flex;gap:4px}
        .task-action-btn{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;background:#f5f5f7}
        .task-action-btn:hover{background:#e8e8ed;transform:scale(1.05)}
        .task-action-btn svg{width:18px;height:18px;color:#8e8e93}
        .task-action-btn.primary{background:#e3f2fd}
        .task-action-btn.primary svg{color:#007aff}
        .task-action-btn.success{background:#e8f5e9}
        .task-action-btn.success svg{color:#34c759}
        .task-action-btn.ai{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #86efac}
        .task-action-btn.ai svg{color:#22c55e}
        
        /* Section Headers */
        .section-header{font-size:11px;font-weight:600;color:#8e8e93;text-transform:uppercase;letter-spacing:0.5px;padding:12px 16px 8px;background:#f9fafb;display:flex;align-items:center;gap:8px}
        .section-header .dot{width:8px;height:8px;border-radius:50%}
        .section-header .dot.red{background:#ff3b30}
        .section-header .dot.blue{background:#007aff}
        .section-header .dot.gray{background:#8e8e93}
        
        /* Empty State */
        .tasks-empty{text-align:center;padding:60px 20px;color:#8e8e93}
        .tasks-empty-icon{width:64px;height:64px;margin:0 auto 16px;background:#f5f5f7;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .tasks-empty-icon svg{width:32px;height:32px;color:#c7c7cc}
        .tasks-empty-title{font-size:17px;font-weight:600;color:#1d1d1f;margin-bottom:4px}
        .tasks-empty-text{font-size:14px}
        
        /* Quick Action Panel - Google Style */
        .quick-panel{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:20px 20px 0 0;box-shadow:0 -4px 24px rgba(0,0,0,0.15);z-index:150;max-height:80vh;overflow:hidden;animation:slideUp .25s ease}
        .quick-panel.active{display:block}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        .quick-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:149;display:none}
        .quick-panel-overlay.active{display:block}
        
        .quick-panel-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .quick-panel-title{font-size:18px;font-weight:600;color:#1a1a1a}
        .quick-panel-close{width:32px;height:32px;border-radius:50%;border:none;background:#f5f5f5;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .quick-panel-close:hover{background:#e8e8e8}
        .quick-panel-close svg{width:20px;height:20px;color:#666}
        
        .quick-panel-lead{padding:16px 20px;background:#f9fafb;border-bottom:1px solid #e5e7eb}
        .quick-lead-name{font-size:16px;font-weight:600;color:#1a1a1a;margin-bottom:4px}
        .quick-lead-info{font-size:13px;color:#666;display:flex;gap:12px;flex-wrap:wrap}
        .quick-lead-action{font-size:14px;color:#1a73e8;font-weight:500;margin-top:8px}
        
        .quick-panel-body{padding:20px;overflow-y:auto;max-height:50vh}
        
        .quick-section{margin-bottom:24px}
        .quick-section:last-child{margin-bottom:0}
        .quick-section-title{font-size:12px;font-weight:600;color:#5f6368;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .quick-section-title svg{width:16px;height:16px}
        
        .quick-buttons{display:flex;flex-wrap:wrap;gap:8px}
        .quick-btn{padding:10px 16px;border-radius:100px;border:1px solid #dadce0;background:#fff;font-size:14px;font-weight:500;color:#1a1a1a;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s}
        .quick-btn:hover{background:#f1f3f4;border-color:#1a73e8}
        .quick-btn:active{background:#e8f0fe}
        .quick-btn svg{width:18px;height:18px;color:#5f6368}
        
        .quick-btn.answered{border-color:#34a853;color:#34a853}
        .quick-btn.answered:hover{background:#e6f4ea}
        .quick-btn.answered svg{color:#34a853}
        
        .quick-btn.no-answer{border-color:#ea4335;color:#ea4335}
        .quick-btn.no-answer:hover{background:#fce8e6}
        .quick-btn.no-answer svg{color:#ea4335}
        
        .quick-btn.scheduled{border-color:#1a73e8;color:#1a73e8}
        .quick-btn.scheduled:hover{background:#e8f0fe}
        .quick-btn.scheduled svg{color:#1a73e8}
        
        .quick-btn.completed{border-color:#34a853;background:#34a853;color:#fff}
        .quick-btn.completed:hover{background:#2d9249}
        .quick-btn.completed svg{color:#fff}
        
        .quick-btn.failed{border-color:#ea4335;background:#ea4335;color:#fff}
        .quick-btn.failed:hover{background:#d33426}
        .quick-btn.failed svg{color:#fff}
        
        /* Time picker buttons */
        .time-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .time-btn{padding:12px 8px;border-radius:12px;border:1px solid #dadce0;background:#fff;font-size:13px;font-weight:500;color:#1a1a1a;cursor:pointer;text-align:center;transition:all .15s}
        .time-btn:hover{background:#f1f3f4;border-color:#1a73e8}
        .time-btn:active{background:#e8f0fe}
        .time-btn .time{font-size:16px;font-weight:600;color:#1a73e8;display:block;margin-bottom:2px}
        .time-btn .label{font-size:11px;color:#5f6368}
        .time-btn.selected{border-color:#1a73e8;background:#e8f0fe}
        
        /* Note input */
        .quick-note{width:100%;padding:12px 16px;border:1px solid #dadce0;border-radius:12px;font-size:14px;resize:none;min-height:60px;margin-top:12px}
        .quick-note:focus{outline:none;border-color:#1a73e8}
        
        /* Confirm button */
        .quick-confirm{width:100%;padding:14px;background:#1a73e8;color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-top:16px;display:flex;align-items:center;justify-content:center;gap:8px}
        .quick-confirm:hover{background:#1557b0}
        .quick-confirm:disabled{background:#dadce0;color:#80868b;cursor:not-allowed}
        .quick-confirm svg{width:20px;height:20px}
        
        /* Contact Links */
        .contact-link{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:500;text-decoration:none;transition:all .15s}
        .contact-link svg{width:16px;height:16px;flex-shrink:0}
        .contact-link.tg{background:#e3f2fd;color:#0088cc}
        .contact-link.tg:hover{background:#bbdefb}
        .contact-link.phone{background:#f3f4f6;color:#1a1a1a}
        .contact-link.phone:hover{background:#e5e7eb}
        
        .contact-phone-group{display:inline-flex;align-items:center;gap:4px}
        .contact-messengers{display:flex;gap:4px}
        .messenger-btn{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s}
        .messenger-btn svg{width:16px;height:16px}
        .messenger-btn.wa{background:#e8f5e9;color:#25d366}
        .messenger-btn.wa:hover{background:#c8e6c9}
        .messenger-btn.viber{background:#f3e5f5;color:#7360f2}
        .messenger-btn.viber:hover{background:#e1bee7}
        
        .no-contact{color:#9ca3af;font-size:13px}
        
        /* Quick panel contact links */
        .quick-lead-contacts{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
        
        .task-card{background:var(--w);border-radius:8px;padding:10px 12px;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.08);border-left:3px solid transparent;cursor:pointer}
        .task-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.12)}
        .task-card.critical{border-left-color:var(--r);background:var(--rl)}
        .task-card.warning{border-left-color:var(--o);background:var(--ol)}
        .task-card.info{border-left-color:var(--b);background:var(--bl)}
        .task-meta{font-size:11px;color:var(--ts);margin-bottom:4px}
        .task-action{font-size:12px;margin-bottom:8px}
        .task-btns{display:flex;gap:6px;flex-wrap:wrap}
        .task-btn{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:none}
        .task-btn.success{background:var(--p);color:#fff}
        .task-btn.warn{background:var(--o);color:#fff}
        .task-btn.danger{background:var(--rl);color:var(--r)}
        .task-btn.secondary{background:var(--gl);color:var(--t)}
        .empty{text-align:center;padding:40px 20px;color:var(--g)}
        
        /* Onboarding */
        .onboarding{background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border:2px dashed #86efac;border-radius:16px;padding:40px;text-align:center;max-width:600px;margin:40px auto}
        .onboarding-icon{width:64px;height:64px;background:var(--p);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
        .onboarding-icon svg{width:32px;height:32px;color:#fff}
        .onboarding-title{font-size:20px;font-weight:700;color:var(--t);margin-bottom:8px}
        .onboarding-text{font-size:14px;color:var(--ts);margin-bottom:24px;line-height:1.6}
        .onboarding-steps{display:flex;flex-direction:column;gap:12px;text-align:left;margin-bottom:24px}
        .onboarding-step{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--w);border-radius:10px;font-size:13px}
        .onboarding-step-num{width:28px;height:28px;background:var(--p);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}
        .onboarding-step-text{flex:1}
        .onboarding-step-text strong{color:var(--t)}
        .onboarding-btn{padding:12px 24px;background:var(--p);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
        .onboarding-btn:hover{background:var(--pd)}
        .onboarding-btn svg{width:18px;height:18px}
        
        /* Kanban */
        .kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:16px}
        .kanban-filters{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
        .filter-btn{padding:5px 10px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid #e5e7eb;background:var(--w);color:var(--t);display:inline-flex;align-items:center;gap:4px;transition:all .2s}
        .filter-btn:hover{border-color:var(--p);background:var(--pl)}
        .filter-btn.active{background:var(--p);color:#fff;border-color:var(--p)}
        .filter-btn svg{flex-shrink:0}
        .column{width:260px;flex-shrink:0;background:var(--gl);border-radius:10px;max-height:calc(100vh - 130px);display:flex;flex-direction:column}
        .column-header{padding:10px 12px;font-weight:600;font-size:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .column-count{background:var(--w);padding:2px 6px;border-radius:6px;font-size:11px;color:var(--g)}
        .column-cards{padding:8px;flex:1;overflow-y:auto;min-height:60px}
        .column-cards.drag-over{background:var(--pl)}
        .k-card{background:var(--w);border-radius:6px;padding:8px 10px;margin-bottom:6px;box-shadow:0 1px 2px rgba(0,0,0,.08);cursor:grab;border-left:3px solid transparent}
        .k-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.12)}
        .k-card.dragging{opacity:.5}
        .k-card.has-alert{border-left-color:var(--o)}
        .k-card.has-critical{border-left-color:var(--r)}
        .k-card-name{font-weight:600;font-size:12px;margin-bottom:2px}
        .k-card-biz{font-size:10px;color:var(--ts);margin-bottom:4px}
        .k-card-footer{display:flex;justify-content:space-between;font-size:10px;color:var(--g)}
        .k-card-amount{color:var(--p);font-weight:600}
        .k-card-days{padding:1px 5px;border-radius:3px;background:var(--gl)}
        .k-card-days.over{background:var(--rl);color:var(--r)}
        .k-card-tags{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
        .k-tag{padding:1px 5px;border-radius:3px;font-size:9px;font-weight:500;display:inline-flex;align-items:center;gap:2px}
        .k-tag svg{width:9px;height:9px}
        .k-tag.overdue{background:var(--rl);color:var(--r)}
        .k-tag.consult-today{background:#dbeafe;color:#1e40af}
        .k-tag.consult-tomorrow{background:#fef3c7;color:#92400e}
        .k-tag.noshow{background:var(--ol);color:#c2410c}
        .k-tag.has-deposit{background:#d1fae5;color:#065f46}
        .k-tag.action-today{background:#f5f3ff;color:#7c3aed}
        .score{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
        .score.hot{background:#fee2e2;color:#dc2626}
        .score.warm{background:#fef3c7;color:#d97706}
        .score.cold{background:#e0e7ff;color:#4f46e5}
        .score-bar{width:40px;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden}
        .score-fill{height:100%;border-radius:3px}
        .score-fill.hot{background:#dc2626}
        .score-fill.warm{background:#d97706}
        .score-fill.cold{background:#4f46e5}
        .ai-hint{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #86efac;border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;display:flex;gap:8px;align-items:flex-start}
        .ai-hint svg{flex-shrink:0;color:#22c55e}
        .ai-hint-text{flex:1}
        .ai-hint-title{font-weight:600;color:#166534;margin-bottom:2px}
        .column[data-status="new"] .column-header{background:#dbeafe}
        .column[data-status="scheduled"] .column-header{background:#fef3c7}
        .column[data-status="completed"] .column-header{background:#e0e7ff}
        .column[data-status="report_sent"] .column-header{background:#fce7f3}
        .column[data-status="repeat"] .column-header{background:#f5f3ff}
        .column[data-status="deposit"] .column-header{background:#d1fae5}
        .column[data-status="paid"] .column-header{background:#22c55e;color:#fff}
        
        /* Reports */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px}
        .stat{background:var(--w);padding:20px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .stat-val{font-size:28px;font-weight:700;color:var(--p)}
        .stat-label{font-size:12px;color:var(--g);margin-top:4px}
        .funnel{background:var(--w);padding:20px;border-radius:12px}
        .funnel-title{font-weight:600;margin-bottom:16px}
        .funnel-row{display:flex;align-items:center;gap:12px;margin-bottom:8px}
        .funnel-label{width:160px;font-size:13px}
        .funnel-bar{flex:1;height:28px;background:var(--gl);border-radius:4px;overflow:hidden}
        .funnel-fill{height:100%;background:var(--p);display:flex;align-items:center;padding:0 10px;font-size:12px;color:#fff;font-weight:500}
        
        /* Modal */
        .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
        .modal-bg.active{display:flex}
        .modal{background:var(--w);border-radius:16px;width:100%;max-width:640px;margin:40px 0}
        .modal-head{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{width:32px;height:32px;border:none;background:var(--gl);border-radius:8px;cursor:pointer;font-size:18px}
        .modal-body{padding:20px;max-height:65vh;overflow-y:auto}
        .modal-foot{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between}
        .tabs{display:flex;gap:0;border-bottom:1px solid #e5e7eb;margin:-20px -20px 20px}
        .tab{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:500;cursor:pointer;border:none;background:0;color:var(--g);border-bottom:2px solid transparent}
        .tab.active{color:var(--p);border-bottom-color:var(--p)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-bottom:16px}
        .form-group{display:flex;flex-direction:column;gap:4px}
        .form-label{font-size:11px;font-weight:600;color:var(--ts);text-transform:uppercase}
        .form-input,.form-select,.form-textarea{padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--p)}
        .form-textarea{min-height:80px;resize:vertical}
        .form-hint{font-size:10px;color:var(--g)}
        
        /* Comm Log */
        .comm-log{max-height:250px;overflow-y:auto}
        .comm-item{display:flex;gap:10px;padding:10px;background:var(--gl);border-radius:8px;margin-bottom:8px}
        .comm-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
        .comm-icon.call{background:var(--bl);color:var(--b)}
        .comm-icon.sms{background:var(--pl);color:var(--p)}
        .comm-icon.note{background:#f5f3ff;color:#8b5cf6}
        .comm-icon.status{background:var(--ol);color:var(--o)}
        .comm-body{flex:1}
        .comm-head{display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px}
        .comm-type{font-weight:600}
        .comm-date{color:var(--g)}
        .comm-text{font-size:12px;color:var(--ts)}
        .comm-add{display:flex;gap:8px;margin-top:12px}
        .comm-add select{width:100px}
        .comm-add input{flex:1}
        
        /* Links */
        .links-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .link-item{padding:12px;background:var(--gl);border-radius:8px}
        .link-label{font-size:10px;font-weight:600;color:var(--g);text-transform:uppercase;margin-bottom:4px}
        .link-input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px}
        
        /* Finance */
        .fin-row{display:grid;grid-template-columns:1fr 80px;gap:8px;margin-bottom:12px}
        
        /* Help */
        .help-btn{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--p);color:#fff;border:none;cursor:pointer;font-size:20px;box-shadow:0 4px 12px rgba(34,197,94,.4)}
        .help-panel{display:none;position:fixed;bottom:80px;right:20px;width:360px;max-width:calc(100vw - 40px);max-height:60vh;background:var(--w);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;z-index:99}
        .help-panel.active{display:block}
        .help-head{padding:14px;background:var(--p);color:#fff;font-weight:600;display:flex;justify-content:space-between}
        .help-close{background:0;border:0;color:#fff;cursor:pointer;font-size:18px}
        .help-body{padding:14px;overflow-y:auto;max-height:calc(60vh - 50px)}
        .help-item{display:flex;gap:8px;padding:8px;background:var(--gl);border-radius:6px;margin-bottom:6px;font-size:12px}
        .status-badge{padding:3px 8px;border-radius:4px;font-size:11px;font-weight:500}
        .st-new{background:#dbeafe;color:#1e40af}
        .st-scheduled{background:#fef3c7;color:#92400e}
        .st-completed{background:#e0e7ff;color:#3730a3}
        .st-report_sent{background:#fce7f3;color:#9d174d}
        .st-repeat{background:#f5f3ff;color:#5b21b6}
        .st-deposit{background:#d1fae5;color:#065f46}
        .st-paid{background:#22c55e;color:#fff}
        .st-failed{background:#f3f4f6;color:#374151}
        .st-reactivation{background:#ede9fe;color:#5b21b6}
        
        /* AI Panel */
        .ai-fab{position:fixed;bottom:80px;right:20px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;border:none;cursor:pointer;font-size:20px;box-shadow:0 4px 12px rgba(99,102,241,.4);z-index:98;display:flex;align-items:center;justify-content:center}
        .ai-fab:hover{transform:scale(1.1)}
        .ai-panel{display:none;position:fixed;bottom:140px;right:20px;width:400px;max-width:calc(100vw - 40px);height:500px;max-height:calc(100vh - 180px);background:var(--w);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;z-index:99;flex-direction:column}
        .ai-panel.active{display:flex}
        .ai-panel-head{padding:14px 16px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-weight:600;display:flex;justify-content:space-between;align-items:center}
        .ai-panel-close{background:0;border:0;color:#fff;cursor:pointer;font-size:20px;line-height:1}
        .ai-panel-body{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .ai-chat{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
        .ai-msg{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;max-width:90%}
        .ai-msg-user{background:var(--p);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
        .ai-msg-bot{background:var(--gl);color:var(--t);align-self:flex-start;border-bottom-left-radius:4px}
        .ai-msg-loading{background:var(--gl);color:var(--g);align-self:flex-start}
        .ai-input-wrap{padding:12px;border-top:1px solid #e5e7eb;background:var(--w)}
        .ai-quick-btns{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
        .ai-quick-btn{padding:6px 10px;font-size:11px;background:var(--gl);border:none;border-radius:6px;cursor:pointer;white-space:nowrap}
        .ai-quick-btn:hover{background:#e5e7eb}
        
        .quick-actions{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--gl);border-radius:8px;margin-bottom:16px}
        
        @media(max-width:768px){
            .header{padding:10px 12px}
            .header-content{flex-direction:column;gap:10px}
            .logo{font-size:18px}
            .nav{width:100%;justify-content:center;order:1}
            .nav-btn{padding:8px 12px;font-size:13px}
            .actions{width:100%;justify-content:center;flex-wrap:wrap;gap:6px;order:2}
            .btn{padding:6px 10px;font-size:12px}
            .sync-status{display:none}
            .user-menu{order:3}
            .user-email{max-width:120px;font-size:11px}
        }
        @media(max-width:480px){
            .form-row{grid-template-columns:1fr}
            .links-grid{grid-template-columns:1fr}
            .nav-btn{padding:6px 10px;font-size:12px}
            .actions .btn.btn-s:not([href]){display:none}
            .kanban{overflow-x:auto;padding-bottom:20px}
            .k-col{min-width:260px}
            .tasks-header{flex-direction:column;align-items:flex-start;gap:12px}
            .kanban-filters{flex-wrap:wrap}
            .filter-btn{padding:6px 10px;font-size:11px}
            .user-email{display:none}
            .user-btn{font-size:11px;padding:4px 8px}
        }
    </style>
</head>
<body>
    <!-- Auth Screen - Premium Landing -->
    <div class="auth-screen" id="auth-screen">
        <div class="auth-container">
            <!-- Logo -->
            <div class="auth-logo-wrap">
                <div class="auth-logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="auth-logo-text">TALKO CRM</div>
            </div>
            
            <!-- Headline -->
            <h1 class="auth-headline">
                <span class="green">AI –∑–∞–∫—Ä–∏–≤–∞—î —É–≥–æ–¥–∏,</span><br>
                <span class="white">–ø–æ–∫–∏ –≤–∏ –ø'—î—Ç–µ –∫–∞–≤—É</span>
            </h1>
            
            <!-- Subtitle -->
            <p class="auth-subtitle">
                –°–∫–æ—Ä–∏–Ω–≥ –ª—ñ–¥—ñ–≤, –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–∫—Ä–∏–ø—Ç—ñ–≤, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è.<br>
                –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∞—Ü—é—î –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–µ. –í–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é—î—Ç–µ –≤–æ—Ä–æ–Ω–∫—É.
            </p>
            
            <!-- Tagline -->
            <p class="auth-tagline">–ù–µ –∑–¥–æ–≥–∞–¥—É–≤–∞—Ç–∏—Å—å —Ö—Ç–æ –∫—É–ø–∏—Ç—å. –ó–Ω–∞—Ç–∏.</p>
            
            <!-- Buttons -->
            <div class="auth-buttons">
                <button class="auth-btn-primary" onclick="openAuthModal('login')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    –£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
                </button>
                <button class="auth-btn-secondary" onclick="window.open('https://calendly.com/management-talco/meet-with-me', '_blank')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    –ó–∞–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ –¥–µ–º–æ
                </button>
            </div>
            
            <!-- Features -->
            <div class="auth-features">
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    AI-—Å–∫–æ—Ä–∏–Ω–≥ –ª—ñ–¥—ñ–≤
                </div>
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Å–∫—Ä–∏–ø—Ç–∏
                </div>
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-box">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            <div class="auth-box-title" id="auth-title">–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            <div class="auth-box-subtitle" id="auth-subtitle-text">–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É</div>
            <div class="auth-error" id="auth-error"></div>
            <input type="email" class="auth-input" id="auth-email" placeholder="Email">
            <input type="password" class="auth-input" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="auth-submit" id="auth-btn" onclick="handleAuth()">–£–≤—ñ–π—Ç–∏</button>
            <div class="auth-switch" id="auth-switch">
                –ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? <a onclick="toggleAuthMode()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display:none">
    <header class="header">
        <div class="header-content">
            <div class="logo">TALKO CRM</div>
            <nav class="nav">
                <button class="nav-btn active" onclick="switchView('tasks')">–ó–∞–≤–¥–∞–Ω–Ω—è</button>
                <button class="nav-btn" onclick="switchView('kanban')">Kanban</button>
                <button class="nav-btn" onclick="switchView('reports')">–ó–≤—ñ—Ç–∏</button>
            </nav>
            <div class="actions">
                <button class="btn btn-p" onclick="openModal()">+ –î–æ–¥–∞—Ç–∏</button>
                <label class="btn btn-s">–Ü–º–ø–æ—Ä—Ç<input type="file" accept=".xlsx,.xls" onchange="importXLS(event)" hidden></label>
                <button class="btn btn-s" onclick="exportXLS()">–ï–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn-s" style="background:#fef3c7;color:#92400e" onclick="loadDemo()">üéÆ –î–µ–º–æ</button>
                <div class="sync-status" id="sync-status"><div class="sync-dot" id="sync-dot"></div><span id="sync-text">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ</span></div>
                <a href="https://chatgpt.com/g/g-695d18d64ffc8191885772ca62dfb66c-talko-crm-support" target="_blank" class="btn btn-s" style="background:linear-gradient(135deg,#10a37f,#1a7f5a);color:#fff;text-decoration:none">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><path d="M9 21h6"/><path d="M9 18h6"/></svg>
                    AI –ü—ñ–¥—Ç—Ä–∏–º–∫–∞
                </a>
                <div class="user-menu">
                    <span class="user-email" id="user-email"></span>
                    <button class="btn btn-s user-btn" onclick="logout()">–í–∏–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Tasks View -->
        <div class="view active" id="v-tasks">
            <div class="tasks-header">
                <h1 class="tasks-title">–©–æ —Ä–æ–±–∏—Ç–∏ –∑–∞—Ä–∞–∑<span class="tasks-count" id="task-count">0</span></h1>
            </div>
            <div class="tasks-filters" id="tasks-filters">
                <button class="filter-pill active" onclick="setTaskFilter('all')">–í—Å—ñ</button>
                <button class="filter-pill" onclick="setTaskFilter('critical')">–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ</button>
                <button class="filter-pill" onclick="setTaskFilter('calls')">–î–∑–≤—ñ–Ω–∫–∏</button>
                <button class="filter-pill" onclick="setTaskFilter('consult')">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</button>
                <button class="filter-pill" onclick="setTaskFilter('followup')">–î–æ–∂–∏–º</button>
                <button class="filter-pill" onclick="setTaskFilter('money')">–û–ø–ª–∞—Ç–∞</button>
            </div>
            <div id="tasks-list"></div>
        </div>
        
        <!-- Kanban View -->
        <div class="view" id="v-kanban">
            <div class="kanban-filters" id="kanban-filters">
                <button class="filter-btn active" onclick="setFilter('all')">–í—Å—ñ</button>
                <button class="filter-btn" onclick="setFilter('critical')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> –ö—Ä–∏—Ç–∏—á–Ω—ñ</button>
                <button class="filter-btn" onclick="setFilter('today')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> –°—å–æ–≥–æ–¥–Ω—ñ</button>
                <button class="filter-btn" onclick="setFilter('tomorrow')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> –ó–∞–≤—Ç—Ä–∞</button>
                <button class="filter-btn" onclick="setFilter('action')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> –î—ñ—è —Å—å–æ–≥–æ–¥–Ω—ñ</button>
                <button class="filter-btn" onclick="setFilter('money')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> –ß–µ–∫–∞—é—Ç—å –æ–ø–ª–∞—Ç—É</button>
            </div>
            <div class="kanban" id="kanban"></div>
        </div>
        
        <!-- Reports View -->
        <div class="view" id="v-reports">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px">
                <h1 class="tasks-title">–ó–≤—ñ—Ç–∏</h1>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                    <div style="display:flex;align-items:center;gap:6px">
                        <label style="font-size:13px;color:var(--g)">–ó:</label>
                        <input type="date" id="date-from" class="form-input" style="width:auto;padding:6px 10px" onchange="renderReports()">
                    </div>
                    <div style="display:flex;align-items:center;gap:6px">
                        <label style="font-size:13px;color:var(--g)">–î–æ:</label>
                        <input type="date" id="date-to" class="form-input" style="width:auto;padding:6px 10px" onchange="renderReports()">
                    </div>
                    <div style="display:flex;gap:4px">
                        <button class="btn btn-s" onclick="setReportPeriod('week')">–¢–∏–∂–¥–µ–Ω—å</button>
                        <button class="btn btn-s" onclick="setReportPeriod('month')">–ú—ñ—Å—è—Ü—å</button>
                        <button class="btn btn-s" onclick="setReportPeriod('quarter')">–ö–≤–∞—Ä—Ç–∞–ª</button>
                        <button class="btn btn-s" onclick="setReportPeriod('all')">–í—Å–µ</button>
                    </div>
                    <button class="btn btn-p" onclick="exportReport()">–ï–∫—Å–ø–æ—Ä—Ç</button>
                </div>
            </div>
            <div class="stats" id="stats"></div>
            <div class="funnel">
                <div class="funnel-title">–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤</div>
                <div id="funnel"></div>
            </div>
        </div>
    </main>
    
    <!-- Lead Modal -->
    <div class="modal-bg" id="modal">
        <div class="modal">
            <div class="modal-head">
                <span class="modal-title" id="modal-title">–ù–æ–≤–∏–π –ª—ñ–¥</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('main')">–û—Å–Ω–æ–≤–Ω–µ</button>
                    <button class="tab" onclick="switchTab('history')">–Ü—Å—Ç–æ—Ä—ñ—è</button>
                    <button class="tab" onclick="switchTab('links')">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
                    <button class="tab" onclick="switchTab('finance')">–§—ñ–Ω–∞–Ω—Å–∏</button>
                </div>
                
                <div class="quick-actions" id="quick-actions" style="display:none">
                    <button class="btn btn-p" onclick="qAction('call')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> –ü–æ–¥–∑–≤–æ–Ω–∏–≤</button>
                    <button class="btn btn-s" onclick="qAction('sms')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> SMS</button>
                    <button class="btn btn-s" onclick="qAction('schedule')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
                    <button class="btn btn-d" onclick="qAction('fail')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> –ù–µ—É—Å–ø—ñ—à–Ω–∞</button>
                </div>
                
                <div class="tab-content active" id="t-main">
                    <input type="hidden" id="f-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-select" id="f-status" onchange="onStatusChange()">
                                <option value="">‚Äî</option>
                                <option value="new">–ù–æ–≤–∏–π –ª—ñ–¥</option>
                                <option value="scheduled">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞</option>
                                <option value="completed">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞</option>
                                <option value="report_sent">–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏–π</option>
                                <option value="repeat">–ü–æ–≤—Ç–æ—Ä–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è</option>
                                <option value="deposit">–ó–∞–≤–¥–∞—Ç–æ–∫</option>
                                <option value="paid">–û–ø–ª–∞—á–µ–Ω–æ</option>
                                <option value="failed">–ù–µ—É—Å–ø—ñ—à–Ω–∞ —É–≥–æ–¥–∞</option>
                                <option value="reactivation">–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ù–µ –ø—Ä–∏–π—à–æ–≤</label>
                            <select class="form-select" id="f-noshow">
                                <option value="0">–ù—ñ</option>
                                <option value="1">1 —Ä–∞–∑</option>
                                <option value="2">2 —Ä–∞–∑–∏</option>
                                <option value="3">3 —Ä–∞–∑–∏</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–¢–µ–ª–µ–≥—Ä–∞–º</label>
                            <input class="form-input" id="f-tg" placeholder="@username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input class="form-input" id="f-phone" placeholder="+380...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Viber</label>
                            <input class="form-input" id="f-viber" placeholder="+380... (—è–∫—â–æ —ñ–Ω—à–∏–π)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp</label>
                            <input class="form-input" id="f-whatsapp" placeholder="+380... (—è–∫—â–æ —ñ–Ω—à–∏–π)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input class="form-input" id="f-email" type="email" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–û—Å–Ω–æ–≤–Ω–∏–π –∫–∞–Ω–∞–ª</label>
                            <select class="form-select" id="f-primary-channel">
                                <option value="phone">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                                <option value="tg">Telegram</option>
                                <option value="viber">Viber</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–ë—ñ–∑–Ω–µ—Å</label>
                            <input class="form-input" id="f-biz" placeholder="–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è-15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–∂–µ—Ä–µ–ª–æ</label>
                            <select class="form-select" id="f-source">
                                <option value="">‚Äî</option>
                                <option value="bot">–ë–æ—Ç</option>
                                <option value="mk_clinic">–ú–ö –ö–ª—ñ–Ω—ñ–∫–∏</option>
                                <option value="mk_prod">–ú–ö –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ</option>
                                <option value="ads">–†–µ–∫–ª–∞–º–∞</option>
                                <option value="ref">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–î–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</label>
                            <input type="datetime-local" class="form-input" id="f-consult">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ–≤—Ç–æ—Ä–Ω–∏—Ö</label>
                            <select class="form-select" id="f-repeat"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">–î–∑–≤—ñ–Ω–∫–∏</label>
                            <select class="form-select" id="f-calls"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SMS</label>
                            <select class="form-select" id="f-sms"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>–ù–∞—Å—Ç—É–ø–Ω–∞ –¥—ñ—è</label>
                            <input type="date" class="form-input" id="f-next">
                        </div>
                        <div class="form-group" style="max-width:120px">
                            <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>–ß–∞—Å</label>
                            <input type="time" class="form-input" id="f-next-time" value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>–©–æ –∑—Ä–æ–±–∏—Ç–∏</label>
                        <input class="form-input" id="f-action" placeholder="–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏, —É—Ç–æ—á–Ω–∏—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è..." style="font-weight:500">
                    </div>
                    <div class="form-group" id="report-group" style="display:none">
                        <label class="form-label">–ó–≤—ñ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</label>
                        <textarea class="form-textarea" id="f-report" placeholder="–û—Å–Ω–æ–≤–Ω—ñ –±–æ–ª—ñ –∫–ª—ñ—î–Ω—Ç–∞, –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è, —â–æ —Ü—ñ–∫–∞–≤–∏–ª–æ, –≥–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –æ–ø–ª–∞—Ç–∏..." style="min-height:120px"></textarea>
                        <div class="form-hint">–î–µ—Ç–∞–ª—å–Ω–∏–π –∑–≤—ñ—Ç = –∫—Ä–∞—â—ñ –ø—ñ–¥–∫–∞–∑–∫–∏ –≤—ñ–¥ –®–Ü</div>
                    </div>
                    <div class="form-group" id="fail-group" style="display:none">
                        <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏</label>
                        <select class="form-select" id="f-fail">
                            <option value="">‚Äî</option>
                            <option value="expensive">–î–æ—Ä–æ–≥–æ</option>
                            <option value="no_time">–ù–µ–º–∞—î —á–∞—Å—É</option>
                            <option value="competitor">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç</option>
                            <option value="no_answer">–ù–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î</option>
                            <option value="other">–Ü–Ω—à–µ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ü—Ä–∏–º—ñ—Ç–∫–∏</label>
                        <textarea class="form-textarea" id="f-notes" placeholder="..."></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="t-history">
                    <div class="comm-log" id="comm-log"></div>
                    <div class="comm-add">
                        <select class="form-select" id="comm-type"><option value="call">–î–∑–≤—ñ–Ω–æ–∫</option><option value="sms">SMS</option><option value="note">–ù–æ—Ç–∞—Ç–∫–∞</option></select>
                        <input class="form-input" id="comm-text" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä...">
                        <button class="btn btn-p" onclick="addComm()">+</button>
                    </div>
                </div>
                
                <div class="tab-content" id="t-links">
                    <div class="links-grid">
                        <div class="link-item"><div class="link-label">–ó–∞–ø–∏—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó</div><input class="link-input" id="l-record" placeholder="https://..."></div>
                        <div class="link-item"><div class="link-label">–ó–≤—ñ—Ç</div><input class="link-input" id="l-report" placeholder="https://docs..."></div>
                        <div class="link-item"><div class="link-label">–ö–ü</div><input class="link-input" id="l-kp" placeholder="https://..."></div>
                        <div class="link-item"><div class="link-label">–î–æ–≥–æ–≤—ñ—Ä</div><input class="link-input" id="l-contract" placeholder="https://..."></div>
                    </div>
                </div>
                
                <div class="tab-content" id="t-finance">
                    <div class="form-group"><label class="form-label">–ó–∞–≤–¥–∞—Ç–æ–∫</label>
                        <div class="fin-row"><input type="number" class="form-input" id="fin-dep" placeholder="0"><select class="form-select" id="fin-dep-cur"><option>UAH</option><option>USD</option><option>EUR</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">–î–∞—Ç–∞ –∑–∞–≤–¥–∞—Ç–∫—É</label><input type="date" class="form-input" id="fin-dep-date"></div>
                    <div class="form-group"><label class="form-label">–ü–æ–≤–Ω–∞ —Å—É–º–∞</label>
                        <div class="fin-row"><input type="number" class="form-input" id="fin-total" placeholder="0"><select class="form-select" id="fin-total-cur"><option>UAH</option><option>USD</option><option>EUR</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç–∏</label><input type="date" class="form-input" id="fin-paid-date"></div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-d" id="del-btn" style="display:none" onclick="delLeadForm()">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-s" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button class="btn btn-p" onclick="saveLeadForm()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- AI Assistant Panel -->
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-head">
            <span style="display:flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="8" cy="14" r="1"/><circle cx="16" cy="14" r="1"/></svg> AI –ê—Å–∏—Å—Ç–µ–Ω—Ç</span>
            <button class="ai-panel-close" onclick="toggleAI()">&times;</button>
        </div>
        <div class="ai-panel-body">
            <div class="ai-chat" id="ai-chat">
                <div class="ai-msg ai-msg-bot">–ü—Ä–∏–≤—ñ—Ç! –Ø AI-–∞—Å–∏—Å—Ç–µ–Ω—Ç TALKO CRM. –ú–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –∑:
                    <br>‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–∫—Ä–∏–ø—Ç—ñ–≤ –¥–∑–≤—ñ–Ω–∫—ñ–≤
                    <br>‚Ä¢ SMS —à–∞–±–ª–æ–Ω–∏ –ø—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ª—ñ–¥–∞
                    <br>‚Ä¢ –ê–Ω–∞–ª—ñ–∑ –∑–≤—ñ—Ç—ñ–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ–π
                    <br>‚Ä¢ –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è
                    <br><br>–í–∏–±–µ—Ä—ñ—Ç—å –ª—ñ–¥–∞ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω—É –¥—ñ—é!</div>
            </div>
            <div class="ai-input-wrap">
                <select id="ai-lead-select" class="form-select" style="margin-bottom:8px">
                    <option value="">‚Äî –í–∏–±–µ—Ä—ñ—Ç—å –ª—ñ–¥–∞ ‚Äî</option>
                </select>
                <div class="ai-quick-btns">
                    <button class="ai-quick-btn" onclick="aiAsk('script')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> –°–∫—Ä–∏–ø—Ç –¥–∑–≤—ñ–Ω–∫–∞</button>
                    <button class="ai-quick-btn" onclick="aiAsk('analysis')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21H4.6c-.56 0-.84 0-1.05-.11a1 1 0 0 1-.44-.44C3 20.24 3 19.96 3 19.4V3"/><path d="m7 14 4-4 4 4 6-6"/></svg> –ê–Ω–∞–ª—ñ–∑</button>
                    <button class="ai-quick-btn" onclick="aiAsk('objections')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> –°–ü–Ü–ù</button>
                    <button class="ai-quick-btn" onclick="aiAsk('sms')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-10 5L2 7"/></svg> SMS</button>
                </div>
                <div style="display:flex;gap:8px">
                    <input type="text" id="ai-input" class="form-input" placeholder="–ê–±–æ –∑–∞–¥–∞–π—Ç–µ —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è..." onkeypress="if(event.key==='Enter')aiSend()">
                    <button class="btn btn-p" onclick="aiSend()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- AI FAB Button -->
    <button class="ai-fab" onclick="toggleAI()"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="8" cy="14" r="1"/><circle cx="16" cy="14" r="1"/><path d="M9 18h6"/></svg></button>
    
    <!-- Help -->
    <button class="help-btn" onclick="toggleHelp()">?</button>
    <div class="help-panel" id="help">
        <div class="help-head"><span>–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</span><button class="help-close" onclick="toggleHelp()">&times;</button></div>
        <div class="help-body">
            <div class="help-item"><span class="status-badge st-new">–ù–æ–≤–∏–π</span><span>–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏, –ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</span></div>
            <div class="help-item"><span class="status-badge st-scheduled">–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∞</span><span>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–∞ –¥–µ–Ω—å</span></div>
            <div class="help-item"><span class="status-badge st-completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–∞</span><span>–ß–µ–∫–∞—Ç–∏ –∑–≤—ñ—Ç</span></div>
            <div class="help-item"><span class="status-badge st-report_sent">–ó–≤—ñ—Ç</span><span>–î–æ–∂–∏–º–∞—Ç–∏ –¥–æ –æ–ø–ª–∞—Ç–∏</span></div>
            <div class="help-item"><span class="status-badge st-repeat">–ü–æ–≤—Ç–æ—Ä–Ω–∞</span><span>–©–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è</span></div>
            <div class="help-item"><span class="status-badge st-deposit">–ó–∞–≤–¥–∞—Ç–æ–∫</span><span>–ü–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞</span></div>
            <div class="help-item"><span class="status-badge st-paid">–û–ø–ª–∞—á–µ–Ω–æ</span><span>–ó–∞–∫—Ä–∏—Ç–æ</span></div>
            <div class="help-item"><span class="status-badge st-failed">–ù–µ—É—Å–ø—ñ—à–Ω–∞</span><span>+3 –º—ñ—Å —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è</span></div>
            <div style="margin-top:12px;padding:10px;background:var(--ol);border-radius:6px;font-size:12px">
                <b>–ü—Ä–∞–≤–∏–ª–∞:</b><br>‚Ä¢ –ù–æ–≤–∏–π –ª—ñ–¥: –º–∞–∫—Å 3 –¥–∑–≤—ñ–Ω–∫–∏<br>‚Ä¢ –ü—ñ—Å–ª—è –∑–≤—ñ—Ç—É: 3 –¥–∑–≤ + 3 SMS<br>‚Ä¢ –ù–µ—É—Å–ø—ñ—à–Ω–∞ ‚Üí —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è 3 –º—ñ—Å
            </div>
        </div>
    </div>

<!-- Quick Action Panel -->
<div class="quick-panel-overlay" onclick="closeQuickPanel()"></div>
<div class="quick-panel" id="quick-panel">
    <div class="quick-panel-header">
        <div class="quick-panel-title">–©–æ —Å—Ç–∞–ª–æ—Å—å?</div>
        <button class="quick-panel-close" onclick="closeQuickPanel()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
    </div>
    
    <div class="quick-panel-lead" id="quick-lead-info">
        <div class="quick-lead-name" id="quick-lead-name">‚Äî</div>
        <div class="quick-lead-info">
            <span id="quick-lead-biz">‚Äî</span>
        </div>
        <div class="quick-lead-contacts" id="quick-lead-contacts"></div>
        <div class="quick-lead-action" id="quick-lead-task">–ó–∞–≤–¥–∞–Ω–Ω—è: ‚Äî</div>
    </div>
    
    <div class="quick-panel-body">
        <!-- Outcome buttons -->
        <div class="quick-section" id="quick-outcome-section">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–∑–≤—ñ–Ω–∫–∞
            </div>
            <div class="quick-buttons" id="quick-outcome-buttons">
                <button class="quick-btn answered" onclick="setQuickOutcome('answered')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    –í–∑—è–≤ —Ç—Ä—É–±–∫—É
                </button>
                <button class="quick-btn no-answer" onclick="setQuickOutcome('no_answer')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 2v4M8 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path d="M10 14l4 4m0-4l-4 4"/></svg>
                    –ù–µ –≤–∑—è–≤
                </button>
                <button class="quick-btn" onclick="setQuickOutcome('sms')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    SMS
                </button>
                <button class="quick-btn" onclick="setQuickOutcome('callback')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7"/><path d="M18 2l4 4-10 10H8v-4L18 2z"/></svg>
                    –ü–µ—Ä–µ–¥–∑–≤–æ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
        
        <!-- Next action section - shown after outcome -->
        <div class="quick-section" id="quick-next-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                –ö–æ–ª–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç?
            </div>
            <div class="time-buttons" id="quick-time-buttons">
                <button class="time-btn" onclick="setQuickTime('30m')">
                    <span class="time">30 —Ö–≤</span>
                    <span class="label">–°–∫–æ—Ä–æ</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('2h')">
                    <span class="time">2 –≥–æ–¥</span>
                    <span class="label">–°—å–æ–≥–æ–¥–Ω—ñ</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('tomorrow_10')">
                    <span class="time">10:00</span>
                    <span class="label">–ó–∞–≤—Ç—Ä–∞</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('tomorrow_14')">
                    <span class="time">14:00</span>
                    <span class="label">–ó–∞–≤—Ç—Ä–∞</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('2d')">
                    <span class="time">+2 –¥–Ω—ñ</span>
                    <span class="label">–ü—ñ—Å–ª—è–∑–∞–≤—Ç—Ä–∞</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('week')">
                    <span class="time">+—Ç–∏–∂–¥–µ–Ω—å</span>
                    <span class="label">–ß–µ—Ä–µ–∑ 7 –¥–Ω—ñ–≤</span>
                </button>
            </div>
        </div>
        
        <!-- Action type - shown after time -->
        <div class="quick-section" id="quick-action-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                –©–æ –∑—Ä–æ–±–∏—Ç–∏?
            </div>
            <div class="quick-buttons" id="quick-action-buttons">
                <button class="quick-btn" onclick="setQuickAction('–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    –ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏
                </button>
                <button class="quick-btn" onclick="setQuickAction('–ù–∞–ø–∏—Å–∞—Ç–∏ SMS')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    SMS
                </button>
                <button class="quick-btn" onclick="setQuickAction('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑—É—Å—Ç—Ä—ñ—á')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
                </button>
                <button class="quick-btn" onclick="setQuickAction('–£—Ç–æ—á–Ω–∏—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    –£—Ç–æ—á–Ω–∏—Ç–∏
                </button>
                <button class="quick-btn" onclick="setQuickAction('–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ö–ü')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ö–ü
                </button>
            </div>
            <textarea class="quick-note" id="quick-note" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)..."></textarea>
        </div>
        
        <!-- Final actions -->
        <div class="quick-section" id="quick-final-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            </div>
            <div class="quick-buttons">
                <button class="quick-btn scheduled" onclick="setQuickFinal('scheduled')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                    –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é
                </button>
                <button class="quick-btn completed" onclick="setQuickFinal('completed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞
                </button>
                <button class="quick-btn failed" onclick="setQuickFinal('failed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
                    –í—ñ–¥–º–æ–≤–∞
                </button>
            </div>
        </div>
        
        <!-- Confirm button -->
        <button class="quick-confirm" id="quick-confirm-btn" onclick="confirmQuickAction()" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            –ó–±–µ—Ä–µ–≥—Ç–∏
        </button>
    </div>
</div>

<!-- Team Modal -->
<div class="team-modal" id="team-modal">
    <div class="team-modal-content">
        <div class="team-modal-header">
            <div class="team-modal-title">–ö–æ–º–∞–Ω–¥–∞</div>
            <button class="btn btn-s" onclick="closeTeamModal()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="team-modal-body">
            <div id="team-list"></div>
            
            <div class="team-invite-section">
                <div class="team-invite-title">–ó–∞–ø—Ä–æ—Å–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å–Ω–∏–∫–∞</div>
                <div class="team-invite-btns">
                    <button class="btn btn-s" onclick="createInvite('employee')">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                        –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫
                    </button>
                    <button class="btn btn-s" onclick="createInvite('manager')">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        –ú–µ–Ω–µ–¥–∂–µ—Ä
                    </button>
                    <button class="btn btn-p" onclick="createInvite('owner')">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        –í–ª–∞—Å–Ω–∏–∫
                    </button>
                </div>
                <p style="font-size:12px;color:#6b7280;margin-top:12px">
                    –ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –±—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è-–∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è, —è–∫–µ –≤–∏ –º–æ–∂–µ—Ç–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∫–æ–ª–µ–∑—ñ
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyCunQezswxYZyjSscD4b7Hg30YRWZ9zA-Y",
    authDomain: "talko-crm.firebaseapp.com",
    projectId: "talko-crm",
    storageBucket: "talko-crm.firebasestorage.app",
    messagingSenderId: "1090643937646",
    appId: "1:1090643937646:web:5607640c57fe9f4192597f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ===== SUPER ADMIN CONFIG =====
const SUPER_ADMIN_EMAILS = ['management.talco@gmail.com', 'sashatalko@gmail.com'];

// ===== APP STATE =====
let currentUser = null;
let currentOrg = null;      // –ü–æ—Ç–æ—á–Ω–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è
let currentRole = null;     // owner | manager | employee | superadmin
let organizations = [];     // –°–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π (–¥–ª—è superadmin)
let isAuthMode = 'login';
let unsubscribe = null;

// ===== HELPER: Check if Super Admin =====
function isSuperAdmin(email) {
    return SUPER_ADMIN_EMAILS.includes(email?.toLowerCase());
}

// ===== AUTH MODAL FUNCTIONS =====
function openAuthModal(mode){
    isAuthMode = mode;
    updateAuthModal();
    document.getElementById('auth-modal').classList.add('active');
    document.getElementById('auth-email').focus();
}

function closeAuthModal(){
    document.getElementById('auth-modal').classList.remove('active');
    hideAuthError();
}

function toggleAuthMode(){
    isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
    updateAuthModal();
    hideAuthError();
}

function updateAuthModal(){
    const title = document.getElementById('auth-title');
    const subtitle = document.getElementById('auth-subtitle-text');
    const btn = document.getElementById('auth-btn');
    const switchEl = document.getElementById('auth-switch');
    
    if(isAuthMode === 'login'){
        title.textContent = '–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É';
        subtitle.textContent = '–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É';
        btn.textContent = '–£–≤—ñ–π—Ç–∏';
        switchEl.innerHTML = '–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? <a onclick="toggleAuthMode()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</a>';
    } else {
        title.textContent = '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è';
        subtitle.textContent = '–°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–∏—Å—Ç–µ–º–∏';
        btn.textContent = '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è';
        switchEl.innerHTML = '–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <a onclick="toggleAuthMode()">–£–≤—ñ–π—Ç–∏</a>';
    }
}

function showAuthError(msg){
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
}

function hideAuthError(){
    document.getElementById('auth-error').style.display = 'none';
}

async function handleAuth(){
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    
    if(!email || !password){
        showAuthError('–í–≤–µ–¥—ñ—Ç—å email —Ç–∞ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    const btn = document.getElementById('auth-btn');
    btn.disabled = true;
    btn.textContent = '–ó–∞—á–µ–∫–∞–π—Ç–µ...';
    hideAuthError();
    
    try {
        if(isAuthMode === 'login'){
            await auth.signInWithEmailAndPassword(email, password);
        } else {
            await auth.createUserWithEmailAndPassword(email, password);
        }
    } catch(err){
        let msg = '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó';
        if(err.code === 'auth/user-not-found') msg = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
        if(err.code === 'auth/wrong-password') msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å';
        if(err.code === 'auth/email-already-in-use') msg = 'Email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ';
        if(err.code === 'auth/weak-password') msg = '–ü–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ —Å–ª–∞–±–∫–∏–π (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)';
        if(err.code === 'auth/invalid-email') msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email';
        showAuthError(msg);
        btn.disabled = false;
        btn.textContent = isAuthMode === 'login' ? '–£–≤—ñ–π—Ç–∏' : '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è';
    }
}

function logout(){
    if(confirm('–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É?')){
        auth.signOut();
    }
}

// ===== AUTH STATE LISTENER =====
auth.onAuthStateChanged(async (user) => {
    if(user){
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('auth-modal').classList.remove('active');
        document.getElementById('user-email').textContent = user.email;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ Super Admin
        if(isSuperAdmin(user.email)){
            currentRole = 'superadmin';
            await initSuperAdminMode();
        } else {
            await initUserMode();
        }
        
        document.getElementById('app').style.display = 'block';
    } else {
        currentUser = null;
        currentOrg = null;
        currentRole = null;
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        document.getElementById('auth-btn').disabled = false;
        document.getElementById('auth-btn').textContent = '–£–≤—ñ–π—Ç–∏';
        hideAdminPanel();
        if(unsubscribe) unsubscribe();
    }
});

// ===== SUPER ADMIN MODE =====
async function initSuperAdminMode(){
    console.log('Super Admin mode activated');
    showAdminPanel();
    await loadOrganizations();
    
    // –Ø–∫—â–æ —î –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó - –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –ø–µ—Ä—à—É, —ñ–Ω–∞–∫—à–µ –ø–æ–∫–∞–∑—É—î–º–æ –ø–∞–Ω–µ–ª—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
    if(organizations.length > 0){
        await selectOrganization(organizations[0].id);
    } else {
        showCreateOrgPrompt();
    }
}

// ===== USER MODE =====
async function initUserMode(){
    console.log('User mode');
    hideAdminPanel();
    
    // –®—É–∫–∞—î–º–æ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    
    if(userDoc.exists){
        const userData = userDoc.data();
        if(userData.organizationId){
            currentOrg = { id: userData.organizationId };
            currentRole = userData.role || 'employee';
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
            const orgDoc = await db.collection('organizations').doc(userData.organizationId).get();
            if(orgDoc.exists){
                currentOrg = { id: orgDoc.id, ...orgDoc.data() };
            }
            
            initFirestoreListener();
        } else {
            showNoOrgMessage();
        }
    } else {
        // –ù–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á - –º–æ–∂–ª–∏–≤–æ –ø—Ä–∏–π—à–æ–≤ –ø–æ —ñ–Ω–≤–∞–π—Ç—É
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('invite');
        
        if(inviteCode){
            await processInvite(inviteCode);
        } else {
            showNoOrgMessage();
        }
    }
}

// ===== ORGANIZATIONS MANAGEMENT =====
async function loadOrganizations(){
    try {
        const snapshot = await db.collection('organizations').orderBy('createdAt', 'desc').get();
        organizations = [];
        snapshot.forEach(doc => {
            organizations.push({ id: doc.id, ...doc.data() });
        });
        renderOrgSelector();
    } catch(err){
        console.error('Error loading organizations:', err);
    }
}

async function selectOrganization(orgId){
    currentOrg = organizations.find(o => o.id === orgId);
    if(!currentOrg){
        const orgDoc = await db.collection('organizations').doc(orgId).get();
        if(orgDoc.exists){
            currentOrg = { id: orgDoc.id, ...orgDoc.data() };
        }
    }
    
    if(currentOrg){
        document.getElementById('org-selector-btn').innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            ${currentOrg.name}
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        `;
        initFirestoreListener();
    }
}

async function createOrganization(){
    const name = prompt('–ù–∞–∑–≤–∞ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó:', '');
    if(!name) return;
    
    try {
        const orgRef = await db.collection('organizations').add({
            name: name,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.uid,
            settings: {
                statuses: getDefaultStatuses(),
                funnels: [{ id: 'default', name: '–û—Å–Ω–æ–≤–Ω–∞ –≤–æ—Ä–æ–Ω–∫–∞' }]
            }
        });
        
        // –î–æ–¥–∞—î–º–æ —Ç–≤–æ—Ä—Ü—è —è–∫ owner
        await db.collection('users').doc(currentUser.uid).set({
            email: currentUser.email,
            organizationId: orgRef.id,
            role: 'owner',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        await loadOrganizations();
        await selectOrganization(orgRef.id);
        
        alert('–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
    } catch(err){
        console.error('Error creating org:', err);
        alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
    }
}

function getDefaultStatuses(){
    return {
        new: { name: '–ù–æ–≤–∏–π –ª—ñ–¥', color: '#1565c0', order: 1 },
        contacted: { name: '–ö–æ–Ω—Ç–∞–∫—Ç', color: '#3949ab', order: 2 },
        scheduled: { name: '–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∞', color: '#2e7d32', order: 3 },
        completed: { name: '–ü—Ä–æ–≤–µ–¥–µ–Ω–∞', color: '#7b1fa2', order: 4 },
        report_sent: { name: '–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ', color: '#00695c', order: 5 },
        deposit: { name: '–ó–∞–≤–¥–∞—Ç–æ–∫', color: '#f57f17', order: 6 },
        paid: { name: '–û–ø–ª–∞—á–µ–Ω–æ', color: '#1b5e20', order: 7, isClosed: true },
        failed: { name: '–í—ñ–¥–º–æ–≤–∞', color: '#c62828', order: 8 },
        frozen: { name: '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∏–π', color: '#546e7a', order: 9 }
    };
}

// ===== INVITE SYSTEM =====
async function processInvite(code){
    try {
        const inviteDoc = await db.collection('invites').doc(code).get();
        
        if(!inviteDoc.exists){
            alert('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
        
        const invite = inviteDoc.data();
        
        if(invite.used){
            alert('–¶–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ');
            return;
        }
        
        // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
        await db.collection('users').doc(currentUser.uid).set({
            email: currentUser.email,
            organizationId: invite.organizationId,
            role: invite.role || 'employee',
            invitedBy: invite.createdBy,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –ü–æ–∑–Ω–∞—á–∞—î–º–æ —ñ–Ω–≤–∞–π—Ç —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π
        await db.collection('invites').doc(code).update({
            used: true,
            usedBy: currentUser.uid,
            usedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // –û—á–∏—â–∞—î–º–æ URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ
        await initUserMode();
        
    } catch(err){
        console.error('Error processing invite:', err);
        alert('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è');
    }
}

async function createInvite(role = 'employee'){
    if(!currentOrg) return;
    
    try {
        const code = generateInviteCode();
        
        await db.collection('invites').doc(code).set({
            organizationId: currentOrg.id,
            organizationName: currentOrg.name,
            role: role,
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            used: false
        });
        
        const link = `${window.location.origin}${window.location.pathname}?invite=${code}`;
        
        if(navigator.clipboard){
            await navigator.clipboard.writeText(link);
            alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!\n\n' + link);
        } else {
            prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', link);
        }
        
    } catch(err){
        console.error('Error creating invite:', err);
        alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
    }
}

function generateInviteCode(){
    return 'inv_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
}

// ===== UI HELPERS =====
function showAdminPanel(){
    let panel = document.getElementById('admin-panel');
    if(!panel){
        // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω–∞
        const header = document.querySelector('.actions');
        const adminHtml = `
            <div id="admin-panel" class="admin-panel">
                <button id="org-selector-btn" class="btn btn-s" onclick="toggleOrgDropdown()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    –û–±–µ—Ä—ñ—Ç—å –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div id="org-dropdown" class="org-dropdown" style="display:none">
                    <div id="org-list"></div>
                    <div class="org-dropdown-divider"></div>
                    <button class="org-dropdown-item create" onclick="createOrganization()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é
                    </button>
                </div>
                <button class="btn btn-s" onclick="openTeamModal()" title="–ö–æ–º–∞–Ω–¥–∞">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </button>
                <span class="admin-badge">ADMIN</span>
            </div>
        `;
        header.insertAdjacentHTML('afterbegin', adminHtml);
    }
    document.getElementById('admin-panel')?.style.setProperty('display', 'flex');
}

function hideAdminPanel(){
    document.getElementById('admin-panel')?.style.setProperty('display', 'none');
}

function toggleOrgDropdown(){
    const dropdown = document.getElementById('org-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function renderOrgSelector(){
    const list = document.getElementById('org-list');
    if(!list) return;
    
    list.innerHTML = organizations.map(org => `
        <button class="org-dropdown-item ${currentOrg?.id === org.id ? 'active' : ''}" onclick="selectOrganization('${org.id}');toggleOrgDropdown()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
            ${org.name}
            <span class="org-item-count">${org.leadsCount || 0}</span>
        </button>
    `).join('');
}

function showNoOrgMessage(){
    document.getElementById('v-tasks').innerHTML = `
        <div style="text-align:center;padding:60px 20px">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" style="margin:0 auto 20px">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <h3 style="font-size:20px;font-weight:600;margin-bottom:8px;color:#1f2937">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó</h3>
            <p style="color:#6b7280;margin-bottom:24px">–ü–æ–ø—Ä–æ—Å—ñ—Ç—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤–∞–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</p>
        </div>
    `;
}

function showCreateOrgPrompt(){
    document.getElementById('v-tasks').innerHTML = `
        <div style="text-align:center;padding:60px 20px">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="#22c55e" stroke-width="1.5" style="margin:0 auto 20px">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <h3 style="font-size:20px;font-weight:600;margin-bottom:8px;color:#1f2937">–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à—É –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é</h3>
            <p style="color:#6b7280;margin-bottom:24px">–ü–æ—á–Ω—ñ—Ç—å —Ä–æ–±–æ—Ç—É –∑ CRM, —Å—Ç–≤–æ—Ä–∏–≤—à–∏ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é –¥–ª—è –≤–∞—à–æ–≥–æ –±—ñ–∑–Ω–µ—Å—É</p>
            <button class="btn btn-p" onclick="createOrganization()" style="padding:12px 24px;font-size:15px">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é
            </button>
        </div>
    `;
}

// ===== TEAM MODAL =====
function openTeamModal(){
    if(!currentOrg) return;
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
    loadTeamMembers();
    
    document.getElementById('team-modal').classList.add('active');
}

function closeTeamModal(){
    document.getElementById('team-modal').classList.remove('active');
}

async function loadTeamMembers(){
    try {
        const snapshot = await db.collection('users')
            .where('organizationId', '==', currentOrg.id)
            .get();
        
        const members = [];
        snapshot.forEach(doc => {
            members.push({ id: doc.id, ...doc.data() });
        });
        
        renderTeamMembers(members);
    } catch(err){
        console.error('Error loading team:', err);
    }
}

function renderTeamMembers(members){
    const container = document.getElementById('team-list');
    if(!container) return;
    
    const roleLabels = {
        owner: '–í–ª–∞—Å–Ω–∏–∫',
        manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä',
        employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫',
        superadmin: 'Super Admin'
    };
    
    const roleColors = {
        owner: '#22c55e',
        manager: '#3b82f6',
        employee: '#6b7280',
        superadmin: '#8b5cf6'
    };
    
    container.innerHTML = members.map(m => `
        <div class="team-member">
            <div class="team-member-avatar">${m.email?.[0]?.toUpperCase() || '?'}</div>
            <div class="team-member-info">
                <div class="team-member-email">${m.email}</div>
                <div class="team-member-role" style="color:${roleColors[m.role]}">${roleLabels[m.role] || m.role}</div>
            </div>
            ${m.id !== currentUser.uid && (currentRole === 'owner' || currentRole === 'superadmin') ? `
                <button class="btn btn-s" onclick="removeTeamMember('${m.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            ` : ''}
        </div>
    `).join('');
}

async function removeTeamMember(userId){
    if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó?')) return;
    
    try {
        await db.collection('users').doc(userId).update({
            organizationId: firebase.firestore.FieldValue.delete(),
            role: firebase.firestore.FieldValue.delete()
        });
        loadTeamMembers();
    } catch(err){
        console.error('Error removing member:', err);
        alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
    }
}

// ===== FIRESTORE SYNC (Organization-based) =====
function initFirestoreListener(){
    if(unsubscribe) unsubscribe();
    
    if(!currentOrg){
        console.log('No organization selected');
        return;
    }
    
    setSyncStatus('syncing', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è...');
    
    // –°–ª—É—Ö–∞—î–º–æ –ª—ñ–¥–∏ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
    unsubscribe = db.collection('organizations').doc(currentOrg.id).collection('leads')
        .onSnapshot(snapshot => {
            leads = [];
            snapshot.forEach(doc => {
                leads.push({ id: doc.id, ...doc.data() });
            });
            render();
            setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ');
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ª—ñ–¥—ñ–≤ –≤ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
            updateOrgLeadsCount(leads.length);
        }, err => {
            console.error('Firestore error:', err);
            setSyncStatus('error', '–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó');
        });
}

function updateOrgLeadsCount(count){
    if(currentOrg){
        currentOrg.leadsCount = count;
        const idx = organizations.findIndex(o => o.id === currentOrg.id);
        if(idx >= 0) organizations[idx].leadsCount = count;
        renderOrgSelector();
    }
}

// ===== SAVE/DELETE with Organization =====
async function saveLead(leadData){
    if(!currentOrg){
        alert('–û–±–µ—Ä—ñ—Ç—å –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—é');
        return;
    }
    
    setSyncStatus('syncing', '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...');
    try {
        const docRef = db.collection('organizations').doc(currentOrg.id).collection('leads').doc(leadData.id);
        await docRef.set(leadData);
        setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ');
    } catch(err){
        console.error('Save error:', err);
        setSyncStatus('error', '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
    }
}

async function deleteLead(leadId){
    if(!currentOrg) return;
    
    setSyncStatus('syncing', '–í–∏–¥–∞–ª–µ–Ω–Ω—è...');
    try {
        await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(leadId).delete();
        setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ');
    } catch(err){
        console.error('Delete error:', err);
        setSyncStatus('error', '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
    }
}

function setSyncStatus(status, text){
    const dot = document.getElementById('sync-dot');
    const txt = document.getElementById('sync-text');
    dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'error' ? ' error' : '');
    txt.textContent = text;
}

// ===== CONSTANTS =====
const ST={new:'–ù–æ–≤–∏–π –ª—ñ–¥',contacted:'–ö–æ–Ω—Ç–∞–∫—Ç',scheduled:'–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∞',completed:'–ü—Ä–æ–≤–µ–¥–µ–Ω–∞',report_sent:'–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ',repeat:'–ü–æ–≤—Ç–æ—Ä–Ω–∞',deposit:'–ó–∞–≤–¥–∞—Ç–æ–∫',paid:'–û–ø–ª–∞—á–µ–Ω–æ',failed:'–í—ñ–¥–º–æ–≤–∞',frozen:'–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∏–π'};
const SRC={bot:'–ë–æ—Ç',mk_clinic:'–ú–ö –ö–ª—ñ–Ω—ñ–∫–∏',mk_prod:'–ú–ö –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ',ads:'–†–µ–∫–ª–∞–º–∞',ref:'–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è',consult_clinic:'–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è'};
const CUR={UAH:'‚Ç¥',USD:'$',EUR:'‚Ç¨'};
let leads=[];
let editing=null;
let currentFilter='all';
let taskFilter='all';

function setTaskFilter(f){
    taskFilter=f;
    document.querySelectorAll('#tasks-filters .filter-pill').forEach(b=>b.classList.remove('active'));
    document.querySelector(`#tasks-filters .filter-pill[onclick="setTaskFilter('${f}')"]`).classList.add('active');
    renderTasks();
}

function save(){} // deprecated - now using Firestore
function today(){return new Date().toISOString().split('T')[0]}
function tomorrow(){let d=new Date();d.setDate(d.getDate()+1);return d.toISOString().split('T')[0]}
function addDays(s,n){let d=new Date(s);d.setDate(d.getDate()+n);return d.toISOString().split('T')[0]}
function fmtDate(s){if(!s)return'';return new Date(s).toLocaleDateString('uk-UA',{day:'numeric',month:'short'})}
function fmtDT(s){if(!s)return'';return new Date(s).toLocaleString('uk-UA',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}
function genId(){return'l'+Date.now()+''+Math.random().toString(36).substr(2,5)}

function switchView(v){
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
    document.getElementById('v-'+v).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.nav-btn[onclick="switchView('${v}')"]`).classList.add('active');
    render();
}

function render(){
    const v=document.querySelector('.view.active').id;
    if(v==='v-tasks')renderTasks();
    else if(v==='v-kanban')renderKanban();
    else renderReports();
}

// ===== TASKS =====
function getTasks(){
    const t=today(),tm=tomorrow(),tasks=[];
    const now = new Date();
    const currentHour = now.getHours();
    
    leads.forEach(l=>{
        // –û–ø–ª–∞—á–µ–Ω—ñ - –≤–∏–∫–ª—é—á–∞—î–º–æ –∑ –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–¥–∞—á
        if(l.status==='paid') return;
        
        // –ó–∞–º–æ—Ä–æ–∂–µ–Ω—ñ —Ç–∞ –í—ñ–¥–º–æ–≤–∞ - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–∞—Ç—É —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
        if(['failed','frozen'].includes(l.status)){
            if(l.reactDate && l.reactDate <= t){
                tasks.push({l, p:'info', msg:'–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è ‚Äî —á–∞—Å –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è', btns:[
                    {t:'success',l:'–¶—ñ–∫–∞–≤–æ',a:'react_ok'},
                    {t:'secondary',l:'+3 –º—ñ—Å',a:'react_later'},
                    {t:'secondary',l:'+1 —Ä—ñ–∫',a:'react_year'}
                ]});
            }
            return;
        }
        
        if(!l.status){tasks.push({l,p:'critical',msg:'–ù–µ–º–∞—î —Å—Ç–∞—Ç—É—Å—É!',btns:[{t:'warn',l:'–í—ñ–¥–∫—Ä–∏—Ç–∏',a:'open'}]});return;}
        
        // –ù–æ–≤–∏–π –ª—ñ–¥
        if(l.status==='new' || l.status==='contacted'){
            if(l.calls>=3){
                tasks.push({l,p:'critical',msg:'3 –¥–∑–≤—ñ–Ω–∫–∏ –±–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ',btns:[
                    {t:'warn',l:'–ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏',a:'freeze'},
                    {t:'secondary',l:'–©–µ —Ä–∞–∑',a:'call'}
                ]});
            }
            else if(!l.nextDate||l.nextDate<=t){
                tasks.push({l,p:l.nextDate<t?'critical':'warning',msg:`–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏ (${l.calls||0}/3)`,btns:[
                    {t:'success',l:'–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏',a:'schedule'},
                    {t:'secondary',l:'–ù–µ –≤–∑—è–≤',a:'call_later'},
                    {t:'warn',l:'–ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏',a:'freeze'}
                ]});
            }
        }
        
        // –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è
        if(l.status==='scheduled'||l.status==='repeat'){
            const cd = l.consult ? l.consult.split('T')[0] : null;
            const consultTime = l.consult ? l.consult.split('T')[1] : null;
            
            // –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–æ–π—à–ª–∞ (–¥–∞—Ç–∞ –≤ –º–∏–Ω—É–ª–æ–º—É) —ñ —Å—Ç–∞—Ç—É—Å –¥–æ—Å—ñ "–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–∞"
            if(cd && cd < t){
                tasks.push({l, p:'critical', msg:'–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –≤—ñ–¥–±—É–ª–∞—Å—å?', btns:[
                    {t:'success',l:'–ü—Ä–æ–≤–µ–¥–µ–Ω–∞',a:'complete'},
                    {t:'danger',l:'–ù–µ –ø—Ä–∏–π—à–æ–≤',a:'noshow'},
                    {t:'secondary',l:'–ü–µ—Ä–µ–Ω–µ—Å–ª–∏',a:'reschedule'}
                ]});
            }
            // –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è —Å—å–æ–≥–æ–¥–Ω—ñ
            else if(cd === t){
                // –†–∞–Ω–æ–∫ (–¥–æ 12:00) - –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
                if(currentHour < 12 && !l.confirmedToday){
                    tasks.push({l, p:'warning', msg:'–°—å–æ–≥–æ–¥–Ω—ñ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏!', btns:[
                        {t:'success',l:'–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤',a:'confirm_today'},
                        {t:'secondary',l:'SMS',a:'confirm_sms'}
                    ]});
                }
                // –ü—ñ—Å–ª—è —á–∞—Å—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó
                else if(consultTime && currentHour >= parseInt(consultTime.split(':')[0])){
                    tasks.push({l, p:'info', msg:'–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –∑–∞—Ä–∞–∑/–±—É–ª–∞', btns:[
                        {t:'success',l:'–ü—Ä–æ–≤–µ–¥–µ–Ω–∞',a:'complete'},
                        {t:'danger',l:'–ù–µ –ø—Ä–∏–π—à–æ–≤',a:'noshow'}
                    ]});
                }
                else {
                    tasks.push({l, p:'info', msg:`–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è —Å—å–æ–≥–æ–¥–Ω—ñ –æ ${consultTime || '‚Äî'}`, btns:[
                        {t:'success',l:'–ü—Ä–æ–≤–µ–¥–µ–Ω–∞',a:'complete'},
                        {t:'danger',l:'–ù–µ –ø—Ä–∏–π—à–æ–≤',a:'noshow'}
                    ]});
                }
            }
            // –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –∑–∞–≤—Ç—Ä–∞
            else if(cd === tm){
                tasks.push({l, p:'warning', msg:'–ó–∞–≤—Ç—Ä–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏', btns:[
                    {t:'success',l:'–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤',a:'confirm'},
                    {t:'secondary',l:'SMS',a:'confirm_sms'}
                ]});
            }
            // No-show –æ–±—Ä–æ–±–∫–∞
            else if(l.noshow > 0){
                const freezeAfter = l.noshow >= 3;
                tasks.push({l, p:'warning', msg:`–ù–µ –ø—Ä–∏–π—à–æ–≤ ${l.noshow} —Ä–∞–∑(—ñ–≤)`, btns:[
                    {t:'success',l:'–ü–µ—Ä–µ–Ω–µ—Å–ª–∏',a:'reschedule'},
                    {t:'warn',l:freezeAfter?'–ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏':'–©–µ —à–∞–Ω—Å',a:freezeAfter?'freeze':'reschedule'}
                ]});
            }
        }
        
        // –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ - —á–µ–∫–∞—î –∑–≤—ñ—Ç
        if(l.status==='completed'){
            tasks.push({l, p:'warning', msg:'–ù–∞–ø–∏—Å–∞—Ç–∏ –∑–≤—ñ—Ç', btns:[
                {t:'success',l:'–ó–≤—ñ—Ç –≥–æ—Ç–æ–≤–∏–π',a:'send_report'}
            ]});
        }
        
        // –ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ - –¥–æ–∂–∏–º
        if(l.status==='report_sent'){
            if(l.calls>=3 && l.sms>=3){
                tasks.push({l, p:'critical', msg:'3+3 –∫–æ–Ω—Ç–∞–∫—Ç–∏ ‚Äî —Ä—ñ—à–µ–Ω–Ω—è?', btns:[
                    {t:'warn',l:'–ü–æ–≤—Ç–æ—Ä–Ω–∞',a:'repeat'},
                    {t:'secondary',l:'–ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏',a:'freeze'}
                ]});
            }
            else if(!l.nextDate || l.nextDate<=t){
                tasks.push({l, p:l.nextDate<t?'critical':'warning', msg:`–î–æ–∂–∞—Ç–∏ (–¥–∑–≤:${l.calls||0} sms:${l.sms||0})`, btns:[
                    {t:'success',l:'–ó–∞–≤–¥–∞—Ç–æ–∫',a:'deposit'},
                    {t:'secondary',l:'–î—É–º–∞—î',a:'followup'},
                    {t:'warn',l:'–ü–æ–≤—Ç–æ—Ä–Ω–∞',a:'repeat'}
                ]});
            }
        }
        
        // –ó–∞–≤–¥–∞—Ç–æ–∫
        if(l.status==='deposit'){
            const days = l.finDepDate ? Math.floor((new Date()-new Date(l.finDepDate))/864e5) : 0;
            if(days>=7 || (l.nextDate && l.nextDate<=t)){
                tasks.push({l, p:days>=14?'critical':'warning', msg:`–ó–∞–≤–¥–∞—Ç–æ–∫ ${days}–¥–Ω ‚Äî –ø–æ–≤–Ω–∞ –æ–ø–ª–∞—Ç–∞?`, btns:[
                    {t:'success',l:'–û–ø–ª–∞—Ç–∏–≤',a:'paid'},
                    {t:'secondary',l:'+—Ç–∏–∂–¥–µ–Ω—å',a:'dep_later'}
                ]});
            }
        }
        
        // –ó–∞–≥–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω—É–≤–∞–Ω–Ω—è
        if(l.nextDate && l.nextDate<t && !tasks.find(x=>x.l.id===l.id)){
            const d = Math.floor((new Date(t)-new Date(l.nextDate))/864e5);
            tasks.push({l, p:'critical', msg:`–ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–æ ${d}–¥–Ω`, btns:[
                {t:'warn',l:'–í—ñ–¥–∫—Ä–∏—Ç–∏',a:'open'}
            ]});
        }
    });
    
    tasks.sort((a,b)=>({critical:0,warning:1,info:2}[a.p])-({critical:0,warning:1,info:2}[b.p]));
    return tasks;
}

function filterTasks(tasks){
    switch(taskFilter){
        case'critical':return tasks.filter(t=>t.p==='critical');
        case'calls':return tasks.filter(t=>t.msg.includes('–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏')||t.msg.includes('–¥–∑–≤—ñ–Ω–∫–∏')||t.msg.includes('–¥–∑–≤:'));
        case'consult':return tasks.filter(t=>t.l.status==='scheduled'||t.l.status==='repeat'||t.msg.includes('–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è'));
        case'followup':return tasks.filter(t=>t.l.status==='report_sent'||t.msg.includes('–î–æ–∂–∞—Ç–∏')||t.msg.includes('–∑–≤—ñ—Ç—É'));
        case'money':return tasks.filter(t=>t.l.status==='deposit'||t.msg.includes('–æ–ø–ª–∞—Ç')||t.msg.includes('–ó–∞–≤–¥–∞—Ç–æ–∫'));
        default:return tasks;
    }
}

function getAIHint(l){
    const hints=[];
    
    // –ü–æ —Å—Ç–∞—Ç—É—Å—É
    if(l.status==='new'){
        if(l.calls>=2)hints.push('–ù–µ –±–µ—Ä–µ —Ç—Ä—É–±–∫—É ‚Äî —Å–ø—Ä–æ–±—É–π SMS –∞–±–æ —ñ–Ω—à–∏–π —á–∞—Å');
        if(l.source==='ref')hints.push('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è ‚Äî –∑–≥–∞–¥–∞–π —Ö—Ç–æ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–≤–∞–≤');
        if(l.source==='mk_clinic'||l.source==='mk_prod')hints.push('–ë—É–≤ –Ω–∞ –ú–ö ‚Äî –≤–∂–µ —Ç–µ–ø–ª–∏–π, –æ–¥—Ä–∞–∑—É –¥–æ —Å—É—Ç—ñ');
    }
    if(l.status==='scheduled'||l.status==='repeat'){
        if(l.noshow>0)hints.push('–í–∂–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏–≤ ‚Äî –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏ –¥–µ–Ω—å –≤ –¥–µ–Ω—å');
    }
    if(l.status==='report_sent'){
        if(l.calls>=2&&l.sms<2)hints.push('–°–ø—Ä–æ–±—É–π SMS ‚Äî –¥–µ—è–∫—ñ –Ω–µ –ª—é–±–ª—è—Ç—å –¥–∑–≤—ñ–Ω–∫–∏');
        if(l.report?.toLowerCase().includes('–¥–æ—Ä–æ–≥–æ'))hints.push('–ó–≥–∞–¥—É–≤–∞–≤ "–¥–æ—Ä–æ–≥–æ" ‚Äî –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π —Ä–æ–∑—Å—Ç—Ä–æ—á–∫—É –∞–±–æ ROI');
        if(l.report?.toLowerCase().includes('–¥—É–º–∞—é'))hints.push('–°–∫–∞–∑–∞–≤ "–¥—É–º–∞—é" ‚Äî –¥–∞–π –¥–µ–¥–ª–∞–π–Ω –∞–±–æ –±–æ–Ω—É—Å');
    }
    if(l.status==='deposit'){
        const days=l.finDepDate?Math.floor((new Date()-new Date(l.finDepDate))/864e5):0;
        if(days>=7)hints.push('–ó–∞–≤–¥–∞—Ç–æ–∫ '+days+' –¥–Ω—ñ–≤ —Ç–æ–º—É ‚Äî —á–∞—Å –∑–∞–∫—Ä–∏–≤–∞—Ç–∏');
    }
    
    // –ü–æ —Ä–æ–∑–º—ñ—Ä—É –±—ñ–∑–Ω–µ—Å—É
    const bizMatch=l.biz?.match(/(\d+)/);
    if(bizMatch){
        const size=parseInt(bizMatch[1]);
        if(size>=15&&size<=25)hints.push('–Ü–¥–µ–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä –∫–ª—ñ–Ω—ñ–∫–∏ ‚Äî –∞–∫—Ü–µ–Ω—Ç—É–π –Ω–∞ —à–≤–∏–¥–∫–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ');
        if(size>40)hints.push('–í–µ–ª–∏–∫–∏–π –±—ñ–∑–Ω–µ—Å ‚Äî —Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–∏–π–º–∞—é—Ç—å –¥–æ–≤—à–µ, –±—É–¥—å —Ç–µ—Ä–ø–ª—è—á–∏–π');
    }
    
    return hints[0]||null;
}

function renderTasks(){
    const allTasks=getTasks();
    const tasks=filterTasks(allTasks);
    tasks.sort((a,b)=>calcScore(b.l)-calcScore(a.l));
    document.getElementById('task-count').textContent=tasks.length;
    const c=document.getElementById('tasks-list');
    
    // –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —è–∫—â–æ –Ω–µ–º–∞—î –ª—ñ–¥—ñ–≤ –≤–∑–∞–≥–∞–ª—ñ
    if(!leads.length){
        c.innerHTML=`<div class="onboarding">
            <div class="onboarding-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <div class="onboarding-title">–í—ñ—Ç–∞—é –≤ TALKO CRM!</div>
            <div class="onboarding-text">–°–∏—Å—Ç–µ–º–∞ –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è —É–≥–æ–¥ –∑ AI-–ø—ñ–¥–∫–∞–∑–∫–∞–º–∏. –ü–æ—á–Ω–∏ –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–µ—Ä—à–æ–≥–æ –ª—ñ–¥–∞.</div>
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="onboarding-step-num">1</div>
                    <div class="onboarding-step-text"><strong>–î–æ–¥–∞–π –ª—ñ–¥–∞</strong> ‚Äî –∫–æ–Ω—Ç–∞–∫—Ç, –±—ñ–∑–Ω–µ—Å, –¥–∂–µ—Ä–µ–ª–æ</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-num">2</div>
                    <div class="onboarding-step-text"><strong>–í–∏–∫–æ–Ω—É–π –∑–∞–≤–¥–∞–Ω–Ω—è</strong> ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø—ñ–¥–∫–∞–∂–µ —â–æ —Ä–æ–±–∏—Ç–∏</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-num">3</div>
                    <div class="onboarding-step-text"><strong>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π AI</strong> ‚Äî —Å–∫—Ä–∏–ø—Ç–∏, SMS, –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è</div>
                </div>
            </div>
            <button class="onboarding-btn" onclick="openModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>–î–æ–¥–∞—Ç–∏ –ø–µ—Ä—à–æ–≥–æ –ª—ñ–¥–∞</button>
            <div style="margin-top:16px"><button class="btn btn-s" onclick="loadDemo()" style="font-size:12px">–∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ</button></div>
        </div>`;
        return;
    }
    
    if(!tasks.length){
        c.innerHTML=`<div class="tasks-empty">
            <div class="tasks-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
            <div class="tasks-empty-title">${taskFilter==='all'?'–í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω—ñ':'–ù–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å'}</div>
            <div class="tasks-empty-text">${taskFilter==='all'?'–ß–∞—Å –¥–ª—è –ø–µ—Ä–µ—Ä–≤–∏':'–û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π —Ñ—ñ–ª—å—Ç—Ä'}</div>
        </div>`;
        return;
    }
    
    // –°–æ—Ä—Ç—É—î–º–æ –ø–æ –¥–∞—Ç—ñ —ñ —á–∞—Å—É –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –¥—ñ—ó
    tasks.sort((a,b) => {
        const dateA = a.l.nextDate || '9999-99-99';
        const dateB = b.l.nextDate || '9999-99-99';
        const timeA = a.l.nextTime || '23:59';
        const timeB = b.l.nextTime || '23:59';
        return (dateA + timeA).localeCompare(dateB + timeB);
    });
    
    // –ì—Ä—É–ø—É—î–º–æ: –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ, –∑–∞—Ä–∞–∑, —Å—å–æ–≥–æ–¥–Ω—ñ, –∑–∞–≤—Ç—Ä–∞, –ø—ñ–∑–Ω—ñ—à–µ
    const now = new Date();
    const todayStr = today();
    const tomorrowStr = tomorrow();
    const currentHour = now.getHours();
    const currentMin = now.getMinutes();
    
    const overdue = [];
    const nowTasks = [];
    const todayTasks = [];
    const tomorrowTasks = [];
    const later = [];
    
    tasks.forEach(t => {
        const d = t.l.nextDate;
        const time = t.l.nextTime || '09:00';
        const [h, m] = time.split(':').map(Number);
        
        if(!d || d < todayStr) {
            overdue.push(t);
        } else if(d === todayStr) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –∑–∞—Ä–∞–∑ (¬±30 —Ö–≤)
            const taskMins = h * 60 + m;
            const nowMins = currentHour * 60 + currentMin;
            if(Math.abs(taskMins - nowMins) <= 30) {
                nowTasks.push(t);
            } else if(taskMins > nowMins) {
                todayTasks.push(t);
            } else {
                overdue.push(t);
            }
        } else if(d === tomorrowStr) {
            tomorrowTasks.push(t);
        } else {
            later.push(t);
        }
    });
    
    let html = '<div class="tasks-list">';
    
    if(overdue.length) {
        html += `<div class="section-header"><span class="dot red"></span>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ ¬∑ ${overdue.length}</div>`;
        overdue.forEach(t => html += renderTaskRow(t, 'overdue'));
    }
    
    if(nowTasks.length) {
        html += `<div class="section-header"><span class="dot blue"></span>–ó–∞—Ä–∞–∑ ¬∑ ${nowTasks.length}</div>`;
        nowTasks.forEach(t => html += renderTaskRow(t, 'now'));
    }
    
    if(todayTasks.length) {
        html += `<div class="section-header"><span class="dot blue"></span>–°—å–æ–≥–æ–¥–Ω—ñ ¬∑ ${todayTasks.length}</div>`;
        todayTasks.forEach(t => html += renderTaskRow(t, 'today'));
    }
    
    if(tomorrowTasks.length) {
        html += `<div class="section-header"><span class="dot gray"></span>–ó–∞–≤—Ç—Ä–∞ ¬∑ ${tomorrowTasks.length}</div>`;
        tomorrowTasks.forEach(t => html += renderTaskRow(t, 'tomorrow'));
    }
    
    if(later.length) {
        html += `<div class="section-header"><span class="dot gray"></span>–ü—ñ–∑–Ω—ñ—à–µ ¬∑ ${later.length}</div>`;
        later.forEach(t => html += renderTaskRow(t, 'later'));
    }
    
    html += '</div>';
    c.innerHTML = html;
}

function renderTaskRow(t, status) {
    const score = calcScore(t.l);
    const scoreClass = score>=70?'hot':score>=50?'warm':'cold';
    const time = t.l.nextTime || '‚Äî';
    const date = t.l.nextDate;
    const action = t.l.nextAction || t.msg || '–ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏';
    
    let dateLabel = '';
    if(date === today()) dateLabel = '–°—å–æ–≥–æ–¥–Ω—ñ';
    else if(date === tomorrow()) dateLabel = '–ó–∞–≤—Ç—Ä–∞';
    else if(date) dateLabel = fmtDate(date);
    else dateLabel = '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
    
    const timeClass = status === 'overdue' ? 'overdue' : status === 'now' ? 'now' : status === 'today' ? 'today' : '';
    const rowClass = status === 'overdue' ? 'overdue' : status === 'now' ? 'now' : '';
    
    return `
    <div class="task-row ${rowClass}" onclick="openQuickPanel('${t.l.id}')" oncontextmenu="event.preventDefault();openModal('${t.l.id}')">
        <div class="task-time ${timeClass}">
            <div class="task-time-value">${status === 'now' ? '‚óè –ó–ê–†–ê–ó' : time}</div>
            <div class="task-time-date">${dateLabel}</div>
        </div>
        <div class="task-main-info">
            <span class="task-action-text">${action}</span>
            ${renderPrimaryContact(t.l)}
            ${t.l.biz ? `<span class="task-biz">${t.l.biz}</span>` : ''}
            <span class="task-score ${scoreClass}">${score}</span>
        </div>
        <div class="task-status-wrap" onclick="event.stopPropagation()">
            <button class="task-status-btn st-${t.l.status || 'new'}" onclick="toggleStatusDropdown('${t.l.id}', this)">
                ${ST[t.l.status] || '–ù–æ–≤–∏–π'}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="task-status-dropdown" id="status-dropdown-${t.l.id}">
                ${Object.entries(ST).map(([key, label]) => `
                    <div class="task-status-option" onclick="changeLeadStatus('${t.l.id}', '${key}')">
                        <span class="dot ${key}"></span>
                        ${label}
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="task-actions">
            <button class="task-action-btn" onclick="event.stopPropagation();openModal('${t.l.id}')" title="–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
            <button class="task-action-btn ai" onclick="event.stopPropagation();openAIPanel('${t.l.id}')" title="AI –ø—ñ–¥–∫–∞–∑–∫–∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><path d="M9 21h6"/></svg>
            </button>
        </div>
    </div>`;
}

function taskAction(id,a){
    const l=leads.find(x=>x.id===id);if(!l)return;
    const updatedLead = {...l}; // clone
    switch(a){
        case'open':openModal(id);return;
        case'schedule':
            updatedLead.status='scheduled';
            updatedLead.consult=prompt('–î–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó (YYYY-MM-DDTHH:MM):',tomorrow()+'T14:00');
            updatedLead.noshow=0;
            updatedLead.nextDate=updatedLead.consult?addDays(updatedLead.consult.split('T')[0],-1):tomorrow();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
            addLog(updatedLead,'status','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ '+fmtDT(updatedLead.consult));
            break;
        case'call_later':
            updatedLead.calls=(updatedLead.calls||0)+1;
            updatedLead.nextDate=tomorrow();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏';
            addLog(updatedLead,'call','–ù–µ –≤–∑—è–≤ —Ç—Ä—É–±–∫—É');
            break;
        case'call':
            updatedLead.calls=(updatedLead.calls||0)+1;
            addLog(updatedLead,'call','–©–µ —Å–ø—Ä–æ–±–∞');
            break;
        case'fail':
            updatedLead.status='failed';
            updatedLead.failReason=prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏:','');
            updatedLead.reactDate=addDays(today(),90);
            updatedLead.nextDate=updatedLead.reactDate;
            updatedLead.nextAction='–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è';
            addLog(updatedLead,'status','–í—ñ–¥–º–æ–≤–∞: '+(updatedLead.failReason||'–Ω–µ –≤–∫–∞–∑–∞–Ω–æ')+'. –†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è —á–µ—Ä–µ–∑ 3 –º—ñ—Å.');
            break;
        case'freeze':
            updatedLead.status='frozen';
            const freezeMonths = prompt('–ß–µ—Ä–µ–∑ —Å–∫—ñ–ª—å–∫–∏ –º—ñ—Å—è—Ü—ñ–≤ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è? (1-12)', '3');
            const months = parseInt(freezeMonths) || 3;
            updatedLead.reactDate=addDays(today(), months * 30);
            updatedLead.nextDate=updatedLead.reactDate;
            updatedLead.nextAction='–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è';
            addLog(updatedLead,'status','–ó–∞–º–æ—Ä–æ–∂–µ–Ω–æ –Ω–∞ '+months+' –º—ñ—Å.');
            break;
        case'confirm':
            updatedLead.confirmedToday = false;
            addLog(updatedLead,'call','–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é');
            break;
        case'confirm_today':
            updatedLead.confirmedToday = true;
            addLog(updatedLead,'call','–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ');
            break;
        case'confirm_sms':
            updatedLead.sms=(updatedLead.sms||0)+1;
            addLog(updatedLead,'sms','SMS –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è');
            break;
        case'complete':
            updatedLead.status='completed';
            updatedLead.calls=0;
            updatedLead.sms=0;
            updatedLead.nextDate=today();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ù–∞–ø–∏—Å–∞—Ç–∏ –∑–≤—ñ—Ç';
            addLog(updatedLead,'status','–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞');
            break;
        case'noshow':
            updatedLead.noshow=(updatedLead.noshow||0)+1;
            const noShowDelay = updatedLead.noshow === 1 ? 7 : updatedLead.noshow === 2 ? 30 : 90;
            updatedLead.nextDate = addDays(today(), noShowDelay);
            updatedLead.nextTime = '10:00';
            updatedLead.nextAction = '–ü–µ—Ä–µ–ø—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
            addLog(updatedLead,'status','–ù–µ –ø—Ä–∏–π—à–æ–≤ ('+updatedLead.noshow+' —Ä–∞–∑). –ù–∞—Å—Ç—É–ø–Ω–∞ —Å–ø—Ä–æ–±–∞ —á–µ—Ä–µ–∑ '+noShowDelay+' –¥–Ω—ñ–≤');
            break;
        case'reschedule':
            updatedLead.consult=prompt('–ù–æ–≤–∞ –¥–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó:',tomorrow()+'T14:00');
            updatedLead.noshow=0;
            updatedLead.nextDate=updatedLead.consult?addDays(updatedLead.consult.split('T')[0],-1):tomorrow();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
            addLog(updatedLead,'status','–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ '+fmtDT(updatedLead.consult));
            break;
        case'send_report':
            updatedLead.status='report_sent';
            updatedLead.reportDate=today();
            updatedLead.calls=0;
            updatedLead.sms=0;
            updatedLead.nextDate=addDays(today(),2);
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–î—ñ–∑–Ω–∞—Ç–∏—Å—å —Ä–µ–∞–∫—Ü—ñ—é –Ω–∞ –∑–≤—ñ—Ç';
            addLog(updatedLead,'status','–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
            break;
        case'followup':
            updatedLead.calls=(updatedLead.calls||0)+1;
            updatedLead.nextDate=addDays(today(),2);
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–î–æ–∂–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è';
            addLog(updatedLead,'call','–î—É–º–∞—î, –ø–µ—Ä–µ–¥–∑–≤–æ–Ω—é');
            break;
        case'repeat':
            updatedLead.status='repeat';
            updatedLead.repeatCount=(updatedLead.repeatCount||0)+1;
            updatedLead.calls=0;
            updatedLead.sms=0;
            updatedLead.noshow=0;
            updatedLead.consult=prompt('–î–∞—Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó:',tomorrow()+'T14:00');
            updatedLead.nextDate=updatedLead.consult?addDays(updatedLead.consult.split('T')[0],-1):tomorrow();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
            addLog(updatedLead,'status','–ü–æ–≤—Ç–æ—Ä–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è #'+(updatedLead.repeatCount));
            break;
        case'deposit':
            const amt=prompt('–°—É–º–∞ –∑–∞–≤–¥–∞—Ç–∫—É:','');
            if(amt){
                updatedLead.status='deposit';
                updatedLead.finDep=+amt;
                updatedLead.finDepDate=today();
                updatedLead.nextDate=addDays(today(),7);
                updatedLead.nextTime='10:00';
                updatedLead.nextAction='–ù–∞–≥–∞–¥–∞—Ç–∏ –ø—Ä–æ –ø–æ–≤–Ω—É –æ–ø–ª–∞—Ç—É';
                addLog(updatedLead,'status','–ó–∞–≤–¥–∞—Ç–æ–∫ '+amt);
            }else return;
            break;
        case'paid':
            const p=prompt('–ü–æ–≤–Ω–∞ —Å—É–º–∞:',updatedLead.finTotal||'');
            if(p){
                updatedLead.status='paid';
                updatedLead.finTotal=+p;
                updatedLead.finPaidDate=today();
                updatedLead.nextDate=null;
                updatedLead.nextAction=null;
                addLog(updatedLead,'status','–û–ø–ª–∞—á–µ–Ω–æ '+p);
            }else return;
            break;
        case'dep_later':
            updatedLead.nextDate=addDays(today(),7);
            updatedLead.nextTime='10:00';
            addLog(updatedLead,'call','–ù–∞–≥–∞–¥–∞–≤, +—Ç–∏–∂–¥–µ–Ω—å');
            break;
        case'react_ok':
            updatedLead.status='new';
            updatedLead.calls=0;
            updatedLead.sms=0;
            updatedLead.noshow=0;
            updatedLead.nextDate=today();
            updatedLead.nextTime='10:00';
            updatedLead.nextAction='–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏';
            addLog(updatedLead,'status','–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è ‚Äî –∑–Ω–æ–≤—É –≤ —Ä–æ–±–æ—Ç—ñ!');
            break;
        case'react_later':
            updatedLead.reactDate=addDays(today(),90);
            updatedLead.nextDate=updatedLead.reactDate;
            addLog(updatedLead,'call','–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è +3 –º—ñ—Å');
            break;
        case'react_year':
            updatedLead.reactDate=addDays(today(),365);
            updatedLead.nextDate=updatedLead.reactDate;
            addLog(updatedLead,'call','–†–µ–∞–∫—Ç–∏–≤–∞—Ü—ñ—è +1 —Ä—ñ–∫');
            break;
    }
    saveLead(updatedLead);
}

// Quick actions from task list
function quickComplete(id) {
    const l = leads.find(x => x.id === id);
    if(!l) return;
    
    // –ü–æ–∫–∞–∑—É—î–º–æ —à–≤–∏–¥–∫–∏–π –¥—ñ–∞–ª–æ–≥ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ—ó –¥—ñ—ó
    const nextAction = prompt('–©–æ –¥–∞–ª—ñ? (–Ω–∞—Å—Ç—É–ø–Ω–∞ –¥—ñ—è)', l.nextAction || '–ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏');
    if(nextAction === null) return;
    
    const nextDate = prompt('–ö–æ–ª–∏? (YYYY-MM-DD)', tomorrow());
    if(nextDate === null) return;
    
    const nextTime = prompt('–û –∫–æ—Ç—Ä—ñ–π? (HH:MM)', '10:00');
    if(nextTime === null) return;
    
    const updatedLead = {...l};
    updatedLead.calls = (updatedLead.calls || 0) + 1;
    updatedLead.nextAction = nextAction;
    updatedLead.nextDate = nextDate;
    updatedLead.nextTime = nextTime;
    addLog(updatedLead, 'call', '–í–∏–∫–æ–Ω–∞–Ω–æ: ' + (l.nextAction || '–¥–∑–≤—ñ–Ω–æ–∫'));
    saveLead(updatedLead);
}

function quickReschedule(id) {
    const l = leads.find(x => x.id === id);
    if(!l) return;
    
    const nextDate = prompt('–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –¥–∞—Ç—É (YYYY-MM-DD):', tomorrow());
    if(!nextDate) return;
    
    const nextTime = prompt('–ß–∞—Å (HH:MM):', l.nextTime || '10:00');
    if(nextTime === null) return;
    
    const updatedLead = {...l};
    updatedLead.nextDate = nextDate;
    updatedLead.nextTime = nextTime;
    addLog(updatedLead, 'status', '–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –Ω–∞ ' + nextDate + ' ' + nextTime);
    saveLead(updatedLead);
}

function openAIPanel(id) {
    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –ª—ñ–¥–∞ —ñ –∞–∫—Ç–∏–≤—É—î–º–æ AI –ø–∞–Ω–µ–ª—å
    openModal(id);
    setTimeout(() => {
        toggleAIPanel();
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î–º–æ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ—ó –¥—ñ—ó
        aiAsk('script');
    }, 300);
}

// ===== KANBAN =====
let dragId=null;

function setFilter(f){
    currentFilter=f;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.filter-btn[onclick="setFilter('${f}')"]`).classList.add('active');
    renderKanban();
}

function filterLeads(arr){
    const t=today(),tm=tomorrow();
    switch(currentFilter){
        case'critical':return arr.filter(l=>getAlert(l)?.crit);
        case'today':return arr.filter(l=>l.consult&&l.consult.split('T')[0]===t);
        case'tomorrow':return arr.filter(l=>l.consult&&l.consult.split('T')[0]===tm);
        case'action':return arr.filter(l=>l.nextDate===t);
        case'money':return arr.filter(l=>l.status==='deposit'||(l.status==='report_sent'&&l.calls>=2));
        default:return arr;
    }
}

function renderKanban(){
    const cols=['new','scheduled','completed','report_sent','repeat','deposit','paid'];
    const filtered=filterLeads(leads);
    document.getElementById('kanban').innerHTML=cols.map(s=>{
        const items=filtered.filter(l=>l.status===s);
        return`<div class="column" data-status="${s}">
            <div class="column-header"><span>${ST[s]}</span><span class="column-count">${items.length}</span></div>
            <div class="column-cards" ondragover="dOver(event)" ondrop="dDrop(event,'${s}')" ondragleave="dLeave(event)">
                ${items.map(l=>kCard(l)).join('')}
            </div>
        </div>`;
    }).join('');
}

function getTags(l){
    const t=today(),tm=tomorrow();
    const tags=[];
    if(l.nextDate&&l.nextDate<t)tags.push({cls:'overdue',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',text:'–ü—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–æ'});
    if(l.consult){
        const cd=l.consult.split('T')[0];
        if(cd===t)tags.push({cls:'consult-today',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',text:'–°—å–æ–≥–æ–¥–Ω—ñ'});
        else if(cd===tm)tags.push({cls:'consult-tomorrow',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',text:'–ó–∞–≤—Ç—Ä–∞'});
    }
    if(l.noshow>0)tags.push({cls:'noshow',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',text:'–ù–µ –ø—Ä–∏–π—à–æ–≤ '+l.noshow+'x'});
    if(l.finDep&&l.status!=='paid')tags.push({cls:'has-deposit',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',text:'–ó–∞–≤–¥–∞—Ç–æ–∫'});
    if(l.nextDate===t&&!tags.find(x=>x.cls==='consult-today'))tags.push({cls:'action-today',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',text:'–î—ñ—è —Å—å–æ–≥–æ–¥–Ω—ñ'});
    return tags;
}

function kCard(l){
    const days=l.stageDate?Math.floor((new Date()-new Date(l.stageDate))/864e5):0;
    const alert=getAlert(l);
    const amt=l.finTotal||l.finDep;
    const tags=getTags(l);
    const score=calcScore(l);
    const scoreClass=score>=70?'hot':score>=50?'warm':'cold';
    return`<div class="k-card ${alert?'has-'+(alert.crit?'critical':'alert'):''}" draggable="true" ondragstart="dStart(event,'${l.id}')" ondragend="dEnd(event)" onclick="openModal('${l.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <div class="k-card-name">${l.tg||l.phone||'‚Äî'}</div>
            <div class="score ${scoreClass}"><div class="score-bar"><div class="score-fill ${scoreClass}" style="width:${score}%"></div></div>${score}</div>
        </div>
        ${l.biz?`<div class="k-card-biz">${l.biz}</div>`:''}
        <div class="k-card-footer">
            <span>${SRC[l.source]||''}</span>
            ${amt?`<span class="k-card-amount">${amt}${CUR[l.finTotalCur||l.finDepCur]||''}</span>`:''}
            <span class="k-card-days ${days>5?'over':''}">${days}–¥</span>
        </div>
        ${tags.length?`<div class="k-card-tags">${tags.map(tag=>`<span class="k-tag ${tag.cls}">${tag.icon} ${tag.text}</span>`).join('')}</div>`:''}
    </div>`;
}
function getAlert(l){
    if(!l.status)return{crit:true};
    if(l.nextDate&&l.nextDate<today())return{crit:true};
    if(l.status==='new'&&l.calls>=3)return{crit:true};
    if(l.status==='report_sent'&&l.calls>=3&&l.sms>=3)return{crit:true};
    if(l.noshow>=3)return{crit:true};
    return null;
}
function dStart(e,id){dragId=id;e.target.classList.add('dragging');}
function dEnd(e){e.target.classList.remove('dragging');dragId=null;}
function dOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function dLeave(e){e.currentTarget.classList.remove('drag-over');}
function dDrop(e,status){
    e.preventDefault();e.currentTarget.classList.remove('drag-over');
    if(!dragId)return;
    const l=leads.find(x=>x.id===dragId);if(!l)return;
    const updatedLead = {...l};
    if(status==='paid'&&!updatedLead.finTotal){alert('–í–∫–∞–∂—ñ—Ç—å —Å—É–º—É!');openModal(updatedLead.id);return;}
    if(status==='deposit'&&!updatedLead.finDep){const a=prompt('–°—É–º–∞ –∑–∞–≤–¥–∞—Ç–∫—É:');if(!a)return;updatedLead.finDep=+a;updatedLead.finDepDate=today();}
    const old=updatedLead.status;updatedLead.status=status;updatedLead.stageDate=new Date().toISOString();
    if(status==='completed'){updatedLead.calls=0;updatedLead.sms=0;}
    if(status==='report_sent'){updatedLead.reportDate=today();updatedLead.calls=0;updatedLead.sms=0;updatedLead.nextDate=tomorrow();}
    addLog(updatedLead,'status',ST[old]+' ‚Üí '+ST[status]);
    saveLead(updatedLead);
}

// ===== REPORTS =====
function initReportDates(){
    const now=new Date();
    const weekAgo=new Date(now);weekAgo.setDate(now.getDate()-7);
    document.getElementById('date-from').value=weekAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value=now.toISOString().split('T')[0];
}

function setReportPeriod(p){
    const now=new Date();
    const to=now.toISOString().split('T')[0];
    let from;
    switch(p){
        case'week':
            const w=new Date(now);w.setDate(now.getDate()-7);
            from=w.toISOString().split('T')[0];
            break;
        case'month':
            const m=new Date(now);m.setMonth(now.getMonth()-1);
            from=m.toISOString().split('T')[0];
            break;
        case'quarter':
            const q=new Date(now);q.setMonth(now.getMonth()-3);
            from=q.toISOString().split('T')[0];
            break;
        case'all':
            from='2020-01-01';
            break;
    }
    document.getElementById('date-from').value=from;
    document.getElementById('date-to').value=to;
    renderReports();
}

function renderReports(){
    const fromDate=document.getElementById('date-from').value;
    const toDate=document.getElementById('date-to').value;
    const fl=filterByDateRange(leads,fromDate,toDate);
    const byS={};fl.forEach(l=>{byS[l.status]=(byS[l.status]||0)+1;});
    const paid=fl.filter(l=>l.status==='paid');
    const dep=fl.filter(l=>l.status==='deposit');
    let rev=0;
    paid.forEach(l=>{rev+=toUAH(l.finTotal,l.finTotalCur);});
    dep.forEach(l=>{rev+=toUAH(l.finDep,l.finDepCur);});
    const cons=fl.filter(l=>['completed','report_sent','repeat','deposit','paid'].includes(l.status)).length;
    
    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const newLeads=fl.filter(l=>l.status==='new').length;
    const failed=fl.filter(l=>l.status==='failed').length;
    const avgDays=fl.length?Math.round(fl.reduce((s,l)=>{
        if(!l.stageDate||!l.created)return s;
        return s+Math.floor((new Date(l.stageDate)-new Date(l.created))/864e5);
    },0)/fl.length):0;
    
    document.getElementById('stats').innerHTML=`
        <div class="stat"><div class="stat-val">${fl.length}</div><div class="stat-label">–õ—ñ–¥—ñ–≤</div></div>
        <div class="stat"><div class="stat-val">${cons}</div><div class="stat-label">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ–π</div></div>
        <div class="stat"><div class="stat-val">${dep.length}</div><div class="stat-label">–ó–∞–≤–¥–∞—Ç–∫—ñ–≤</div></div>
        <div class="stat"><div class="stat-val">${paid.length}</div><div class="stat-label">–û–ø–ª–∞—Ç</div></div>
        <div class="stat"><div class="stat-val">${Math.round(rev).toLocaleString()}</div><div class="stat-label">–°—É–º–∞ (–≥—Ä–Ω)</div></div>
        <div class="stat"><div class="stat-val">${fl.length?Math.round(paid.length/fl.length*100):0}%</div><div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å—ñ—è</div></div>
        <div class="stat"><div class="stat-val">${failed}</div><div class="stat-label">–ù–µ—É—Å–ø—ñ—à–Ω–∏—Ö</div></div>
        <div class="stat"><div class="stat-val">${avgDays}–¥</div><div class="stat-label">–°–µ—Ä. —Ü–∏–∫–ª</div></div>
    `;
    const funnel=[['–ù–æ–≤—ñ',byS.new||0],['–ü—Ä–∏–∑–Ω–∞—á–µ–Ω—ñ',byS.scheduled||0],['–ü—Ä–æ–≤–µ–¥–µ–Ω—ñ',byS.completed||0],['–ó–≤—ñ—Ç',byS.report_sent||0],['–ó–∞–≤–¥–∞—Ç–æ–∫',byS.deposit||0],['–û–ø–ª–∞—á–µ–Ω–æ',byS.paid||0]];
    const max=Math.max(...funnel.map(f=>f[1]),1);
    document.getElementById('funnel').innerHTML=funnel.map(f=>`
        <div class="funnel-row"><div class="funnel-label">${f[0]}</div><div class="funnel-bar"><div class="funnel-fill" style="width:${f[1]/max*100}%">${f[1]}</div></div></div>
    `).join('');
}

function filterByDateRange(arr,from,to){
    if(!from&&!to)return arr;
    const fromD=from?new Date(from+'T00:00:00'):new Date('2000-01-01');
    const toD=to?new Date(to+'T23:59:59'):new Date();
    return arr.filter(l=>{
        const created=new Date(l.created);
        return created>=fromD&&created<=toD;
    });
}

function toUAH(a,c){if(!a)return 0;return a*({UAH:1,USD:41,EUR:45}[c]||1);}

function exportReport(){
    const fromDate=document.getElementById('date-from').value;
    const toDate=document.getElementById('date-to').value;
    const fl=filterByDateRange(leads,fromDate,toDate);
    const byS={};fl.forEach(l=>{byS[l.status]=(byS[l.status]||0)+1;});
    const paid=fl.filter(l=>l.status==='paid');
    const dep=fl.filter(l=>l.status==='deposit');
    let rev=0;
    paid.forEach(l=>{rev+=toUAH(l.finTotal,l.finTotalCur);});
    dep.forEach(l=>{rev+=toUAH(l.finDep,l.finDepCur);});
    
    const data=[
        ['TALKO CRM –ó–≤—ñ—Ç'],
        ['–ü–µ—Ä—ñ–æ–¥:',fromDate+' ‚Äî '+toDate],
        [''],
        ['–°—Ç–∞—Ç—É—Å','–ö-—Å—Ç—å'],
        ...Object.entries(byS).map(([k,v])=>[ST[k]||k,v]),
        [''],
        ['–í—Å—å–æ–≥–æ –ª—ñ–¥—ñ–≤',fl.length],
        ['–û–ø–ª–∞—á–µ–Ω–æ',paid.length],
        ['–°—É–º–∞ (–≥—Ä–Ω)',Math.round(rev)],
        ['–ö–æ–Ω–≤–µ—Ä—Å—ñ—è',fl.length?Math.round(paid.length/fl.length*100)+'%':'0%']
    ];
    const ws=XLSX.utils.aoa_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'–ó–≤—ñ—Ç');
    XLSX.writeFile(wb,'TALKO_Report_'+fromDate+'_'+toDate+'.xlsx');
}

// ===== MODAL =====
function openModal(id){
    editing=id||null;
    document.getElementById('modal').classList.add('active');
    document.getElementById('modal-title').textContent=id?'–†–µ–¥–∞–≥—É–≤–∞—Ç–∏':'–ù–æ–≤–∏–π –ª—ñ–¥';
    document.getElementById('del-btn').style.display=id?'block':'none';
    document.getElementById('quick-actions').style.display=id?'flex':'none';
    resetForm();
    if(id){const l=leads.find(x=>x.id===id);if(l)fillForm(l);}
    switchTab('main');
}
function closeModal(){document.getElementById('modal').classList.remove('active');editing=null;}
function switchTab(t){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
    document.getElementById('t-'+t).classList.add('active');
}
function resetForm(){
    ['f-id','f-status','f-noshow','f-tg','f-phone','f-viber','f-whatsapp','f-email','f-primary-channel','f-biz','f-source','f-consult','f-repeat','f-calls','f-sms','f-next','f-next-time','f-action','f-fail','f-report','f-notes','l-record','l-report','l-kp','l-contract','fin-dep','fin-dep-cur','fin-dep-date','fin-total','fin-total-cur','fin-paid-date'].forEach(id=>{
        const e=document.getElementById(id);if(e)e.value='';
    });
    document.getElementById('f-next-time').value='10:00';
    document.getElementById('f-primary-channel').value='phone';
    document.getElementById('comm-log').innerHTML='<div style="color:var(--g);text-align:center;padding:20px">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</div>';
    document.getElementById('fail-group').style.display='none';
}
function fillForm(l){
    document.getElementById('f-id').value=l.id;
    document.getElementById('f-status').value=l.status||'';
    document.getElementById('f-noshow').value=l.noshow||'0';
    document.getElementById('f-tg').value=l.tg||'';
    document.getElementById('f-phone').value=l.phone||'';
    document.getElementById('f-viber').value=l.viber||'';
    document.getElementById('f-whatsapp').value=l.whatsapp||'';
    document.getElementById('f-email').value=l.email||'';
    document.getElementById('f-primary-channel').value=l.primaryChannel||'phone';
    document.getElementById('f-biz').value=l.biz||'';
    document.getElementById('f-source').value=l.source||'';
    document.getElementById('f-consult').value=l.consult||'';
    document.getElementById('f-repeat').value=l.repeatCount||'0';
    document.getElementById('f-calls').value=l.calls||'0';
    document.getElementById('f-sms').value=l.sms||'0';
    document.getElementById('f-next').value=l.nextDate||'';
    document.getElementById('f-next-time').value=l.nextTime||'10:00';
    document.getElementById('f-action').value=l.nextAction||'';
    document.getElementById('f-fail').value=l.failReason||'';
    document.getElementById('f-notes').value=l.notes||'';
    document.getElementById('f-report').value=l.report||'';
    document.getElementById('l-record').value=l.linkRecord||'';
    document.getElementById('l-report').value=l.linkReport||'';
    document.getElementById('l-kp').value=l.linkKP||'';
    document.getElementById('l-contract').value=l.linkContract||'';
    document.getElementById('fin-dep').value=l.finDep||'';
    document.getElementById('fin-dep-cur').value=l.finDepCur||'UAH';
    document.getElementById('fin-dep-date').value=l.finDepDate||'';
    document.getElementById('fin-total').value=l.finTotal||'';
    document.getElementById('fin-total-cur').value=l.finTotalCur||'UAH';
    document.getElementById('fin-paid-date').value=l.finPaidDate||'';
    onStatusChange();
    renderCommLog(l);
}
function saveLeadForm(){
    const phone=document.getElementById('f-phone').value;
    const tg=document.getElementById('f-tg').value;
    const email=document.getElementById('f-email').value;
    if(!phone&&!tg&&!email){alert('–í–∫–∞–∂—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –∫–æ–Ω—Ç–∞–∫—Ç');return;}
    const status=document.getElementById('f-status').value;
    if(status==='failed'&&!document.getElementById('f-fail').value){alert('–í–∫–∞–∂—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É');return;}
    
    const data={
        id:document.getElementById('f-id').value||genId(),
        status,
        noshow:+document.getElementById('f-noshow').value||0,
        tg,phone,
        viber:document.getElementById('f-viber').value,
        whatsapp:document.getElementById('f-whatsapp').value,
        email,
        primaryChannel:document.getElementById('f-primary-channel').value||'phone',
        biz:document.getElementById('f-biz').value,
        source:document.getElementById('f-source').value,
        consult:document.getElementById('f-consult').value,
        repeatCount:+document.getElementById('f-repeat').value||0,
        calls:+document.getElementById('f-calls').value||0,
        sms:+document.getElementById('f-sms').value||0,
        nextDate:document.getElementById('f-next').value,
        nextTime:document.getElementById('f-next-time').value||'10:00',
        nextAction:document.getElementById('f-action').value,
        failReason:document.getElementById('f-fail').value,
        report:document.getElementById('f-report').value,
        notes:document.getElementById('f-notes').value,
        linkRecord:document.getElementById('l-record').value,
        linkReport:document.getElementById('l-report').value,
        linkKP:document.getElementById('l-kp').value,
        linkContract:document.getElementById('l-contract').value,
        finDep:+document.getElementById('fin-dep').value||null,
        finDepCur:document.getElementById('fin-dep-cur').value,
        finDepDate:document.getElementById('fin-dep-date').value,
        finTotal:+document.getElementById('fin-total').value||null,
        finTotalCur:document.getElementById('fin-total-cur').value,
        finPaidDate:document.getElementById('fin-paid-date').value
    };
    
    const idx=leads.findIndex(l=>l.id===data.id);
    if(idx>=0){
        data.created=leads[idx].created;
        data.log=leads[idx].log||[];
        if(leads[idx].status!==data.status){data.stageDate=new Date().toISOString();addLog(data,'status','‚Üí '+ST[data.status]);}
        else data.stageDate=leads[idx].stageDate;
    }else{
        data.created=new Date().toISOString();
        data.stageDate=new Date().toISOString();
        data.log=[];
        if(!data.status)data.status='new';
        if(!data.nextDate){data.nextDate=today();data.nextTime='10:00';data.nextAction='–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏';}
    }
    if(data.status==='failed'&&!data.reactDate)data.reactDate=addDays(today(),90);
    
    saveLead(data); // Firebase save
    closeModal();
}
function delLeadForm(){if(!editing)return;if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?'))return;deleteLead(editing);closeModal();}
function onStatusChange(){
    const st=document.getElementById('f-status').value;
    document.getElementById('fail-group').style.display=st==='failed'?'block':'none';
    document.getElementById('report-group').style.display=['completed','report_sent','repeat','deposit','paid'].includes(st)?'block':'none';
}

// ===== LEAD SCORING =====
function calcScore(l){
    let score=50; // –±–∞–∑–æ–≤–∏–π
    
    // –î–∂–µ—Ä–µ–ª–æ (+/- 15)
    if(l.source==='ref')score+=15; // —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è - –Ω–∞–π–∫—Ä–∞—â–µ
    if(l.source==='mk_clinic')score+=10;
    if(l.source==='mk_prod')score+=10;
    if(l.source==='ads')score+=5;
    if(l.source==='bot')score+=0;
    
    // –†–æ–∑–º—ñ—Ä –±—ñ–∑–Ω–µ—Å—É (+/- 10)
    const bizMatch=l.biz?.match(/(\d+)/);
    if(bizMatch){
        const size=parseInt(bizMatch[1]);
        if(size>=15&&size<=30)score+=10; // sweet spot
        else if(size>=10&&size<=50)score+=5;
        else if(size>50)score+=3; // –≤–µ–ª–∏–∫—ñ –¥–æ–≤—à–µ –∑–∞–∫—Ä–∏–≤–∞—é—Ç—å—Å—è
    }
    
    // –ü—Ä–æ–≥—Ä–µ—Å –ø–æ –≤–æ—Ä–æ–Ω—Ü—ñ (+20)
    if(l.status==='report_sent')score+=10;
    if(l.status==='repeat')score+=15;
    if(l.status==='deposit')score+=20;
    
    // –®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–µ–∞–∫—Ü—ñ—ó (+/- 10)
    if(l.stageDate){
        const days=Math.floor((new Date()-new Date(l.stageDate))/864e5);
        if(days<=2)score+=10; // —Å–≤—ñ–∂–∏–π
        else if(days<=5)score+=5;
        else if(days>7)score-=10; // –∑–∞—Å—Ç—Ä—è–≥
        else if(days>14)score-=20;
    }
    
    // Engagement (+/- 15)
    if(l.noshow>0)score-=l.noshow*10; // –∫–æ–∂–Ω–∞ –Ω–µ—è–≤–∫–∞ -10
    if(l.calls>3&&l.status==='new')score-=15; // –Ω–µ –±–µ—Ä–µ —Ç—Ä—É–±–∫—É
    
    // –§—ñ–Ω–∞–Ω—Å–∏ (+15)
    if(l.finDep)score+=15; // —î –∑–∞–≤–¥–∞—Ç–æ–∫
    
    // –ó–≤—ñ—Ç —î (+10)
    if(l.report&&l.report.length>50)score+=10;
    
    // –ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞ –≤ –∑–≤—ñ—Ç—ñ
    if(l.report){
        const r=l.report.toLowerCase();
        if(r.includes('–≥–æ—Ç–æ–≤')||r.includes('—Ö–æ—á'))score+=10;
        if(r.includes('–±—é–¥–∂–µ—Ç')||r.includes('–≥—Ä–æ—à'))score+=5;
        if(r.includes('—Ç–µ—Ä–º—ñ–Ω–æ–≤–æ')||r.includes('—à–≤–∏–¥–∫'))score+=10;
        if(r.includes('–¥—É–º–∞—é')||r.includes('–ø–æ—Ä–∞–¥–∂'))score-=5;
        if(r.includes('–¥–æ—Ä–æ–≥–æ')||r.includes('–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç'))score-=10;
    }
    
    // –û–±–º–µ–∂—É—î–º–æ 0-100
    return Math.max(0,Math.min(100,score));
}

// ===== COMM LOG =====
function renderCommLog(l){
    const log=l.log||[];
    const c=document.getElementById('comm-log');
    if(!log.length){c.innerHTML='<div style="color:var(--g);text-align:center;padding:20px">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</div>';return;}
    c.innerHTML=log.slice().reverse().map(e=>`
        <div class="comm-item">
            <div class="comm-icon ${e.type}">${{call:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',sms:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',note:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',status:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>'}[e.type]||'‚Ä¢'}</div>
            <div class="comm-body">
                <div class="comm-head"><span class="comm-type">${{call:'–î–∑–≤—ñ–Ω–æ–∫',sms:'SMS',note:'–ù–æ—Ç–∞—Ç–∫–∞',status:'–°—Ç–∞—Ç—É—Å'}[e.type]||e.type}</span><span class="comm-date">${fmtDT(e.date)}</span></div>
                <div class="comm-text">${e.text}</div>
            </div>
        </div>
    `).join('');
}
function addComm(){
    if(!editing)return;
    const type=document.getElementById('comm-type').value;
    const text=document.getElementById('comm-text').value;
    if(!text.trim())return;
    const l=leads.find(x=>x.id===editing);if(!l)return;
    addLog(l,type,text);
    if(type==='call'){l.calls=(l.calls||0)+1;document.getElementById('f-calls').value=l.calls;}
    if(type==='sms'){l.sms=(l.sms||0)+1;document.getElementById('f-sms').value=l.sms;}
    save();renderCommLog(l);
    document.getElementById('comm-text').value='';
}
function addLog(l,type,text){if(!l.log)l.log=[];l.log.push({type,text,date:new Date().toISOString()});}

function qAction(a){if(!editing)return;closeModal();taskAction(editing,a==='call'?'call_later':a==='sms'?'followup':a==='schedule'?'schedule':'fail');}

// ===== IMPORT/EXPORT =====
function exportXLS(){
    if(!leads.length){alert('–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö');return;}
    const data=leads.map(l=>({–¢–µ–ª–µ–≥—Ä–∞–º:l.tg,–¢–µ–ª–µ—Ñ–æ–Ω:l.phone,–ë—ñ–∑–Ω–µ—Å:l.biz,–î–∂–µ—Ä–µ–ª–æ:SRC[l.source]||l.source,–°—Ç–∞—Ç—É—Å:ST[l.status]||l.status,–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è:l.consult,–î–∑–≤—ñ–Ω–∫–∏:l.calls,SMS:l.sms,'–ù–∞—Å—Ç—É–ø–Ω–∞ –¥—ñ—è':l.nextDate,–ó–∞–≤–¥–∞—Ç–æ–∫:l.finDep,'–ü–æ–≤–Ω–∞ —Å—É–º–∞':l.finTotal,–ü—Ä–∏–º—ñ—Ç–∫–∏:l.notes}));
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Leads');
    XLSX.writeFile(wb,'TALKO_CRM_'+today()+'.xlsx');
}
function importXLS(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array',cellDates:true});
            const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,raw:false,defval:''});
            
            // –®—É–∫–∞—î–º–æ —Ä—è–¥–æ–∫ –∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ (–º—ñ—Å—Ç–∏—Ç—å 'phone' –∞–±–æ 'timestamp')
            let headerRow=-1;
            for(let i=0;i<Math.min(10,rows.length);i++){
                const row=rows[i].map(c=>String(c).toLowerCase());
                if(row.some(c=>c.includes('phone')||c.includes('timestamp')||c.includes('—Ç–µ–ª–µ—Ñ–æ–Ω'))){
                    headerRow=i;break;
                }
            }
            
            // –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ ‚Äî –ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫
            if(headerRow===-1)headerRow=0;
            
            const headers=rows[headerRow].map(h=>String(h).toLowerCase().trim());
            console.log('Headers found at row',headerRow,':',headers);
            
            // –ú–∞–ø–ø—ñ–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫
            const colMap={};
            headers.forEach((h,i)=>{
                if(h.includes('timestamp')||h.includes('–¥–∞—Ç–∞'))colMap.date=i;
                if(h.includes('clinic')||h.includes('—Ç–∏–ø')||h.includes('–±—ñ–∑–Ω–µ—Å'))colMap.biz=i;
                if(h.includes('problem')||h.includes('–ø—Ä–æ–±–ª–µ–º'))colMap.problem=i;
                if(h.includes('goal')||h.includes('—Ü—ñ–ª—å'))colMap.goal=i;
                if(h.includes('phone')||h.includes('—Ç–µ–ª–µ—Ñ–æ–Ω'))colMap.phone=i;
                if(h.includes('source')||h.includes('–¥–∂–µ—Ä–µ–ª–æ'))colMap.source=i;
                if(h.includes('telegram')||h.includes('–Ω—ñ–∫'))colMap.tg=i;
                if(h.includes('mk_name')||h.includes('–Ω–∞–∑–≤–∞'))colMap.mkName=i;
                if(h.includes('status')||h.includes('—Å—Ç–∞—Ç—É—Å'))colMap.status=i;
            });
            console.log('Column mapping:',colMap);
            
            let n=0,skip=0;
            for(let i=headerRow+1;i<rows.length;i++){
                const row=rows[i];
                if(!row||row.length===0)continue;
                
                // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–ª–µ—Ñ–æ–Ω
                let phone=colMap.phone!==undefined?String(row[colMap.phone]||''):'';
                phone=phone.replace(/\D/g,''); // —Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏
                if(phone.length===9)phone='380'+phone; // 970064026 -> 380970064026
                if(phone.length===10&&phone[0]==='0')phone='38'+phone; // 0970064026 -> 380970064026
                if(phone.length>=10)phone='+'+phone;
                if(phone.length<10){skip++;continue;} // –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –±–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω—É
                
                // –û—Ç—Ä–∏–º—É—î–º–æ —Ç–µ–ª–µ–≥—Ä–∞–º
                let tg=colMap.tg!==undefined?String(row[colMap.tg]||''):'';
                if(tg&&!tg.startsWith('@'))tg='@'+tg;
                if(tg==='@')tg='';
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏
                if(leads.some(l=>(phone&&l.phone===phone)||(tg&&l.tg===tg))){skip++;continue;}
                
                // –ü–∞—Ä—Å–∏–º–æ –ø—Ä–æ–±–ª–µ–º—É (–º–æ–∂–µ –±—É—Ç–∏ —á–∏—Å–ª–æ, —Ç–µ–∫—Å—Ç, –∞–±–æ –¥–∞—Ç–∞-–±–∞–≥)
                let problem=colMap.problem!==undefined?String(row[colMap.problem]||''):'';
                if(problem.includes('1900')||problem.includes('2004'))problem=''; // Excel date bug
                
                // –ü–∞—Ä—Å–∏–º–æ —Ü—ñ–ª—å
                let goal=colMap.goal!==undefined?String(row[colMap.goal]||''):'';
                if(goal.includes('1900')||goal.includes('2004'))goal=''; // Excel date bug
                
                // –ë—ñ–∑–Ω–µ—Å
                let biz=colMap.biz!==undefined?String(row[colMap.biz]||''):'';
                if(biz==='NaN'||biz==='undefined')biz='';
                
                // –î–∂–µ—Ä–µ–ª–æ
                let source=colMap.source!==undefined?String(row[colMap.source]||''):'';
                if(!source||source==='NaN'){
                    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ mk_name —è–∫—â–æ —î
                    const mkName=colMap.mkName!==undefined?String(row[colMap.mkName]||'').toLowerCase():'';
                    if(mkName.includes('–∫–ª—ñ–Ω—ñ–∫'))source='mk_clinic';
                    else if(mkName.includes('–≤–∏—Ä–æ–±–Ω'))source='mk_prod';
                    else source='bot';
                }
                
                const newLead = {
                    id:genId(),
                    tg,
                    phone,
                    biz,
                    source,
                    status:'new',
                    problem,
                    goal,
                    calls:0,
                    sms:0,
                    noshow:0,
                    nextDate:today(),
                    nextAction:'–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏',
                    created:new Date().toISOString(),
                    stageDate:new Date().toISOString(),
                    log:[]
                };
                saveLead(newLead); // Firebase save
                n++;
            }
            alert('–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ: '+n+(skip?' (–ø—Ä–æ–ø—É—â–µ–Ω–æ: '+skip+')':''));
        }catch(err){console.error(err);alert('–ü–æ–º–∏–ª–∫–∞: '+err.message);}
    };
    reader.readAsArrayBuffer(file);
    e.target.value='';
}

// ===== DEMO =====
async function loadDemo(){
    if(leads.length&&!confirm('–î–æ–¥–∞—Ç–∏ –¥–µ–º–æ-–¥–∞–Ω—ñ?'))return;
    const demoLeads=[
        {id:'d1',tg:'@iryna_dental',phone:'+380501234567',biz:'–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è-15',source:'mk_clinic',status:'new',calls:0,sms:0,noshow:0,nextDate:today(),nextAction:'–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏',created:addDays(today(),-2),stageDate:addDays(today(),-2),log:[]},
        {id:'d2',tg:'@petro_meble',phone:'+380672345678',biz:'–ú–µ–±–ª—ñ-25',source:'mk_prod',status:'scheduled',consult:tomorrow()+'T14:00',calls:1,sms:0,noshow:0,nextDate:today(),nextAction:'–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏',created:addDays(today(),-5),stageDate:addDays(today(),-3),log:[{type:'call',text:'–ü—Ä–∏–∑–Ω–∞—á–∏–ª–∏',date:addDays(today(),-3)}]},
        {id:'d3',tg:'@maria_cosmo',phone:'+380933456789',biz:'–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥—ñ—è-8',source:'bot',status:'scheduled',consult:addDays(today(),-1)+'T10:00',calls:2,sms:1,noshow:2,nextDate:today(),created:addDays(today(),-10),stageDate:addDays(today(),-1),log:[{type:'status',text:'–ù–µ –ø—Ä–∏–π—à–ª–∞ 2/3',date:addDays(today(),-1)}]},
        {id:'d4',tg:'@oleksandr_food',phone:'+380504567890',biz:'–•–∞—Ä—á—É–≤–∞–Ω–Ω—è-50',source:'mk_prod',status:'report_sent',calls:1,sms:1,noshow:0,reportDate:addDays(today(),-2),nextDate:today(),linkRecord:'https://youtu.be/ex',linkReport:'https://docs.google.com/ex',created:addDays(today(),-14),stageDate:addDays(today(),-2),log:[{type:'status',text:'–ó–≤—ñ—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ',date:addDays(today(),-2)}]},
        {id:'d5',tg:'@natalia_pharm',phone:'+380675678901',biz:'–ê–ø—Ç–µ–∫–∏-12',source:'ref',status:'deposit',finDep:15000,finDepCur:'UAH',finDepDate:addDays(today(),-10),finTotal:45000,finTotalCur:'UAH',nextDate:addDays(today(),-3),created:addDays(today(),-20),stageDate:addDays(today(),-10),log:[{type:'status',text:'–ó–∞–≤–¥–∞—Ç–æ–∫ 15000',date:addDays(today(),-10)}]}
    ];
    for(const lead of demoLeads){
        await saveLead(lead);
    }
    alert('–î–µ–º–æ-–¥–∞–Ω—ñ –¥–æ–¥–∞–Ω–æ!');
}

function toggleHelp(){document.getElementById('help').classList.toggle('active');}

// ===== AI ASSISTANT =====
const AI_API_URL = 'https://openai-proxy-1090643937646.europe-central2.run.app'; // –ó–∞–º—ñ–Ω–∏ –Ω–∞ —Å–≤—ñ–π URL –ø—ñ—Å–ª—è –¥–µ–ø–ª–æ—é

function toggleAI(){
    document.getElementById('ai-panel').classList.toggle('active');
    updateAILeadSelect();
}

function updateAILeadSelect(){
    const sel = document.getElementById('ai-lead-select');
    sel.innerHTML = '<option value="">‚Äî –í–∏–±–µ—Ä—ñ—Ç—å –ª—ñ–¥–∞ ‚Äî</option>' + 
        leads.map(l => `<option value="${l.id}">${l.tg||l.phone} (${l.biz||'‚Äî'})</option>`).join('');
}

function getSelectedLead(){
    const id = document.getElementById('ai-lead-select').value;
    return id ? leads.find(l => l.id === id) : null;
}

function addAIMessage(text, isUser = false){
    const chat = document.getElementById('ai-chat');
    const msg = document.createElement('div');
    msg.className = `ai-msg ${isUser ? 'ai-msg-user' : 'ai-msg-bot'}`;
    msg.innerHTML = text.replace(/\n/g, '<br>');
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    return msg;
}

function showAILoading(){
    const chat = document.getElementById('ai-chat');
    const msg = document.createElement('div');
    msg.className = 'ai-msg ai-msg-loading';
    msg.id = 'ai-loading';
    msg.innerHTML = '‚è≥ –î—É–º–∞—é...';
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function hideAILoading(){
    const el = document.getElementById('ai-loading');
    if(el) el.remove();
}

async function aiAsk(type){
    const lead = getSelectedLead();
    if(!lead && type !== 'general'){
        alert('–°–ø–æ—á–∞—Ç–∫—É –≤–∏–±–µ—Ä—ñ—Ç—å –ª—ñ–¥–∞');
        return;
    }
    
    const prompts = {
        script: `–ó–≥–µ–Ω–µ—Ä—É–π –¥–µ—Ç–∞–ª—å–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –¥–∑–≤—ñ–Ω–∫–∞ –¥–ª—è —Ü—å–æ–≥–æ –ª—ñ–¥–∞. 
–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
1. –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —è–∫ –º–∏ –ø–æ–∑–Ω–∞–π–æ–º–∏–ª–∏—Å—å)
2. –ü—Ä–∏—á–∏–Ω–∞ –¥–∑–≤—ñ–Ω–∫–∞
3. –í–∏—è–≤–ª–µ–Ω–Ω—è –±–æ–ª—é (2-3 –ø–∏—Ç–∞–Ω–Ω—è)
4. –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è —Ä—ñ—à–µ–Ω–Ω—è
5. –†–æ–±–æ—Ç–∞ –∑ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è–º–∏
6. –ó–∞–∫—Ä–∏—Ç—Ç—è –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫

–í—Ä–∞—Ö–æ–≤—É–π: —Å—Ç–∞—Ç—É—Å –ª—ñ–¥–∞, —ñ—Å—Ç–æ—Ä—ñ—é –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤, —Ä–æ–∑–º—ñ—Ä –±—ñ–∑–Ω–µ—Å—É, –¥–∂–µ—Ä–µ–ª–æ.`,

        analysis: `–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ü—å–æ–≥–æ –ª—ñ–¥–∞ –¥–µ—Ç–∞–ª—å–Ω–æ:

1. –°–ö–û–†–ò–ù–ì (0-100): –æ—Ü—ñ–Ω–∏ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –∑–∞–∫—Ä–∏—Ç—Ç—è
2. –°–ò–õ–¨–ù–Ü –°–¢–û–†–û–ù–ò: —â–æ –≥—Ä–∞—î –Ω–∞ –Ω–∞—à—É –∫–æ—Ä–∏—Å—Ç—å
3. –°–õ–ê–ë–ö–Ü –°–¢–û–†–û–ù–ò: —â–æ –º–æ–∂–µ –∑–∞–≤–∞–¥–∏—Ç–∏
4. –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–ê –°–¢–†–ê–¢–ï–ì–Ü–Ø: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –∫—Ä–æ–∫–∏
5. –û–ü–¢–ò–ú–ê–õ–¨–ù–ò–ô –ß–ê–°: –∫–æ–ª–∏ –∫—Ä–∞—â–µ –¥–∑–≤–æ–Ω–∏—Ç–∏
6. –ü–†–û–ì–ù–û–ó: —Å–∫—ñ–ª—å–∫–∏ —â–µ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –¥–æ –∑–∞–∫—Ä–∏—Ç—Ç—è

${lead.report ? '–í—Ä–∞—Ö–æ–≤—É–π –∑–≤—ñ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó: ' + lead.report : ''}`,

        objections: `–û–ø—Ä–∞—Ü—é–π –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è –¥–ª—è —Ü—å–æ–≥–æ –ª—ñ–¥–∞ —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥–æ–ª–æ–≥—ñ—é –°–ü–Ü–ù:

–°–ü–Ü–ù = –°–∏—Ç—É–∞—Ü—ñ–π–Ω—ñ ‚Üí –ü—Ä–æ–±–ª–µ–º–Ω—ñ ‚Üí –Ü–º–ø–ª—ñ–∫–∞—Ü—ñ–π–Ω—ñ ‚Üí –ù–∞–ø—Ä—è–º–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è

–î–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–æ–∂–ª–∏–≤–æ–≥–æ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è –¥–∞–π:
1. –°–∞–º–µ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è
2. –° ‚Äî –°–∏—Ç—É–∞—Ü—ñ–π–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è (—Ä–æ–∑—É–º—ñ—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç)
3. –ü ‚Äî –ü—Ä–æ–±–ª–µ–º–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è (–≤–∏—è–≤–ª—è—î–º–æ –±—ñ–ª—å)
4. –Ü ‚Äî –Ü–º–ø–ª—ñ–∫–∞—Ü—ñ–π–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è (–ø–æ–∫–∞–∑—É—î–º–æ –Ω–∞—Å–ª—ñ–¥–∫–∏)
5. –ù ‚Äî –ù–∞–ø—Ä—è–º–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è (–≤–µ–¥–µ–º–æ –¥–æ —Ä—ñ—à–µ–Ω–Ω—è)

–¢–∏–ø–æ–≤—ñ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è: –¥–æ—Ä–æ–≥–æ, –Ω–µ–º–∞—î —á–∞—Å—É, –ø–æ–¥—É–º–∞—é, –ø–æ—Ä–∞–¥—é—Å—å, –≤–∂–µ —î –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –Ω–µ –≤—ñ—Ä—é –≤ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥.

${lead.report ? '–í—Ä–∞—Ö–æ–≤—É–π –∑–≤—ñ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó: ' + lead.report : ''}
${lead.biz ? '–ë—ñ–∑–Ω–µ—Å –∫–ª—ñ—î–Ω—Ç–∞: ' + lead.biz : ''}`,

        sms: `–ù–∞–ø–∏—à–∏ 3 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ SMS –¥–ª—è —Ü—å–æ–≥–æ –ª—ñ–¥–∞ (–∫–æ–∂–µ–Ω –¥–æ 160 —Å–∏–º–≤–æ–ª—ñ–≤).

–í–∞—Ä—ñ–∞–Ω—Ç 1: –ú'—è–∫–∏–π (–Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è)
–í–∞—Ä—ñ–∞–Ω—Ç 2: –¶—ñ–Ω–Ω—ñ—Å—Ç—å (–∫–æ—Ä–∏—Å—Ç—å –≤—ñ–¥ –∑—É—Å—Ç—Ä—ñ—á—ñ)  
–í–∞—Ä—ñ–∞–Ω—Ç 3: –¢–µ—Ä–º—ñ–Ω–æ–≤—ñ—Å—Ç—å (–¥–µ–¥–ª–∞–π–Ω/–æ–±–º–µ–∂–µ–Ω–Ω—è)

–ú–µ—Ç–∞: –ø—ñ–¥—à—Ç–æ–≤—Ö–Ω—É—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É —É –≤–æ—Ä–æ–Ω—Ü—ñ.
–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ${ST[lead.status] || lead.status}`,

        report_analysis: `–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –∑–≤—ñ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó —Ç–∞ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:

–ó–í–Ü–¢: ${lead.report || '–ó–≤—ñ—Ç –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'}

–í–∏–∑–Ω–∞—á:
1. –ì–æ–ª–æ–≤–Ω–∏–π –±—ñ–ª—å –∫–ª—ñ—î–Ω—Ç–∞
2. –¢—Ä–∏–≥–µ—Ä–∏ –¥–æ –ø–æ–∫—É–ø–∫–∏
3. –ú–æ–∂–ª–∏–≤—ñ –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è
4. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è –¥–æ–∂–∏–º—É
5. –û–ø—Ç–∏–º–∞–ª—å–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è (–ø–∞–∫–µ—Ç, —Ü—ñ–Ω–∞, —É–º–æ–≤–∏)`
    };
    
    const userMsg = prompts[type] || type;
    addAIMessage(getShortPromptName(type), true);
    showAILoading();
    
    try {
        const response = await fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: userMsg }],
                lead: lead
            })
        });
        
        const data = await response.json();
        hideAILoading();
        
        if(data.success){
            addAIMessage(data.message);
        } else {
            addAIMessage('–ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch(err){
        hideAILoading();
        addAIMessage('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + err.message);
    }
}

function getShortPromptName(type){
    const names = {
        script: '–ó–≥–µ–Ω–µ—Ä—É–π —Å–∫—Ä–∏–ø—Ç –¥–∑–≤—ñ–Ω–∫–∞',
        analysis: '–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –ª—ñ–¥–∞',
        objections: '–û–ø—Ä–∞—Ü—é–π –∑–∞–ø–µ—Ä–µ—á–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –°–ü–Ü–ù',
        sms: '–ù–∞–ø–∏—à–∏ SMS –≤–∞—Ä—ñ–∞–Ω—Ç–∏',
        report_analysis: '–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –∑–≤—ñ—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó'
    };
    return names[type] || type;
}

async function aiSend(){
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if(!text) return;
    
    input.value = '';
    addAIMessage(text, true);
    showAILoading();
    
    try {
        const lead = getSelectedLead();
        const response = await fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: text }],
                lead: lead
            })
        });
        
        const data = await response.json();
        hideAILoading();
        
        if(data.success){
            addAIMessage(data.message);
        } else {
            addAIMessage('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch(err){
        hideAILoading();
        addAIMessage('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è: ' + err.message);
    }
}

// Init report dates on load
initReportDates();

// ===== STATUS DROPDOWN =====
let activeDropdown = null;

function toggleStatusDropdown(leadId, btn) {
    const dropdown = document.getElementById(`status-dropdown-${leadId}`);
    
    // –ó–∞–∫—Ä–∏—Ç–∏ —ñ–Ω—à—ñ dropdown
    document.querySelectorAll('.task-status-dropdown.active').forEach(d => {
        if(d !== dropdown) d.classList.remove('active');
    });
    
    dropdown.classList.toggle('active');
    activeDropdown = dropdown.classList.contains('active') ? dropdown : null;
}

function changeLeadStatus(leadId, newStatus) {
    const l = leads.find(x => x.id === leadId);
    if(!l) return;
    
    const updatedLead = {...l};
    const oldStatus = updatedLead.status;
    updatedLead.status = newStatus;
    updatedLead.stageDate = new Date().toISOString();
    
    // –õ–æ–≥—ñ–∫–∞ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å—ñ–≤
    if(newStatus === 'scheduled' && !updatedLead.consult) {
        const dt = prompt('–î–∞—Ç–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó (YYYY-MM-DDTHH:MM):', tomorrow() + 'T14:00');
        if(dt) {
            updatedLead.consult = dt;
            updatedLead.nextDate = addDays(dt.split('T')[0], -1);
            updatedLead.nextTime = '10:00';
            updatedLead.nextAction = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
        }
    }
    
    if(newStatus === 'failed') {
        const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏:', '');
        updatedLead.failReason = reason || '';
        updatedLead.reactDate = addDays(today(), 90);
    }
    
    if(newStatus === 'deposit') {
        const amt = prompt('–°—É–º–∞ –∑–∞–≤–¥–∞—Ç–∫—É:', '');
        if(amt) {
            updatedLead.finDep = +amt;
            updatedLead.finDepDate = today();
        }
    }
    
    if(newStatus === 'paid') {
        const amt = prompt('–ü–æ–≤–Ω–∞ —Å—É–º–∞:', updatedLead.finTotal || '');
        if(amt) {
            updatedLead.finTotal = +amt;
            updatedLead.finPaidDate = today();
        }
    }
    
    addLog(updatedLead, 'status', `${ST[oldStatus] || '–ù–æ–≤–∏–π'} ‚Üí ${ST[newStatus]}`);
    saveLead(updatedLead);
    
    // –ó–∞–∫—Ä–∏—Ç–∏ dropdown
    if(activeDropdown) {
        activeDropdown.classList.remove('active');
        activeDropdown = null;
    }
}

// –ó–∞–∫—Ä–∏—Ç–∏ dropdown –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.addEventListener('click', (e) => {
    if(activeDropdown && !e.target.closest('.task-status-wrap')) {
        activeDropdown.classList.remove('active');
        activeDropdown = null;
    }
});

// ===== QUICK ACTION PANEL =====
let quickLeadId = null;
let quickState = {
    outcome: null,
    time: null,
    action: null,
    note: ''
};

// Messenger links
function getTelegramLink(username) {
    if(!username) return null;
    const clean = username.replace('@', '').trim();
    return `https://t.me/${clean}`;
}

function getViberLink(phone) {
    if(!phone) return null;
    const clean = phone.replace(/\D/g, '');
    return `viber://chat?number=%2B${clean}`;
}

function getWhatsAppLink(phone) {
    if(!phone) return null;
    const clean = phone.replace(/\D/g, '');
    return `https://wa.me/${clean}`;
}

function getPhoneLink(phone) {
    if(!phone) return null;
    const clean = phone.replace(/\D/g, '');
    return `tel:+${clean}`;
}

function getEmailLink(email) {
    if(!email) return null;
    return `mailto:${email}`;
}

// Render primary contact based on primaryChannel setting
function renderPrimaryContact(l) {
    let channel = l.primaryChannel || 'phone';
    
    // Channel icons (SVG)
    const icons = {
        tg: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`,
        phone: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
        viber: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M11.398.002C9.473.028 5.331.344 3.014 2.467 1.294 4.182.518 6.792.377 10.967c-.14 4.175-.324 12.001 7.326 14.127h.006l-.006 3.09s-.048.757.47 1.076c.626.386 1.04.169 1.665-.437.345-.334 1.056-1.09 1.497-1.556 4.13.36 7.3-.453 7.657-.562.821-.254 5.469-.863 6.223-7.049.777-6.379-.389-10.413-2.566-12.24-1.276-1.136-6.397-2.81-11.25-3.414z"/></svg>`,
        whatsapp: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>`,
        email: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`
    };
    
    const classes = {
        tg: 'tg',
        phone: 'phone',
        viber: 'viber',
        whatsapp: 'whatsapp',
        email: 'email'
    };
    
    // Get contact value and link based on channel
    let value, link, displayValue;
    
    switch(channel) {
        case 'tg':
            value = l.tg;
            link = getTelegramLink(l.tg);
            displayValue = l.tg;
            break;
        case 'viber':
            value = l.viber || l.phone;
            link = getViberLink(l.viber || l.phone);
            displayValue = l.viber || l.phone;
            break;
        case 'whatsapp':
            value = l.whatsapp || l.phone;
            link = getWhatsAppLink(l.whatsapp || l.phone);
            displayValue = l.whatsapp || l.phone;
            break;
        case 'email':
            value = l.email;
            link = getEmailLink(l.email);
            displayValue = l.email;
            break;
        default: // phone
            value = l.phone;
            link = getPhoneLink(l.phone);
            displayValue = l.phone;
    }
    
    // Fallback to any available contact
    if(!value) {
        if(l.tg) { value = l.tg; link = getTelegramLink(l.tg); displayValue = l.tg; channel = 'tg'; }
        else if(l.phone) { value = l.phone; link = getPhoneLink(l.phone); displayValue = l.phone; channel = 'phone'; }
        else if(l.email) { value = l.email; link = getEmailLink(l.email); displayValue = l.email; channel = 'email'; }
        else return '<span class="task-contact-link">‚Äî</span>';
    }
    
    return `<a href="${link}" target="_blank" class="task-contact-link ${classes[channel]}" onclick="event.stopPropagation()" title="${channel.toUpperCase()}">
        ${icons[channel]}
        ${displayValue}
    </a>`;
}

function renderContactLinks(lead) {
    let html = '';
    
    // Telegram
    if(lead.tg) {
        const link = getTelegramLink(lead.tg);
        html += `<a href="${link}" target="_blank" class="contact-link tg" onclick="event.stopPropagation()" title="–í—ñ–¥–∫—Ä–∏—Ç–∏ Telegram">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
            ${lead.tg}
        </a>`;
    }
    
    // Phone with options
    if(lead.phone) {
        const phoneClean = lead.phone.replace(/\D/g, '');
        html += `<div class="contact-phone-group" onclick="event.stopPropagation()">
            <a href="${getPhoneLink(lead.phone)}" class="contact-link phone" title="–ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                ${lead.phone}
            </a>
            <div class="contact-messengers">
                <a href="${getWhatsAppLink(lead.phone)}" target="_blank" class="messenger-btn wa" title="WhatsApp">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </a>
                <a href="${getViberLink(lead.phone)}" target="_blank" class="messenger-btn viber" title="Viber">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.398.002C9.473.028 5.331.344 3.014 2.467 1.294 4.182.518 6.792.377 10.967c-.14 4.175-.324 12.001 7.326 14.127h.006l-.006 3.09s-.048.757.47 1.076c.626.386 1.04.169 1.665-.437.345-.334 1.056-1.09 1.497-1.556 4.13.36 7.3-.453 7.657-.562.821-.254 5.469-.863 6.223-7.049.777-6.379-.389-10.413-2.566-12.24-1.276-1.136-6.397-2.81-11.25-3.414zm.175 1.843c4.44.536 8.856 1.866 9.863 2.715 1.73 1.456 2.752 5.072 2.092 10.485-.606 5.033-4.178 5.473-4.883 5.69-.296.09-3.054.787-6.573.554 0 0-2.602 3.144-3.413 3.96-.126.126-.277.178-.376.152-.14-.035-.179-.2-.177-.44l.02-4.294c-6.277-1.655-5.902-8.037-5.79-11.39.112-3.353.702-5.523 2.076-6.882 1.755-1.67 5.261-2.45 7.16-2.55zm.083 2.842c-.186.012-.186.286 0 .299 1.478.084 2.802.567 3.827 1.481 1.026.915 1.639 2.203 1.77 3.736.016.185.282.195.299 0 .07-1.655-.656-3.1-1.793-4.11-1.138-1.012-2.676-1.47-4.103-1.406zm-2.46.652c-.202-.002-.39.086-.56.235L7.7 6.468c-.246.222-.337.542-.396.85-.058.31-.069.653.017 1.048.168.784.637 1.85 1.609 3.19.972 1.341 2.327 2.853 4.312 4.148 1.095.683 1.9.963 2.606 1.076.353.057.68.066.996.003.316-.064.626-.2.864-.425.162-.152.347-.428.537-.722.19-.294.387-.619.457-.783.136-.313.098-.601-.089-.82-.185-.216-.49-.356-.756-.46l-1.435-.554c-.258-.1-.622-.166-.926.103l-.742.657c-.143.126-.39.115-.39.115s-1.655-.394-2.791-1.658c-1.135-1.264-1.413-2.92-1.413-2.92s-.022-.241.105-.378l.604-.784c.23-.322.151-.67.066-.929l-.515-1.532c-.093-.277-.222-.588-.437-.776a.857.857 0 00-.556-.216zm2.754 1.018c-.189-.011-.2.282 0 .297a3.48 3.48 0 012.403 1.12 3.479 3.479 0 01.882 2.507c.001.185.273.2.295 0 .105-1.04-.215-2.053-.893-2.8-.678-.748-1.635-1.147-2.687-1.124zm.287 1.474c-.192-.015-.21.267 0 .293.66.082 1.2.6 1.268 1.336.017.185.285.186.296 0 .004-.465-.17-.879-.483-1.185-.313-.307-.718-.438-1.08-.444z"/></svg>
                </a>
            </div>
        </div>`;
    }
    
    return html || '<span class="no-contact">–ù–µ–º–∞—î –∫–æ–Ω—Ç–∞–∫—Ç—É</span>';
}

function openQuickPanel(id) {
    const l = leads.find(x => x.id === id);
    if(!l) return;
    
    quickLeadId = id;
    quickState = { outcome: null, time: null, action: null, note: '' };
    
    // Fill lead info
    document.getElementById('quick-lead-name').textContent = l.tg || l.phone || '‚Äî';
    document.getElementById('quick-lead-biz').textContent = l.biz || '‚Äî';
    document.getElementById('quick-lead-contacts').innerHTML = renderContactLinks(l);
    document.getElementById('quick-lead-task').textContent = '–ó–∞–≤–¥–∞–Ω–Ω—è: ' + (l.nextAction || '–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏');
    
    // Reset sections
    document.getElementById('quick-outcome-section').style.display = 'block';
    document.getElementById('quick-next-section').style.display = 'none';
    document.getElementById('quick-action-section').style.display = 'none';
    document.getElementById('quick-final-section').style.display = 'none';
    document.getElementById('quick-confirm-btn').style.display = 'none';
    document.getElementById('quick-note').value = '';
    
    // Clear selections
    document.querySelectorAll('.quick-btn.selected, .time-btn.selected').forEach(b => b.classList.remove('selected'));
    
    // Show panel
    document.getElementById('quick-panel').classList.add('active');
    document.querySelector('.quick-panel-overlay').classList.add('active');
}

function closeQuickPanel() {
    document.getElementById('quick-panel').classList.remove('active');
    document.querySelector('.quick-panel-overlay').classList.remove('active');
    quickLeadId = null;
}

function setQuickOutcome(outcome) {
    quickState.outcome = outcome;
    
    // Highlight selected
    document.querySelectorAll('#quick-outcome-buttons .quick-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.quick-btn').classList.add('selected');
    
    // Show next section based on outcome
    if(outcome === 'answered') {
        // –í–∑—è–≤ - –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω—ñ –¥—ñ—ó + —á–∞—Å
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'block';
        document.getElementById('quick-action-section').style.display = 'none';
    } else if(outcome === 'no_answer' || outcome === 'callback') {
        // –ù–µ –≤–∑—è–≤ / –ü–µ—Ä–µ–¥–∑–≤–æ–Ω–∏—Ç—å - –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —á–∞—Å
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'none';
        document.getElementById('quick-action-section').style.display = 'none';
        quickState.action = outcome === 'callback' ? '–ß–µ–∫–∞—é –¥–∑–≤—ñ–Ω–æ–∫' : '–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏';
    } else if(outcome === 'sms') {
        // SMS - –ø–æ–∫–∞–∑—É—î–º–æ —á–∞—Å
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'none';
        document.getElementById('quick-action-section').style.display = 'none';
        quickState.action = '–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏ (–ø—ñ—Å–ª—è SMS)';
    }
    
    // Scroll to next section
    setTimeout(() => {
        document.getElementById('quick-next-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function setQuickTime(time) {
    quickState.time = time;
    
    // Highlight selected
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.time-btn').classList.add('selected');
    
    // Show action section if answered
    if(quickState.outcome === 'answered') {
        document.getElementById('quick-action-section').style.display = 'block';
        setTimeout(() => {
            document.getElementById('quick-action-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    } else {
        // For no_answer/sms/callback - show confirm button directly
        document.getElementById('quick-confirm-btn').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('quick-confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function setQuickAction(action) {
    quickState.action = action;
    
    // Highlight selected
    document.querySelectorAll('#quick-action-buttons .quick-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.quick-btn').classList.add('selected');
    
    // Show confirm button
    document.getElementById('quick-confirm-btn').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('quick-confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function setQuickFinal(finalAction) {
    const l = leads.find(x => x.id === quickLeadId);
    if(!l) return;
    
    const updatedLead = {...l};
    
    if(finalAction === 'scheduled') {
        const dt = prompt('–î–∞—Ç–∞ —ñ —á–∞—Å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó:', tomorrow() + 'T14:00');
        if(!dt) return;
        updatedLead.status = 'scheduled';
        updatedLead.consult = dt;
        updatedLead.noshow = 0;
        updatedLead.nextDate = addDays(dt.split('T')[0], -1);
        updatedLead.nextTime = '10:00';
        updatedLead.nextAction = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é';
        addLog(updatedLead, 'status', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ ' + fmtDT(dt));
    } else if(finalAction === 'completed') {
        updatedLead.status = 'completed';
        updatedLead.calls = 0;
        updatedLead.sms = 0;
        updatedLead.nextDate = today();
        updatedLead.nextTime = '10:00';
        updatedLead.nextAction = '–ù–∞–ø–∏—Å–∞—Ç–∏ –∑–≤—ñ—Ç';
        addLog(updatedLead, 'status', '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞');
    } else if(finalAction === 'failed') {
        const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –≤—ñ–¥–º–æ–≤–∏:', '');
        updatedLead.status = 'failed';
        updatedLead.failReason = reason || '';
        updatedLead.reactDate = addDays(today(), 90);
        addLog(updatedLead, 'status', '–í—ñ–¥–º–æ–≤–∞: ' + (reason || '–Ω–µ –≤–∫–∞–∑–∞–Ω–æ'));
    }
    
    saveLead(updatedLead);
    closeQuickPanel();
}

function confirmQuickAction() {
    const l = leads.find(x => x.id === quickLeadId);
    if(!l) return;
    
    const updatedLead = {...l};
    const note = document.getElementById('quick-note').value.trim();
    
    // Calculate next date/time
    const nextDateTime = calculateNextDateTime(quickState.time);
    updatedLead.nextDate = nextDateTime.date;
    updatedLead.nextTime = nextDateTime.time;
    updatedLead.nextAction = quickState.action || '–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏';
    
    // Update counters based on outcome
    if(quickState.outcome === 'no_answer') {
        updatedLead.calls = (updatedLead.calls || 0) + 1;
        addLog(updatedLead, 'call', '–ù–µ –≤–∑—è–≤ —Ç—Ä—É–±–∫—É' + (note ? ': ' + note : ''));
    } else if(quickState.outcome === 'sms') {
        updatedLead.sms = (updatedLead.sms || 0) + 1;
        addLog(updatedLead, 'sms', 'SMS –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ' + (note ? ': ' + note : ''));
    } else if(quickState.outcome === 'callback') {
        addLog(updatedLead, 'call', '–ß–µ–∫–∞—é –¥–∑–≤—ñ–Ω–æ–∫' + (note ? ': ' + note : ''));
    } else if(quickState.outcome === 'answered') {
        updatedLead.calls = (updatedLead.calls || 0) + 1;
        addLog(updatedLead, 'call', '–†–æ–∑–º–æ–≤–∞: ' + (quickState.action || '') + (note ? ' | ' + note : ''));
    }
    
    // Add notes if provided
    if(note && !quickState.outcome) {
        updatedLead.notes = ((updatedLead.notes || '') + '\n' + note).trim();
    }
    
    saveLead(updatedLead);
    closeQuickPanel();
}

function calculateNextDateTime(timeCode) {
    const now = new Date();
    let targetDate = new Date();
    let targetTime = '10:00';
    
    switch(timeCode) {
        case '30m':
            targetDate.setMinutes(targetDate.getMinutes() + 30);
            targetTime = targetDate.getHours().toString().padStart(2,'0') + ':' + 
                         Math.round(targetDate.getMinutes()/5)*5 .toString().padStart(2,'0');
            break;
        case '2h':
            targetDate.setHours(targetDate.getHours() + 2);
            targetTime = targetDate.getHours().toString().padStart(2,'0') + ':00';
            break;
        case 'tomorrow_10':
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '10:00';
            break;
        case 'tomorrow_14':
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '14:00';
            break;
        case '2d':
            targetDate.setDate(targetDate.getDate() + 2);
            targetTime = '10:00';
            break;
        case 'week':
            targetDate.setDate(targetDate.getDate() + 7);
            targetTime = '10:00';
            break;
        default:
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '10:00';
    }
    
    return {
        date: targetDate.toISOString().split('T')[0],
        time: targetTime
    };
}
</script>
</body>
</html>

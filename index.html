<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALKO CRM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322c55e' rx='20' width='100' height='100'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>T</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:#22c55e;--pd:#16a34a;--pl:#f0fdf4;--r:#ef4444;--rl:#fef2f2;--o:#f97316;--ol:#fff7ed;--b:#3b82f6;--bl:#eff6ff;--g:#6b7280;--gl:#f3f4f6;--t:#1a1a1a;--ts:#525252;--bg:#f9fafb;--w:#fff}
        body{font-family:Inter,-apple-system,sans-serif;background:var(--bg);color:var(--t);min-height:100vh}
        
        /* Auth Screen - Premium */
        .auth-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%)}
        .auth-container{text-align:center;width:100%;max-width:500px}
        .auth-logo-wrap{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:48px}
        .auth-logo-icon{width:48px;height:48px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px;display:flex;align-items:center;justify-content:center}
        .auth-logo-icon svg{width:28px;height:28px;color:#fff}
        .auth-logo-text{font-size:24px;font-weight:700;color:#fff}
        .auth-headline{font-size:42px;font-weight:700;line-height:1.2;margin-bottom:24px}
        .auth-headline .green{color:#22c55e}
        .auth-headline .white{color:#fff}
        .auth-subtitle{font-size:18px;color:#94a3b8;line-height:1.6;margin-bottom:16px}
        .auth-tagline{font-size:16px;color:#e2e8f0;margin-bottom:48px}
        .auth-buttons{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-bottom:48px}
        .auth-btn-primary{padding:16px 32px;background:#22c55e;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s}
        .auth-btn-primary:hover{background:#16a34a;transform:translateY(-2px)}
        .auth-btn-secondary{padding:16px 32px;background:transparent;color:#fff;border:1px solid #475569;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s}
        .auth-btn-secondary:hover{border-color:#22c55e;background:rgba(34,197,94,.1)}
        .auth-features{display:flex;gap:32px;justify-content:center;flex-wrap:wrap;margin-bottom:48px}
        .auth-feature{display:flex;align-items:center;gap:8px;color:#94a3b8;font-size:14px}
        .auth-feature svg{color:#22c55e}
        
        /* Auth Modal */
        .auth-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px}
        .auth-modal.active{display:flex}
        .auth-box{background:#1e293b;padding:40px;border-radius:20px;width:100%;max-width:400px;border:1px solid #334155}
        .auth-box-title{font-size:24px;font-weight:700;color:#fff;text-align:center;margin-bottom:8px}
        .auth-box-subtitle{text-align:center;color:#94a3b8;margin-bottom:32px;font-size:14px}
        .auth-input{width:100%;padding:14px 16px;background:#0f172a;border:1px solid #334155;border-radius:10px;font-size:15px;color:#fff;margin-bottom:12px}
        .auth-input::placeholder{color:#64748b}
        .auth-input:focus{outline:none;border-color:#22c55e}
        .auth-submit{width:100%;padding:14px;background:#22c55e;color:#fff;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-top:8px}
        .auth-submit:hover{background:#16a34a}
        .auth-submit:disabled{background:#475569;cursor:not-allowed}
        .auth-error{background:rgba(239,68,68,.2);color:#f87171;padding:12px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none;border:1px solid rgba(239,68,68,.3)}
        .auth-switch{text-align:center;margin-top:24px;font-size:14px;color:#94a3b8}
        .auth-switch a{color:#22c55e;cursor:pointer;text-decoration:none;font-weight:500}
        .auth-switch a:hover{text-decoration:underline}
        .auth-close{position:absolute;top:20px;right:20px;background:none;border:none;color:#64748b;cursor:pointer;font-size:24px}
        .auth-close:hover{color:#fff}
        .spinner{width:40px;height:40px;border:3px solid var(--gl);border-top-color:var(--p);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* User menu */
        .user-menu{display:flex;align-items:center;gap:8px}
        .user-email{font-size:12px;color:var(--g);max-width:150px;overflow:hidden;text-overflow:ellipsis}
        .user-btn{padding:6px 10px;font-size:12px}
        
        /* Admin Panel */
        .admin-panel{display:flex;align-items:center;gap:8px;padding-right:12px;margin-right:12px;border-right:1px solid #e5e7eb}
        .admin-badge{background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;letter-spacing:0.5px}
        .org-dropdown{position:absolute;top:100%;left:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.15);min-width:280px;z-index:200;margin-top:4px;overflow:hidden}
        .org-dropdown-item{display:flex;align-items:center;gap:10px;padding:12px 14px;width:100%;border:none;background:none;font-size:13px;color:#374151;cursor:pointer;text-align:left}
        .org-dropdown-item:hover{background:#f3f4f6}
        .org-dropdown-item.active{background:#f0fdf4;color:#16a34a}
        .org-dropdown-item.active span{font-weight:600}
        .org-dropdown-item.create{color:#22c55e;font-weight:500;border-top:1px solid #e5e7eb}
        .org-dropdown-item.create:hover{background:#f0fdf4}
        .org-dropdown-divider{height:1px;background:#e5e7eb;margin:0}
        .org-item-count{margin-left:auto;background:#e5e7eb;color:#6b7280;font-size:11px;padding:2px 6px;border-radius:10px;flex-shrink:0}
        #org-selector-btn{position:relative}
        
        /* Team Modal */
        .team-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:300;align-items:center;justify-content:center;padding:20px}
        .team-modal.active{display:flex}
        .team-modal-content{background:#fff;border-radius:16px;width:100%;max-width:500px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}
        .team-modal-header{padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .team-modal-title{font-size:18px;font-weight:600}
        .team-modal-body{padding:20px;overflow-y:auto;flex:1}
        .team-member{display:flex;align-items:center;gap:12px;padding:12px;background:#f9fafb;border-radius:10px;margin-bottom:8px}
        .team-member-avatar{width:40px;height:40px;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:600}
        .team-member-info{flex:1;min-width:0}
        .team-member-email{font-size:14px;font-weight:500;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .team-member-role{font-size:12px;font-weight:500}
        .team-invite-section{margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb}
        .team-invite-title{font-size:14px;font-weight:600;margin-bottom:12px;color:#374151}
        .team-invite-btns{display:flex;gap:8px;flex-wrap:wrap}
        
        /* Settings Panel - Google style slide-in */
        .settings-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:400}
        .settings-overlay.active{display:block}
        .settings-panel{position:fixed;top:0;right:-420px;width:400px;max-width:100vw;height:100vh;background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,0.15);z-index:401;transition:right 0.3s ease;display:flex;flex-direction:column}
        .settings-panel.active{right:0}
        .settings-header{padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .settings-title{font-size:18px;font-weight:600;color:#1f2937}
        .settings-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .settings-close:hover{background:#e5e7eb}
        .settings-body{flex:1;overflow-y:auto;padding:20px}
        .settings-section{margin-bottom:24px}
        .settings-section-title{font-size:14px;font-weight:600;color:#374151;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .settings-section-title svg{width:18px;height:18px;color:#6b7280}
        
        /* Status Editor */
        .status-list{display:flex;flex-direction:column;gap:8px}
        .status-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f9fafb;border-radius:10px;cursor:grab}
        .status-item:active{cursor:grabbing}
        .status-item.dragging{opacity:0.5;background:#e5e7eb}
        .status-color{width:24px;height:24px;border-radius:6px;flex-shrink:0;cursor:pointer;border:2px solid rgba(0,0,0,0.1)}
        .status-name{flex:1;font-size:14px;font-weight:500;color:#1f2937}
        .status-name input{width:100%;border:none;background:transparent;font-size:14px;font-weight:500;color:#1f2937;outline:none}
        .status-actions{display:flex;gap:4px}
        .status-action-btn{width:28px;height:28px;border:none;background:transparent;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#9ca3af}
        .status-action-btn:hover{background:#e5e7eb;color:#374151}
        .status-action-btn.delete:hover{background:#fef2f2;color:#ef4444}
        .status-add-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;border:2px dashed #d1d5db;border-radius:10px;background:transparent;color:#6b7280;font-size:14px;font-weight:500;cursor:pointer;margin-top:12px;width:100%}
        .status-add-btn:hover{border-color:#22c55e;color:#22c55e;background:#f0fdf4}
        
        /* Funnel List */
        .funnel-list{display:flex;flex-direction:column;gap:6px}
        .funnel-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#f9fafb;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
        .funnel-item:hover{background:#f3f4f6}
        .funnel-item.active{background:#f0fdf4;border-color:#22c55e}
        .funnel-item-icon{width:32px;height:32px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:8px;display:flex;align-items:center;justify-content:center}
        .funnel-item-icon svg{width:18px;height:18px;color:#fff}
        .funnel-item-info{flex:1;min-width:0}
        .funnel-item-name{font-size:14px;font-weight:600;color:#1f2937}
        .funnel-item-meta{font-size:12px;color:#6b7280;display:flex;gap:12px;margin-top:2px}
        .funnel-item-actions{display:flex;gap:4px}
        .funnel-default-badge{font-size:10px;background:#dbeafe;color:#1d4ed8;padding:2px 6px;border-radius:4px;font-weight:500}
        
        /* Assignment Modes */
        
        /* Sources Editor */
        .source-list{display:flex;flex-direction:column;gap:6px}
        .source-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f9fafb;border-radius:10px}
        .source-code{font-family:monospace;font-size:12px;color:#6b7280;background:#e5e7eb;padding:2px 6px;border-radius:4px;min-width:80px}
        .source-name{flex:1}
        .source-name input{width:100%;border:none;background:transparent;font-size:14px;font-weight:500;color:#1f2937;outline:none}
        .source-actions{display:flex;gap:4px}
        .assignment-modes{display:flex;flex-direction:column;gap:8px}
        .assignment-mode{display:flex;align-items:flex-start;gap:12px;padding:14px;background:#f9fafb;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
        .assignment-mode:hover{background:#f3f4f6}
        .assignment-mode:has(input:checked){background:#f0fdf4;border-color:#22c55e}
        .assignment-mode input{margin-top:2px;accent-color:#22c55e}
        .assignment-mode-content{flex:1}
        .assignment-mode-title{font-size:14px;font-weight:600;color:#1f2937}
        .assignment-mode-desc{font-size:12px;color:#6b7280;margin-top:2px}
        
        /* Round-robin Queue */
        .rr-queue-section{margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb}
        .rr-queue-title{font-size:13px;font-weight:600;color:#374151;margin-bottom:10px}
        .rr-queue-list{display:flex;flex-direction:column;gap:6px}
        .rr-queue-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f9fafb;border-radius:8px}
        .rr-queue-item.current{background:#f0fdf4;border:1px solid #22c55e}
        .rr-queue-avatar{width:32px;height:32px;background:#e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;color:#374151}
        .rr-queue-info{flex:1}
        .rr-queue-name{font-size:13px;font-weight:500;color:#1f2937}
        .rr-queue-count{font-size:11px;color:#6b7280}
        .rr-queue-toggle{width:20px;height:20px;border:none;background:transparent;cursor:pointer;color:#9ca3af}
        .rr-queue-toggle:hover{color:#374151}
        .rr-queue-toggle.active{color:#22c55e}
        
        /* Funnel Selector in Header */
        .funnel-selector{position:relative}
        .funnel-selector-btn{display:flex;align-items:center;gap:8px;padding:8px 14px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:500;color:#374151;cursor:pointer;min-width:160px}
        .funnel-selector-btn:hover{background:#f9fafb;border-color:#d1d5db}
        .funnel-selector-btn svg{width:16px;height:16px;flex-shrink:0}
        .funnel-selector-btn svg:last-child{margin-left:auto;width:12px;height:12px;color:#9ca3af}
        .funnel-selector-btn span{flex:1;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .funnel-dropdown{position:absolute;top:100%;left:0;margin-top:4px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.15);min-width:220px;z-index:200;display:none}
        .funnel-dropdown.active{display:block}
        .funnel-dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;font-size:13px;color:#374151}
        .funnel-dropdown-item:hover{background:#f3f4f6}
        .funnel-dropdown-item.active{background:#f0fdf4;color:#16a34a;font-weight:500}
        .funnel-dropdown-item svg{width:16px;height:16px;flex-shrink:0}
        .funnel-dropdown-divider{height:1px;background:#e5e7eb;margin:4px 0}
        
        /* Assignee in Cards */
        .assignee-badge{display:flex;align-items:center;gap:4px;font-size:11px;color:#6b7280}
        .assignee-avatar{width:18px;height:18px;background:#e5e7eb;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:#374151}
        
        /* Color Picker */
        .color-picker-popup{position:absolute;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);padding:12px;z-index:500;display:none}
        .color-picker-popup.active{display:block}
        .color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
        .color-option{width:28px;height:28px;border-radius:6px;cursor:pointer;border:2px solid transparent}
        .color-option:hover{transform:scale(1.1)}
        .color-option.selected{border-color:#1f2937}
        
        /* Reports - Premium Dashboard Design */
        .reports-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;flex-wrap:wrap;gap:16px}
        .reports-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .reports-period-btns{display:flex;background:linear-gradient(135deg,#f8fafc,#f1f5f9);border-radius:12px;padding:4px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.06)}
        .period-btn{padding:10px 20px;border:none;background:transparent;font-size:13px;font-weight:600;color:#64748b;cursor:pointer;border-radius:10px;transition:all .25s}
        .period-btn:hover{color:#334155}
        .period-btn.active{background:#fff;color:#22c55e;box-shadow:0 2px 8px rgba(34,197,94,0.15),0 1px 3px rgba(0,0,0,0.08)}
        .reports-dates{display:flex;align-items:center;gap:8px}
        .reports-dates input{width:140px;padding:10px 14px;border:1px solid #e2e8f0;border-radius:10px;font-size:13px;background:#fff;transition:all .2s}
        .reports-dates input:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
        
        /* Summary Cards - Glass Morphism */
        .reports-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px}
        .summary-card{background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);border-radius:16px;padding:24px;border:1px solid rgba(226,232,240,0.8);position:relative;overflow:hidden;transition:all .3s}
        .summary-card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.08)}
        .summary-card::before{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(34,197,94,0.08) 0%,transparent 70%);pointer-events:none}
        .summary-card-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px}
        .summary-card-icon svg{width:24px;height:24px}
        .summary-card-icon.green{background:linear-gradient(135deg,#dcfce7,#bbf7d0);color:#16a34a}
        .summary-card-icon.blue{background:linear-gradient(135deg,#dbeafe,#bfdbfe);color:#2563eb}
        .summary-card-icon.purple{background:linear-gradient(135deg,#f3e8ff,#e9d5ff);color:#9333ea}
        .summary-card-icon.orange{background:linear-gradient(135deg,#ffedd5,#fed7aa);color:#ea580c}
        .summary-card-label{font-size:13px;color:#64748b;margin-bottom:8px;font-weight:500}
        .summary-card-value{font-size:32px;font-weight:800;color:#0f172a;letter-spacing:-0.02em}
        .summary-card-change{font-size:12px;margin-top:8px;display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-weight:600}
        .summary-card-change.up{background:#dcfce7;color:#16a34a}
        .summary-card-change.down{background:#fee2e2;color:#dc2626}
        .summary-card-change.neutral{background:#f1f5f9;color:#64748b}
        
        /* Analytics Grid - Modern Cards */
        .analytics-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin-bottom:32px}
        @media(max-width:1024px){.analytics-grid{grid-template-columns:1fr}}
        .chart-card{background:#fff;border-radius:20px;padding:28px;border:1px solid #e2e8f0;box-shadow:0 1px 3px rgba(0,0,0,0.04);transition:all .3s}
        .chart-card:hover{box-shadow:0 8px 30px rgba(0,0,0,0.08)}
        .chart-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px}
        .chart-card-title{font-size:16px;font-weight:700;color:#0f172a;margin-bottom:4px}
        .chart-card-subtitle{font-size:13px;color:#64748b}
        .chart-card-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;background:#f0fdf4;color:#16a34a}
        .chart-container{height:220px;position:relative}
        
        /* Bar Chart - Premium */
        .chart-bar-group{display:flex;align-items:flex-end;gap:6px;height:100%;padding:0 4px 32px}
        .chart-bar{flex:1;background:linear-gradient(180deg,#22c55e 0%,#16a34a 100%);border-radius:6px 6px 0 0;min-height:4px;position:relative;transition:all .3s ease;cursor:pointer}
        .chart-bar:hover{filter:brightness(1.1);transform:scaleY(1.02);transform-origin:bottom}
        .chart-bar-label{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:10px;color:#94a3b8;white-space:nowrap;font-weight:500}
        .chart-bar-value{position:absolute;top:-22px;left:50%;transform:translateX(-50%);font-size:11px;font-weight:700;color:#0f172a;opacity:0;transition:opacity .2s}
        .chart-bar:hover .chart-bar-value{opacity:1}
        .chart-bar.revenue{background:linear-gradient(180deg,#3b82f6 0%,#2563eb 100%)}
        
        /* Conversion Funnel - Modern */
        .conversion-funnel{display:flex;flex-direction:column;gap:12px;height:100%;justify-content:center}
        .conversion-step{display:flex;align-items:center;gap:16px}
        .conversion-label{min-width:110px;font-size:13px;color:#475569;font-weight:500}
        .conversion-bar{flex:1;height:40px;background:#f1f5f9;border-radius:10px;overflow:hidden;position:relative}
        .conversion-fill{height:100%;border-radius:10px;display:flex;align-items:center;padding:0 16px;font-size:14px;font-weight:700;color:#fff;transition:width .6s cubic-bezier(0.4,0,0.2,1);min-width:fit-content}
        .conversion-percent{min-width:55px;text-align:right;font-size:14px;font-weight:700;color:#0f172a}
        .conversion-arrow{color:#94a3b8;font-size:11px;padding-left:126px;display:flex;align-items:center;gap:6px}
        .conversion-arrow svg{width:14px;height:14px}
        
        /* Donut Chart - Premium */
        .donut-chart-wrap{display:flex;gap:24px;height:100%;align-items:center}
        .donut-chart{width:160px;height:160px;position:relative;flex-shrink:0}
        .donut-chart svg{width:100%;height:100%;transform:rotate(-90deg)}
        .donut-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .donut-center-value{font-size:28px;font-weight:800;color:#0f172a}
        .donut-center-label{font-size:12px;color:#64748b;font-weight:500}
        .donut-legend{flex:1;display:flex;flex-direction:column;gap:12px;justify-content:center}
        .donut-legend-item{display:flex;align-items:center;gap:12px}
        .donut-legend-dot{width:14px;height:14px;border-radius:4px;flex-shrink:0}
        .donut-legend-label{flex:1;font-size:13px;color:#475569}
        .donut-legend-value{font-size:14px;font-weight:700;color:#0f172a}
        .donut-legend-pct{font-size:12px;color:#94a3b8;min-width:40px;text-align:right}
        
        /* Table - Clean Modern */
        .reports-table-wrap{background:#fff;border-radius:20px;border:1px solid #e2e8f0;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
        .reports-section-title{padding:20px 24px;font-size:16px;font-weight:700;color:#0f172a;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:10px}
        .reports-section-title svg{width:20px;height:20px;color:#22c55e}
        .reports-table{width:100%;border-collapse:collapse;font-size:14px}
        .reports-table th{background:#f8fafc;padding:14px 20px;text-align:left;font-weight:600;color:#475569;border-bottom:1px solid #e2e8f0;white-space:nowrap;font-size:12px;text-transform:uppercase;letter-spacing:0.05em}
        .reports-table th:first-child{position:sticky;left:0;background:#f8fafc;z-index:1;min-width:140px}
        .reports-table td{padding:16px 20px;border-bottom:1px solid #f1f5f9;color:#1e293b}
        .reports-table td:first-child{position:sticky;left:0;background:#fff;font-weight:600;z-index:1}
        .reports-table tr:hover td{background:#f8fafc}
        .reports-table tr:hover td:first-child{background:#f8fafc}
        .reports-table tr:last-child td{border-bottom:none}
        .reports-table .current-row td{background:#f0fdf4}
        .reports-table .current-row td:first-child{background:#f0fdf4}
        .reports-table .cell-value{font-weight:600}
        .reports-table .cell-zero{color:#cbd5e1}
        .reports-table .cell-money{color:#16a34a;font-weight:700}
        .reports-table .cell-badge{display:inline-flex;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
        
        /* Visual Funnel - Premium 3D Effect */
        .reports-funnel-visual{background:linear-gradient(135deg,#fff 0%,#f8fafc 100%);border-radius:20px;padding:28px;border:1px solid #e2e8f0}
        .funnel-visual-title{font-size:16px;font-weight:700;color:#0f172a;margin-bottom:24px;display:flex;align-items:center;gap:10px}
        .funnel-visual-title svg{color:#22c55e}
        .funnel-visual-container{display:flex;gap:32px;align-items:flex-start}
        .funnel-shape{flex:1;display:flex;flex-direction:column;gap:4px}
        .funnel-stage{display:flex;align-items:center;gap:12px}
        .funnel-stage-bar{height:44px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;color:#fff;font-weight:600;margin:0 auto;transition:all .3s;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .funnel-stage-bar:hover{filter:brightness(1.05);transform:scale(1.02)}
        .funnel-bar-name{font-size:13px}
        .funnel-bar-count{font-size:15px;font-weight:700}
        .funnel-stage-dropoff{min-width:60px;text-align:right}
        .funnel-dropoff-pct{font-size:12px;font-weight:600;color:#ef4444}
        .funnel-dropoff-arrow{color:#94a3b8;margin-left:4px}
        .funnel-stats{min-width:200px;background:#f8fafc;border-radius:16px;padding:20px}
        .funnel-stat{margin-bottom:16px}
        .funnel-stat:last-child{margin-bottom:0}
        .funnel-stat-label{font-size:12px;color:#64748b;margin-bottom:4px}
        .funnel-stat-value{font-size:20px;font-weight:700;color:#0f172a}
        .funnel-stat-value.green{color:#16a34a}
        .funnel-stat-value.red{color:#ef4444}
        
        .reports-grid{display:grid;grid-template-columns:1.5fr 1fr;gap:24px;margin-bottom:24px}
        @media(max-width:1024px){.reports-grid{grid-template-columns:1fr}}
        
        /* Sync indicator */
        .chart-axis-label{font-size:10px;fill:#9ca3af}
        .conversion-funnel{display:flex;flex-direction:column;gap:8px}
        .conversion-step{display:flex;align-items:center;gap:12px}
        .conversion-bar{flex:1;height:36px;background:#f3f4f6;border-radius:6px;overflow:hidden;position:relative}
        .conversion-fill{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 12px;font-size:13px;font-weight:500;color:#fff;transition:width .5s ease}
        .conversion-label{min-width:100px;font-size:13px;color:#374151}
        .conversion-percent{min-width:50px;text-align:right;font-size:13px;font-weight:600;color:#1f2937}
        .conversion-arrow{color:#9ca3af;font-size:11px;padding-left:112px}
        
        /* Sync indicator */
        .sync-status{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--g);padding:4px 8px;background:var(--gl);border-radius:4px}
        .sync-dot{width:6px;height:6px;border-radius:50%;background:var(--p)}
        .sync-dot.syncing{background:var(--o);animation:pulse 1s infinite}
        .sync-dot.error{background:var(--r)}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        
        .header{background:var(--w);padding:8px 16px;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:100}
        .header-content{max-width:1600px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
        .logo{font-size:18px;font-weight:700;color:var(--p)}
        .nav{display:flex;gap:2px;background:var(--gl);padding:3px;border-radius:6px}
        .nav-btn{padding:6px 12px;border:none;background:0;border-radius:5px;font-size:13px;cursor:pointer;color:var(--g)}
        .nav-btn:hover{color:var(--t)}
        .nav-btn.active{background:var(--w);color:var(--p);box-shadow:0 1px 2px rgba(0,0,0,.1)}
        .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .btn{padding:6px 10px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:4px;white-space:nowrap}
        .btn-p{background:var(--p);color:#fff}
        .btn-p:hover{background:var(--pd)}
        .btn-s{background:var(--gl);color:var(--t)}
        .btn-s:hover{background:#e5e7eb}
        .btn-d{background:var(--r);color:#fff}
        .container{max-width:1600px;margin:0 auto;padding:12px 16px}
        .view{display:none}
        .view.active{display:block}
        
        /* Funnel Bar */
        .funnel-bar{display:flex;gap:12px;margin-bottom:16px;padding:12px 16px;background:#fff;border-radius:10px;border:1px solid #e5e7eb;align-items:center;flex-wrap:wrap}
        .funnel-dropdown-divider{height:1px;background:#e5e7eb;margin:4px 0}
        
        /* Search Box */
        .search-box{position:relative;flex:1;min-width:200px;max-width:400px}
        .search-box input{width:100%;padding:8px 12px 8px 36px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;background:#f9fafb;transition:all .2s}
        .search-box input:focus{outline:none;border-color:#22c55e;background:#fff;box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
        .search-box input::placeholder{color:#9ca3af}
        .search-box-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#9ca3af;pointer-events:none}
        .search-box-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:#9ca3af;cursor:pointer;padding:4px;display:none}
        .search-box-clear:hover{color:#6b7280}
        .search-box.has-value .search-box-clear{display:block}
        .search-highlight{background:#fef08a;padding:0 2px;border-radius:2px}
        
        /* Bulk Actions */
        .bulk-bar{display:none;align-items:center;gap:12px;padding:12px 16px;background:#1f2937;color:#fff;border-radius:10px;margin-bottom:16px;animation:slideDown .2s ease}
        .bulk-bar.active{display:flex}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .bulk-count{font-weight:600;font-size:14px}
        .bulk-actions{display:flex;gap:8px;flex:1;flex-wrap:wrap}
        .bulk-btn{padding:6px 12px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.15);color:#fff;transition:all .2s}
        .bulk-btn:hover{background:rgba(255,255,255,0.25)}
        .bulk-btn.danger{background:#ef4444}
        .bulk-btn.danger:hover{background:#dc2626}
        .bulk-close{margin-left:auto;background:none;border:none;color:#fff;cursor:pointer;padding:4px;opacity:0.7}
        .bulk-close:hover{opacity:1}
        .k-card.selected{outline:2px solid #22c55e;outline-offset:2px}
        .k-card .select-checkbox{position:absolute;top:8px;right:8px;width:20px;height:20px;border-radius:4px;border:2px solid #d1d5db;background:#fff;cursor:pointer;display:none;align-items:center;justify-content:center}
        .k-card:hover .select-checkbox,.k-card.selected .select-checkbox,.bulk-mode .k-card .select-checkbox{display:flex}
        .k-card.selected .select-checkbox{background:#22c55e;border-color:#22c55e}
        .k-card.selected .select-checkbox::after{content:'';width:6px;height:10px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);margin-bottom:2px}
        
        /* Skeleton Loading */
        .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite}
        @keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
        .skeleton-card{height:120px;border-radius:10px;margin-bottom:12px}
        .skeleton-row{display:grid;grid-template-columns:65px 1fr auto;gap:12px;padding:12px 16px;border-bottom:1px solid #f0f0f0}
        .skeleton-circle{width:40px;height:40px;border-radius:50%}
        .skeleton-line{height:14px;border-radius:4px}
        .skeleton-line.short{width:60%}
        .skeleton-line.medium{width:80%}
        .skeleton-column{background:#fff;border-radius:12px;padding:16px;min-width:280px}
        .skeleton-column-header{height:20px;border-radius:4px;margin-bottom:16px;width:50%}
        
        /* Tasks - Focus on Date/Time/Action */
        .tasks-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}
        .tasks-title{font-size:20px;font-weight:600;color:#1d1d1f}
        .tasks-count{background:#007aff;color:#fff;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;margin-left:8px}
        
        .tasks-filters{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
        .tasks-filters::-webkit-scrollbar{display:none}
        .filter-pill{padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;cursor:pointer;border:none;background:#f5f5f7;color:#1d1d1f;white-space:nowrap;transition:all .2s}
        .filter-pill:hover{background:#e8e8ed}
        .filter-pill.active{background:#007aff;color:#fff}
        
        .tasks-list{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        
        /* Task Row - Compact single line */
        .task-row{display:grid;grid-template-columns:65px 1fr auto auto;gap:12px;padding:10px 16px;border-bottom:1px solid #f0f0f0;cursor:pointer;transition:background .15s;align-items:center}
        .task-row:last-child{border-bottom:none}
        .task-row:hover{background:#fafafa}
        .task-row.overdue{background:#fff5f5}
        .task-row.now{background:#f0f9ff}
        
        /* Time Column */
        .task-time{text-align:center}
        .task-time-value{font-size:14px;font-weight:600;color:#1d1d1f}
        .task-time-date{font-size:10px;color:#8e8e93}
        .task-time.overdue .task-time-value{color:#ff3b30}
        .task-time.overdue .task-time-date{color:#ff3b30}
        .task-time.today .task-time-value{color:#007aff}
        .task-time.now .task-time-value{color:#34c759;font-size:12px}
        
        /* Main Info - Single line */
        .task-main-info{min-width:0;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .task-action-text{font-size:14px;font-weight:500;color:#1d1d1f;white-space:nowrap}
        .task-contact-link{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:500;text-decoration:none;transition:all .15s}
        .task-contact-link.tg{background:#e3f2fd;color:#0088cc}
        .task-contact-link.tg:hover{background:#bbdefb}
        .task-contact-link.phone{background:#f3f4f6;color:#1d1d1f}
        .task-contact-link.phone:hover{background:#e5e7eb}
        .task-contact-link.viber{background:#f3e5f5;color:#7360f2}
        .task-contact-link.viber:hover{background:#e1bee7}
        .task-contact-link.whatsapp{background:#e8f5e9;color:#25d366}
        .task-contact-link.whatsapp:hover{background:#c8e6c9}
        .task-contact-link.email{background:#fff3e0;color:#f57c00}
        .task-contact-link.email:hover{background:#ffe0b2}
        .task-biz{font-size:12px;color:#8e8e93}
        .task-score{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
        .task-score.hot{background:#ffebee;color:#c62828}
        .task-score.warm{background:#fff3e0;color:#ef6c00}
        .task-score.cold{background:#e3f2fd;color:#1565c0}
        
        /* Status dropdown */
        .task-status-wrap{position:relative}
        .task-status-btn{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;text-transform:uppercase}
        .task-status-btn:hover{filter:brightness(0.95)}
        .task-status-btn svg{width:12px;height:12px;opacity:0.6}
        .task-status-btn.st-new{background:#e3f2fd;color:#1565c0}
        .task-status-btn.st-contacted{background:#e8eaf6;color:#3949ab}
        .task-status-btn.st-scheduled{background:#e8f5e9;color:#2e7d32}
        .task-status-btn.st-completed{background:#f3e5f5;color:#7b1fa2}
        .task-status-btn.st-report_sent{background:#e0f2f1;color:#00695c}
        .task-status-btn.st-deposit{background:#fff8e1;color:#f57f17}
        .task-status-btn.st-paid{background:#e8f5e9;color:#1b5e20}
        .task-status-btn.st-failed{background:#ffebee;color:#c62828}
        .task-status-btn.st-repeat{background:#ede7f6;color:#512da8}
        .task-status-btn.st-frozen{background:#eceff1;color:#546e7a}
        
        .task-status-dropdown{position:absolute;top:100%;right:0;margin-top:4px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:1001;min-width:180px;padding:8px 0;display:none;max-height:300px;overflow-y:auto}
        .task-status-dropdown.drop-up{top:auto;bottom:100%;margin-top:0;margin-bottom:4px;box-shadow:0 -10px 40px rgba(0,0,0,0.2)}
        
        /* Status Picker Modal */
        .status-picker-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
        .status-picker-overlay.active{display:flex}
        .status-picker{background:#fff;border-radius:20px;width:100%;max-width:600px;max-height:85vh;overflow:hidden;animation:modalSlide 0.25s ease}
        .status-picker-header{padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .status-picker-title{font-size:18px;font-weight:600;color:#1f2937}
        .status-picker-subtitle{font-size:13px;color:#6b7280;margin-top:2px}
        .status-picker-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:10px;cursor:pointer;font-size:20px;color:#6b7280;transition:all 0.2s}
        .status-picker-close:hover{background:#e5e7eb;color:#1f2937}
        .status-picker-body{padding:20px 24px;overflow-y:auto;max-height:calc(85vh - 80px)}
        .status-group{margin-bottom:24px}
        .status-group:last-child{margin-bottom:0}
        .status-group-title{font-size:11px;font-weight:600;text-transform:uppercase;color:#9ca3af;margin-bottom:12px;letter-spacing:0.5px;display:flex;align-items:center;gap:6px}
        .status-group-title svg{stroke:#9ca3af}
        .status-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(160px, 1fr));gap:10px}
        .status-card{padding:16px;border-radius:12px;border:2px solid #e5e7eb;cursor:pointer;transition:all 0.2s;display:flex;flex-direction:column;gap:8px;background:#fff}
        .status-card:hover{border-color:#d1d5db;background:#f9fafb;transform:translateY(-2px)}
        .status-card.active{border-color:var(--p);background:#f0fdf4}
        .status-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center}
        .status-card-icon svg{width:22px;height:22px}
        .status-card-name{font-size:14px;font-weight:600;color:#1f2937}
        .status-card-desc{font-size:11px;color:#6b7280;line-height:1.4}
        .status-card.current{border-color:var(--p);background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)}
        .status-card.current::after{content:'✓ Поточний';font-size:10px;color:var(--p);font-weight:600}
        .task-status-dropdown.active{display:block}
        .task-status-option{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:12px;cursor:pointer;transition:background .1s}
        .task-status-option:hover{background:#f5f5f5}
        .task-status-option .dot{width:8px;height:8px;border-radius:50%}
        .task-status-option .dot.new{background:#1565c0}
        .task-status-option .dot.contacted{background:#3949ab}
        .task-status-option .dot.scheduled{background:#2e7d32}
        .task-status-option .dot.completed{background:#7b1fa2}
        .task-status-option .dot.report_sent{background:#00695c}
        .task-status-option .dot.deposit{background:#f57f17}
        .task-status-option .dot.paid{background:#1b5e20}
        .task-status-option .dot.failed{background:#c62828}
        .task-status-option .dot.repeat{background:#512da8}
        .task-status-option .dot.frozen{background:#546e7a}
        
        /* Actions */
        .task-actions{display:flex;gap:4px}
        .task-action-btn{width:36px;height:36px;border-radius:8px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;background:#f5f5f7}
        .task-action-btn:hover{background:#e8e8ed;transform:scale(1.05)}
        .task-action-btn svg{width:18px;height:18px;color:#8e8e93}
        .task-action-btn.primary{background:#e3f2fd}
        .task-action-btn.primary svg{color:#007aff}
        .task-action-btn.success{background:#e8f5e9}
        .task-action-btn.success svg{color:#34c759}
        .task-action-btn.ai{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #86efac}
        .task-action-btn.ai svg{color:#22c55e}
        
        /* Section Headers */
        .section-header{font-size:11px;font-weight:600;color:#8e8e93;text-transform:uppercase;letter-spacing:0.5px;padding:12px 16px 8px;background:#f9fafb;display:flex;align-items:center;gap:8px}
        .section-header .dot{width:8px;height:8px;border-radius:50%}
        .section-header .dot.red{background:#ff3b30}
        .section-header .dot.blue{background:#007aff}
        .section-header .dot.gray{background:#8e8e93}
        
        /* Task Icons */
        .task-icon{width:16px;height:16px;flex-shrink:0;vertical-align:middle;margin-right:6px}
        .task-icon.critical{color:#ef4444}
        .task-icon.warning{color:#f59e0b}
        .task-icon.success{color:#22c55e}
        .task-msg{display:flex;align-items:center}
        
        /* Empty State */
        .tasks-empty{text-align:center;padding:60px 20px;color:#8e8e93}
        .tasks-empty-icon{width:64px;height:64px;margin:0 auto 16px;background:#f5f5f7;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .tasks-empty-icon svg{width:32px;height:32px;color:#c7c7cc}
        .tasks-empty-title{font-size:17px;font-weight:600;color:#1d1d1f;margin-bottom:4px}
        .tasks-empty-text{font-size:14px}
        
        /* Quick Action Panel - Google Style */
        .quick-panel{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:20px 20px 0 0;box-shadow:0 -4px 24px rgba(0,0,0,0.15);z-index:150;max-height:80vh;overflow:hidden;animation:slideUp .25s ease}
        .quick-panel.active{display:block}
        @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        @keyframes fadeInUp{from{opacity:0;transform:translate(-50%,20px)}to{opacity:1;transform:translate(-50%,0)}}
        @keyframes fadeOutDown{from{opacity:1;transform:translate(-50%,0)}to{opacity:0;transform:translate(-50%,20px)}}
        .quick-panel-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:149;display:none}
        .quick-panel-overlay.active{display:block}
        
        /* DateTime Picker Modal */
        .datetime-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:none}
        .datetime-modal-overlay.active{display:block}
        .datetime-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:201;width:340px;display:none}
        #confirm-modal-overlay{z-index:2000}
        #confirm-modal{z-index:2001}
        .datetime-modal.active{display:block}
        #templates-modal{width:420px;max-width:95vw}
        .datetime-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .datetime-header span{font-size:16px;font-weight:600;color:#1a1a1a}
        .datetime-close{width:28px;height:28px;border:none;background:none;font-size:24px;color:#666;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:50%}
        .datetime-close:hover{background:#f5f5f5}
        .datetime-body{padding:20px}
        .datetime-row{display:flex;gap:12px;margin-bottom:16px}
        .datetime-field{flex:1}
        .datetime-field label{display:block;font-size:12px;font-weight:600;color:#5f6368;margin-bottom:6px;text-transform:uppercase}
        .datetime-input{width:100%;padding:12px;border:1px solid #e0e0e0;border-radius:8px;font-size:15px;box-sizing:border-box}
        .datetime-input:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,0.1)}
        .datetime-quick{display:flex;gap:8px;flex-wrap:wrap}
        .datetime-quick-btn{padding:8px 14px;border:1px solid #e0e0e0;border-radius:20px;background:#fff;font-size:13px;cursor:pointer;transition:all 0.15s}
        .datetime-quick-btn:hover{border-color:#22c55e;color:#22c55e;background:#f0fdf4}
        .datetime-footer{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px}
        
        .quick-panel-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .quick-panel-title{font-size:18px;font-weight:600;color:#1a1a1a}
        .quick-panel-close{width:32px;height:32px;border-radius:50%;border:none;background:#f5f5f5;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .quick-panel-close:hover{background:#e8e8e8}
        .quick-panel-close svg{width:20px;height:20px;color:#666}
        
        .quick-panel-lead{padding:16px 20px;background:#f9fafb;border-bottom:1px solid #e5e7eb}
        .quick-lead-name{font-size:16px;font-weight:600;color:#1a1a1a;margin-bottom:4px}
        .quick-lead-info{font-size:13px;color:#666;display:flex;gap:12px;flex-wrap:wrap}
        .quick-lead-action{font-size:14px;color:#1a73e8;font-weight:500;margin-top:8px}
        
        .quick-panel-body{padding:20px;overflow-y:auto;max-height:50vh}
        
        .quick-section{margin-bottom:24px}
        .quick-section:last-child{margin-bottom:0}
        .quick-section-title{font-size:12px;font-weight:600;color:#5f6368;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .quick-section-title svg{width:16px;height:16px}
        
        .quick-buttons{display:flex;flex-wrap:wrap;gap:8px}
        .quick-btn{padding:10px 16px;border-radius:100px;border:1px solid #dadce0;background:#fff;font-size:14px;font-weight:500;color:#1a1a1a;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s}
        .quick-btn:hover{background:#f1f3f4;border-color:#1a73e8}
        .quick-btn:active{background:#e8f0fe}
        .quick-btn svg{width:18px;height:18px;color:#5f6368}
        
        .quick-btn.answered{border-color:#34a853;color:#34a853}
        .quick-btn.answered:hover{background:#e6f4ea}
        .quick-btn.answered svg{color:#34a853}
        
        .quick-btn.no-answer{border-color:#ea4335;color:#ea4335}
        .quick-btn.no-answer:hover{background:#fce8e6}
        .quick-btn.no-answer svg{color:#ea4335}
        
        .quick-btn.scheduled{border-color:#1a73e8;color:#1a73e8}
        .quick-btn.scheduled:hover{background:#e8f0fe}
        .quick-btn.scheduled svg{color:#1a73e8}
        
        .quick-btn.completed{border-color:#34a853;background:#34a853;color:#fff}
        .quick-btn.completed:hover{background:#2d9249}
        .quick-btn.completed svg{color:#fff}
        
        .quick-btn.failed{border-color:#ea4335;background:#ea4335;color:#fff}
        .quick-btn.failed:hover{background:#d33426}
        .quick-btn.failed svg{color:#fff}
        
        /* Time picker buttons */
        .time-buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
        .time-btn{padding:12px 8px;border-radius:12px;border:1px solid #dadce0;background:#fff;font-size:13px;font-weight:500;color:#1a1a1a;cursor:pointer;text-align:center;transition:all .15s}
        .time-btn:hover{background:#f1f3f4;border-color:#1a73e8}
        .time-btn:active{background:#e8f0fe}
        .time-btn .time{font-size:16px;font-weight:600;color:#1a73e8;display:block;margin-bottom:2px}
        .time-btn .label{font-size:11px;color:#5f6368}
        .time-btn.selected{border-color:#1a73e8;background:#e8f0fe}
        .time-btn-custom{border-style:dashed;background:#f8fafc}
        .time-btn-custom:hover{background:#e8f0fe;border-style:solid}
        .time-btn-custom .time{display:flex;align-items:center;justify-content:center}
        .time-btn-custom .time svg{stroke:#1a73e8}
        
        /* Custom datetime picker */
        .custom-datetime-picker{margin-top:12px;padding:16px;background:#f8fafc;border-radius:12px;border:1px solid #e5e7eb}
        .custom-datetime-row{display:flex;gap:12px;align-items:flex-end}
        .custom-datetime-field{flex:1;display:flex;flex-direction:column;gap:4px}
        .custom-datetime-field label{font-size:11px;font-weight:600;color:#6b7280;text-transform:uppercase}
        .custom-datetime-field input{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:#fff}
        .custom-datetime-field input:focus{outline:none;border-color:#1a73e8}
        .custom-datetime-confirm{width:48px;height:44px;border:none;background:#22c55e;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .custom-datetime-confirm:hover{background:#16a34a;transform:scale(1.05)}
        .custom-datetime-confirm svg{stroke:#fff}
        
        /* Note input */
        .quick-note{width:100%;padding:12px 16px;border:1px solid #dadce0;border-radius:12px;font-size:14px;resize:none;min-height:60px;margin-top:12px}
        .quick-note:focus{outline:none;border-color:#1a73e8}
        
        /* Confirm button */
        .quick-confirm{width:100%;padding:14px;background:#1a73e8;color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-top:16px;display:flex;align-items:center;justify-content:center;gap:8px}
        .quick-confirm:hover{background:#1557b0}
        .quick-confirm:disabled{background:#dadce0;color:#80868b;cursor:not-allowed}
        .quick-confirm svg{width:20px;height:20px}
        
        /* Contact Links */
        .contact-link{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:500;text-decoration:none;transition:all .15s}
        .contact-link svg{width:16px;height:16px;flex-shrink:0}
        .contact-link.tg{background:#e3f2fd;color:#0088cc}
        .contact-link.tg:hover{background:#bbdefb}
        .contact-link.phone{background:#f3f4f6;color:#1a1a1a}
        .contact-link.phone:hover{background:#e5e7eb}
        
        .contact-phone-group{display:inline-flex;align-items:center;gap:4px}
        .contact-messengers{display:flex;gap:4px}
        .messenger-btn{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .15s}
        .messenger-btn svg{width:16px;height:16px}
        .messenger-btn.wa{background:#e8f5e9;color:#25d366}
        .messenger-btn.wa:hover{background:#c8e6c9}
        .messenger-btn.viber{background:#f3e5f5;color:#7360f2}
        .messenger-btn.viber:hover{background:#e1bee7}
        
        .no-contact{color:#9ca3af;font-size:13px}
        
        /* Quick panel contact links */
        .quick-lead-contacts{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
        
        .task-card{background:var(--w);border-radius:8px;padding:10px 12px;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.08);border-left:3px solid transparent;cursor:pointer}
        .task-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.12)}
        .task-card.critical{border-left-color:var(--r);background:var(--rl)}
        .task-card.warning{border-left-color:var(--o);background:var(--ol)}
        .task-card.info{border-left-color:var(--b);background:var(--bl)}
        .task-meta{font-size:11px;color:var(--ts);margin-bottom:4px}
        .task-action{font-size:12px;margin-bottom:8px}
        .task-btns{display:flex;gap:6px;flex-wrap:wrap}
        .task-btn{padding:5px 10px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:none}
        .task-btn.success{background:var(--p);color:#fff}
        .task-btn.warn{background:var(--o);color:#fff}
        .task-btn.danger{background:var(--rl);color:var(--r)}
        .task-btn.secondary{background:var(--gl);color:var(--t)}
        .empty{text-align:center;padding:40px 20px;color:var(--g)}
        
        /* Onboarding */
        .onboarding{background:linear-gradient(135deg,#f0fdf4 0%,#ecfdf5 100%);border:2px dashed #86efac;border-radius:16px;padding:40px;text-align:center;max-width:600px;margin:40px auto}
        .onboarding-icon{width:64px;height:64px;background:var(--p);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
        .onboarding-icon svg{width:32px;height:32px;color:#fff}
        .onboarding-title{font-size:20px;font-weight:700;color:var(--t);margin-bottom:8px}
        .onboarding-text{font-size:14px;color:var(--ts);margin-bottom:24px;line-height:1.6}
        .onboarding-steps{display:flex;flex-direction:column;gap:12px;text-align:left;margin-bottom:24px}
        .onboarding-step{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--w);border-radius:10px;font-size:13px}
        .onboarding-step-num{width:28px;height:28px;background:var(--p);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}
        .onboarding-step-text{flex:1}
        .onboarding-step-text strong{color:var(--t)}
        .onboarding-btn{padding:12px 24px;background:var(--p);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
        .onboarding-btn:hover{background:var(--pd)}
        .onboarding-btn svg{width:18px;height:18px}
        
        /* Kanban */
        .kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:16px}
        .kanban-filters{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
        .filter-btn{padding:5px 10px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid #e5e7eb;background:var(--w);color:var(--t);display:inline-flex;align-items:center;gap:4px;transition:all .2s}
        .filter-btn:hover{border-color:var(--p);background:var(--pl)}
        .filter-btn.active{background:var(--p);color:#fff;border-color:var(--p)}
        .filter-btn svg{flex-shrink:0}
        .column{width:260px;flex-shrink:0;background:var(--gl);border-radius:10px;max-height:calc(100vh - 130px);display:flex;flex-direction:column}
        .column-header{padding:10px 12px;font-weight:600;font-size:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
        .column-count{background:var(--w);padding:2px 6px;border-radius:6px;font-size:11px;color:var(--g)}
        .column-cards{padding:8px;flex:1;overflow-y:auto;min-height:60px;transition:background .2s}
        .column-cards.drag-over{background:var(--pl);box-shadow:inset 0 0 0 2px var(--p)}
        .k-card{background:var(--w);border-radius:6px;padding:8px 10px;margin-bottom:6px;box-shadow:0 1px 2px rgba(0,0,0,.08);cursor:grab;border-left:3px solid transparent;transition:transform .15s,box-shadow .15s,opacity .15s}
        .k-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.12)}
        .k-card:active{cursor:grabbing}
        .k-card.dragging{opacity:.4;transform:rotate(3deg);box-shadow:0 10px 30px rgba(0,0,0,.2)}
        .k-card.drag-ghost{position:fixed;pointer-events:none;z-index:1000;opacity:0.9;transform:rotate(-2deg);box-shadow:0 15px 40px rgba(0,0,0,.25)}
        .k-card.has-alert{border-left-color:var(--o)}
        .k-card.has-critical{border-left-color:var(--r)}
        .k-card-name{font-weight:600;font-size:12px;margin-bottom:2px}
        .k-card-biz{font-size:10px;color:var(--ts);margin-bottom:4px}
        .k-card-footer{display:flex;justify-content:space-between;font-size:10px;color:var(--g)}
        .k-card-amount{color:var(--p);font-weight:600}
        .k-card-days{padding:1px 5px;border-radius:3px;background:var(--gl)}
        .k-card-days.over{background:var(--rl);color:var(--r)}
        .k-card-tags{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
        .k-tag{padding:1px 5px;border-radius:3px;font-size:9px;font-weight:500;display:inline-flex;align-items:center;gap:2px}
        .k-tag svg{width:9px;height:9px}
        .k-tag.overdue{background:var(--rl);color:var(--r)}
        .k-tag.consult-today{background:#dbeafe;color:#1e40af}
        .k-tag.consult-tomorrow{background:#fef3c7;color:#92400e}
        .k-tag.noshow{background:var(--ol);color:#c2410c}
        .k-tag.has-deposit{background:#d1fae5;color:#065f46}
        .k-tag.action-today{background:#f5f3ff;color:#7c3aed}
        .k-tag.action-tomorrow{background:#f0fdf4;color:#16a34a}
        .score{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
        .score.hot{background:#fee2e2;color:#dc2626}
        .score.warm{background:#fef3c7;color:#d97706}
        .score.cold{background:#e0e7ff;color:#4f46e5}
        .score-bar{width:40px;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden}
        .score-fill{height:100%;border-radius:3px}
        .score-fill.hot{background:#dc2626}
        .score-fill.warm{background:#d97706}
        .score-fill.cold{background:#4f46e5}
        .ai-hint{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #86efac;border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;display:flex;gap:8px;align-items:flex-start}
        .ai-hint svg{flex-shrink:0;color:#22c55e}
        .ai-hint-text{flex:1}
        .ai-hint-title{font-weight:600;color:#166534;margin-bottom:2px}
        .column[data-status="new"] .column-header{background:#dbeafe}
        .column[data-status="scheduled"] .column-header{background:#fef3c7}
        .column[data-status="completed"] .column-header{background:#e0e7ff}
        .column[data-status="report_sent"] .column-header{background:#fce7f3}
        .column[data-status="repeat"] .column-header{background:#f5f3ff}
        .column[data-status="deposit"] .column-header{background:#d1fae5}
        .column[data-status="paid"] .column-header{background:#22c55e;color:#fff}
        
        /* Reports */
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px}
        .stat{background:var(--w);padding:20px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .stat-val{font-size:28px;font-weight:700;color:var(--p)}
        .stat-label{font-size:12px;color:var(--g);margin-top:4px}
        
        /* Reports Grid Layout */
        .reports-grid{display:grid;grid-template-columns:1fr 380px;gap:24px;margin-top:20px}
        .reports-section-title{font-size:13px;font-weight:600;color:var(--ts);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
        
        /* Compact Table */
        .reports-table-wrap{background:var(--w);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
        .reports-table{width:100%;border-collapse:collapse;font-size:13px}
        .reports-table th{text-align:center;padding:8px 6px;font-weight:500;color:var(--ts);font-size:11px;border-bottom:1px solid #e5e7eb}
        .reports-table th:first-child{text-align:left}
        .reports-table td{padding:6px;text-align:center;border-bottom:1px solid #f3f4f6;color:var(--t)}
        .reports-table td:first-child{text-align:left;font-weight:500;font-size:12px}
        .reports-table tr:last-child td{border-bottom:none}
        .reports-table tr:hover{background:#f9fafb}
        .reports-table .current-week{background:#f0fdf4}
        .reports-table .zero{color:#d1d5db}
        .reports-table .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px;vertical-align:middle}
        
        /* Visual Funnel - Dark Theme */
        .reports-funnel-visual{background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(0,0,0,.15);color:#fff}
        .funnel-visual-title{font-size:15px;font-weight:600;margin-bottom:20px;display:flex;align-items:center;gap:10px;color:#fff}
        .funnel-visual-title svg{opacity:0.7}
        
        .funnel-visual-container{position:relative}
        .funnel-shape{display:flex;flex-direction:column;align-items:center;gap:3px}
        
        .funnel-stage{display:flex;align-items:center;width:100%;gap:12px}
        .funnel-stage-bar{
            height:40px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 16px;
            font-weight:600;
            font-size:14px;
            color:#fff;
            transition:all .3s;
            margin:0 auto;
            border-radius:4px;
            position:relative;
            min-width:80px;
        }
        .funnel-stage-bar:hover{filter:brightness(1.1);transform:scale(1.02)}
        .funnel-bar-name{font-size:12px;font-weight:500;color:rgba(255,255,255,0.85);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}
        .funnel-bar-count{font-size:15px;font-weight:700;color:#fff}
        
        .funnel-stage-dropoff{width:70px;text-align:right;flex-shrink:0}
        .funnel-dropoff-pct{font-size:13px;font-weight:700;color:#f87171}
        .funnel-dropoff-arrow{color:#f87171;font-size:14px;margin-left:2px}
        
        /* Funnel Metrics */
        .funnel-metrics{margin-top:24px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .funnel-metric-card{background:rgba(255,255,255,0.05);border-radius:10px;padding:14px;border:1px solid rgba(255,255,255,0.1)}
        .funnel-metric-label{font-size:11px;color:rgba(255,255,255,0.6);margin-bottom:4px}
        .funnel-metric-value{font-size:20px;font-weight:700;color:#fff}
        .funnel-metric-value.positive{color:#4ade80}
        .funnel-metric-value.negative{color:#f87171}
        
        /* Recent Failed */
        .funnel-failed{margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.1)}
        .funnel-failed-title{font-size:12px;color:rgba(255,255,255,0.6);margin-bottom:10px}
        .funnel-failed-item{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
        .funnel-failed-item:last-child{border-bottom:none}
        .funnel-failed-icon{width:20px;height:20px;background:#f87171;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .funnel-failed-icon svg{width:12px;height:12px;color:#fff}
        .funnel-failed-name{flex:1;font-size:12px;color:rgba(255,255,255,0.8);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .funnel-failed-time{font-size:11px;color:rgba(255,255,255,0.4);flex-shrink:0}
        
        @media(max-width:1024px){
            .reports-grid{grid-template-columns:1fr}
            .reports-funnel-visual{order:-1}
        }
        @media(max-width:768px){
            .reports-table{font-size:11px}
            .reports-table th,.reports-table td{padding:4px 3px}
            .funnel-metrics{grid-template-columns:1fr}
        }
        
        /* Modal */
        .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto}
        .modal-bg.active{display:flex}
        .modal{background:var(--w);border-radius:16px;width:100%;max-width:640px;margin:40px 0;overflow:visible}
        .modal-head{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;position:relative;overflow:visible}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{width:32px;height:32px;border:none;background:var(--gl);border-radius:8px;cursor:pointer;font-size:18px}
        .modal-body{padding:20px;max-height:65vh;overflow-y:auto}
        .modal-foot{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between}
        .tabs{display:flex;gap:0;border-bottom:1px solid #e5e7eb;margin:-20px -20px 20px}
        .tab{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:500;cursor:pointer;border:none;background:0;color:var(--g);border-bottom:2px solid transparent}
        .tab.active{color:var(--p);border-bottom-color:var(--p)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .form-row{display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-bottom:16px}
        .form-group{display:flex;flex-direction:column;gap:4px}
        .form-label{font-size:11px;font-weight:600;color:var(--ts);text-transform:uppercase}
        .form-input,.form-select,.form-textarea{padding:10px;border:1px solid #e5e7eb;border-radius:8px;font-size:14px}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--p)}
        .form-textarea{min-height:80px;resize:vertical}
        .form-hint{font-size:10px;color:var(--g)}
        
        /* Comm Log */
        .comm-log{max-height:250px;overflow-y:auto}
        .comm-item{display:flex;gap:10px;padding:10px;background:var(--gl);border-radius:8px;margin-bottom:8px}
        .comm-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
        .comm-icon.call{background:var(--bl);color:var(--b)}
        .comm-icon.sms{background:var(--pl);color:var(--p)}
        .comm-icon.note{background:#f5f3ff;color:#8b5cf6}
        .comm-icon.status{background:var(--ol);color:var(--o)}
        .comm-body{flex:1}
        .comm-head{display:flex;justify-content:space-between;font-size:12px;margin-bottom:2px}
        .comm-type{font-weight:600}
        .comm-date{color:var(--g)}
        .comm-text{font-size:12px;color:var(--ts)}
        .comm-add{display:flex;gap:8px;margin-top:12px}
        .comm-add select{width:100px}
        .comm-add input{flex:1}
        
        /* Links */
        .links-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .link-item{padding:12px;background:var(--gl);border-radius:8px}
        .link-label{font-size:10px;font-weight:600;color:var(--g);text-transform:uppercase;margin-bottom:4px}
        .link-input{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px}
        
        /* Finance */
        .fin-row{display:grid;grid-template-columns:1fr 80px;gap:8px;margin-bottom:12px}
        
        /* Help */
        .help-btn{position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--p);color:#fff;border:none;cursor:pointer;font-size:20px;box-shadow:0 4px 12px rgba(34,197,94,.4)}
        .help-panel{display:none;position:fixed;bottom:80px;right:20px;width:360px;max-width:calc(100vw - 40px);max-height:60vh;background:var(--w);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;z-index:99}
        .help-panel.active{display:block}
        .help-head{padding:14px;background:var(--p);color:#fff;font-weight:600;display:flex;justify-content:space-between}
        .help-close{background:0;border:0;color:#fff;cursor:pointer;font-size:18px}
        .help-body{padding:14px;overflow-y:auto;max-height:calc(60vh - 50px)}
        .help-item{display:flex;gap:8px;padding:8px;background:var(--gl);border-radius:6px;margin-bottom:6px;font-size:12px}
        .status-badge{padding:3px 8px;border-radius:4px;font-size:11px;font-weight:500}
        .st-new{background:#dbeafe;color:#1e40af}
        .st-scheduled{background:#fef3c7;color:#92400e}
        .st-completed{background:#e0e7ff;color:#3730a3}
        .st-report_sent{background:#fce7f3;color:#9d174d}
        .st-repeat{background:#f5f3ff;color:#5b21b6}
        .st-deposit{background:#d1fae5;color:#065f46}
        .st-paid{background:#22c55e;color:#fff}
        .st-failed{background:#f3f4f6;color:#374151}
        .st-reactivation{background:#ede9fe;color:#5b21b6}
        
        /* AI Panel */
        .ai-fab{position:fixed;bottom:80px;right:20px;width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;border:none;cursor:pointer;font-size:20px;box-shadow:0 4px 12px rgba(99,102,241,.4);z-index:98;display:flex;align-items:center;justify-content:center}
        .ai-fab:hover{transform:scale(1.1)}
        .ai-panel{display:none;position:fixed;bottom:140px;right:20px;width:400px;max-width:calc(100vw - 40px);height:500px;max-height:calc(100vh - 180px);background:var(--w);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);overflow:hidden;z-index:99;flex-direction:column}
        .ai-panel.active{display:flex}
        .ai-panel-head{padding:14px 16px;background:linear-gradient(135deg,#8b5cf6,#6366f1);color:#fff;font-weight:600;display:flex;justify-content:space-between;align-items:center}
        .ai-panel-close{background:0;border:0;color:#fff;cursor:pointer;font-size:20px;line-height:1}
        .ai-panel-body{flex:1;display:flex;flex-direction:column;overflow:hidden}
        .ai-chat{flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
        .ai-msg{padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;max-width:90%}
        .ai-msg-user{background:var(--p);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
        .ai-msg-bot{background:var(--gl);color:var(--t);align-self:flex-start;border-bottom-left-radius:4px}
        .ai-msg-loading{background:var(--gl);color:var(--g);align-self:flex-start}
        .ai-input-wrap{padding:12px;border-top:1px solid #e5e7eb;background:var(--w)}
        .ai-quick-btns{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
        .ai-quick-btn{padding:6px 10px;font-size:11px;background:var(--gl);border:none;border-radius:6px;cursor:pointer;white-space:nowrap}
        .ai-quick-btn:hover{background:#e5e7eb}
        
        .quick-actions{display:flex;gap:8px;flex-wrap:wrap;padding:12px;background:var(--gl);border-radius:8px;margin-bottom:16px}
        
        /* ===== MOBILE RESPONSIVE ===== */
        
        /* Tablet (768px) */
        @media(max-width:768px){
            .header{padding:8px 12px}
            .header-content{flex-direction:column;gap:8px}
            .logo{font-size:16px}
            .nav{width:100%;justify-content:center;order:1}
            .nav-btn{padding:8px 14px;font-size:13px}
            .actions{width:100%;justify-content:center;flex-wrap:wrap;gap:6px;order:2}
            .btn{padding:6px 10px;font-size:12px}
            .sync-status{display:none}
            .user-menu{order:3}
            .user-email{max-width:120px;font-size:11px}
            .container{padding:8px 12px}
            
            /* Funnel bar */
            .funnel-bar{padding:10px 12px;gap:8px}
            .funnel-selector-btn{padding:8px 12px;font-size:12px}
            
            /* Settings panel */
            .settings-panel{width:100%;max-width:100vw;right:-100%}
            
            /* Modal */
            .modal{width:95%;max-width:none;margin:10px;max-height:90vh}
            .modal-body{padding:16px}
            .form-row{grid-template-columns:1fr}
            
            /* Kanban */
            .kanban{gap:12px}
            .column{min-width:280px}
            
            /* Reports */
            .reports-header{flex-direction:column;align-items:stretch}
            .reports-controls{flex-direction:column;gap:12px}
            .reports-summary{grid-template-columns:repeat(2,1fr)}
        }
        
        /* Mobile (480px) */
        @media(max-width:480px){
            /* Header - mobile optimized */
            .header{padding:6px 10px;position:sticky;top:0;z-index:100}
            .header-content{gap:6px}
            .logo{font-size:15px}
            .nav{background:transparent;padding:0;gap:0}
            .nav-btn{padding:8px 12px;font-size:12px;background:var(--gl);border-radius:6px}
            .nav-btn.active{background:var(--p);color:#fff}
            
            /* Actions - hide non-essential */
            .actions{gap:4px}
            .actions .btn.btn-s:not(#team-btn):not(#settings-btn){display:none}
            .actions .btn.btn-p{padding:8px 12px;font-size:12px}
            #team-btn, #settings-btn{padding:8px}
            .user-email{display:none}
            .user-btn{font-size:11px;padding:6px 10px}
            
            /* Container */
            .container{padding:6px 10px}
            
            /* Funnel bar - compact */
            .funnel-bar{padding:8px;margin-bottom:8px;gap:8px;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
            .funnel-selector{flex-shrink:0}
            .funnel-selector-btn{padding:8px 12px;font-size:12px;white-space:nowrap;min-width:auto;gap:6px}
            .funnel-selector-btn span{max-width:100px;overflow:hidden;text-overflow:ellipsis}
            .funnel-dropdown{min-width:200px;max-width:280px}
            
            /* Tasks View */
            .tasks-header{flex-direction:column;align-items:stretch;gap:8px;padding-bottom:8px;margin-bottom:10px}
            .tasks-title{font-size:18px}
            .tasks-count{font-size:11px;padding:2px 6px}
            .tasks-filters{gap:6px;margin-bottom:10px;padding-bottom:8px;-webkit-overflow-scrolling:touch;overflow-x:auto}
            .filter-pill{padding:6px 12px;font-size:12px;white-space:nowrap;flex-shrink:0}
            
            /* Task rows - mobile redesign */
            .task-row{
                display:grid;
                grid-template-columns:1fr auto;
                grid-template-rows:auto auto auto;
                gap:6px 8px;
                padding:12px;
                align-items:center;
            }
            .task-time{
                grid-column:1;
                grid-row:1;
                display:flex;
                align-items:center;
                gap:8px;
                min-width:0;
                padding:0;
            }
            .task-time-value{font-size:13px;font-weight:600;white-space:nowrap}
            .task-time-date{font-size:11px;color:#8e8e93}
            
            .task-actions{
                grid-column:2;
                grid-row:1;
                display:flex;
                gap:6px;
                justify-content:flex-end;
            }
            .task-action-btn{width:34px;height:34px}
            .task-action-btn svg{width:16px;height:16px}
            
            .task-main-info{
                grid-column:1/-1;
                grid-row:2;
                display:flex;
                flex-wrap:wrap;
                align-items:center;
                gap:6px;
            }
            .task-action-text{font-size:14px;font-weight:500;margin-right:4px}
            .task-contact-link{font-size:12px;padding:4px 8px}
            .task-biz{font-size:11px;color:#8e8e93}
            .task-score{font-size:11px;padding:3px 6px;margin-left:auto}
            
            .task-status-wrap{
                grid-column:1/-1;
                grid-row:3;
                margin-top:4px;
            }
            .task-status-btn{
                width:100%;
                justify-content:center;
                padding:10px 14px;
                font-size:12px;
                border-radius:8px;
            }
            .task-status-dropdown{left:0;right:0;min-width:auto}
            
            /* Sections styling */
            .task-section{margin-bottom:12px}
            .task-section-header{font-size:11px;padding:6px 10px}
            
            /* Kanban - horizontal scroll */
            .kanban{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:16px;gap:10px;scroll-snap-type:x mandatory}
            .column{min-width:85vw;max-width:85vw;scroll-snap-align:start}
            .column-header{padding:10px 12px;font-size:13px}
            .column-count{font-size:11px;padding:2px 6px}
            .column-cards{padding:8px;gap:8px;max-height:60vh}
            
            /* Kanban cards */
            .k-card{padding:10px}
            .k-card-name{font-size:13px}
            .k-card-biz{font-size:11px}
            .k-card-footer{font-size:11px}
            .k-card-tags{gap:4px;margin-top:6px}
            .k-tag{font-size:10px;padding:3px 6px}
            .score{font-size:11px}
            
            /* Kanban filters */
            .kanban-filters{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;gap:6px;padding-bottom:8px}
            .filter-btn{padding:6px 10px;font-size:11px;white-space:nowrap;flex-shrink:0}
            
            /* Reports */
            .reports-header{gap:12px}
            .reports-controls{width:100%}
            .reports-period-btns{width:100%;justify-content:center}
            .period-btn{flex:1;padding:8px 12px;font-size:12px;text-align:center}
            .reports-dates{width:100%;justify-content:center}
            .reports-dates input{width:100%;max-width:130px}
            .reports-summary{grid-template-columns:1fr 1fr;gap:10px}
            .summary-card{padding:14px}
            .summary-card-value{font-size:22px}
            .summary-card-label{font-size:12px}
            
            /* Reports table - horizontal scroll */
            .reports-table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
            .reports-table{font-size:12px;min-width:600px}
            .reports-table th,.reports-table td{padding:10px 12px}
            .reports-table th:first-child,.reports-table td:first-child{min-width:100px}
            
            /* Funnel */
            .reports-funnel{padding:16px}
            .reports-funnel-title{font-size:14px;margin-bottom:14px}
            .funnel-bar-header{font-size:12px}
            .funnel-progress{height:28px}
            
            /* Modal - full screen on mobile */
            .modal-bg{padding:0}
            .modal{width:100%;height:100%;max-height:100vh;border-radius:0;margin:0}
            .modal-head{padding:12px 16px;position:sticky;top:0;background:#fff;z-index:10;border-bottom:1px solid #e5e7eb}
            .modal-title{font-size:16px}
            .modal-body{padding:12px 16px;padding-bottom:80px;overflow-y:auto}
            .tabs{gap:0;margin-bottom:16px;overflow-x:auto;-webkit-overflow-scrolling:touch}
            .tab{padding:10px 14px;font-size:12px;white-space:nowrap}
            .quick-actions{flex-wrap:wrap;gap:6px}
            .quick-actions .btn{font-size:11px;padding:6px 10px}
            .form-group{margin-bottom:12px}
            .form-label{font-size:12px;margin-bottom:4px}
            .form-input,.form-select,.form-textarea{padding:10px 12px;font-size:14px}
            .modal-foot{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;background:#fff;border-top:1px solid #e5e7eb;gap:8px}
            .modal-foot .btn{flex:1;padding:12px;font-size:14px}
            
            /* Quick Action Panel */
            .quick-panel{width:100%;max-width:100vw;right:-100%}
            .quick-panel.active{right:0}
            .quick-panel-header{padding:14px 16px}
            .quick-panel-body{padding:16px}
            .quick-section-title{font-size:13px}
            .quick-btn{padding:12px;font-size:13px}
            
            /* Team Modal */
            .team-modal-content{width:95%;max-width:none;margin:10px;max-height:85vh}
            .team-modal-body{padding:16px}
            .team-member{padding:10px}
            .team-member-avatar{width:36px;height:36px;font-size:14px}
            .team-member-email{font-size:13px}
            .team-invite-btns{flex-direction:column}
            .team-invite-btns .btn{width:100%;justify-content:center}
            
            /* Settings Panel - full screen */
            .settings-panel{width:100%}
            .settings-header{padding:14px 16px}
            .settings-title{font-size:16px}
            .settings-body{padding:16px}
            .settings-section{margin-bottom:20px}
            .settings-section-title{font-size:13px}
            .status-item{padding:10px}
            .status-name input{font-size:13px}
            .status-action-btn{width:32px;height:32px}
            .funnel-item{padding:10px}
            .funnel-item-name{font-size:13px}
            .funnel-item-meta{font-size:11px}
            .assignment-mode{padding:12px}
            .assignment-mode-title{font-size:13px}
            .assignment-mode-desc{font-size:11px}
            
            /* Auth screen */
            .auth-headline{font-size:28px}
            .auth-subtitle{font-size:15px}
            .auth-buttons{flex-direction:column;gap:12px}
            .auth-btn-primary,.auth-btn-secondary{width:100%;justify-content:center}
            .auth-features{flex-direction:column;gap:12px}
            .auth-box{padding:24px;margin:10px}
            
            /* Org selector */
            .org-selector-btn{padding:6px 10px;font-size:12px}
            .org-dropdown{min-width:260px;right:0;left:auto}
            .org-dropdown-item{padding:10px}
            
            /* Color picker */
            .color-picker-popup{left:10px!important;right:10px!important;width:auto}
            .color-grid{grid-template-columns:repeat(6,1fr)}
            .color-option{width:32px;height:32px}
            
            /* AI Panel */
            .ai-panel{width:100%;max-width:100vw}
            .ai-panel-body{padding:16px}
            .ai-suggestion{padding:14px}
            
            /* Floating buttons - above mobile nav */
            .ai-fab{bottom:90px;right:16px;width:46px;height:46px}
            .help-btn{bottom:145px;right:16px;width:46px;height:46px}
            
            /* Hide non-essential on very small screens */
            .score-bar{display:none}
            .k-card-amount{font-size:11px}
        }
        
        /* Extra small (360px) */
        @media(max-width:360px){
            .nav-btn{padding:6px 8px;font-size:11px}
            .tasks-title{font-size:16px}
            .column{min-width:90vw}
            .reports-summary{grid-template-columns:1fr}
            .period-btn{padding:6px 8px;font-size:11px}
        }
        
        /* Touch-friendly improvements */
        @media(hover:none) and (pointer:coarse){
            .btn,.nav-btn,.filter-btn,.filter-pill,.tab,.task-card,.k-card,.status-item,.funnel-item,.assignment-mode{
                min-height:44px
            }
            .task-action-btn,.status-action-btn{
                min-width:44px;min-height:44px
            }
            .form-input,.form-select,.form-textarea{
                font-size:16px; /* Prevents zoom on iOS */
                padding:8px 10px !important;
                min-height:auto !important;
            }
            .form-textarea{
                min-height:60px !important;
            }
            .form-row{
                gap:8px !important;
            }
            .form-group{
                margin-bottom:8px !important;
            }
            .form-label{
                font-size:11px !important;
                margin-bottom:3px !important;
            }
        }
        
        /* Safe area for notched phones */
        @supports(padding:max(0px)){
            .header{padding-top:max(8px,env(safe-area-inset-top))}
            .modal-foot{padding-bottom:max(12px,env(safe-area-inset-bottom))}
            .settings-panel{padding-bottom:env(safe-area-inset-bottom)}
            .mobile-nav{padding-bottom:max(12px,env(safe-area-inset-bottom))}
        }
        
        /* Mobile Bottom Navigation */
        .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #e5e7eb;padding:8px 0 12px;z-index:100;box-shadow:0 -4px 20px rgba(0,0,0,0.08)}
        .mobile-nav-items{display:flex;justify-content:space-around;align-items:center;max-width:500px;margin:0 auto}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 16px;border:none;background:none;color:#6b7280;font-size:10px;cursor:pointer;border-radius:8px;transition:all .2s}
        .mobile-nav-item svg{width:22px;height:22px}
        .mobile-nav-item.active{color:#22c55e}
        .mobile-nav-item.active svg{stroke-width:2.5}
        .mobile-nav-item:active{background:#f3f4f6}
        .mobile-nav-badge{position:absolute;top:-2px;right:-2px;background:#ef4444;color:#fff;font-size:9px;font-weight:600;padding:2px 5px;border-radius:10px;min-width:16px;text-align:center}
        .mobile-nav-item-wrap{position:relative}
        .mobile-nav-add{width:48px;height:48px;background:linear-gradient(135deg,#22c55e,#16a34a);border:none;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(34,197,94,0.4);margin-top:-20px}
        .mobile-nav-add svg{width:24px;height:24px}
        .mobile-nav-add:active{transform:scale(0.95)}
        
        /* Mobile Menu */
        .mobile-menu-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:150}
        .mobile-menu-overlay.active{display:block}
        .mobile-menu{position:fixed;bottom:0;left:0;right:0;background:#fff;border-radius:20px 20px 0 0;z-index:151;transform:translateY(100%);transition:transform .3s ease;max-height:80vh;overflow-y:auto}
        .mobile-menu.active{transform:translateY(0)}
        .mobile-menu-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid #e5e7eb}
        .mobile-menu-title{font-size:16px;font-weight:600;color:#1f2937}
        .mobile-menu-close{width:36px;height:36px;border:none;background:#f3f4f6;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .mobile-menu-items{padding:12px}
        .mobile-menu-item{display:flex;align-items:center;gap:14px;width:100%;padding:14px 16px;border:none;background:none;color:#374151;font-size:15px;cursor:pointer;border-radius:10px;text-decoration:none}
        .mobile-menu-item:active{background:#f3f4f6}
        .mobile-menu-item svg{width:22px;height:22px;color:#6b7280}
        .mobile-menu-item.logout{color:#ef4444}
        .mobile-menu-item.logout svg{color:#ef4444}
        .mobile-menu-divider{height:1px;background:#e5e7eb;margin:8px 16px}
        .mobile-menu-user{padding:8px 16px;font-size:13px;color:#6b7280}
        
        /* Offline Banner */
        .offline-banner{position:fixed;top:0;left:0;right:0;background:#ef4444;color:#fff;padding:10px 16px;text-align:center;font-size:14px;font-weight:500;z-index:10000;display:none;align-items:center;justify-content:center;gap:8px}
        .offline-banner.active{display:flex}
        .offline-banner svg{flex-shrink:0}
        .online-restored{background:#059669}
        
        @media(max-width:480px){
            .mobile-nav{display:block}
            .header .nav{display:none}
            .container{padding-bottom:80px}
            .modal-body{padding-bottom:100px}
        }
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div id="offline-banner" class="offline-banner">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55"/><path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39"/><path d="M10.71 5.05A16 16 0 0 1 22.58 9"/><path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>
        <span>Немає з'єднання з інтернетом</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);z-index:9999;justify-content:center;align-items:center;flex-direction:column;">
        <div style="color:#22c55e;margin-bottom:10px;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div style="color:#525252;">Завантаження...</div>
    </div>
    
    <!-- Auth Screen - Premium Landing -->
    <div class="auth-screen" id="auth-screen">
        <div class="auth-container">
            <!-- Logo -->
            <div class="auth-logo-wrap">
                <div class="auth-logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="auth-logo-text">TALKO CRM</div>
            </div>
            
            <!-- Headline -->
            <h1 class="auth-headline">
                <span class="green">AI закриває угоди,</span><br>
                <span class="white">поки ви п'єте каву</span>
            </h1>
            
            <!-- Subtitle -->
            <p class="auth-subtitle">
                Скоринг лідів, генерація скриптів, автоматичні нагадування.<br>
                Менеджер працює ефективніше. Ви контролюєте воронку.
            </p>
            
            <!-- Tagline -->
            <p class="auth-tagline">Не здогадуватись хто купить. Знати.</p>
            
            <!-- Buttons -->
            <div class="auth-buttons">
                <button class="auth-btn-primary" onclick="openAuthModal('login')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                    Увійти в систему
                </button>
                <button class="auth-btn-secondary" onclick="window.open('https://calendly.com/management-talco/meet-with-me', '_blank')">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Записатися на демо
                </button>
            </div>
            
            <!-- Features -->
            <div class="auth-features">
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    AI-скоринг лідів
                </div>
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Автоматичні скрипти
                </div>
                <div class="auth-feature">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Синхронізація в реальному часі
                </div>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-box">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            <div class="auth-box-title" id="auth-title">Вхід в систему</div>
            <div class="auth-box-subtitle" id="auth-subtitle-text">Введіть дані вашого акаунту</div>
            <div class="auth-error" id="auth-error"></div>
            <input type="email" class="auth-input" id="auth-email" placeholder="Email">
            <input type="password" class="auth-input" id="auth-password" placeholder="Пароль">
            <button class="auth-submit" id="auth-btn" onclick="handleAuth()">Увійти</button>
            <div class="auth-switch" id="auth-switch">
                Немає акаунту? <a onclick="toggleAuthMode()">Зареєструватися</a>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" style="display:none">
    <header class="header">
        <div class="header-content">
            <div class="logo">TALKO CRM</div>
            <nav class="nav">
                <button class="nav-btn active" onclick="switchView('tasks')">Завдання</button>
                <button class="nav-btn" onclick="switchView('kanban')">Kanban</button>
                <button class="nav-btn" onclick="switchView('reports')">Звіти</button>
            </nav>
            <div class="actions">
                <button class="btn btn-s" id="team-btn" onclick="openTeamModal()" style="display:none" title="Команда">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </button>
                <button class="btn btn-s" id="settings-btn" onclick="openSettingsPanel()" style="display:none" title="Налаштування">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
                <button class="btn btn-p" onclick="openModal()">+ Додати</button>
                <label class="btn btn-s">Імпорт<input type="file" accept=".xlsx,.xls" onchange="importXLS(event)" hidden></label>
                <button class="btn btn-s" onclick="exportXLS()">Експорт</button>
                <button class="btn btn-s" style="background:#fef3c7;color:#92400e" onclick="loadDemo()"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><circle cx="17" cy="12" r="1"/></svg> Демо</button>
                <div class="sync-status" id="sync-status"><div class="sync-dot" id="sync-dot"></div><span id="sync-text">Синхронізовано</span></div>
                <a href="https://chatgpt.com/g/g-695d18d64ffc8191885772ca62dfb66c-talko-crm-support" target="_blank" class="btn btn-s" style="background:linear-gradient(135deg,#10a37f,#1a7f5a);color:#fff;text-decoration:none">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><path d="M9 21h6"/><path d="M9 18h6"/></svg>
                    AI Підтримка
                </a>
                <div class="user-menu">
                    <span class="user-email" id="user-email"></span>
                    <button class="btn btn-s user-btn" onclick="logout()">Вийти</button>
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <!-- Funnel Selector Bar -->
        <div class="funnel-bar" id="funnel-bar" style="display:none">
            <div class="funnel-selector" id="funnel-selector">
                <button class="funnel-selector-btn" onclick="toggleFunnelDropdown()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    <span id="current-funnel-label">Всі воронки</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="funnel-dropdown" id="funnel-dropdown">
                    <div class="funnel-dropdown-item active" onclick="selectFunnel(null)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                        Всі воронки
                    </div>
                    <div class="funnel-dropdown-divider"></div>
                    <div id="funnel-dropdown-list"></div>
                </div>
            </div>
            <div class="assignee-filter funnel-selector" id="assignee-filter">
                <button class="funnel-selector-btn" onclick="toggleAssigneeDropdown()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span id="current-assignee-label">Всі менеджери</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="funnel-dropdown" id="assignee-dropdown">
                    <div class="funnel-dropdown-item active" onclick="selectAssignee(null)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Всі менеджери
                    </div>
                    <div class="funnel-dropdown-item" onclick="selectAssignee('mine')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Мої ліди
                    </div>
                    <div class="funnel-dropdown-divider"></div>
                    <div id="assignee-dropdown-list"></div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div class="search-box" id="search-box">
                <svg class="search-box-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="search-input" placeholder="Пошук... (Ctrl+K)" oninput="handleSearch(this.value)" autocomplete="off">
                <button class="search-box-clear" onclick="clearSearch()" title="Очистити">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <!-- Source Filter -->
            <div class="funnel-selector" id="source-filter">
                <button class="funnel-selector-btn" onclick="toggleSourceDropdown()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    <span id="current-source-label">Всі джерела</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="funnel-dropdown" id="source-dropdown">
                    <div class="funnel-dropdown-item active" onclick="selectSource(null)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                        Всі джерела
                    </div>
                    <div class="funnel-dropdown-divider"></div>
                    <div id="source-dropdown-list"></div>
                </div>
            </div>
            
            <!-- Date Filter -->
            <div class="funnel-selector" id="date-filter">
                <button class="funnel-selector-btn" onclick="toggleDateDropdown()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span id="current-date-label">Весь час</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="funnel-dropdown" id="date-dropdown">
                    <div class="funnel-dropdown-item active" onclick="selectDateFilter(null)">Весь час</div>
                    <div class="funnel-dropdown-divider"></div>
                    <div class="funnel-dropdown-item" onclick="selectDateFilter('today')">Сьогодні</div>
                    <div class="funnel-dropdown-item" onclick="selectDateFilter('week')">Цей тиждень</div>
                    <div class="funnel-dropdown-item" onclick="selectDateFilter('month')">Цей місяць</div>
                    <div class="funnel-dropdown-item" onclick="selectDateFilter('quarter')">Цей квартал</div>
                </div>
            </div>
            
            <!-- Clear All Filters -->
            <button class="btn btn-s" id="clear-filters-btn" onclick="clearAllFilters()" style="display:none" title="Скинути всі фільтри">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                Скинути
            </button>
            
            <!-- Export Button -->
            <button class="btn btn-s" onclick="exportLeadsToCSV()" title="Експорт в Excel (Ctrl+E)">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Експорт
            </button>
        </div>
        
        <!-- Tasks View -->
        <div class="view active" id="v-tasks">
            <div class="tasks-header">
                <h1 class="tasks-title">Що робити зараз<span class="tasks-count" id="task-count">0</span></h1>
            </div>
            <div class="tasks-filters" id="tasks-filters">
                <button class="filter-pill active" onclick="setTaskFilter('all')">Всі</button>
                <button class="filter-pill" onclick="setTaskFilter('critical')">Прострочені</button>
                <!-- Статуси з Kanban додаються динамічно -->
            </div>
            <div id="tasks-list"></div>
        </div>
        
        <!-- Kanban View -->
        <div class="view" id="v-kanban">
            <!-- Bulk Actions Bar -->
            <div class="bulk-bar" id="bulk-bar">
                <span class="bulk-count"><span id="bulk-count">0</span> вибрано</span>
                <div class="bulk-actions">
                    <button class="bulk-btn" onclick="bulkAssign()">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        Призначити
                    </button>
                    <button class="bulk-btn" onclick="bulkChangeStatus()">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                        Змінити статус
                    </button>
                    <button class="bulk-btn" onclick="bulkSetNextDate()">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        Встановити дату
                    </button>
                    <button class="bulk-btn danger" onclick="bulkDelete()">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Видалити
                    </button>
                </div>
                <button class="bulk-close" onclick="clearBulkSelection()" title="Скасувати вибір">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            
            <div class="kanban-filters" id="kanban-filters">
                <button class="filter-btn active" onclick="setFilter('all')">Всі</button>
                <button class="filter-btn" onclick="setFilter('critical')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> Критичні</button>
                <button class="filter-btn" onclick="setFilter('today')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Сьогодні</button>
                <button class="filter-btn" onclick="setFilter('tomorrow')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Завтра</button>
                <button class="filter-btn" onclick="setFilter('action')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Дія сьогодні</button>
                <button class="filter-btn" onclick="setFilter('money')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Чекають оплату</button>
            </div>
            <div class="kanban" id="kanban"></div>
        </div>
        
        <!-- Reports View -->
        <div class="view" id="v-reports">
            <div class="reports-header">
                <h1 class="tasks-title">Аналітика</h1>
                <div class="reports-controls">
                    <div class="reports-period-btns">
                        <button class="period-btn active" onclick="setReportPeriod('week', this)">Тиждень</button>
                        <button class="period-btn" onclick="setReportPeriod('month', this)">Місяць</button>
                        <button class="period-btn" onclick="setReportPeriod('quarter', this)">Квартал</button>
                    </div>
                    <div class="reports-dates">
                        <input type="date" id="date-from" class="form-input" onchange="renderReports()">
                        <span style="color:#9ca3af">—</span>
                        <input type="date" id="date-to" class="form-input" onchange="renderReports()">
                    </div>
                    <button class="btn btn-p" onclick="exportReport()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Експорт
                    </button>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="reports-summary" id="reports-summary"></div>
            
            <!-- Analytics Charts -->
            <div class="analytics-grid">
                <!-- Leads by Day Chart -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div>
                            <div class="chart-card-title">Нові ліди по днях</div>
                            <div class="chart-card-subtitle">Динаміка надходження</div>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-leads-by-day"></div>
                </div>
                
                <!-- Conversion Funnel -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div>
                            <div class="chart-card-title">Воронка конверсії</div>
                            <div class="chart-card-subtitle">Від ліда до оплати</div>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-conversion-funnel"></div>
                </div>
                
                <!-- Revenue Chart -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div>
                            <div class="chart-card-title">Виручка по днях</div>
                            <div class="chart-card-subtitle">Оплачені угоди</div>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-revenue"></div>
                </div>
                
                <!-- Sources Pie -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div>
                            <div class="chart-card-title">Джерела лідів</div>
                            <div class="chart-card-subtitle">Розподіл по каналах</div>
                        </div>
                    </div>
                    <div class="chart-container" id="chart-sources"></div>
                </div>
            </div>
            
            <!-- Main Content: Table + Funnel -->
            <div class="reports-grid">
                <!-- Stats Table -->
                <div class="reports-table-wrap">
                    <div class="reports-section-title">Детальна статистика</div>
                    <table class="reports-table" id="reports-table">
                        <thead id="reports-thead"></thead>
                        <tbody id="reports-tbody"></tbody>
                    </table>
                </div>
                
                <!-- Visual Funnel -->
                <div class="reports-funnel-visual" id="reports-funnel-visual"></div>
            </div>
            
            <!-- Old Bar Funnel (hidden for now) -->
            <div class="reports-funnel" id="reports-funnel" style="display:none"></div>
        </div>
    </main>
    
    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav" id="mobile-nav">
        <div class="mobile-nav-items">
            <div class="mobile-nav-item-wrap">
                <button class="mobile-nav-item active" onclick="mobileNav('tasks')" id="mnav-tasks">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    Завдання
                </button>
                <span class="mobile-nav-badge" id="mnav-tasks-badge" style="display:none">0</span>
            </div>
            <button class="mobile-nav-item" onclick="mobileNav('kanban')" id="mnav-kanban">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                Kanban
            </button>
            <button class="mobile-nav-add" onclick="openModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </button>
            <button class="mobile-nav-item" onclick="mobileNav('reports')" id="mnav-reports">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                Звіти
            </button>
            <button class="mobile-nav-item" onclick="openMobileMenu()" id="mnav-more">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                Ще
            </button>
        </div>
    </nav>
    
    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-menu" id="mobile-menu">
        <div class="mobile-menu-header">
            <span class="mobile-menu-title">Меню</span>
            <button class="mobile-menu-close" onclick="closeMobileMenu()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="mobile-menu-items">
            <button class="mobile-menu-item" onclick="openTeamModal();closeMobileMenu()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Команда
            </button>
            <button class="mobile-menu-item" onclick="openSettingsPanel();closeMobileMenu()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Налаштування
            </button>
            <a class="mobile-menu-item" href="https://chatgpt.com/g/g-695d18d64ffc8191885772ca62dfb66c-talko-crm-support" target="_blank">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><path d="M9 21h6"/></svg>
                AI Підтримка
            </a>
            <div class="mobile-menu-divider"></div>
            <div class="mobile-menu-user">
                <span id="mobile-user-email"></span>
            </div>
            <button class="mobile-menu-item logout" onclick="logout()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                Вийти
            </button>
        </div>
    </div>
    
    <!-- Lead Modal -->
    <div class="modal-bg" id="modal">
        <div class="modal">
            <div class="modal-head">
                <span class="modal-title" id="modal-title">Новий лід</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('main')">Основне</button>
                    <button class="tab" onclick="switchTab('history')">Історія</button>
                    <button class="tab" onclick="switchTab('links')">Посилання</button>
                    <button class="tab" onclick="switchTab('finance')">Фінанси</button>
                </div>
                
                <div class="tab-content active" id="t-main">
                    <input type="hidden" id="f-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Воронка</label>
                            <select class="form-select" id="f-funnel" onchange="onFunnelChange()">
                                <!-- Воронки генеруються динамічно -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Відповідальний</label>
                            <select class="form-select" id="f-assignee">
                                <option value="">Не призначено</option>
                                <!-- Члени команди генеруються динамічно -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="f-status" onchange="onStatusChange()">
                                <!-- Статуси генеруються динамічно -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Не прийшов</label>
                            <select class="form-select" id="f-noshow">
                                <option value="0">Ні</option>
                                <option value="1">1 раз</option>
                                <option value="2">2 рази</option>
                                <option value="3">3 рази</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Телеграм</label>
                            <input class="form-input" id="f-tg" placeholder="@username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Телефон</label>
                            <input class="form-input" id="f-phone" placeholder="+380...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Viber</label>
                            <input class="form-input" id="f-viber" placeholder="+380... (якщо інший)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">WhatsApp</label>
                            <input class="form-input" id="f-whatsapp" placeholder="+380... (якщо інший)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input class="form-input" id="f-email" type="email" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Основний канал</label>
                            <select class="form-select" id="f-primary-channel">
                                <option value="phone">Телефон</option>
                                <option value="tg">Telegram</option>
                                <option value="viber">Viber</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Бізнес</label>
                            <input class="form-input" id="f-biz" placeholder="Стоматологія-15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Джерело</label>
                            <select class="form-select" id="f-source">
                                <option value="">—</option>
                                <!-- Options generated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Дата консультації</label>
                            <input type="datetime-local" class="form-input" id="f-consult">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Повторних</label>
                            <select class="form-select" id="f-repeat"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Дзвінки</label>
                            <select class="form-select" id="f-calls"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SMS</label>
                            <select class="form-select" id="f-sms"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Наступна дія</label>
                            <input type="date" class="form-input" id="f-next">
                        </div>
                        <div class="form-group" style="max-width:120px">
                            <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Час</label>
                            <input type="time" class="form-input" id="f-next-time" value="10:00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>Що зробити</label>
                        <input class="form-input" id="f-action" placeholder="Подзвонити, уточнити рішення..." style="font-weight:500">
                    </div>
                    <div class="form-group" id="report-group" style="display:none">
                        <label class="form-label">Звіт консультації</label>
                        <textarea class="form-textarea" id="f-report" placeholder="Основні болі клієнта, заперечення, що цікавило, готовність до оплати..." style="min-height:120px"></textarea>
                        <div class="form-hint">Детальний звіт = кращі підказки від ШІ</div>
                    </div>
                    <div class="form-group" id="fail-group" style="display:none">
                        <label class="form-label">Причина відмови</label>
                        <select class="form-select" id="f-fail">
                            <option value="">—</option>
                            <option value="expensive">Дорого</option>
                            <option value="no_time">Немає часу</option>
                            <option value="competitor">Конкурент</option>
                            <option value="no_answer">Не відповідає</option>
                            <option value="other">Інше</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Примітки</label>
                        <textarea class="form-textarea" id="f-notes" placeholder="..."></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="t-history">
                    <div class="comm-log" id="comm-log"></div>
                    <div class="comm-add">
                        <select class="form-select" id="comm-type"><option value="call">Дзвінок</option><option value="sms">SMS</option><option value="note">Нотатка</option></select>
                        <input class="form-input" id="comm-text" placeholder="Коментар...">
                        <button class="btn btn-p" onclick="addComm()">+</button>
                    </div>
                </div>
                
                <div class="tab-content" id="t-links">
                    <div class="links-grid">
                        <div class="link-item"><div class="link-label">Запис консультації</div><input class="link-input" id="l-record" placeholder="https://..."></div>
                        <div class="link-item"><div class="link-label">Звіт</div><input class="link-input" id="l-report" placeholder="https://docs..."></div>
                        <div class="link-item"><div class="link-label">КП</div><input class="link-input" id="l-kp" placeholder="https://..."></div>
                        <div class="link-item"><div class="link-label">Договір</div><input class="link-input" id="l-contract" placeholder="https://..."></div>
                    </div>
                </div>
                
                <div class="tab-content" id="t-finance">
                    <div class="form-group"><label class="form-label">Завдаток</label>
                        <div class="fin-row"><input type="number" class="form-input" id="fin-dep" placeholder="0"><select class="form-select" id="fin-dep-cur"><option>UAH</option><option>USD</option><option>EUR</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">Дата завдатку</label><input type="date" class="form-input" id="fin-dep-date"></div>
                    <div class="form-group"><label class="form-label">Повна сума</label>
                        <div class="fin-row"><input type="number" class="form-input" id="fin-total" placeholder="0"><select class="form-select" id="fin-total-cur"><option>UAH</option><option>USD</option><option>EUR</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">Дата оплати</label><input type="date" class="form-input" id="fin-paid-date"></div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-d" id="del-btn" style="display:none" onclick="delLeadForm()">Видалити</button>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-s" onclick="closeModal()">Скасувати</button>
                    <button class="btn btn-p" onclick="saveLeadForm()">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- AI Assistant Panel -->
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-head">
            <span style="display:flex;align-items:center;gap:8px"><svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="8" cy="14" r="1"/><circle cx="16" cy="14" r="1"/></svg> AI Асистент</span>
            <button class="ai-panel-close" onclick="toggleAI()">&times;</button>
        </div>
        <div class="ai-panel-body">
            <div class="ai-chat" id="ai-chat">
                <div class="ai-msg ai-msg-bot">Привіт! Я AI-асистент TALKO CRM. Можу допомогти з:
                    <br>• Генерація скриптів дзвінків
                    <br>• SMS шаблони під конкретного ліда
                    <br>• Аналіз звітів консультацій
                    <br>• Відповіді на заперечення
                    <br><br>Виберіть ліда та натисніть потрібну дію!</div>
            </div>
            <div class="ai-input-wrap">
                <select id="ai-lead-select" class="form-select" style="margin-bottom:8px">
                    <option value="">— Виберіть ліда —</option>
                </select>
                <div class="ai-quick-btns">
                    <button class="ai-quick-btn" onclick="aiAsk('script')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> Скрипт дзвінка</button>
                    <button class="ai-quick-btn" onclick="aiAsk('analysis')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21H4.6c-.56 0-.84 0-1.05-.11a1 1 0 0 1-.44-.44C3 20.24 3 19.96 3 19.4V3"/><path d="m7 14 4-4 4 4 6-6"/></svg> Аналіз</button>
                    <button class="ai-quick-btn" onclick="aiAsk('objections')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> СПІН</button>
                    <button class="ai-quick-btn" onclick="aiAsk('sms')"><svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-10 5L2 7"/></svg> SMS</button>
                </div>
                <div style="display:flex;gap:8px">
                    <input type="text" id="ai-input" class="form-input" placeholder="Або задайте своє питання..." onkeypress="if(event.key==='Enter')aiSend()">
                    <button class="btn btn-p" onclick="aiSend()"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- AI FAB Button -->
    <button class="ai-fab" onclick="toggleAI()"><svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="8" cy="14" r="1"/><circle cx="16" cy="14" r="1"/><path d="M9 18h6"/></svg></button>
    
    <!-- Help -->
    <button class="help-btn" onclick="toggleHelp()">?</button>
    <div class="help-panel" id="help">
        <div class="help-head"><span>Інструкція</span><button class="help-close" onclick="toggleHelp()">&times;</button></div>
        <div class="help-body">
            <div class="help-item"><span class="status-badge st-new">Новий</span><span>Подзвонити, призначити</span></div>
            <div class="help-item"><span class="status-badge st-scheduled">Призначена</span><span>Підтвердити за день</span></div>
            <div class="help-item"><span class="status-badge st-completed">Проведена</span><span>Чекати звіт</span></div>
            <div class="help-item"><span class="status-badge st-report_sent">Звіт</span><span>Дожимати до оплати</span></div>
            <div class="help-item"><span class="status-badge st-repeat">Повторна</span><span>Ще консультація</span></div>
            <div class="help-item"><span class="status-badge st-deposit">Завдаток</span><span>Повна оплата</span></div>
            <div class="help-item"><span class="status-badge st-paid">Оплачено</span><span>Закрито</span></div>
            <div class="help-item"><span class="status-badge st-failed">Неуспішна</span><span>+3 міс реактивація</span></div>
            <div style="margin-top:12px;padding:10px;background:var(--ol);border-radius:6px;font-size:12px">
                <b>Правила:</b><br>• Новий лід: макс 3 дзвінки<br>• Після звіту: 3 дзв + 3 SMS<br>• Неуспішна → реактивація 3 міс
            </div>
        </div>
    </div>

<!-- Quick Action Panel -->
<div class="quick-panel-overlay" onclick="closeQuickPanel()"></div>
<div class="quick-panel" id="quick-panel">
    <div class="quick-panel-header">
        <div class="quick-panel-title">Що сталось?</div>
        <button class="quick-panel-close" onclick="closeQuickPanel()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
    </div>
    
    <div class="quick-panel-lead" id="quick-lead-info">
        <div class="quick-lead-name" id="quick-lead-name">—</div>
        <div class="quick-lead-info">
            <span id="quick-lead-biz">—</span>
        </div>
        <div class="quick-lead-contacts" id="quick-lead-contacts"></div>
        <div style="margin-top:8px">
            <button class="btn btn-s" onclick="showMessageTemplates(quickLeadId)" style="font-size:11px">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Шаблони
            </button>
        </div>
        <div class="quick-lead-action" id="quick-lead-task">Завдання: —</div>
        <div class="quick-lead-notes" id="quick-lead-notes" style="display:none;margin-top:12px;padding:10px 12px;background:#fffbeb;border-left:3px solid #f59e0b;border-radius:6px;font-size:13px;color:#92400e;">
            <div style="font-weight:600;margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;">
                <span style="display:flex;align-items:center;gap:6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    Примітки/Звіт:
                </span>
                <button onclick="toggleNotesExpand()" id="notes-expand-btn" style="background:none;border:none;color:#b45309;cursor:pointer;font-size:12px;padding:2px 6px;">
                    Розгорнути ▼
                </button>
            </div>
            <div id="quick-lead-notes-text" style="max-height:80px;overflow:hidden;transition:max-height 0.3s;"></div>
        </div>
    </div>
    
    <div class="quick-panel-body">
        <!-- Confirm consultation section - shown if task is "Підтвердити консультацію" -->
        <div class="quick-section" id="quick-confirm-consult-section" style="display:none">
            <div class="quick-section-title" style="color:#22c55e">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/><path d="M9 16l2 2 4-4"/></svg>
                Підтвердження консультації
            </div>
            <div class="quick-buttons">
                <button class="quick-btn completed" onclick="confirmConsultation()" style="flex:1;justify-content:center">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Консультація підтверджена
                </button>
            </div>
            <div style="margin-top:12px;padding:12px;background:#f0fdf4;border-radius:8px;font-size:13px;color:#166534">
                Клієнт підтвердив що прийде на консультацію
            </div>
        </div>
        
        <!-- Outcome buttons -->
        <div class="quick-section" id="quick-outcome-section">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                Результат дзвінка
            </div>
            <div class="quick-buttons" id="quick-outcome-buttons">
                <button class="quick-btn answered" onclick="setQuickOutcome('answered')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Взяв трубку
                </button>
                <button class="quick-btn no-answer" onclick="setQuickOutcome('no_answer')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 2v4M8 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/><path d="M10 14l4 4m0-4l-4 4"/></svg>
                    Не взяв
                </button>
                <button class="quick-btn" onclick="setQuickOutcome('sms')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    SMS
                </button>
                <button class="quick-btn" onclick="setQuickOutcome('callback')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h7"/><path d="M18 2l4 4-10 10H8v-4L18 2z"/></svg>
                    Передзвонить
                </button>
            </div>
        </div>
        
        <!-- Comment section - shown after outcome -->
        <div class="quick-section" id="quick-comment-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Коментар до дзвінка
            </div>
            <textarea class="quick-note" id="quick-comment" placeholder="Що обговорили? Про що домовились?"></textarea>
        </div>
        
        <!-- Next action section - shown after outcome -->
        <div class="quick-section" id="quick-next-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Коли наступний контакт?
            </div>
            <div class="time-buttons" id="quick-time-buttons">
                <button class="time-btn" onclick="setQuickTime('30m')">
                    <span class="time">30 хв</span>
                    <span class="label">Скоро</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('2h')">
                    <span class="time">2 год</span>
                    <span class="label">Сьогодні</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('tomorrow_10')">
                    <span class="time">10:00</span>
                    <span class="label">Завтра</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('tomorrow_14')">
                    <span class="time">14:00</span>
                    <span class="label">Завтра</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('2d')">
                    <span class="time">+2 дні</span>
                    <span class="label">Післязавтра</span>
                </button>
                <button class="time-btn" onclick="setQuickTime('week')">
                    <span class="time">+тиждень</span>
                    <span class="label">Через 7 днів</span>
                </button>
                <button class="time-btn time-btn-custom" onclick="showCustomDateTime()">
                    <span class="time">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    </span>
                    <span class="label">Обрати дату</span>
                </button>
            </div>
            <!-- Custom date/time picker -->
            <div class="custom-datetime-picker" id="custom-datetime-picker" style="display:none">
                <div class="custom-datetime-row">
                    <div class="custom-datetime-field">
                        <label>Дата</label>
                        <input type="date" id="quick-custom-date">
                    </div>
                    <div class="custom-datetime-field">
                        <label>Час</label>
                        <input type="time" id="quick-custom-time" value="10:00">
                    </div>
                    <button class="custom-datetime-confirm" onclick="confirmCustomDateTime()">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Action type - shown after time -->
        <div class="quick-section" id="quick-action-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                Що зробити?
            </div>
            <div class="quick-buttons" id="quick-action-buttons">
                <button class="quick-btn" onclick="setQuickAction('Подзвонити')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    Подзвонити
                </button>
                <button class="quick-btn" onclick="setQuickAction('Написати SMS')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    SMS
                </button>
                <button class="quick-btn" onclick="setQuickAction('Підтвердити зустріч')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Підтвердити
                </button>
                <button class="quick-btn" onclick="setQuickAction('Уточнити рішення')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Уточнити
                </button>
                <button class="quick-btn" onclick="setQuickAction('Надіслати КП')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    Надіслати КП
                </button>
            </div>
            <textarea class="quick-note" id="quick-note" placeholder="Додаткові нотатки (необов'язково)..."></textarea>
        </div>
        
        <!-- Final actions -->
        <div class="quick-section" id="quick-final-section" style="display:none">
            <div class="quick-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                Фінальний результат
            </div>
            <div class="quick-buttons">
                <button class="quick-btn scheduled" onclick="setQuickFinal('scheduled')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                    Призначити консультацію
                </button>
                <button class="quick-btn completed" onclick="setQuickFinal('completed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Консультація проведена
                </button>
                <button class="quick-btn failed" onclick="setQuickFinal('failed')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>
                    Відмова
                </button>
            </div>
        </div>
        
        <!-- Confirm button -->
        <button class="quick-confirm" id="quick-confirm-btn" onclick="confirmQuickAction()" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            Зберегти
        </button>
    </div>
</div>

<!-- DateTime Picker Modal -->
<div class="datetime-modal-overlay" id="datetime-overlay" onclick="closeDateTimePicker()"></div>
<div class="datetime-modal" id="datetime-modal">
    <div class="datetime-header">
        <span id="datetime-title">Оберіть дату і час</span>
        <button class="datetime-close" onclick="closeDateTimePicker()">×</button>
    </div>
    <div class="datetime-body">
        <div class="datetime-row">
            <div class="datetime-field">
                <label>Дата</label>
                <input type="date" id="dt-date" class="datetime-input">
            </div>
            <div class="datetime-field">
                <label>Час</label>
                <select id="dt-time" class="datetime-input">
                    <option value="09:00">09:00</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="12:00">12:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00" selected>14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                    <option value="17:00">17:00</option>
                    <option value="18:00">18:00</option>
                    <option value="19:00">19:00</option>
                </select>
            </div>
        </div>
        <div class="datetime-quick">
            <button class="datetime-quick-btn" onclick="setQuickDate('today')">Сьогодні</button>
            <button class="datetime-quick-btn" onclick="setQuickDate('tomorrow')">Завтра</button>
            <button class="datetime-quick-btn" onclick="setQuickDate('+2')">+2 дні</button>
            <button class="datetime-quick-btn" onclick="setQuickDate('+7')">+1 тиждень</button>
        </div>
    </div>
    <div class="datetime-footer">
        <button class="btn btn-s" onclick="closeDateTimePicker()">Скасувати</button>
        <button class="btn btn-p" onclick="confirmDateTimePicker()">OK</button>
    </div>
</div>

<!-- Universal Input Modal (замість prompt) -->
<div class="datetime-modal-overlay" id="input-modal-overlay" onclick="closeInputModal()"></div>
<div class="datetime-modal" id="input-modal" style="max-width:380px">
    <div class="datetime-header">
        <span id="input-modal-title">Введіть значення</span>
        <button class="datetime-close" onclick="closeInputModal()">×</button>
    </div>
    <div class="datetime-body">
        <div id="input-modal-content">
            <!-- Контент генерується динамічно -->
        </div>
    </div>
    <div class="datetime-footer">
        <button class="btn btn-s" onclick="closeInputModal()">Скасувати</button>
        <button class="btn btn-p" id="input-modal-confirm" onclick="confirmInputModal()">OK</button>
    </div>
</div>

<!-- Confirm Modal (замість confirm) -->
<div class="datetime-modal-overlay" id="confirm-modal-overlay" onclick="closeConfirmModal(false)"></div>
<div class="datetime-modal" id="confirm-modal" style="max-width:360px">
    <div class="datetime-header">
        <span id="confirm-modal-title">Підтвердження</span>
        <button class="datetime-close" onclick="closeConfirmModal(false)">×</button>
    </div>
    <div class="datetime-body">
        <p id="confirm-modal-message" style="margin:0;color:#374151;line-height:1.5"></p>
    </div>
    <div class="datetime-footer">
        <button class="btn btn-s" id="confirm-modal-cancel" onclick="closeConfirmModal(false)">Скасувати</button>
        <button class="btn btn-p" id="confirm-modal-ok" onclick="closeConfirmModal(true)">Так</button>
    </div>
</div>

<!-- Team Modal -->
<div class="team-modal" id="team-modal">
    <div class="team-modal-content">
        <div class="team-modal-header">
            <div class="team-modal-title">Команда</div>
            <button class="btn btn-s" onclick="closeTeamModal()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="team-modal-body">
            <div id="team-list"></div>
            
            <div class="team-invite-section" id="team-invite-section">
                <div class="team-invite-title">Запросити нового учасника</div>
                <div class="team-invite-btns" id="team-invite-btns">
                    <!-- Кнопки генеруються динамічно в openTeamModal() -->
                </div>
                <p style="font-size:12px;color:#6b7280;margin-top:12px">
                    Після натискання буде створено посилання-запрошення, яке ви можете надіслати колезі
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Settings Panel (Google-style slide-in) -->
<div class="settings-overlay" id="settings-overlay" onclick="closeSettingsPanel()"></div>
<div class="settings-panel" id="settings-panel">
    <div class="settings-header">
        <div class="settings-title">Налаштування</div>
        <button class="settings-close" onclick="closeSettingsPanel()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
    </div>
    <div class="settings-body">
        <!-- Funnels Section -->
        <div class="settings-section">
            <div class="settings-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                Воронки продажів
            </div>
            <div class="funnel-list" id="funnel-list">
                <!-- Воронки генеруються динамічно -->
            </div>
            <button class="status-add-btn" onclick="addNewFunnel()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Додати воронку
            </button>
        </div>
        
        <!-- Status Editor Section (for selected funnel) -->
        <div class="settings-section" id="statuses-section">
            <div class="settings-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                Статуси воронки: <span id="current-funnel-name">—</span>
            </div>
            <div class="status-list" id="status-list">
                <!-- Статуси генеруються динамічно -->
            </div>
            <button class="status-add-btn" onclick="addNewStatus()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Додати статус
            </button>
        </div>
        
        <!-- Sources Editor Section -->
        <div class="settings-section">
            <div class="settings-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Джерела лідів
            </div>
            <div class="source-list" id="source-list">
                <!-- Джерела генеруються динамічно -->
            </div>
            <button class="status-add-btn" onclick="addNewSource()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Додати джерело
            </button>
        </div>
        
        <!-- Assignment Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Розподіл лідів
            </div>
            <div class="assignment-modes">
                <label class="assignment-mode">
                    <input type="radio" name="assignment-mode" value="manual" onchange="setAssignmentMode('manual')">
                    <div class="assignment-mode-content">
                        <div class="assignment-mode-title">Ручний</div>
                        <div class="assignment-mode-desc">Призначати вручну кожного ліда</div>
                    </div>
                </label>
                <label class="assignment-mode">
                    <input type="radio" name="assignment-mode" value="round-robin" onchange="setAssignmentMode('round-robin')">
                    <div class="assignment-mode-content">
                        <div class="assignment-mode-title">Round-robin</div>
                        <div class="assignment-mode-desc">Автоматично по черзі між менеджерами</div>
                    </div>
                </label>
                <label class="assignment-mode">
                    <input type="radio" name="assignment-mode" value="by-funnel" onchange="setAssignmentMode('by-funnel')">
                    <div class="assignment-mode-content">
                        <div class="assignment-mode-title">По воронках</div>
                        <div class="assignment-mode-desc">Дефолтний відповідальний для кожної воронки</div>
                    </div>
                </label>
            </div>
            
            <!-- Round-robin queue (shown when round-robin selected) -->
            <div class="rr-queue-section" id="rr-queue-section" style="display:none">
                <div class="rr-queue-title">Черга розподілу:</div>
                <div class="rr-queue-list" id="rr-queue-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Color Picker Popup -->
<div class="color-picker-popup" id="color-picker">
    <div class="color-grid" id="color-grid"></div>
</div>

<script>
// ===== GLOBAL ERROR HANDLER =====
window.onerror = function(message, source, lineno, colno, error) {
    console.error('Global error:', { message, source, lineno, colno, error });
    // Спробуємо залогувати якщо logError вже існує
    if (typeof logError === 'function') {
        logError('global', error || message, { source, lineno, colno });
    }
    return false; // Продовжуємо стандартну обробку
};

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    if (typeof logError === 'function') {
        logError('promise', event.reason);
    }
});

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyCunQezswxYZyjSscD4b7Hg30YRWZ9zA-Y",
    authDomain: "talko-crm.firebaseapp.com",
    projectId: "talko-crm",
    storageBucket: "talko-crm.firebasestorage.app",
    messagingSenderId: "1090643937646",
    appId: "1:1090643937646:web:5607640c57fe9f4192597f"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ===== SUPER ADMIN CONFIG =====
// FIX: Super Admin emails - можна також завантажувати з Firestore collection 'config'
// Для динамічного налаштування створіть документ db.collection('config').doc('superadmins')
// з полем emails: ['email1@example.com', 'email2@example.com']
let SUPER_ADMIN_EMAILS = ['management.talco@gmail.com'];

// Функція для завантаження Super Admin з Firestore (опціонально)
async function loadSuperAdminConfig() {
    try {
        const configDoc = await db.collection('config').doc('superadmins').get();
        if(configDoc.exists && configDoc.data().emails) {
            SUPER_ADMIN_EMAILS = configDoc.data().emails;
            console.log('Super admin config loaded from Firestore');
        }
    } catch(e) {
        // Ігноруємо помилку - використовуємо дефолтний список
        console.log('Using default super admin config');
    }
}

// ===== BUSINESS CONSTANTS =====
const REACTIVATION_DAYS = 90;           // Днів до реактивації після відмови
const DEFAULT_FREEZE_MONTHS = 3;        // Місяців заморозки за замовчуванням
const DEPOSIT_REMINDER_DAYS = 7;        // Днів до нагадування про оплату після завдатку
const CONFIRM_BEFORE_DAYS = 1;          // За скільки днів підтверджувати консультацію
const NOSHOW_DELAYS = [7, 30, 90];      // Затримки після неявки (1-ша, 2-га, 3+ разів)

// ===== APP STATE =====
let currentUser = null;
let currentOrg = null;      // Поточна організація
let currentRole = null;     // owner | manager | employee | superadmin
let organizations = [];     // Список організацій (для superadmin)
let isAuthMode = 'login';
let unsubscribe = null;

// Funnel & Assignment state
let currentFunnelId = null;     // null = всі воронки
let currentAssigneeFilter = null; // null = всі, 'mine' = мої, userId = конкретний
let selectedFunnelForEdit = null; // Воронка яку редагуємо в налаштуваннях
let teamMembers = [];           // Кешований список членів команди
let currentSearchQuery = '';    // Поточний пошуковий запит
let currentSourceFilter = null; // Фільтр по джерелу
let currentDateFilter = null;   // Фільтр по даті: 'today', 'week', 'month', 'quarter'
let selectedLeadIds = new Set(); // Вибрані ліди для bulk actions

// ===== UTILITIES =====
function debounce(fn, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Валідація дати
function isValidDateTime(str) {
    if(!str) return false;
    const regex = /^\d{4}-\d{2}-\d{2}(T\d{2}:\d{2})?$/;
    if(!regex.test(str)) return false;
    const date = new Date(str);
    return !isNaN(date.getTime());
}

// DateTime Picker - замість prompt
let dateTimeCallback = null;

function promptDateTime(message, defaultValue) {
    return new Promise((resolve) => {
        const modal = document.getElementById('datetime-modal');
        const overlay = document.getElementById('datetime-overlay');
        const dateInput = document.getElementById('dt-date');
        const timeSelect = document.getElementById('dt-time');
        const title = document.getElementById('datetime-title');
        
        // Парсимо defaultValue (формат: YYYY-MM-DDTHH:MM)
        let defaultDate = tomorrow();
        let defaultTime = '14:00';
        if(defaultValue) {
            const parts = defaultValue.split('T');
            defaultDate = parts[0] || tomorrow();
            defaultTime = parts[1] || '14:00';
        }
        
        title.textContent = message || 'Оберіть дату і час';
        dateInput.value = defaultDate;
        timeSelect.value = defaultTime;
        
        dateTimeCallback = resolve;
        
        modal.classList.add('active');
        overlay.classList.add('active');
    });
}

function closeDateTimePicker() {
    document.getElementById('datetime-modal').classList.remove('active');
    document.getElementById('datetime-overlay').classList.remove('active');
    if(dateTimeCallback) {
        dateTimeCallback(null);
        dateTimeCallback = null;
    }
}

function confirmDateTimePicker() {
    const date = document.getElementById('dt-date').value;
    const time = document.getElementById('dt-time').value;
    
    document.getElementById('datetime-modal').classList.remove('active');
    document.getElementById('datetime-overlay').classList.remove('active');
    
    if(dateTimeCallback) {
        dateTimeCallback(date + 'T' + time);
        dateTimeCallback = null;
    }
}

function setQuickDate(option) {
    const dateInput = document.getElementById('dt-date');
    const now = new Date();
    
    if(option === 'today') {
        dateInput.value = today();
    } else if(option === 'tomorrow') {
        dateInput.value = tomorrow();
    } else if(option === '+2') {
        dateInput.value = addDays(today(), 2);
    } else if(option === '+7') {
        dateInput.value = addDays(today(), 7);
    }
}

// ===== UNIVERSAL INPUT MODAL (замість prompt) =====
let inputModalCallback = null;
let inputModalType = 'text';

/**
 * Універсальна модалка замість prompt()
 * @param {string} title - Заголовок
 * @param {string} defaultValue - Значення за замовчуванням
 * @param {Object} options - Додаткові опції
 * @param {string} options.type - 'text', 'number', 'textarea', 'select'
 * @param {string} options.placeholder - Placeholder
 * @param {Array} options.selectOptions - Опції для select [{value, label}]
 * @param {string} options.min - Мін значення для number
 * @param {string} options.max - Макс значення для number
 * @returns {Promise<string|null>}
 */
function promptModal(title, defaultValue = '', options = {}) {
    return new Promise((resolve) => {
        const modal = document.getElementById('input-modal');
        const overlay = document.getElementById('input-modal-overlay');
        const titleEl = document.getElementById('input-modal-title');
        const content = document.getElementById('input-modal-content');
        
        inputModalCallback = resolve;
        inputModalType = options.type || 'text';
        
        titleEl.textContent = title || 'Введіть значення';
        
        // Генеруємо контент залежно від типу
        let inputHtml = '';
        
        if(options.type === 'select' && options.selectOptions) {
            inputHtml = `<select id="input-modal-value" class="form-select" style="width:100%;padding:12px;font-size:15px">
                ${options.selectOptions.map(opt => 
                    `<option value="${opt.value}" ${opt.value == defaultValue ? 'selected' : ''}>${opt.label}</option>`
                ).join('')}
            </select>`;
        } else if(options.type === 'textarea') {
            inputHtml = `<textarea id="input-modal-value" class="form-textarea" 
                style="width:100%;min-height:100px;padding:12px;font-size:15px;resize:vertical"
                placeholder="${options.placeholder || ''}">${defaultValue}</textarea>`;
        } else if(options.type === 'number') {
            inputHtml = `<input type="number" id="input-modal-value" class="form-input" 
                style="width:100%;padding:12px;font-size:15px"
                value="${defaultValue}"
                placeholder="${options.placeholder || ''}"
                ${options.min !== undefined ? `min="${options.min}"` : ''}
                ${options.max !== undefined ? `max="${options.max}"` : ''}>`;
        } else {
            inputHtml = `<input type="text" id="input-modal-value" class="form-input" 
                style="width:100%;padding:12px;font-size:15px"
                value="${defaultValue}"
                placeholder="${options.placeholder || ''}">`;
        }
        
        content.innerHTML = inputHtml;
        
        modal.classList.add('active');
        overlay.classList.add('active');
        
        // Фокус на input
        setTimeout(() => {
            const input = document.getElementById('input-modal-value');
            if(input) {
                input.focus();
                if(input.select) input.select();
            }
        }, 100);
        
        // Enter для підтвердження
        const input = document.getElementById('input-modal-value');
        if(input && input.tagName !== 'TEXTAREA') {
            input.onkeydown = (e) => {
                if(e.key === 'Enter') confirmInputModal();
                if(e.key === 'Escape') closeInputModal();
            };
        }
    });
}

function closeInputModal() {
    document.getElementById('input-modal').classList.remove('active');
    document.getElementById('input-modal-overlay').classList.remove('active');
    if(inputModalCallback) {
        inputModalCallback(null);
        inputModalCallback = null;
    }
}

function confirmInputModal() {
    const input = document.getElementById('input-modal-value');
    const value = input ? input.value : '';
    
    document.getElementById('input-modal').classList.remove('active');
    document.getElementById('input-modal-overlay').classList.remove('active');
    
    if(inputModalCallback) {
        inputModalCallback(value);
        inputModalCallback = null;
    }
}

// ===== CONFIRM MODAL (замість confirm) =====
let confirmModalCallback = null;

/**
 * Красива модалка замість confirm()
 * @param {string} message - Повідомлення
 * @param {Object} options - Опції
 * @param {string} options.title - Заголовок (default: "Підтвердження")
 * @param {string} options.okText - Текст кнопки OK (default: "Так")
 * @param {string} options.cancelText - Текст кнопки Cancel (default: "Скасувати")
 * @param {boolean} options.danger - Червона кнопка OK для небезпечних дій
 * @returns {Promise<boolean>}
 */
function confirmModal(message, options = {}) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const overlay = document.getElementById('confirm-modal-overlay');
        const titleEl = document.getElementById('confirm-modal-title');
        const messageEl = document.getElementById('confirm-modal-message');
        const okBtn = document.getElementById('confirm-modal-ok');
        const cancelBtn = document.getElementById('confirm-modal-cancel');
        
        confirmModalCallback = resolve;
        
        titleEl.textContent = options.title || 'Підтвердження';
        messageEl.innerHTML = escapeHtml(message).replace(/\n/g, '<br>');
        okBtn.textContent = options.okText || 'Так';
        cancelBtn.textContent = options.cancelText || 'Скасувати';
        
        // Danger mode
        if(options.danger) {
            okBtn.style.background = '#ef4444';
        } else {
            okBtn.style.background = '';
        }
        
        modal.classList.add('active');
        overlay.classList.add('active');
        
        // Focus на OK кнопці
        setTimeout(() => okBtn.focus(), 100);
        
        // Escape для закриття
        const handleKeydown = (e) => {
            if(e.key === 'Escape') {
                closeConfirmModal(false);
                document.removeEventListener('keydown', handleKeydown);
            }
            if(e.key === 'Enter') {
                closeConfirmModal(true);
                document.removeEventListener('keydown', handleKeydown);
            }
        };
        document.addEventListener('keydown', handleKeydown);
    });
}

function closeConfirmModal(result) {
    document.getElementById('confirm-modal').classList.remove('active');
    document.getElementById('confirm-modal-overlay').classList.remove('active');
    if(confirmModalCallback) {
        confirmModalCallback(result);
        confirmModalCallback = null;
    }
}

// Loading overlay
function showLoading(text = 'Завантаження...') {
    const el = document.getElementById('loading-overlay');
    if(el) { 
        el.querySelector('div:last-child').textContent = text;
        el.style.display = 'flex'; 
    }
}
function hideLoading() {
    const el = document.getElementById('loading-overlay');
    if(el) el.style.display = 'none';
}

// ===== HELPER: Check if Super Admin =====
function isSuperAdmin(email) {
    return SUPER_ADMIN_EMAILS.includes(email?.toLowerCase());
}

// ===== AUTH MODAL FUNCTIONS =====
function openAuthModal(mode){
    isAuthMode = mode;
    updateAuthModal();
    document.getElementById('auth-modal').classList.add('active');
    document.getElementById('auth-email').focus();
}

function closeAuthModal(){
    document.getElementById('auth-modal').classList.remove('active');
    hideAuthError();
}

function toggleAuthMode(){
    isAuthMode = isAuthMode === 'login' ? 'register' : 'login';
    updateAuthModal();
    hideAuthError();
}

function updateAuthModal(){
    const title = document.getElementById('auth-title');
    const subtitle = document.getElementById('auth-subtitle-text');
    const btn = document.getElementById('auth-btn');
    const switchEl = document.getElementById('auth-switch');
    
    if(isAuthMode === 'login'){
        title.textContent = 'Вхід в систему';
        subtitle.textContent = 'Введіть дані вашого акаунту';
        btn.textContent = 'Увійти';
        switchEl.innerHTML = 'Немає акаунту? <a onclick="toggleAuthMode()">Зареєструватися</a>';
    } else {
        title.textContent = 'Реєстрація';
        subtitle.textContent = 'Створіть акаунт для доступу до системи';
        btn.textContent = 'Зареєструватися';
        switchEl.innerHTML = 'Вже є акаунт? <a onclick="toggleAuthMode()">Увійти</a>';
    }
}

function showAuthError(msg){
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
}

function hideAuthError(){
    document.getElementById('auth-error').style.display = 'none';
}

async function handleAuth(){
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    
    if(!email || !password){
        showAuthError('Введіть email та пароль');
        return;
    }
    
    const btn = document.getElementById('auth-btn');
    btn.disabled = true;
    btn.textContent = 'Зачекайте...';
    hideAuthError();
    
    try {
        if(isAuthMode === 'login'){
            await auth.signInWithEmailAndPassword(email, password);
        } else {
            await auth.createUserWithEmailAndPassword(email, password);
        }
    } catch(err){
        let msg = 'Помилка авторизації';
        if(err.code === 'auth/user-not-found') msg = 'Користувача не знайдено';
        if(err.code === 'auth/wrong-password') msg = 'Невірний пароль';
        if(err.code === 'auth/email-already-in-use') msg = 'Email вже зареєстровано';
        if(err.code === 'auth/weak-password') msg = 'Пароль занадто слабкий (мін. 6 символів)';
        if(err.code === 'auth/invalid-email') msg = 'Невірний формат email';
        showAuthError(msg);
        btn.disabled = false;
        btn.textContent = isAuthMode === 'login' ? 'Увійти' : 'Зареєструватися';
    }
}

async function logout(){
    const confirmed = await confirmModal('Вийти з акаунту?', {
        title: 'Вихід',
        okText: 'Вийти',
        cancelText: 'Залишитись'
    });
    if(confirmed) {
        auth.signOut();
    }
}

// ===== AUTH STATE LISTENER =====
auth.onAuthStateChanged(async (user) => {
    if(user){
        currentUser = user;
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('auth-modal').classList.remove('active');
        document.getElementById('user-email').textContent = user.email;
        
        showLoading('Завантаження даних...');
        
        try {
            if(isSuperAdmin(user.email)){
                currentRole = 'superadmin';
                await initSuperAdminMode();
            } else {
                await initUserMode();
            }
        } catch(err) {
            console.error('Init error:', err);
            showError('Помилка завантаження: ' + err.message);
        } finally {
            hideLoading();
        }
        
        document.getElementById('app').style.display = 'block';
    } else {
        currentUser = null;
        currentOrg = null;
        currentRole = null;
        leads = [];
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
        document.getElementById('auth-btn').disabled = false;
        document.getElementById('auth-btn').textContent = 'Увійти';
        hideAdminPanel();
        if(unsubscribe) { unsubscribe(); unsubscribe = null; }
    }
});

// ===== SUPER ADMIN MODE =====
async function initSuperAdminMode(){
    // Super Admin mode
    showAdminPanel();
    
    // Завантажуємо ВСІ організації для ADMIN панелі
    await loadOrganizations();
    
    // Шукаємо власну організацію Super Admin (де він є членом команди)
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    let ownOrgId = null;
    
    if(userDoc.exists && userDoc.data().organizationId){
        ownOrgId = userDoc.data().organizationId;
        currentRole = userDoc.data().role || 'owner';
    }
    
    // Super Admin працює ТІЛЬКИ зі своєю організацією
    if(ownOrgId){
        const orgDoc = await db.collection('organizations').doc(ownOrgId).get();
        if(orgDoc.exists){
            currentOrg = { id: orgDoc.id, ...orgDoc.data() };
            
            // Оновлюємо UI
            document.getElementById('org-selector-btn').innerHTML = `
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                ${escapeHtml(currentOrg.name || '')}
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            `;
            
            // Показуємо кнопки
            document.getElementById('team-btn').style.display = 'inline-flex';
            document.getElementById('settings-btn').style.display = 'inline-flex';
            document.getElementById('funnel-bar').style.display = 'flex';
            
            // Завантажуємо команду та ліди ТІЛЬКИ своєї організації
            loadTeamMembersForSettings();
            renderFunnelDropdown();
            initFirestoreListener();
        }
    } else {
        // Super Admin без власної організації - тільки ADMIN панель
        showSuperAdminOnlyMessage();
    }
}

function showSuperAdminOnlyMessage(){
    document.getElementById('v-tasks').innerHTML = `
        <div style="text-align:center;padding:60px 20px">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="#8b5cf6" stroke-width="1.5" style="margin:0 auto 20px">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            <h3 style="font-size:20px;font-weight:600;margin-bottom:8px;color:#1f2937">Режим Super Admin</h3>
            <p style="color:#6b7280;margin-bottom:16px">Використовуйте <strong>ADMIN</strong> панель для управління організаціями клієнтів.</p>
            <p style="color:#6b7280;margin-bottom:24px">Для роботи з власними лідами — створіть організацію і призначте себе власником.</p>
            <button class="btn btn-p" onclick="createOrgForSuperAdmin()" style="padding:12px 24px;font-size:15px">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Створити власну організацію
            </button>
        </div>
    `;
    document.getElementById('v-kanban').innerHTML = '';
    document.getElementById('v-reports').innerHTML = '';
}

async function createOrgForSuperAdmin(){
    const name = await promptModal('Назва вашої організації:', '', {
        placeholder: 'Моя компанія'
    });
    if(!name) return;
    
    try {
        // Створюємо організацію з Super Admin як Owner
        const orgRef = await db.collection('organizations').add({
            name: name,
            createdAt: new Date().toISOString(),
            createdBy: currentUser.uid,
            ownerEmail: currentUser.email,
            settings: {
                statuses: getDefaultStatuses(),
                funnels: [{
                    id: 'default',
                    name: 'Основна воронка',
                    statuses: getDefaultStatuses(),
                    isDefault: true
                }]
            }
        });
        
        // Зберігаємо зв'язок користувача з організацією
        await db.collection('users').doc(currentUser.uid).set({
            email: currentUser.email,
            organizationId: orgRef.id,
            role: 'owner',
            joinedAt: new Date().toISOString()
        });
        
        // Додаємо в team
        await db.collection('organizations').doc(orgRef.id).collection('team').doc(currentUser.uid).set({
            id: currentUser.uid,
            email: currentUser.email,
            role: 'owner',
            status: 'active',
            joinedAt: new Date().toISOString()
        });
        
        showToast('Організацію створено! Сторінка перезавантажиться.');
        setTimeout(() => location.reload(), 1500);
        location.reload();
        
    } catch(err) {
        console.error(err);
        showError(err.message);
    }
}

// ===== USER MODE =====
async function initUserMode(){
    // User mode
    hideAdminPanel();
    
    // Шукаємо організацію користувача
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    
    if(userDoc.exists){
        const userData = userDoc.data();
        if(userData.organizationId){
            currentOrg = { id: userData.organizationId };
            currentRole = userData.role || 'employee';
            
            // Завантажуємо дані організації
            const orgDoc = await db.collection('organizations').doc(userData.organizationId).get();
            if(orgDoc.exists){
                currentOrg = { id: orgDoc.id, ...orgDoc.data() };
            }
            
            // Показуємо кнопку команди для Owner та Manager
            if(currentRole === 'owner' || currentRole === 'manager'){
                document.getElementById('team-btn').style.display = 'inline-flex';
            }
            
            // Показуємо кнопку налаштувань для Owner
            if(currentRole === 'owner'){
                document.getElementById('settings-btn').style.display = 'inline-flex';
            }
            
            // Показуємо funnel-bar
            document.getElementById('funnel-bar').style.display = 'flex';
            
            // Завантажуємо команду для фільтрів
            loadTeamMembersForSettings();
            
            // Рендеримо dropdown воронок
            renderFunnelDropdown();
            
            initFirestoreListener();
        } else {
            showNoOrgMessage();
        }
    } else {
        // Новий користувач - можливо прийшов по інвайту
        const urlParams = new URLSearchParams(window.location.search);
        const inviteCode = urlParams.get('invite');
        
        if(inviteCode){
            await processInvite(inviteCode);
        } else {
            showNoOrgMessage();
        }
    }
}

// ===== ORGANIZATIONS MANAGEMENT =====
async function loadOrganizations(){
    try {
        const snapshot = await db.collection('organizations').orderBy('createdAt', 'desc').get();
        organizations = [];
        snapshot.forEach(doc => {
            organizations.push({ id: doc.id, ...doc.data() });
        });
        renderOrgSelector();
    } catch(err){
        console.error('Error loading organizations:', err);
    }
}

async function selectOrganization(orgId){
    // Super Admin не може перемикатися на чужі організації
    if(currentRole === 'superadmin'){
        // Перевіряємо чи це власна організація
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const ownOrgId = userDoc.exists ? userDoc.data().organizationId : null;
        
        if(orgId !== ownOrgId){
            alert('Як Super Admin ви можете працювати тільки зі своєю організацією.\n\nДля управління організаціями клієнтів використовуйте ADMIN панель.');
            return;
        }
    }
    
    currentOrg = organizations.find(o => o.id === orgId);
    if(!currentOrg){
        const orgDoc = await db.collection('organizations').doc(orgId).get();
        if(orgDoc.exists){
            currentOrg = { id: orgDoc.id, ...orgDoc.data() };
        }
    }
    
    if(currentOrg){
        document.getElementById('org-selector-btn').innerHTML = `
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            ${escapeHtml(currentOrg.name || '')}
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        `;
        initFirestoreListener();
    }
}

async function createOrganization(){
    // Показуємо модалку створення організації
    showCreateOrgModal();
}

function showCreateOrgModal(){
    // Створюємо модалку якщо її ще немає
    let modal = document.getElementById('create-org-modal');
    if(!modal){
        const modalHtml = `
            <div class="team-modal" id="create-org-modal">
                <div class="team-modal-content" style="max-width:400px">
                    <div class="team-modal-header">
                        <div class="team-modal-title">Нова організація</div>
                        <button class="btn btn-s" onclick="closeCreateOrgModal()">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="team-modal-body">
                        <div style="margin-bottom:16px">
                            <label style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:#374151">Назва компанії</label>
                            <input type="text" id="new-org-name" class="form-input" placeholder="Клініка Здоров'я" style="width:100%">
                        </div>
                        <div style="margin-bottom:20px">
                            <label style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:#374151">Email власника</label>
                            <input type="email" id="new-org-owner-email" class="form-input" placeholder="owner@company.com" style="width:100%">
                            <p style="font-size:11px;color:#6b7280;margin-top:6px">На цей email буде надіслано запрошення</p>
                        </div>
                        <button class="btn btn-p" onclick="submitCreateOrganization()" style="width:100%;padding:12px">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Створити
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('create-org-modal');
    }
    
    // Очищаємо поля
    document.getElementById('new-org-name').value = '';
    document.getElementById('new-org-owner-email').value = '';
    
    modal.classList.add('active');
    document.getElementById('new-org-name').focus();
}

function closeCreateOrgModal(){
    document.getElementById('create-org-modal')?.classList.remove('active');
}

async function submitCreateOrganization(){
    const name = document.getElementById('new-org-name').value.trim();
    const ownerEmail = document.getElementById('new-org-owner-email').value.trim();
    
    if(!name){
        showWarning('Введіть назву компанії');
        return;
    }
    
    if(!ownerEmail || !ownerEmail.includes('@')){
        showWarning('Введіть коректний email власника');
        return;
    }
    
    try {
        // Створюємо організацію
        const orgRef = await db.collection('organizations').add({
            name: name,
            ownerEmail: ownerEmail,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.uid,
            settings: {
                statuses: getDefaultStatuses(),
                funnels: [{ id: 'default', name: 'Основна воронка' }]
            }
        });
        
        // Створюємо інвайт для власника
        const code = generateInviteCode();
        await db.collection('invites').doc(code).set({
            organizationId: orgRef.id,
            organizationName: name,
            role: 'owner',
            targetEmail: ownerEmail,
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            used: false
        });
        
        const link = `${window.location.origin}${window.location.pathname}?invite=${code}`;
        
        closeCreateOrgModal();
        
        await loadOrganizations();
        await selectOrganization(orgRef.id);
        
        // Копіюємо посилання
        if(navigator.clipboard){
            await navigator.clipboard.writeText(link);
        } else {
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
        }
        showToast(`Організацію "${escapeHtml(name)}" створено! Посилання скопійовано.`);
        
    } catch(err){
        console.error('Error creating org:', err);
        showError(err.message);
    }
}

function getDefaultStatuses(){
    return {
        new: { name: 'Новий лід', color: '#1565c0', order: 1 },
        contacted: { name: 'Контакт', color: '#3949ab', order: 2 },
        scheduled: { name: 'Призначена', color: '#2e7d32', order: 3 },
        completed: { name: 'Проведена', color: '#7b1fa2', order: 4 },
        report_sent: { name: 'Звіт відправлено', color: '#00695c', order: 5 },
        deposit: { name: 'Завдаток', color: '#f57f17', order: 6 },
        paid: { name: 'Оплачено', color: '#1b5e20', order: 7, isClosed: true },
        failed: { name: 'Відмова', color: '#c62828', order: 8 },
        frozen: { name: 'Заморожений', color: '#546e7a', order: 9 }
    };
}

// ===== INVITE SYSTEM =====
async function processInvite(code){
    try {
        const inviteDoc = await db.collection('invites').doc(code).get();
        
        if(!inviteDoc.exists){
            showError('Запрошення не знайдено');
            return;
        }
        
        const invite = inviteDoc.data();
        
        if(invite.used){
            showWarning('Це запрошення вже використано');
            return;
        }
        
        // FIX: Перевірка терміну дії запрошення (7 днів)
        if(invite.createdAt) {
            const createdDate = invite.createdAt.toDate ? invite.createdAt.toDate() : new Date(invite.createdAt);
            const expirationDays = 7;
            const expirationDate = new Date(createdDate.getTime() + expirationDays * 24 * 60 * 60 * 1000);
            if(new Date() > expirationDate) {
                showWarning('Термін дії запрошення вичерпано. Попросіть нове запрошення.');
                return;
            }
        }
        
        // FIX: Перевірка targetEmail якщо вказаний
        if(invite.targetEmail && invite.targetEmail.toLowerCase() !== currentUser.email.toLowerCase()) {
            showWarning(`Це запрошення призначене для ${invite.targetEmail}`);
            return;
        }
        
        // Додаємо користувача до організації
        await db.collection('users').doc(currentUser.uid).set({
            email: currentUser.email,
            organizationId: invite.organizationId,
            role: invite.role || 'employee',
            invitedBy: invite.createdBy,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Позначаємо інвайт як використаний
        await db.collection('invites').doc(code).update({
            used: true,
            usedBy: currentUser.uid,
            usedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Очищаємо URL
        window.history.replaceState({}, document.title, window.location.pathname);
        
        showToast(`Ви приєдналися до ${invite.organizationName || 'організації'}`);
        
        // Ініціалізуємо
        await initUserMode();
        
    } catch(err){
        console.error('Error processing invite:', err);
        showError('Помилка обробки запрошення');
    }
}

async function createInvite(role = 'employee'){
    if(!currentOrg) return;
    
    try {
        const code = generateInviteCode();
        
        // FIX: Додаємо термін дії запрошення
        await db.collection('invites').doc(code).set({
            organizationId: currentOrg.id,
            organizationName: currentOrg.name,
            role: role,
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 днів
            used: false
        });
        
        const link = `${window.location.origin}${window.location.pathname}?invite=${code}`;
        
        if(navigator.clipboard){
            await navigator.clipboard.writeText(link);
            showToast('Посилання скопійовано!');
        } else {
            // Fallback - створюємо тимчасовий input
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showToast('Посилання скопійовано!');
        }
        
    } catch(err){
        console.error('Error creating invite:', err);
        showError(err.message);
    }
}

function generateInviteCode(){
    return 'inv_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
}

// ===== UI HELPERS =====
function showAdminPanel(){
    let panel = document.getElementById('admin-panel');
    if(!panel){
        // Створюємо панель адміна
        const header = document.querySelector('.actions');
        const adminHtml = `
            <div id="admin-panel" class="admin-panel">
                <button id="org-selector-btn" class="btn btn-s" onclick="toggleOrgDropdown()">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Оберіть організацію
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div id="org-dropdown" class="org-dropdown" style="display:none">
                    <div id="org-list"></div>
                    <div class="org-dropdown-divider"></div>
                    <button class="org-dropdown-item create" onclick="createOrganization()">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Створити організацію
                    </button>
                </div>
                <button class="btn btn-s" onclick="openTeamModal()" title="Команда">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </button>
                <button class="btn admin-badge" onclick="openAdminFullPanel()" title="Панель управління організаціями">ADMIN</button>
            </div>
        `;
        header.insertAdjacentHTML('afterbegin', adminHtml);
    }
    document.getElementById('admin-panel')?.style.setProperty('display', 'flex');
}

function hideAdminPanel(){
    document.getElementById('admin-panel')?.style.setProperty('display', 'none');
}

function toggleOrgDropdown(){
    const dropdown = document.getElementById('org-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function renderOrgSelector(){
    const list = document.getElementById('org-list');
    if(!list) return;
    
    // Super Admin бачить тільки свою організацію в dropdown
    // Всі інші організації він бачить в ADMIN панелі
    let orgsToShow = organizations;
    
    if(currentRole === 'superadmin' && currentOrg){
        // Показуємо тільки власну організацію
        orgsToShow = organizations.filter(o => o.id === currentOrg.id);
    }
    
    list.innerHTML = orgsToShow.map(org => `
        <button class="org-dropdown-item ${currentOrg?.id === org.id ? 'active' : ''}" onclick="selectOrganization('${org.id}');toggleOrgDropdown()">
            <div style="display:flex;flex-direction:column;align-items:flex-start;flex:1;min-width:0">
                <div style="display:flex;align-items:center;gap:8px;width:100%">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                    <span style="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(org.name || '')}</span>
                    <span class="org-item-count">${org.leadsCount || 0}</span>
                </div>
                ${org.ownerEmail ? `<div style="font-size:11px;color:#6b7280;margin-left:24px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px">${escapeHtml(org.ownerEmail)}</div>` : ''}
            </div>
        </button>
    `).join('');
}

function showNoOrgMessage(){
    document.getElementById('v-tasks').innerHTML = `
        <div style="text-align:center;padding:60px 20px">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="#d1d5db" stroke-width="1.5" style="margin:0 auto 20px">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <h3 style="font-size:20px;font-weight:600;margin-bottom:8px;color:#1f2937">Немає доступу до організації</h3>
            <p style="color:#6b7280;margin-bottom:24px">Попросіть адміністратора надіслати вам запрошення</p>
        </div>
    `;
}

function showCreateOrgPrompt(){
    document.getElementById('v-tasks').innerHTML = `
        <div style="text-align:center;padding:60px 20px">
            <svg viewBox="0 0 24 24" width="64" height="64" fill="none" stroke="#22c55e" stroke-width="1.5" style="margin:0 auto 20px">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <h3 style="font-size:20px;font-weight:600;margin-bottom:8px;color:#1f2937">Створіть першу організацію</h3>
            <p style="color:#6b7280;margin-bottom:24px">Почніть роботу з CRM, створивши організацію для вашого бізнесу</p>
            <button class="btn btn-p" onclick="createOrganization()" style="padding:12px 24px;font-size:15px">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Створити організацію
            </button>
        </div>
    `;
}

// ===== TEAM MODAL =====
function openTeamModal(){
    if(!currentOrg) return;
    
    // Завантажуємо користувачів організації
    loadTeamMembers();
    
    // Генеруємо кнопки запрошення залежно від ролі
    renderInviteButtons();
    
    document.getElementById('team-modal').classList.add('active');
}

function renderInviteButtons(){
    const container = document.getElementById('team-invite-btns');
    const section = document.getElementById('team-invite-section');
    if(!container || !section) return;
    
    let buttons = '';
    
    // Super Admin може запрошувати всіх
    if(currentRole === 'superadmin'){
        buttons = `
            <button class="btn btn-s" onclick="createInvite('employee')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Співробітник
            </button>
            <button class="btn btn-s" onclick="createInvite('manager')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Менеджер
            </button>
            <button class="btn btn-p" onclick="createInvite('owner')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                Власник
            </button>
        `;
    }
    // Owner може запрошувати менеджерів і співробітників
    else if(currentRole === 'owner'){
        buttons = `
            <button class="btn btn-s" onclick="createInvite('employee')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Співробітник
            </button>
            <button class="btn btn-p" onclick="createInvite('manager')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Менеджер
            </button>
        `;
    }
    // Manager може запрошувати тільки співробітників
    else if(currentRole === 'manager'){
        buttons = `
            <button class="btn btn-p" onclick="createInvite('employee')">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Співробітник
            </button>
        `;
    }
    // Employee не може запрошувати нікого
    else {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    container.innerHTML = buttons;
}

function closeTeamModal(){
    document.getElementById('team-modal').classList.remove('active');
}

async function loadTeamMembers(){
    try {
        const snapshot = await db.collection('users')
            .where('organizationId', '==', currentOrg.id)
            .get();
        
        const members = [];
        snapshot.forEach(doc => {
            members.push({ id: doc.id, ...doc.data() });
        });
        
        renderTeamMembers(members);
    } catch(err){
        console.error('Error loading team:', err);
    }
}

function renderTeamMembers(members){
    const container = document.getElementById('team-list');
    if(!container) return;
    
    const roleLabels = {
        owner: 'Власник',
        manager: 'Менеджер',
        employee: 'Співробітник',
        superadmin: 'Super Admin'
    };
    
    const roleColors = {
        owner: '#22c55e',
        manager: '#3b82f6',
        employee: '#6b7280',
        superadmin: '#8b5cf6'
    };
    
    container.innerHTML = members.map(m => `
        <div class="team-member">
            <div class="team-member-avatar">${escapeHtml(m.email?.[0]?.toUpperCase() || '?')}</div>
            <div class="team-member-info">
                <div class="team-member-email">${escapeHtml(m.email || '')}</div>
                <div class="team-member-role" style="color:${roleColors[m.role]}">${roleLabels[m.role] || escapeHtml(m.role || '')}</div>
            </div>
            ${m.id !== currentUser.uid && (currentRole === 'owner' || currentRole === 'superadmin') ? `
                <button class="btn btn-s" onclick="removeTeamMember('${m.id}')" title="Видалити">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            ` : ''}
        </div>
    `).join('');
}

async function removeTeamMember(userId){
    const confirmed = await confirmModal('Видалити цього користувача з організації?', {
        title: 'Видалення учасника',
        okText: 'Видалити',
        danger: true
    });
    if(!confirmed) return;
    
    try {
        await db.collection('users').doc(userId).update({
            organizationId: firebase.firestore.FieldValue.delete(),
            role: firebase.firestore.FieldValue.delete()
        });
        loadTeamMembers();
    } catch(err){
        console.error('Error removing member:', err);
        showError(err.message);
    }
}

// ===== SETTINGS PANEL =====
const STATUS_COLORS = [
    '#1565c0', '#1e88e5', '#42a5f5', // Blues
    '#2e7d32', '#43a047', '#66bb6a', // Greens
    '#7b1fa2', '#9c27b0', '#ba68c8', // Purples
    '#c62828', '#ef5350', '#e57373', // Reds
    '#ef6c00', '#ff9800', '#ffb74d', // Oranges
    '#00695c', '#00897b', '#4db6ac', // Teals
    '#546e7a', '#78909c', '#90a4ae', // Grays
    '#f57f17', '#fbc02d', '#fff176'  // Yellows
];

let editingStatusId = null;
let colorPickerTarget = null;

// openSettingsPanel - перенесено нижче з повною логікою (рядок ~3149)

function closeSettingsPanel(){
    document.getElementById('settings-overlay').classList.remove('active');
    document.getElementById('settings-panel').classList.remove('active');
    hideColorPicker();
}

function renderStatusList(){
    const container = document.getElementById('status-list');
    if(!container) return;
    
    const statuses = getOrgStatuses();
    
    // Сортуємо по order
    const sortedStatuses = Object.entries(statuses)
        .sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
    
    container.innerHTML = sortedStatuses.map(([id, status], index) => `
        <div class="status-item" draggable="true" data-status-id="${id}" ondragstart="dragStatusStart(event)" ondragover="dragStatusOver(event)" ondrop="dropStatus(event)" ondragend="dragStatusEnd(event)">
            <div class="status-color" style="background:${status.color}" onclick="openColorPicker(event, '${id}')" title="Змінити колір"></div>
            <div class="status-name">
                <input type="text" value="${status.name}" onchange="updateStatusName('${id}', this.value)" onblur="saveStatuses()">
            </div>
            <div class="status-actions">
                <button class="status-action-btn" onclick="moveStatus('${id}', -1)" title="Вгору" ${index === 0 ? 'disabled style="opacity:0.3"' : ''}>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg>
                </button>
                <button class="status-action-btn" onclick="moveStatus('${id}', 1)" title="Вниз" ${index === sortedStatuses.length - 1 ? 'disabled style="opacity:0.3"' : ''}>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <button class="status-action-btn delete" onclick="deleteStatus('${id}')" title="Видалити">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
    `).join('');
}

function renderColorPicker(){
    const grid = document.getElementById('color-grid');
    if(!grid) return;
    
    grid.innerHTML = STATUS_COLORS.map(color => `
        <div class="color-option" style="background:${color}" onclick="selectColor('${color}')" data-color="${color}"></div>
    `).join('');
}

function openColorPicker(event, statusId){
    event.stopPropagation();
    colorPickerTarget = statusId;
    
    const picker = document.getElementById('color-picker');
    const rect = event.target.getBoundingClientRect();
    
    picker.style.top = (rect.bottom + 8) + 'px';
    picker.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
    picker.classList.add('active');
    
    // Позначаємо поточний колір
    const statuses = getOrgStatuses();
    const currentColor = statuses[statusId]?.color;
    document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === currentColor);
    });
    
    // Закриваємо при кліку поза пікером
    setTimeout(() => {
        document.addEventListener('click', hideColorPickerOnOutsideClick);
    }, 10);
}

function hideColorPicker(){
    document.getElementById('color-picker')?.classList.remove('active');
    document.removeEventListener('click', hideColorPickerOnOutsideClick);
    colorPickerTarget = null;
}

function hideColorPickerOnOutsideClick(e){
    if(!e.target.closest('.color-picker-popup') && !e.target.closest('.status-color')){
        hideColorPicker();
    }
}

function selectColor(color){
    if(!colorPickerTarget) return;
    
    const statuses = getOrgStatuses();
    if(statuses[colorPickerTarget]){
        statuses[colorPickerTarget].color = color;
        saveStatuses();
        renderStatusList();
    }
    
    hideColorPicker();
}

function updateStatusName(statusId, newName){
    const statuses = getOrgStatuses();
    if(statuses[statusId]){
        statuses[statusId].name = newName.trim() || 'Без назви';
    }
}

function moveStatus(statusId, direction){
    const statuses = getOrgStatuses();
    const entries = Object.entries(statuses).sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
    
    const currentIndex = entries.findIndex(([id]) => id === statusId);
    const newIndex = currentIndex + direction;
    
    if(newIndex < 0 || newIndex >= entries.length) return;
    
    // Swap orders
    const currentOrder = entries[currentIndex][1].order;
    const targetOrder = entries[newIndex][1].order;
    
    statuses[entries[currentIndex][0]].order = targetOrder;
    statuses[entries[newIndex][0]].order = currentOrder;
    
    saveStatuses();
    renderStatusList();
}

function addNewStatus(){
    const statuses = getOrgStatuses();
    
    // Генеруємо ID
    const newId = 'status_' + Date.now();
    
    // Знаходимо максимальний order
    const maxOrder = Math.max(...Object.values(statuses).map(s => s.order || 0), 0);
    
    // Випадковий колір
    const randomColor = STATUS_COLORS[Math.floor(Math.random() * STATUS_COLORS.length)];
    
    statuses[newId] = {
        name: 'Новий статус',
        color: randomColor,
        order: maxOrder + 1
    };
    
    // Зберігаємо в currentOrg
    if(!currentOrg.settings) currentOrg.settings = {};
    currentOrg.settings.statuses = statuses;
    
    saveStatuses();
    renderStatusList();
    
    // Фокус на новий статус
    setTimeout(() => {
        const inputs = document.querySelectorAll('.status-item input');
        const lastInput = inputs[inputs.length - 1];
        if(lastInput){
            lastInput.select();
            lastInput.focus();
        }
    }, 100);
}

async function deleteStatus(statusId){
    const statuses = getOrgStatuses();
    
    // Перевіряємо чи є ліди з цим статусом
    const leadsWithStatus = leads.filter(l => l.status === statusId);
    if(leadsWithStatus.length > 0){
        showWarning(`Неможливо видалити: ${leadsWithStatus.length} лідів мають цей статус`);
        return;
    }
    
    if(Object.keys(statuses).length <= 2){
        showWarning('Потрібно мати мінімум 2 статуси');
        return;
    }
    
    const confirmed = await confirmModal('Видалити цей статус?', {
        title: 'Видалення статусу',
        okText: 'Видалити',
        danger: true
    });
    if(!confirmed) return;
    
    delete statuses[statusId];
    saveStatuses();
    renderStatusList();
}

// saveStatuses визначена нижче для роботи з воронками

// Drag & Drop для статусів
let draggedStatusId = null;

function dragStatusStart(e){
    draggedStatusId = e.target.dataset.statusId;
    e.target.classList.add('dragging');
}

function dragStatusOver(e){
    e.preventDefault();
}

function dropStatus(e){
    e.preventDefault();
    const targetId = e.target.closest('.status-item')?.dataset.statusId;
    
    if(!draggedStatusId || !targetId || draggedStatusId === targetId) return;
    
    const statuses = getOrgStatuses();
    const entries = Object.entries(statuses).sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
    
    const draggedIndex = entries.findIndex(([id]) => id === draggedStatusId);
    const targetIndex = entries.findIndex(([id]) => id === targetId);
    
    // Переміщуємо
    const [removed] = entries.splice(draggedIndex, 1);
    entries.splice(targetIndex, 0, removed);
    
    // Оновлюємо orders
    entries.forEach(([id], index) => {
        statuses[id].order = index + 1;
    });
    
    debouncedSaveStatuses();
    renderStatusList();
}

function dragStatusEnd(e){
    e.target.classList.remove('dragging');
    draggedStatusId = null;
}

// ===== FUNNELS MANAGEMENT =====
function getOrgFunnels(){
    // Якщо є нова структура воронок
    if(currentOrg?.settings?.funnels && currentOrg.settings.funnels.length > 0){
        return currentOrg.settings.funnels;
    }
    
    // Міграція: якщо є стара структура statuses, конвертуємо в воронку
    if(currentOrg?.settings?.statuses && Object.keys(currentOrg.settings.statuses).length > 0){
        return [{
            id: 'default',
            name: 'Основна воронка',
            statuses: currentOrg.settings.statuses,
            isDefault: true
        }];
    }
    
    // Дефолтна воронка
    return [{
        id: 'default',
        name: 'Основна воронка',
        statuses: getDefaultStatuses(),
        isDefault: true
    }];
}

function openSettingsPanel(){
    if(!currentOrg) return;
    
    // Завантажуємо членів команди
    loadTeamMembersForSettings();
    
    // Рендеримо воронки
    renderFunnelList();
    
    // Вибираємо першу воронку для редагування
    const funnels = getOrgFunnels();
    if(funnels.length > 0 && !selectedFunnelForEdit){
        selectedFunnelForEdit = funnels[0].id;
    }
    renderStatusList();
    
    // Рендеримо джерела
    renderSourceList();
    
    // Рендеримо режим розподілу
    renderAssignmentMode();
    
    renderColorPicker();
    
    document.getElementById('settings-overlay').classList.add('active');
    document.getElementById('settings-panel').classList.add('active');
}

function renderFunnelList(){
    const container = document.getElementById('funnel-list');
    if(!container) return;
    
    const funnels = getOrgFunnels();
    
    container.innerHTML = funnels.map(funnel => {
        const statusCount = funnel.statuses ? Object.keys(funnel.statuses).length : 0;
        const leadsCount = leads.filter(l => l.funnelId === funnel.id || (!l.funnelId && funnel.isDefault)).length;
        const isActive = selectedFunnelForEdit === funnel.id;
        
        return `
            <div class="funnel-item ${isActive ? 'active' : ''}" onclick="selectFunnelForEdit('${funnel.id}')">
                <div class="funnel-item-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                </div>
                <div class="funnel-item-info">
                    <div class="funnel-item-name">
                        ${escapeHtml(funnel.name)}
                        ${funnel.isDefault ? '<span class="funnel-default-badge">За замовч.</span>' : ''}
                    </div>
                    <div class="funnel-item-meta">
                        <span>${statusCount} статусів</span>
                        <span>${leadsCount} лідів</span>
                    </div>
                </div>
                <div class="funnel-item-actions" onclick="event.stopPropagation()">
                    ${!funnel.isDefault ? `
                        <button class="status-action-btn delete" onclick="deleteFunnel('${funnel.id}')" title="Видалити">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function selectFunnelForEdit(funnelId){
    selectedFunnelForEdit = funnelId;
    renderFunnelList();
    renderStatusList();
    
    // Оновлюємо назву в заголовку секції статусів
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === funnelId);
    const nameEl = document.getElementById('current-funnel-name');
    if(nameEl) nameEl.textContent = funnel?.name || '—';
}

function addNewFunnel(){
    promptModal('Назва нової воронки:', 'Нова воронка', {
        placeholder: 'Введіть назву воронки'
    }).then(name => {
        if(!name) return;
        
        const funnels = getOrgFunnels();
        const newFunnel = {
            id: 'funnel_' + Date.now(),
            name: name.trim(),
            statuses: getDefaultStatuses(),
            isDefault: false
        };
        
        funnels.push(newFunnel);
        saveFunnels(funnels);
        
        selectedFunnelForEdit = newFunnel.id;
        renderFunnelList();
        renderStatusList();
    });
}

async function deleteFunnel(funnelId){
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === funnelId);
    
    if(funnel?.isDefault){
        showWarning('Неможливо видалити основну воронку');
        return;
    }
    
    const leadsInFunnel = leads.filter(l => l.funnelId === funnelId);
    if(leadsInFunnel.length > 0){
        showWarning(`Неможливо видалити: ${leadsInFunnel.length} лідів в цій воронці`);
        return;
    }
    
    const confirmed = await confirmModal(`Видалити воронку "${escapeHtml(funnel?.name)}"?`, {
        title: 'Видалення воронки',
        okText: 'Видалити',
        danger: true
    });
    if(!confirmed) return;
    
    const newFunnels = funnels.filter(f => f.id !== funnelId);
    saveFunnels(newFunnels);
    
    if(selectedFunnelForEdit === funnelId){
        selectedFunnelForEdit = newFunnels[0]?.id;
    }
    
    renderFunnelList();
    renderStatusList();
}

async function saveFunnels(funnels){
    if(!currentOrg) return;
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.funnels': funnels
        });
        
        if(!currentOrg.settings) currentOrg.settings = {};
        currentOrg.settings.funnels = funnels;
        
        // Оновлюємо UI
        renderFunnelDropdown();
        render();
        
    } catch(err){
        console.error('Error saving funnels:', err);
        showError(err.message);
    }
}

// ===== SOURCES MANAGEMENT =====

function renderSourceList(){
    const container = document.getElementById('source-list');
    if(!container) return;
    
    const sources = getOrgSources();
    const entries = Object.entries(sources).sort((a, b) => a[1].localeCompare(b[1]));
    
    container.innerHTML = entries.map(([code, name]) => `
        <div class="source-item" data-source-code="${code}">
            <span class="source-code">${escapeHtml(code)}</span>
            <div class="source-name">
                <input type="text" value="${escapeHtml(name)}" 
                    onchange="updateSourceName('${code}', this.value)" 
                    onblur="saveSources()">
            </div>
            <div class="source-actions">
                <button class="status-action-btn delete" onclick="deleteSource('${code}')" title="Видалити">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
    `).join('');
}

async function addNewSource(){
    const code = await promptModal('Код джерела (латиницею, без пробілів):', '', {
        title: 'Нове джерело',
        placeholder: 'наприклад: instagram_ads'
    });
    
    if(!code) return;
    
    // Валідація коду
    const cleanCode = code.toLowerCase().replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
    if(!cleanCode || cleanCode.length < 2){
        showError('Код має містити мінімум 2 латинські символи');
        return;
    }
    
    const sources = getOrgSources();
    if(sources[cleanCode]){
        showError('Джерело з таким кодом вже існує');
        return;
    }
    
    const name = await promptModal('Назва джерела:', '', {
        title: 'Назва для ' + cleanCode,
        placeholder: 'наприклад: Instagram реклама'
    });
    
    if(!name) return;
    
    sources[cleanCode] = name.trim();
    await saveSourcesToFirebase(sources);
    
    renderSourceList();
    updateSourceDropdowns();
    showToast('Джерело "' + name + '" додано');
}

function updateSourceName(code, newName){
    const sources = getOrgSources();
    if(sources[code]){
        sources[code] = newName.trim() || code;
    }
}

async function deleteSource(code){
    const sources = getOrgSources();
    const name = sources[code] || code;
    
    const confirmed = await confirmModal(`Видалити джерело "${escapeHtml(name)}"?`, {
        title: 'Видалення джерела',
        text: 'Ліди з цим джерелом залишаться, але відображатиметься код замість назви.',
        okText: 'Видалити',
        danger: true
    });
    
    if(!confirmed) return;
    
    delete sources[code];
    await saveSourcesToFirebase(sources);
    
    renderSourceList();
    updateSourceDropdowns();
    showToast('Джерело видалено');
}

async function saveSources(){
    const sources = getOrgSources();
    await saveSourcesToFirebase(sources);
}

async function saveSourcesToFirebase(sources){
    if(!currentOrg) return;
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.sources': sources
        });
        
        if(!currentOrg.settings) currentOrg.settings = {};
        currentOrg.settings.sources = sources;
        
    } catch(err){
        console.error('Error saving sources:', err);
        showError('Помилка збереження: ' + err.message);
    }
}

function updateSourceDropdowns(){
    // Оновлюємо select в формі редагування ліда
    const sourceSelect = document.getElementById('f-source');
    if(sourceSelect){
        const currentValue = sourceSelect.value;
        const sources = getOrgSources();
        
        sourceSelect.innerHTML = '<option value="">—</option>' + 
            Object.entries(sources)
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([code, name]) => `<option value="${code}">${escapeHtml(name)}</option>`)
                .join('');
        
        sourceSelect.value = currentValue;
    }
    
    // Оновлюємо фільтр джерел
    renderSourceFilter();
}

// Оновлюємо getOrgStatuses для роботи з вибраною воронкою
function getOrgStatuses(){
    const funnels = getOrgFunnels();
    
    // Якщо редагуємо конкретну воронку
    if(selectedFunnelForEdit){
        const funnel = funnels.find(f => f.id === selectedFunnelForEdit);
        if(funnel?.statuses){
            return funnel.statuses;
        }
    }
    
    // Повертаємо статуси першої/дефолтної воронки
    const defaultFunnel = funnels.find(f => f.isDefault) || funnels[0];
    if(defaultFunnel?.statuses){
        return defaultFunnel.statuses;
    }
    
    return getDefaultStatuses();
}

// Оновлюємо saveStatuses для роботи з воронками
async function saveStatuses(){
    if(!currentOrg) return;
    
    const funnels = getOrgFunnels();
    const statuses = getOrgStatuses();
    
    // Оновлюємо статуси у вибраній воронці
    const funnelIndex = funnels.findIndex(f => f.id === selectedFunnelForEdit);
    if(funnelIndex >= 0){
        funnels[funnelIndex].statuses = statuses;
    }
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.funnels': funnels
        });
        
        if(!currentOrg.settings) currentOrg.settings = {};
        currentOrg.settings.funnels = funnels;
        
        render();
        
    } catch(err){
        console.error('Error saving statuses:', err);
        showError('Помилка збереження: ' + err.message);
    }
}

// Debounced версія для drag-n-drop
const debouncedSaveStatuses = debounce(saveStatuses, 500);

// ===== ASSIGNMENT MODE =====
function renderAssignmentMode(){
    const mode = currentOrg?.settings?.assignmentMode || 'manual';
    
    document.querySelectorAll('input[name="assignment-mode"]').forEach(input => {
        input.checked = input.value === mode;
    });
    
    // Показуємо/ховаємо round-robin секцію
    const rrSection = document.getElementById('rr-queue-section');
    if(rrSection){
        rrSection.style.display = mode === 'round-robin' ? 'block' : 'none';
        if(mode === 'round-robin'){
            renderRoundRobinQueue();
        }
    }
}

async function setAssignmentMode(mode){
    if(!currentOrg) return;
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.assignmentMode': mode
        });
        
        if(!currentOrg.settings) currentOrg.settings = {};
        currentOrg.settings.assignmentMode = mode;
        
        renderAssignmentMode();
        
    } catch(err){
        console.error('Error setting assignment mode:', err);
        showError(err.message);
    }
}

async function loadTeamMembersForSettings(){
    if(!currentOrg) return;
    
    try {
        const snapshot = await db.collection('users')
            .where('organizationId', '==', currentOrg.id)
            .get();
        
        teamMembers = [];
        snapshot.forEach(doc => {
            teamMembers.push({ id: doc.id, ...doc.data() });
        });
        
        renderRoundRobinQueue();
        renderAssigneeDropdown();
        
    } catch(err){
        console.error('Error loading team:', err);
    }
}

function renderRoundRobinQueue(){
    const container = document.getElementById('rr-queue-list');
    if(!container) return;
    
    const queue = currentOrg?.settings?.roundRobinQueue || [];
    const currentIndex = currentOrg?.settings?.roundRobinIndex || 0;
    
    // Фільтруємо тільки активних членів (не employee якщо потрібно)
    const activeMembers = teamMembers.filter(m => m.role === 'owner' || m.role === 'manager');
    
    container.innerHTML = activeMembers.map((member, index) => {
        const inQueue = queue.includes(member.id);
        const isCurrent = queue[currentIndex] === member.id;
        const leadsAssigned = leads.filter(l => l.assignedTo === member.id).length;
        
        return `
            <div class="rr-queue-item ${isCurrent ? 'current' : ''}">
                <div class="rr-queue-avatar">${escapeHtml(member.email?.[0]?.toUpperCase() || '?')}</div>
                <div class="rr-queue-info">
                    <div class="rr-queue-name">${escapeHtml(member.email || '')}</div>
                    <div class="rr-queue-count">${leadsAssigned} лідів</div>
                </div>
                <button class="rr-queue-toggle ${inQueue ? 'active' : ''}" onclick="toggleRoundRobinMember('${member.id}')" title="${inQueue ? 'Видалити з черги' : 'Додати в чергу'}">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="${inQueue ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </button>
            </div>
        `;
    }).join('');
}

async function toggleRoundRobinMember(memberId){
    if(!currentOrg) return;
    
    let queue = currentOrg?.settings?.roundRobinQueue || [];
    
    if(queue.includes(memberId)){
        queue = queue.filter(id => id !== memberId);
    } else {
        queue.push(memberId);
    }
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.roundRobinQueue': queue
        });
        
        if(!currentOrg.settings) currentOrg.settings = {};
        currentOrg.settings.roundRobinQueue = queue;
        
        renderRoundRobinQueue();
        
    } catch(err){
        console.error('Error updating queue:', err);
    }
}

// ===== FUNNEL FILTER UI =====
function renderFunnelDropdown(){
    const list = document.getElementById('funnel-dropdown-list');
    if(!list) return;
    
    const funnels = getOrgFunnels();
    
    list.innerHTML = funnels.map(funnel => `
        <div class="funnel-dropdown-item ${currentFunnelId === funnel.id ? 'active' : ''}" onclick="selectFunnel('${funnel.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
            ${funnel.name}
        </div>
    `).join('');
}

function toggleFunnelDropdown(){
    const dropdown = document.getElementById('funnel-dropdown');
    const wasActive = dropdown?.classList.contains('active');
    closeAllDropdowns();
    if(!wasActive) dropdown?.classList.add('active');
}

function selectFunnel(funnelId){
    currentFunnelId = funnelId;
    
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === funnelId);
    
    document.getElementById('current-funnel-label').textContent = funnel?.name || 'Всі воронки';
    document.getElementById('funnel-dropdown')?.classList.remove('active');
    
    // Оновлюємо фільтр
    updateClearFiltersButton();
    render();
}

function renderAssigneeDropdown(){
    const list = document.getElementById('assignee-dropdown-list');
    if(!list) return;
    
    const managers = teamMembers.filter(m => m.role === 'owner' || m.role === 'manager');
    
    list.innerHTML = managers.map(member => `
        <div class="funnel-dropdown-item ${currentAssigneeFilter === member.id ? 'active' : ''}" onclick="selectAssignee('${member.id}')">
            ${member.email}
        </div>
    `).join('');
}

function toggleAssigneeDropdown(){
    const dropdown = document.getElementById('assignee-dropdown');
    const wasActive = dropdown?.classList.contains('active');
    closeAllDropdowns();
    if(!wasActive) dropdown?.classList.add('active');
    renderAssigneeDropdown();
}

function selectAssignee(filter){
    currentAssigneeFilter = filter;
    
    let label = 'Всі менеджери';
    if(filter === 'mine'){
        label = 'Мої ліди';
    } else if(filter){
        const member = teamMembers.find(m => m.id === filter);
        label = member?.email?.split('@')[0] || filter; // Тільки ім'я без домену
    }
    
    document.getElementById('current-assignee-label').textContent = label;
    document.getElementById('assignee-dropdown')?.classList.remove('active');
    
    // Оновлюємо active клас
    document.querySelectorAll('#assignee-dropdown .funnel-dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    
    updateClearFiltersButton();
    render();
}

// ===== UTILITY FUNCTIONS =====
function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
}

// ===== SEARCH =====
let searchDebounceTimer = null;

function handleSearch(query) {
    currentSearchQuery = query.toLowerCase().trim();
    
    // Update search box state
    const searchBox = document.getElementById('search-box');
    if(searchBox) {
        searchBox.classList.toggle('has-value', currentSearchQuery.length > 0);
    }
    
    updateClearFiltersButton();
    
    // Debounced render (300ms delay)
    clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
        render();
    }, 300);
}

function clearSearch() {
    currentSearchQuery = '';
    const input = document.getElementById('search-input');
    if(input) input.value = '';
    
    const searchBox = document.getElementById('search-box');
    if(searchBox) searchBox.classList.remove('has-value');
    
    updateClearFiltersButton();
    render();
}

function matchesSearch(lead, query) {
    if(!query) return true;
    
    // Нормалізуємо телефон (видаляємо все крім цифр)
    const normalizedQuery = query.replace(/\D/g, '');
    const phoneDigits = (lead.phone || '').replace(/\D/g, '');
    
    // Якщо запит схожий на номер телефону (тільки цифри)
    if(normalizedQuery.length >= 3 && /^\d+$/.test(query.replace(/[\s\-\+]/g, ''))) {
        if(phoneDigits.includes(normalizedQuery)) return true;
    }
    
    // Звичайний текстовий пошук
    const searchFields = [
        lead.tg,
        lead.phone,
        lead.biz,
        lead.email,
        lead.notes,
        lead.nextAction
    ].filter(Boolean).map(f => f.toLowerCase());
    
    return searchFields.some(field => field.includes(query));
}

// Оновлюємо filterLeads для підтримки воронок та відповідальних
function filterLeadsWithFunnelAndAssignee(leadsArray){
    let filtered = leadsArray;
    
    // Фільтр по пошуку
    if(currentSearchQuery) {
        filtered = filtered.filter(l => matchesSearch(l, currentSearchQuery));
    }
    
    // Фільтр по воронці
    if(currentFunnelId){
        filtered = filtered.filter(l => l.funnelId === currentFunnelId || (!l.funnelId && currentFunnelId === 'default'));
    }
    
    // Фільтр по відповідальному
    if(currentAssigneeFilter === 'mine'){
        filtered = filtered.filter(l => l.assignedTo === currentUser?.uid);
    } else if(currentAssigneeFilter){
        filtered = filtered.filter(l => l.assignedTo === currentAssigneeFilter);
    }
    
    // Фільтр по джерелу
    if(currentSourceFilter) {
        filtered = filtered.filter(l => l.source === currentSourceFilter);
    }
    
    // Фільтр по даті створення
    if(currentDateFilter) {
        const now = new Date();
        let startDate;
        
        switch(currentDateFilter) {
            case 'today':
                startDate = today();
                break;
            case 'week':
                const weekAgo = new Date(now);
                weekAgo.setDate(weekAgo.getDate() - 7);
                startDate = weekAgo.toISOString().split('T')[0];
                break;
            case 'month':
                const monthAgo = new Date(now);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                startDate = monthAgo.toISOString().split('T')[0];
                break;
            case 'quarter':
                const quarterAgo = new Date(now);
                quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                startDate = quarterAgo.toISOString().split('T')[0];
                break;
        }
        
        if(startDate) {
            filtered = filtered.filter(l => {
                const created = l.created ? l.created.split('T')[0] : null;
                return created && created >= startDate;
            });
        }
    }
    
    return filtered;
}

// ===== SOURCE FILTER =====
function toggleSourceDropdown() {
    const dropdown = document.getElementById('source-dropdown');
    const wasActive = dropdown.classList.contains('active');
    closeAllDropdowns();
    if(!wasActive) {
        dropdown.classList.add('active');
        renderSourceDropdown();
    }
}

function renderSourceDropdown() {
    const list = document.getElementById('source-dropdown-list');
    if(!list) return;
    
    // Отримуємо джерела з налаштувань організації
    const orgSources = getOrgSources();
    
    // Також збираємо джерела з лідів (якщо є ліди з джерелами яких немає в налаштуваннях)
    const leadSources = [...new Set(leads.map(l => l.source).filter(Boolean))];
    
    // Об'єднуємо: спочатку з налаштувань, потім унікальні з лідів
    const allSourceCodes = [...new Set([...Object.keys(orgSources), ...leadSources])];
    
    list.innerHTML = allSourceCodes.map(source => `
        <div class="funnel-dropdown-item ${currentSourceFilter === source ? 'active' : ''}" onclick="selectSource('${source}')">
            ${escapeHtml(orgSources[source] || source)}
        </div>
    `).join('');
}

// Alias для updateSourceDropdowns
function renderSourceFilter() {
    renderSourceDropdown();
}

function selectSource(source) {
    currentSourceFilter = source;
    document.getElementById('current-source-label').textContent = source ? (SRC[source] || source) : 'Всі джерела';
    document.getElementById('source-dropdown').classList.remove('active');
    
    // Оновлюємо active стан
    document.querySelectorAll('#source-dropdown .funnel-dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    
    updateClearFiltersButton();
    render();
}

// ===== DATE FILTER =====
function toggleDateDropdown() {
    const dropdown = document.getElementById('date-dropdown');
    const wasActive = dropdown.classList.contains('active');
    closeAllDropdowns();
    if(!wasActive) {
        dropdown.classList.add('active');
    }
}

const DATE_FILTER_LABELS = {
    'today': 'Сьогодні',
    'week': 'Цей тиждень',
    'month': 'Цей місяць',
    'quarter': 'Цей квартал'
};

function selectDateFilter(filter) {
    currentDateFilter = filter;
    document.getElementById('current-date-label').textContent = filter ? DATE_FILTER_LABELS[filter] : 'Весь час';
    document.getElementById('date-dropdown').classList.remove('active');
    
    // Оновлюємо active стан
    document.querySelectorAll('#date-dropdown .funnel-dropdown-item').forEach(item => {
        item.classList.remove('active');
    });
    
    updateClearFiltersButton();
    render();
}

// ===== CLEAR ALL FILTERS =====
function clearAllFilters() {
    currentFunnelId = null;
    currentAssigneeFilter = null;
    currentSourceFilter = null;
    currentDateFilter = null;
    currentSearchQuery = '';
    
    // Reset UI
    document.getElementById('current-funnel-label').textContent = 'Всі воронки';
    document.getElementById('current-assignee-label').textContent = 'Всі менеджери';
    document.getElementById('current-source-label').textContent = 'Всі джерела';
    document.getElementById('current-date-label').textContent = 'Весь час';
    
    const searchInput = document.getElementById('search-input');
    if(searchInput) searchInput.value = '';
    
    const searchBox = document.getElementById('search-box');
    if(searchBox) searchBox.classList.remove('has-value');
    
    updateClearFiltersButton();
    render();
}

function updateClearFiltersButton() {
    const btn = document.getElementById('clear-filters-btn');
    if(!btn) return;
    
    const hasFilters = currentFunnelId || currentAssigneeFilter || currentSourceFilter || currentDateFilter || currentSearchQuery;
    btn.style.display = hasFilters ? 'inline-flex' : 'none';
}

function closeAllDropdowns() {
    document.querySelectorAll('.funnel-dropdown').forEach(d => d.classList.remove('active'));
}

// ===== BULK ACTIONS =====
function handleCardClick(event, leadId) {
    // Якщо Ctrl/Cmd натиснуто — toggle selection
    if(event.ctrlKey || event.metaKey) {
        event.preventDefault();
        toggleLeadSelection(leadId);
        return;
    }
    
    // Якщо Shift натиснуто і вже є вибрані — select range
    if(event.shiftKey && selectedLeadIds.size > 0) {
        event.preventDefault();
        // TODO: select range
        toggleLeadSelection(leadId);
        return;
    }
    
    // Звичайний клік — відкрити модалку
    openModal(leadId);
}

function toggleLeadSelection(leadId) {
    if(selectedLeadIds.has(leadId)) {
        selectedLeadIds.delete(leadId);
    } else {
        selectedLeadIds.add(leadId);
    }
    updateBulkBar();
    renderKanban(); // Re-render to update selection state
}

function updateBulkBar() {
    const bar = document.getElementById('bulk-bar');
    const count = document.getElementById('bulk-count');
    if(!bar || !count) return;
    
    count.textContent = selectedLeadIds.size;
    
    if(selectedLeadIds.size > 0) {
        bar.classList.add('active');
        document.getElementById('v-kanban')?.classList.add('bulk-mode');
    } else {
        bar.classList.remove('active');
        document.getElementById('v-kanban')?.classList.remove('bulk-mode');
    }
}

function clearBulkSelection() {
    selectedLeadIds.clear();
    updateBulkBar();
    renderKanban();
}

async function bulkAssign() {
    if(selectedLeadIds.size === 0) return;
    
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Організацію не вибрано');
        return;
    }
    
    // Показуємо dropdown з менеджерами
    const managers = teamMembers.filter(m => m.role === 'owner' || m.role === 'manager');
    
    if(managers.length === 0) {
        showWarning('Немає доступних менеджерів');
        return;
    }
    
    const options = managers.map(m => ({ value: m.id, label: m.email }));
    options.unshift({ value: '', label: '— Зняти призначення —' });
    
    const selected = await promptModal('Призначити відповідального:', '', {
        type: 'select',
        selectOptions: options
    });
    
    if(selected === null) return;
    
    showLoading('Призначення...');
    
    try {
        const assignee = selected || null;
        for(const leadId of selectedLeadIds) {
            const lead = leads.find(l => l.id === leadId);
            if(lead) {
                lead.assignedTo = assignee;
                // FIX: Використовуємо централізовану функцію збереження
                await saveLeadToFirebase(lead);
            }
        }
        showToast(`Призначено ${selectedLeadIds.size} лідів`);
        clearBulkSelection();
        render();
    } catch(err) {
        showError(err.message);
    } finally {
        hideLoading();
    }
}

async function bulkChangeStatus() {
    if(selectedLeadIds.size === 0) return;
    
    const statuses = getOrgStatuses();
    const options = Object.entries(statuses)
        .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
        .map(([id, s]) => ({
            value: id,
            label: s.name || id
        }));
    
    const newStatus = await promptModal('Змінити статус на:', '', {
        type: 'select',
        selectOptions: options
    });
    
    if(!newStatus) return;
    
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Організацію не вибрано');
        return;
    }
    
    showLoading('Зміна статусу...');
    
    try {
        for(const leadId of selectedLeadIds) {
            const lead = leads.find(l => l.id === leadId);
            if(lead) {
                lead.status = newStatus;
                // FIX: Використовуємо ISO формат для консистентності
                lead.stageDate = new Date().toISOString();
                addLog(lead, 'status', `Масова зміна на: ${statuses[newStatus]?.name || newStatus}`);
                // FIX: Використовуємо централізовану функцію збереження
                await saveLeadToFirebase(lead);
            }
        }
        showToast(`Статус змінено для ${selectedLeadIds.size} лідів`);
        clearBulkSelection();
        render();
    } catch(err) {
        showError(err.message);
    } finally {
        hideLoading();
    }
}

async function bulkSetNextDate() {
    if(selectedLeadIds.size === 0) return;
    
    const result = await promptDateTime('Встановити дату наступної дії');
    if(!result) return;
    
    // FIX: promptDateTime повертає string "YYYY-MM-DDTHH:MM", а не об'єкт
    const [dateStr, timeStr] = result.split('T');
    
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Організацію не вибрано');
        return;
    }
    
    showLoading('Встановлення дати...');
    
    try {
        for(const leadId of selectedLeadIds) {
            const lead = leads.find(l => l.id === leadId);
            if(lead) {
                lead.nextDate = dateStr;
                lead.nextTime = timeStr || '10:00';
                addLog(lead, 'call', `Масове встановлення дати: ${dateStr} ${timeStr || '10:00'}`);
                // FIX: Використовуємо централізовану функцію збереження
                await saveLeadToFirebase(lead);
            }
        }
        showToast(`Дату встановлено для ${selectedLeadIds.size} лідів`);
        clearBulkSelection();
        render();
    } catch(err) {
        showError(err.message);
    } finally {
        hideLoading();
    }
}

async function bulkDelete() {
    if(selectedLeadIds.size === 0) return;
    
    const confirmed = await confirmModal(
        `Видалити ${selectedLeadIds.size} лідів?\n\nЦю дію неможливо скасувати.`,
        { title: 'Масове видалення', okText: 'Видалити', danger: true }
    );
    
    if(!confirmed) return;
    
    showLoading('Видалення...');
    
    try {
        for(const leadId of selectedLeadIds) {
            await deleteLead(leadId);
        }
        showToast(`Видалено ${selectedLeadIds.size} лідів`);
        clearBulkSelection();
    } catch(err) {
        showError(err.message);
    } finally {
        hideLoading();
    }
}

// ===== AUTO-ASSIGNMENT =====
function getNextAssignee(){
    const mode = currentOrg?.settings?.assignmentMode || 'manual';
    
    if(mode === 'manual'){
        return null;
    }
    
    if(mode === 'round-robin'){
        const queue = currentOrg?.settings?.roundRobinQueue || [];
        if(queue.length === 0) return null;
        
        const currentIndex = currentOrg?.settings?.roundRobinIndex || 0;
        return queue[currentIndex % queue.length];
    }
    
    if(mode === 'by-funnel'){
        const funnels = getOrgFunnels();
        const defaultFunnel = funnels.find(f => f.isDefault) || funnels[0];
        return defaultFunnel?.defaultAssignee || null;
    }
    
    return null;
}

async function incrementRoundRobinIndex(){
    if(currentOrg?.settings?.assignmentMode !== 'round-robin') return;
    
    const queue = currentOrg?.settings?.roundRobinQueue || [];
    if(queue.length === 0) return;
    
    const currentIndex = currentOrg?.settings?.roundRobinIndex || 0;
    const nextIndex = (currentIndex + 1) % queue.length;
    
    try {
        await db.collection('organizations').doc(currentOrg.id).update({
            'settings.roundRobinIndex': nextIndex
        });
        
        currentOrg.settings.roundRobinIndex = nextIndex;
        
    } catch(err){
        console.error('Error incrementing RR index:', err);
    }
}

// ===== FIRESTORE SYNC (Organization-based) =====
// FIX: Додаємо debounce для запобігання швидких перемикань
let pendingListenerTimeout = null;

function initFirestoreListener(){
    // FIX: Очищаємо попередній timeout якщо є
    if(pendingListenerTimeout) {
        clearTimeout(pendingListenerTimeout);
        pendingListenerTimeout = null;
    }
    
    // FIX: Спочатку відписуємось від попереднього listener
    if(unsubscribe) { 
        try {
            unsubscribe(); 
        } catch(e) {
            console.warn('Error unsubscribing:', e);
        }
        unsubscribe = null; 
    }
    
    if(!currentOrg?.id){
        leads = [];
        render();
        return;
    }
    
    setSyncStatus('syncing', 'Синхронізація...');
    showSkeleton(); // Показуємо skeleton поки завантажуються дані
    
    // FIX: Зберігаємо ID організації локально
    const orgId = currentOrg.id;
    
    // FIX: Невелика затримка для запобігання race condition при швидкому перемиканні
    pendingListenerTimeout = setTimeout(() => {
        // Перевіряємо чи організація не змінилась
        if(currentOrg?.id !== orgId) {
            console.log('initFirestoreListener: org changed, aborting');
            return;
        }
        
        unsubscribe = db.collection('organizations').doc(orgId).collection('leads')
            .onSnapshot(snapshot => {
                // FIX: Подвійна перевірка що організація все ще та сама
                if(currentOrg?.id !== orgId) {
                    console.log('onSnapshot: org changed, ignoring update');
                    return;
                }
                leads = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Фільтруємо видалених лідів
                    if (!data.deleted) {
                        leads.push({ id: doc.id, ...data });
                    }
                });
                console.log('onSnapshot: Received', snapshot.size, 'total,', leads.length, 'active leads');
                render();
                setSyncStatus('synced', 'Синхронізовано');
                updateOrgLeadsCount(leads.length);
            }, err => {
                console.error('Firestore error:', err);
                setSyncStatus('error', 'Помилка синхронізації');
            });
    }, 50); // 50ms затримка
}

function updateOrgLeadsCount(count){
    if(currentOrg){
        currentOrg.leadsCount = count;
        const idx = organizations.findIndex(o => o.id === currentOrg.id);
        if(idx >= 0) organizations[idx].leadsCount = count;
        renderOrgSelector();
    }
}

// ===== DATA VALIDATION & SANITIZATION =====
function validateDate(dateStr) {
    if (!dateStr) return null;
    // Підтримка форматів: "2025-01-20", "2025-01-20T14:00", "2025-01-20T14:00:00"
    const dateOnly = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dateOnly)) return null;
    const d = new Date(dateOnly);
    if (isNaN(d.getTime())) return null;
    return dateStr; // Повертаємо оригінал якщо валідний
}

function validateTime(timeStr) {
    if (!timeStr) return '10:00';
    if (!/^\d{2}:\d{2}(:\d{2})?$/.test(timeStr)) return '10:00';
    return timeStr.slice(0, 5); // HH:MM
}

function sanitizeLead(lead) {
    const sanitized = { ...lead };
    
    // Валідація дат
    sanitized.nextDate = validateDate(lead.nextDate);
    sanitized.consult = validateDate(lead.consult);
    sanitized.reactDate = validateDate(lead.reactDate);
    sanitized.finDepDate = validateDate(lead.finDepDate);
    sanitized.finPaidDate = validateDate(lead.finPaidDate);
    sanitized.confirmedDate = validateDate(lead.confirmedDate);
    
    // Валідація часу
    sanitized.nextTime = validateTime(lead.nextTime);
    
    // Валідація чисел
    sanitized.calls = Math.max(0, parseInt(lead.calls) || 0);
    sanitized.sms = Math.max(0, parseInt(lead.sms) || 0);
    sanitized.noshow = Math.max(0, parseInt(lead.noshow) || 0);
    sanitized.repeatCount = Math.max(0, parseInt(lead.repeatCount) || 0);
    sanitized.finDep = lead.finDep ? Math.max(0, parseFloat(lead.finDep) || 0) : null;
    sanitized.finTotal = lead.finTotal ? Math.max(0, parseFloat(lead.finTotal) || 0) : null;
    
    // Валідація статусу - дозволяємо базові та кастомні статуси
    const baseStatuses = ['new', 'contacted', 'scheduled', 'completed', 'report_sent', 'repeat', 'deposit', 'paid', 'failed', 'frozen'];
    // Кастомні статуси мають формат 'status_' + timestamp
    const isCustomStatus = sanitized.status && sanitized.status.startsWith('status_');
    if (!baseStatuses.includes(sanitized.status) && !isCustomStatus) {
        // Тільки якщо статус невалідний і не кастомний - скидаємо на new
        sanitized.status = sanitized.status || 'new';
    }
    
    // Обрізаємо занадто довгі рядки
    if (sanitized.notes && sanitized.notes.length > 10000) {
        sanitized.notes = sanitized.notes.slice(0, 10000);
    }
    if (sanitized.report && sanitized.report.length > 10000) {
        sanitized.report = sanitized.report.slice(0, 10000);
    }
    
    return sanitized;
}

// ===== ERROR LOGGING =====
const errorLog = [];
const MAX_ERROR_LOG = 50;

function logError(context, error, data = null) {
    const entry = {
        timestamp: new Date().toISOString(),
        context,
        message: error?.message || String(error),
        stack: error?.stack?.slice(0, 500),
        data: data ? JSON.stringify(data).slice(0, 200) : null
    };
    
    errorLog.unshift(entry);
    if (errorLog.length > MAX_ERROR_LOG) errorLog.pop();
    
    console.error(`[${context}]`, error, data);
    
    // Можна додати відправку в аналітику
    // sendToAnalytics('error', entry);
}

function getErrorLog() {
    return errorLog;
}

// ===== CENTRALIZED FIREBASE SAVE (FIX: усуває дублювання коду) =====
/**
 * Централізована функція збереження ліда в Firebase
 * Використовується замість дублювання JSON.parse(JSON.stringify...) скрізь
 * @param {Object} lead - об'єкт ліда
 * @param {boolean} showStatus - чи показувати статус синхронізації
 * @returns {Promise<boolean>}
 */
async function saveLeadToFirebase(lead, showStatus = false) {
    if(!currentOrg?.id) {
        console.error('saveLeadToFirebase: currentOrg is not set');
        return false;
    }
    if(!lead?.id) {
        console.error('saveLeadToFirebase: lead.id is not set');
        return false;
    }
    
    try {
        if(showStatus) setSyncStatus('syncing', 'Збереження...');
        
        // Clean undefined values (Firebase doesn't accept them)
        const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
            value === undefined ? null : value
        ));
        
        await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData);
        
        if(showStatus) setSyncStatus('synced', 'Синхронізовано');
        return true;
    } catch(err) {
        logError('saveLeadToFirebase', err, { leadId: lead?.id });
        if(showStatus) setSyncStatus('error', 'Помилка збереження');
        throw err; // Re-throw для обробки в caller
    }
}

// ===== SAVE/DELETE with Organization =====
async function saveLead(leadData){
    if(!currentOrg){
        showWarning('Оберіть організацію');
        return false;
    }
    
    setSyncStatus('syncing', 'Збереження...');
    try {
        // Валідація та санітизація
        const sanitized = sanitizeLead(leadData);
        
        // Clean undefined values (Firebase doesn't accept them)
        const cleanData = JSON.parse(JSON.stringify(sanitized, (key, value) => 
            value === undefined ? null : value
        ));
        
        const docRef = db.collection('organizations').doc(currentOrg.id).collection('leads').doc(cleanData.id);
        await docRef.set(cleanData);
        setSyncStatus('synced', 'Синхронізовано');
        return true;
    } catch(err){
        logError('saveLead', err, { leadId: leadData?.id });
        setSyncStatus('error', 'Помилка збереження');
        showWarning('Помилка збереження: ' + (err.message || 'невідома помилка'));
        return false;
    }
}

async function deleteLead(leadId){
    if(!currentOrg) return false;
    if(!leadId) {
        console.error('deleteLead: leadId is empty');
        showError('Помилка: ID ліда не визначено');
        return false;
    }
    
    console.log('deleteLead: Soft delete for', leadId);
    setSyncStatus('syncing', 'Видалення...');
    
    try {
        const docRef = db.collection('organizations').doc(currentOrg.id).collection('leads').doc(leadId);
        
        // М'яке видалення - ставимо deleted: true
        await docRef.update({
            deleted: true,
            deletedAt: new Date().toISOString()
        });
        console.log('deleteLead: Marked as deleted in Firebase');
        
        // Видаляємо з локального масиву (для UI)
        const idx = leads.findIndex(l => l.id === leadId);
        if (idx >= 0) {
            leads.splice(idx, 1);
            console.log('deleteLead: Removed from local array, new length:', leads.length);
        }
        
        setSyncStatus('synced', 'Синхронізовано');
        render();
        showToast('Ліда видалено');
        return true;
    } catch(err){
        console.error('deleteLead: ERROR', err);
        logError('deleteLead', err, { leadId });
        setSyncStatus('error', 'Помилка видалення');
        showError('Помилка видалення: ' + err.message);
        return false;
    }
}

// ===== DATA MIGRATION & CLEANUP =====
function analyzeDataQuality() {
    const issues = {
        invalidDates: [],
        missingStatus: [],
        invalidStatus: [],
        orphanedLeads: [],
        duplicateContacts: [],
        summary: {}
    };
    
    const validStatuses = ['new', 'contacted', 'scheduled', 'completed', 'report_sent', 'repeat', 'deposit', 'paid', 'failed', 'frozen'];
    const phones = new Map();
    const emails = new Map();
    
    leads.forEach(l => {
        // Перевірка дат
        ['nextDate', 'consult', 'reactDate', 'finDepDate', 'finPaidDate'].forEach(field => {
            if (l[field] && !validateDate(l[field])) {
                issues.invalidDates.push({ id: l.id, field, value: l[field] });
            }
        });
        
        // Перевірка статусу
        if (!l.status) {
            issues.missingStatus.push({ id: l.id, name: l.tg || l.phone });
        } else if (!validStatuses.includes(l.status) && !l.status.startsWith('status_')) {
            // Дозволяємо кастомні статуси (status_*)
            issues.invalidStatus.push({ id: l.id, status: l.status });
        }
        
        // Дублікати телефонів
        if (l.phone) {
            const normalized = String(l.phone).replace(/\D/g, '');
            if (phones.has(normalized)) {
                issues.duplicateContacts.push({ 
                    id: l.id, 
                    duplicateOf: phones.get(normalized),
                    phone: l.phone 
                });
            } else {
                phones.set(normalized, l.id);
            }
        }
        
        // Дублікати email
        if (l.email) {
            const normalized = l.email.toLowerCase().trim();
            if (emails.has(normalized)) {
                issues.duplicateContacts.push({ 
                    id: l.id, 
                    duplicateOf: emails.get(normalized),
                    email: l.email 
                });
            } else {
                emails.set(normalized, l.id);
            }
        }
    });
    
    issues.summary = {
        total: leads.length,
        invalidDates: issues.invalidDates.length,
        missingStatus: issues.missingStatus.length,
        invalidStatus: issues.invalidStatus.length,
        duplicates: issues.duplicateContacts.length,
        healthScore: Math.round(100 - (
            (issues.invalidDates.length + issues.missingStatus.length + 
             issues.invalidStatus.length + issues.duplicateContacts.length) / 
            Math.max(1, leads.length) * 100
        ))
    };
    
    return issues;
}

async function migrateAndCleanData(options = {}) {
    const { 
        fixDates = true, 
        fixStatus = true, 
        dryRun = true 
    } = options;
    
    const results = {
        checked: 0,
        fixed: 0,
        errors: 0,
        details: []
    };
    
    for (let i = 0; i < leads.length; i++) {
        const lead = leads[i]; // Працюємо з оригіналом!
        results.checked++;
        const fixes = [];
        
        // Фікс невалідних дат
        if (fixDates) {
            ['nextDate', 'consult', 'reactDate', 'finDepDate', 'finPaidDate'].forEach(field => {
                if (lead[field] && !validateDate(lead[field])) {
                    lead[field] = null;
                    fixes.push(`${field}: invalid → null`);
                }
            });
        }
        
        // Фікс відсутнього статусу
        if (fixStatus && !lead.status) {
            lead.status = 'new';
            lead.nextDate = lead.nextDate || today();
            lead.nextTime = lead.nextTime || '10:00';
            lead.nextAction = lead.nextAction || 'Подзвонити';
            fixes.push('status: null → "new"');
        }
        
        // Зберігаємо якщо є зміни
        if (fixes.length > 0) {
            results.details.push({ id: lead.id, name: lead.tg || lead.phone, fixes });
            
            if (!dryRun) {
                try {
                    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
                        value === undefined ? null : value
                    ));
                    await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData);
                    results.fixed++;
                } catch (err) {
                    results.errors++;
                    logError('migrateData', err, { leadId: lead.id });
                }
            } else {
                results.fixed++;
            }
        }
    }
    
    if (!dryRun && results.fixed > 0) {
        render();
    }
    
    return results;
}

// ===== EXPORT TO CSV/EXCEL =====
function exportLeadsToCSV() {
    const data = filterLeadsWithFunnelAndAssignee(leads);
    
    if (data.length === 0) {
        showWarning('Немає даних для експорту');
        return;
    }
    
    // Заголовки
    const headers = [
        'ID', 'Telegram', 'Телефон', 'Email', 'Бізнес', 'Джерело',
        'Статус', 'Дзвінки', 'SMS', 'No-show', 
        'Наступна дія', 'Дата дії', 'Час дії',
        'Консультація', 'Завдаток', 'Повна сума',
        'Примітки', 'Звіт', 'Створено'
    ];
    
    // Дані
    const rows = data.map(l => [
        l.id,
        l.tg || '',
        l.phone || '',
        l.email || '',
        l.biz || '',
        SRC[l.source] || l.source || '',
        getStatusName(l.status) || '',
        l.calls || 0,
        l.sms || 0,
        l.noshow || 0,
        l.nextAction || '',
        l.nextDate || '',
        l.nextTime || '',
        l.consult || '',
        l.finDep || '',
        l.finTotal || '',
        (l.notes || '').replace(/[\n\r]/g, ' ').slice(0, 500),
        (l.report || '').replace(/[\n\r]/g, ' ').slice(0, 500),
        l.created || ''
    ]);
    
    // Формуємо CSV з BOM для Excel
    const BOM = '\uFEFF';
    const csvContent = BOM + [
        headers.join(';'),
        ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';'))
    ].join('\n');
    
    // Завантажуємо
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `leads_${currentOrg?.name || 'export'}_${today()}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast(`Експортовано ${data.length} лідів`);
}

function exportLeadsToJSON() {
    const data = filterLeadsWithFunnelAndAssignee(leads);
    
    if (data.length === 0) {
        showWarning('Немає даних для експорту');
        return;
    }
    
    const jsonContent = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `leads_${currentOrg?.name || 'export'}_${today()}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showToast(`Експортовано ${data.length} лідів`);
}

// ===== MESSAGE TEMPLATES =====
const MESSAGE_TEMPLATES = {
    confirm_consultation: {
        name: 'Підтвердження консультації',
        text: 'Добрий день! Нагадую про нашу консультацію {date} о {time}. Підтверджуєте?'
    },
    after_consultation: {
        name: 'Після консультації',
        text: 'Дякую за консультацію! Надсилаю звіт з рекомендаціями. Якщо є питання — пишіть!'
    },
    followup_report: {
        name: 'Фоллоу-ап після звіту',
        text: 'Добрий день! Перевірили звіт? Чи є питання? Готовий обговорити деталі.'
    },
    deposit_reminder: {
        name: 'Нагадування про оплату',
        text: 'Добрий день! Нагадую про завдаток. Чи все гаразд? Готовий допомогти.'
    },
    reactivation: {
        name: 'Реактивація',
        text: 'Добрий день! Ми спілкувались раніше про {topic}. Чи актуально для вас зараз?'
    },
    noshow: {
        name: 'Після неявки',
        text: 'Добрий день! На жаль, не змогли зустрітись. Все гаразд? Коли зручно перенести?'
    }
};

function getMessageTemplate(templateId, lead) {
    const template = MESSAGE_TEMPLATES[templateId];
    if (!template) return null;
    
    let text = template.text;
    
    // Заміна плейсхолдерів
    if (lead.consult) {
        const [date, time] = lead.consult.split('T');
        text = text.replace('{date}', fmtDate(date));
        text = text.replace('{time}', time?.slice(0, 5) || '');
    }
    text = text.replace('{topic}', lead.biz || 'ваш бізнес');
    text = text.replace('{name}', lead.tg || '');
    
    return text;
}

function showMessageTemplates(leadId) {
    const lead = leads.find(l => l.id === leadId);
    if (!lead) return;
    
    // Закриваємо попередні модалки
    closeTemplatesModal();
    
    // Створюємо overlay
    let overlay = document.getElementById('templates-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'templates-overlay';
        document.body.appendChild(overlay);
    }
    // Inline стилі для гарантії
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;display:block';
    overlay.onclick = closeTemplatesModal;
    
    // Створюємо modal
    let modal = document.getElementById('templates-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'templates-modal';
        document.body.appendChild(modal);
    }
    // Inline стилі для гарантії
    modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:201;width:420px;max-width:95vw;display:block';
    
    const templatesHtml = Object.entries(MESSAGE_TEMPLATES).map(([id, tmpl]) => {
        const text = getMessageTemplate(id, lead);
        return `
            <div style="padding:12px;background:#f9fafb;border-radius:12px;margin-bottom:10px">
                <div style="font-weight:600;font-size:14px;color:#1a1a1a;margin-bottom:6px">${tmpl.name}</div>
                <div style="font-size:13px;color:#4b5563;margin-bottom:10px;line-height:1.4">${text}</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button onclick="copyTemplate('${id}', '${leadId}')" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#f3f4f6;border:none;border-radius:8px;font-size:13px;font-weight:500;color:#374151;cursor:pointer">
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        Копіювати
                    </button>
                    ${lead.phone ? `<a href="https://wa.me/${String(lead.phone).replace(/\D/g, '')}?text=${encodeURIComponent(text)}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#25D366;border:none;border-radius:8px;font-size:13px;font-weight:500;color:white;text-decoration:none">WhatsApp</a>` : ''}
                    ${lead.tg ? `<a href="https://t.me/${String(lead.tg).replace('@', '')}?text=${encodeURIComponent(text)}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 12px;background:#0088cc;border:none;border-radius:8px;font-size:13px;font-weight:500;color:white;text-decoration:none">Telegram</a>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    modal.innerHTML = `
        <div style="padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:16px;font-weight:600;color:#1a1a1a">Шаблони повідомлень</span>
            <button onclick="closeTemplatesModal()" style="width:32px;height:32px;border:none;background:#f3f4f6;border-radius:50%;font-size:20px;color:#666;cursor:pointer;display:flex;align-items:center;justify-content:center">×</button>
        </div>
        <div style="padding:16px;max-height:60vh;overflow-y:auto">
            ${templatesHtml}
        </div>
    `;
}

function closeTemplatesModal() {
    const overlay = document.getElementById('templates-overlay');
    const modal = document.getElementById('templates-modal');
    if(overlay) overlay.style.display = 'none';
    if(modal) modal.style.display = 'none';
}

function copyTemplate(templateId, leadId) {
    const lead = leads.find(l => l.id === leadId);
    if (!lead) return;
    
    const text = getMessageTemplate(templateId, lead);
    navigator.clipboard.writeText(text).then(() => {
        showToast('Скопійовано!');
    }).catch(() => {
        showWarning('Не вдалося скопіювати');
    });
}

// ===== UNDO/REDO SYSTEM =====
const undoStack = [];
const redoStack = [];
const MAX_UNDO = 20;

function pushUndo(action, data) {
    undoStack.push({ action, data, timestamp: Date.now() });
    if (undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack.length = 0; // Clear redo on new action
}

async function undo() {
    if (undoStack.length === 0) {
        showWarning('Немає дій для скасування');
        return;
    }
    
    const item = undoStack.pop();
    
    try {
        switch (item.action) {
            case 'update_lead':
                // Зберігаємо поточний стан для redo
                const currentLead = leads.find(l => l.id === item.data.id);
                if (currentLead) {
                    redoStack.push({ action: 'update_lead', data: { ...currentLead } });
                }
                // Знаходимо індекс і оновлюємо оригінал
                const idx = leads.findIndex(l => l.id === item.data.id);
                if (idx >= 0) {
                    Object.assign(leads[idx], item.data);
                    const cleanData = JSON.parse(JSON.stringify(leads[idx], (key, value) => 
                        value === undefined ? null : value
                    ));
                    await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(item.data.id).set(cleanData);
                }
                showToast('Скасовано');
                render();
                break;
                
            case 'delete_lead':
                // Відновлюємо видаленого ліда
                leads.push(item.data);
                const cleanDataDel = JSON.parse(JSON.stringify(item.data, (key, value) => 
                    value === undefined ? null : value
                ));
                await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(item.data.id).set(cleanDataDel);
                redoStack.push({ action: 'delete_lead', data: item.data });
                showToast('Лід відновлено');
                render();
                break;
                
            case 'status_change':
                const lead = leads.find(l => l.id === item.data.id);
                if (lead) {
                    redoStack.push({ 
                        action: 'status_change', 
                        data: { id: lead.id, oldStatus: lead.status, newStatus: item.data.oldStatus }
                    });
                    lead.status = item.data.oldStatus;
                    const cleanDataStatus = JSON.parse(JSON.stringify(lead, (key, value) => 
                        value === undefined ? null : value
                    ));
                    await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanDataStatus);
                    showToast('Статус повернено');
                    render();
                }
                break;
        }
    } catch (err) {
        logError('undo', err, item);
        showWarning('Помилка скасування');
    }
}

async function redo() {
    if (redoStack.length === 0) {
        showWarning('Немає дій для повтору');
        return;
    }
    
    const item = redoStack.pop();
    
    try {
        switch (item.action) {
            case 'update_lead':
                const currentLead = leads.find(l => l.id === item.data.id);
                if (currentLead) {
                    undoStack.push({ action: 'update_lead', data: { ...currentLead } });
                }
                const idx = leads.findIndex(l => l.id === item.data.id);
                if (idx >= 0) {
                    Object.assign(leads[idx], item.data);
                    const cleanData = JSON.parse(JSON.stringify(leads[idx], (key, value) => 
                        value === undefined ? null : value
                    ));
                    await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(item.data.id).set(cleanData);
                }
                showToast('Повторено');
                render();
                break;
                
            case 'delete_lead':
                undoStack.push({ action: 'delete_lead', data: item.data });
                await deleteLead(item.data.id);
                showToast('Видалено знову');
                render();
                break;
        }
    } catch (err) {
        logError('redo', err, item);
        showWarning('Помилка повтору');
    }
}

// ===== AUTO-STATUS RULES =====
const AUTO_STATUS_RULES = [
    {
        name: 'Заморозка після 3 неявок',
        condition: (l) => l.noshow >= 3 && l.status !== 'frozen' && l.status !== 'paid',
        action: (l) => ({ ...l, status: 'frozen', reactDate: addDays(today(), 90) }),
        message: 'Автоматично заморожено (3+ неявки)'
    },
    {
        name: 'Реактивація прострочених',
        condition: (l) => l.status === 'frozen' && l.reactDate && l.reactDate <= today(),
        action: (l) => ({ ...l, status: 'new', calls: 0, sms: 0, noshow: 0, nextDate: today(), nextAction: 'Реактивація' }),
        message: 'Автоматична реактивація'
    }
];

async function applyAutoStatusRules() {
    let applied = 0;
    
    for (let i = 0; i < leads.length; i++) {
        const lead = leads[i]; // Працюємо з оригіналом!
        for (const rule of AUTO_STATUS_RULES) {
            if (rule.condition(lead)) {
                // Застосовуємо зміни до оригіналу
                const changes = rule.action(lead);
                Object.assign(lead, changes);
                addLog(lead, 'auto', rule.message);
                
                // Зберігаємо напряму в Firebase
                const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
                    value === undefined ? null : value
                ));
                await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData);
                applied++;
            }
        }
    }
    
    if (applied > 0) {
        console.log(`Auto-status rules applied to ${applied} leads`);
        render();
    }
    
    return applied;
}

// ===== DIAGNOSTICS PANEL =====
function openDiagnosticsPanel() {
    const analysis = analyzeDataQuality();
    const errors = getErrorLog();
    
    let modal = document.getElementById('diagnostics-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'diagnostics-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:700px;max-height:90vh;overflow:auto">
                <div class="modal-header">
                    <h2>🔧 Діагностика системи</h2>
                    <button class="close-modal" onclick="closeDiagnosticsPanel()">×</button>
                </div>
                <div id="diagnostics-content"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    const healthColor = analysis.summary.healthScore >= 90 ? '#22c55e' : 
                        analysis.summary.healthScore >= 70 ? '#eab308' : '#ef4444';
    
    document.getElementById('diagnostics-content').innerHTML = `
        <div style="padding:20px">
            <!-- Health Score -->
            <div style="text-align:center;margin-bottom:24px">
                <div style="font-size:48px;font-weight:700;color:${healthColor}">${analysis.summary.healthScore}%</div>
                <div style="color:#6b7280;font-size:14px">Здоров'я даних</div>
            </div>
            
            <!-- Summary Cards -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px">
                <div style="background:#f0fdf4;padding:16px;border-radius:12px;text-align:center">
                    <div style="font-size:24px;font-weight:600;color:#22c55e">${analysis.summary.total}</div>
                    <div style="font-size:12px;color:#6b7280">Всього лідів</div>
                </div>
                <div style="background:${analysis.summary.invalidDates?'#fef2f2':'#f9fafb'};padding:16px;border-radius:12px;text-align:center">
                    <div style="font-size:24px;font-weight:600;color:${analysis.summary.invalidDates?'#ef4444':'#22c55e'}">${analysis.summary.invalidDates}</div>
                    <div style="font-size:12px;color:#6b7280">Невалідні дати</div>
                </div>
                <div style="background:${analysis.summary.missingStatus?'#fef2f2':'#f9fafb'};padding:16px;border-radius:12px;text-align:center">
                    <div style="font-size:24px;font-weight:600;color:${analysis.summary.missingStatus?'#ef4444':'#22c55e'}">${analysis.summary.missingStatus}</div>
                    <div style="font-size:12px;color:#6b7280">Без статусу</div>
                </div>
                <div style="background:${analysis.summary.duplicates?'#fef3c7':'#f9fafb'};padding:16px;border-radius:12px;text-align:center">
                    <div style="font-size:24px;font-weight:600;color:${analysis.summary.duplicates?'#d97706':'#22c55e'}">${analysis.summary.duplicates}</div>
                    <div style="font-size:12px;color:#6b7280">Дублікати</div>
                </div>
            </div>
            
            <!-- Issues Details -->
            ${analysis.summary.invalidDates + analysis.summary.missingStatus + analysis.summary.duplicates > 0 ? `
                <div style="margin-bottom:24px">
                    <h3 style="font-size:14px;font-weight:600;margin-bottom:12px">Проблеми для виправлення</h3>
                    <div style="background:#f9fafb;border-radius:12px;padding:16px;max-height:200px;overflow:auto;font-size:13px">
                        ${analysis.invalidDates.slice(0, 10).map(i => `
                            <div style="padding:4px 0;border-bottom:1px solid #e5e7eb">
                                🗓️ <strong>${i.id.slice(0,8)}...</strong> — ${i.field}: "${i.value}"
                            </div>
                        `).join('')}
                        ${analysis.missingStatus.slice(0, 10).map(i => `
                            <div style="padding:4px 0;border-bottom:1px solid #e5e7eb">
                                ⚠️ <strong>${i.name || i.id.slice(0,8)}</strong> — немає статусу
                            </div>
                        `).join('')}
                        ${analysis.duplicateContacts.slice(0, 10).map(i => `
                            <div style="padding:4px 0;border-bottom:1px solid #e5e7eb">
                                👥 <strong>${i.phone || i.email}</strong> — дублікат
                            </div>
                        `).join('')}
                        ${(analysis.invalidDates.length + analysis.missingStatus.length + analysis.duplicateContacts.length) > 10 ? 
                            `<div style="padding:8px 0;color:#6b7280;font-style:italic">...та ще ${analysis.invalidDates.length + analysis.missingStatus.length + analysis.duplicateContacts.length - 10}</div>` : ''}
                    </div>
                </div>
                
                <!-- Fix Buttons -->
                <div style="display:flex;gap:12px;margin-bottom:24px">
                    <button onclick="runMigrationDryRun()" class="btn" style="flex:1">
                        🔍 Перевірити (без змін)
                    </button>
                    <button onclick="runMigrationFix()" class="btn btn-p" style="flex:1">
                        🔧 Виправити автоматично
                    </button>
                </div>
            ` : `
                <div style="text-align:center;padding:24px;color:#22c55e">
                    ✅ Всі дані в порядку!
                </div>
            `}
            
            <!-- Error Log -->
            <div style="margin-bottom:16px">
                <h3 style="font-size:14px;font-weight:600;margin-bottom:12px">Лог помилок (${errors.length})</h3>
                <div style="background:#f9fafb;border-radius:12px;padding:16px;max-height:150px;overflow:auto;font-size:12px;font-family:monospace">
                    ${errors.length === 0 ? '<div style="color:#6b7280">Помилок немає</div>' : 
                        errors.slice(0, 20).map(e => `
                            <div style="padding:4px 0;border-bottom:1px solid #e5e7eb">
                                <span style="color:#6b7280">${e.timestamp.slice(11,19)}</span>
                                <span style="color:#ef4444">[${e.context}]</span>
                                ${e.message}
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <!-- System Info -->
            <div style="font-size:11px;color:#9ca3af;text-align:center">
                Версія CRM: 2.0 | Лідів в пам'яті: ${leads.length} | 
                Браузер: ${navigator.userAgent.includes('Chrome') ? 'Chrome' : navigator.userAgent.includes('Firefox') ? 'Firefox' : 'Інший'}
            </div>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeDiagnosticsPanel() {
    document.getElementById('diagnostics-modal')?.classList.remove('active');
}

async function runMigrationDryRun() {
    const results = await migrateAndCleanData({ dryRun: true });
    alert(`Перевірка завершена!\n\nПеревірено: ${results.checked}\nБуде виправлено: ${results.fixed}\n\nДеталі в консолі.`);
    console.log('Migration dry run results:', results);
}

async function runMigrationFix() {
    if (!confirm(`Ви впевнені що хочете автоматично виправити дані?\n\nЦе змінить ${leads.length} записів.`)) return;
    
    const results = await migrateAndCleanData({ dryRun: false });
    alert(`Міграція завершена!\n\nПеревірено: ${results.checked}\nВиправлено: ${results.fixed}\nПомилок: ${results.errors}`);
    console.log('Migration results:', results);
    openDiagnosticsPanel(); // Оновити панель
}

function setSyncStatus(status, text){
    const dot = document.getElementById('sync-dot');
    const txt = document.getElementById('sync-text');
    dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'error' ? ' error' : '');
    txt.textContent = text;
}

// ===== CONSTANTS =====
const ST_DEFAULT={new:'Новий лід',contacted:'Контакт',scheduled:'Призначена',completed:'Проведена',report_sent:'Звіт відправлено',repeat:'Повторна',deposit:'Завдаток',paid:'Оплачено',failed:'Відмова',frozen:'Заморожений'};

function getStatusName(statusId, funnelId){ 
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === (funnelId || currentFunnelId || 'default')) || funnels.find(f => f.isDefault) || funnels[0];
    const statuses = funnel?.statuses || ST_DEFAULT;
    return statuses[statusId]?.name || ST_DEFAULT[statusId] || statusId; 
}

function getStatusColor(statusId, funnelId){ 
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === (funnelId || currentFunnelId || 'default')) || funnels.find(f => f.isDefault) || funnels[0];
    const statuses = funnel?.statuses;
    return statuses?.[statusId]?.color || '#6b7280'; 
}

function getStatusIds(funnelId){ 
    const funnels = getOrgFunnels();
    const funnel = funnels.find(f => f.id === (funnelId || currentFunnelId || 'default')) || funnels.find(f => f.isDefault) || funnels[0];
    const statuses = funnel?.statuses || ST_DEFAULT;
    return Object.entries(statuses).sort((a,b) => (a[1].order||0) - (b[1].order||0)).map(([id]) => id); 
}

const ST = ST_DEFAULT; // Legacy compatibility

// Default sources (will be overridden by org settings)
const DEFAULT_SOURCES = {
    bot: 'Бот',
    mk_clinic: 'МК Клініки',
    mk_prod: 'МК Виробництво',
    ads: 'Реклама',
    ref: 'Рекомендація',
    clinic_ua: 'Клініки UA',
    clinic_eu: 'Клініки EU',
    furniture_ua: 'Меблі UA',
    furniture_eu: 'Меблі EU',
    prod_ua: 'Виробництво UA',
    prod_metal_ua: 'Виробництво метал UA',
    prod_food_ua: 'Виробництво харчове UA',
    prod_eu: 'Виробництво EU',
    prod_eu_ru: 'Виробництво EU (RU)'
};

// Get sources from org settings or use defaults
function getOrgSources() {
    if (currentOrg?.settings?.sources && Object.keys(currentOrg.settings.sources).length > 0) {
        return currentOrg.settings.sources;
    }
    return DEFAULT_SOURCES;
}

// Legacy SRC variable - now dynamically gets sources
const SRC = new Proxy({}, {
    get: function(target, prop) {
        const sources = getOrgSources();
        return sources[prop] || prop;
    },
    has: function(target, prop) {
        const sources = getOrgSources();
        return prop in sources;
    }
});

const CUR={UAH:'₴',USD:'$',EUR:'€'};
let leads=[];
let editing=null;
let currentFilter='all';
let taskFilter='all';

function setTaskFilter(f){
    taskFilter = f;
    renderTaskFilters(); // Перемалювати вкладки з активним станом
    renderTasks();
}

function save(){} // deprecated - now using Firestore
function today(){return new Date().toISOString().split('T')[0]}
function tomorrow(){let d=new Date();d.setDate(d.getDate()+1);return d.toISOString().split('T')[0]}
function addDays(s,n){if(!s)return tomorrow();try{let d=new Date(s);d.setDate(d.getDate()+n);return d.toISOString().split('T')[0]}catch(e){return tomorrow()}}
function fmtDate(s){if(!s)return'—';try{return new Date(s).toLocaleDateString('uk-UA',{day:'numeric',month:'short'})}catch(e){return s}}
function fmtDT(s){if(!s)return'—';try{return new Date(s).toLocaleString('uk-UA',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})}catch(e){return s}}
function genId(){return'l'+Date.now()+''+Math.random().toString(36).substr(2,5)}
// Безпечні функції для роботи з датами
function getDateOnly(dateStr){if(!dateStr)return null;return dateStr.includes('T')?dateStr.split('T')[0]:dateStr}
function getTimeOnly(dateStr){if(!dateStr||!dateStr.includes('T'))return null;return(dateStr.split('T')[1]||'').slice(0,5)||null}
function getConsultDate(lead){return lead?.consult?getDateOnly(lead.consult):null}
function getConsultTime(lead){return lead?.consult?getTimeOnly(lead.consult):null}
function getDayBefore(dateStr){return addDays(getDateOnly(dateStr)||today(),-1)}

// ===== TASK ICONS (SVG) =====
const TASK_ICONS = {
    // Критичні
    alert: '<svg class="task-icon critical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    overdue: '<svg class="task-icon critical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    
    // Дзвінки
    phone: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
    
    // Календар/Дати
    calendar: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    
    // Консультація/Зустріч
    meeting: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
    
    // Підтвердження/Успіх
    check: '<svg class="task-icon success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    
    // Документ/Звіт
    document: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
    
    // Гроші/Завдаток
    money: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
    
    // Реактивація/Оновлення
    refresh: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>',
    
    // Ціль/Результат
    target: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
    
    // Попередження
    warning: '<svg class="task-icon warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    
    // SMS
    sms: '<svg class="task-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
};

function taskIcon(type) {
    return TASK_ICONS[type] || TASK_ICONS.alert;
}

function switchView(v){
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
    document.getElementById('v-'+v).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    const navBtn = document.querySelector(`.nav-btn[onclick="switchView('${v}')"]`);
    if(navBtn) navBtn.classList.add('active');
    
    // Оновлюємо мобільну навігацію
    updateMobileNav(v);
    
    render();
}

// ===== MOBILE NAVIGATION =====
function mobileNav(view){
    switchView(view);
}

function updateMobileNav(view){
    document.querySelectorAll('.mobile-nav-item').forEach(item => item.classList.remove('active'));
    const activeItem = document.getElementById('mnav-' + view);
    if(activeItem) activeItem.classList.add('active');
    
    // Оновлюємо badge з кількістю задач
    updateMobileTasksBadge();
}

function updateMobileTasksBadge(){
    const tasks = getTasks();
    const criticalCount = tasks.filter(t => t.p === 'critical').length;
    const badge = document.getElementById('mnav-tasks-badge');
    if(badge){
        if(criticalCount > 0){
            badge.textContent = criticalCount > 99 ? '99+' : criticalCount;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }
}

function openMobileMenu(){
    document.getElementById('mobile-menu-overlay').classList.add('active');
    document.getElementById('mobile-menu').classList.add('active');
    document.getElementById('mobile-user-email').textContent = currentUser?.email || '';
}

function closeMobileMenu(){
    document.getElementById('mobile-menu-overlay').classList.remove('active');
    document.getElementById('mobile-menu').classList.remove('active');
}

function render(){
    const v=document.querySelector('.view.active').id;
    if(v==='v-tasks'){
        renderTaskFilters(); // Оновлюємо вкладки зі статусів
        renderTasks();
    }
    else if(v==='v-kanban')renderKanban();
    else renderReports();
    
    // Оновлюємо мобільний badge
    updateMobileTasksBadge();
}

// ===== SKELETON LOADING =====
function showTasksSkeleton() {
    const container = document.getElementById('tasks-list');
    if(!container) return;
    
    container.innerHTML = Array(5).fill(0).map(() => `
        <div class="skeleton-row">
            <div class="skeleton skeleton-circle"></div>
            <div style="flex:1;display:flex;flex-direction:column;gap:8px">
                <div class="skeleton skeleton-line medium"></div>
                <div class="skeleton skeleton-line short"></div>
            </div>
            <div class="skeleton skeleton-line" style="width:80px"></div>
        </div>
    `).join('');
}

function showKanbanSkeleton() {
    const container = document.getElementById('kanban');
    if(!container) return;
    
    container.innerHTML = Array(4).fill(0).map(() => `
        <div class="skeleton-column">
            <div class="skeleton skeleton-column-header"></div>
            ${Array(3).fill(0).map(() => `
                <div class="skeleton skeleton-card"></div>
            `).join('')}
        </div>
    `).join('');
}

function showSkeleton() {
    const v = document.querySelector('.view.active')?.id;
    if(v === 'v-tasks') showTasksSkeleton();
    else if(v === 'v-kanban') showKanbanSkeleton();
}

// ===== TASKS =====
function getTasks(){
    const t=today(),tm=tomorrow(),tasks=[];
    const now = new Date();
    const currentHour = now.getHours();
    
    // Застосовуємо фільтри (включаючи пошук)
    const filteredLeads = filterLeadsWithFunnelAndAssignee(leads);
    
    filteredLeads.forEach(l=>{
        // ========== ЗАВЕРШЕНІ СТАТУСИ ==========
        // Оплачені - виключаємо з активних задач
        if(l.status==='paid') return;
        
        // Заморожені та Відмова - ТІЛЬКИ реактивація
        if(['failed','frozen'].includes(l.status)){
            if(l.reactDate && l.reactDate <= t){
                tasks.push({l, p:'warning', icon:'refresh', msg:'Реактивація — час повернутися!', btns:[
                    {t:'success',l:'Цікаво',a:'react_ok'},
                    {t:'secondary',l:'+3 міс',a:'react_later'},
                    {t:'danger',l:'Видалити',a:'delete_lead'}
                ]});
            }
            // Показуємо в секції "Пізніше" якщо реактивація в майбутньому
            else if(l.reactDate && l.reactDate > t){
                tasks.push({l, p:'info', icon:'calendar', msg:`Реактивація ${fmtDate(l.reactDate)}`, btns:[
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            return;
        }
        
        // ========== КРИТИЧНІ ПОМИЛКИ ==========
        if(!l.status){
            tasks.push({l,p:'critical',icon:'warning',msg:'НЕМАЄ СТАТУСУ!',btns:[{t:'warn',l:'Виправити',a:'open'}]});
            return;
        }
        
        // ========== НОВИЙ ЛІД / КОНТАКТ ==========
        if(l.status==='new' || l.status==='contacted'){
            // 3+ дзвінки без відповіді — критично
            if(l.calls>=3){
                tasks.push({l,p:'critical',icon:'alert',msg:'3 дзвінки без відповіді — рішення!',btns:[
                    {t:'warn',l:'Заморозити',a:'freeze'},
                    {t:'secondary',l:'Ще спроба',a:'call'},
                    {t:'secondary',l:'SMS',a:'send_sms'}
                ]});
            }
            // Прострочено — критично
            else if(l.nextDate && l.nextDate < t){
                const daysOverdue = Math.floor((new Date(t) - new Date(l.nextDate)) / 864e5);
                tasks.push({l,p:'critical',icon:'overdue',msg:`Прострочено ${daysOverdue}дн — ПОДЗВОНИТИ!`,btns:[
                    {t:'success',l:'Призначив',a:'schedule'},
                    {t:'secondary',l:'Не взяв',a:'call_later'},
                    {t:'warn',l:'Заморозити',a:'freeze'}
                ]});
            }
            // Сьогодні — warning
            else if(!l.nextDate || l.nextDate === t){
                const timeStr = l.nextTime ? ` о ${l.nextTime}` : '';
                tasks.push({l,p:'warning',icon:'phone',msg:`Подзвонити${timeStr} (${l.calls||0}/3)`,btns:[
                    {t:'success',l:'Призначив',a:'schedule'},
                    {t:'secondary',l:'Не взяв',a:'call_later'},
                    {t:'warn',l:'Заморозити',a:'freeze'}
                ]});
            }
            // Завтра
            else if(l.nextDate === tm){
                tasks.push({l,p:'info',icon:'calendar',msg:`Завтра: подзвонити (${l.calls||0}/3)`,btns:[
                    {t:'success',l:'Зробити зараз',a:'do_now'},
                    {t:'secondary',l:'OK',a:'open'}
                ]});
            }
            // Пізніше
            else {
                tasks.push({l,p:'info',icon:'calendar',msg:`${fmtDate(l.nextDate)}: ${l.nextAction||'подзвонити'}`,btns:[
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            return;
        }
        
        // ========== ПРИЗНАЧЕНА КОНСУЛЬТАЦІЯ ==========
        if(l.status==='scheduled'||l.status==='repeat'){
            let cd = null, consultTime = null;
            if(l.consult){
                const consultStr = String(l.consult);
                cd = consultStr.includes('T') ? consultStr.split('T')[0] : consultStr;
                consultTime = consultStr.includes('T') ? consultStr.split('T')[1]?.slice(0,5) : null;
            }
            
            // Немає дати консультації — критично!
            if(!cd){
                tasks.push({l, p:'critical', icon:'warning', msg:'Призначити дату консультації!', btns:[
                    {t:'success',l:'Призначити',a:'reschedule'}
                ]});
                return;
            }
            
            // Консультація в минулому — критично!
            if(cd < t){
                const daysAgo = Math.floor((new Date(t) - new Date(cd)) / 864e5);
                tasks.push({l, p:'critical', icon:'overdue', msg:`Консультація була ${daysAgo}дн тому — результат?`, btns:[
                    {t:'success',l:'Проведена',a:'complete'},
                    {t:'danger',l:'Не прийшов',a:'noshow'},
                    {t:'secondary',l:'Перенесли',a:'reschedule'}
                ]});
                return;
            }
            
            // Консультація сьогодні
            if(cd === t){
                const confirmedToday = l.confirmedToday && l.confirmedDate === t;
                const consultHour = consultTime ? parseInt(consultTime.split(':')[0]) : 12;
                
                // До консультації і не підтверджено
                if(currentHour < consultHour && !confirmedToday){
                    tasks.push({l, p:'warning', icon:'phone', msg:`Підтвердити консультацію о ${consultTime||'12:00'}!`, btns:[
                        {t:'success',l:'Підтвердив',a:'confirm_today'},
                        {t:'secondary',l:'SMS',a:'confirm_sms'},
                        {t:'danger',l:'Скасував',a:'reschedule'}
                    ]});
                }
                // Час консультації настав або минув
                else if(currentHour >= consultHour){
                    tasks.push({l, p:'warning', icon:'target', msg:`Консультація зараз/була о ${consultTime||'—'} — результат?`, btns:[
                        {t:'success',l:'Проведена',a:'complete'},
                        {t:'danger',l:'Не прийшов',a:'noshow'}
                    ]});
                }
                // Підтверджено, чекаємо
                else {
                    tasks.push({l, p:'info', icon:'check', msg:`Консультація сьогодні о ${consultTime||'—'} (підтв.)`, btns:[
                        {t:'success',l:'Проведена',a:'complete'},
                        {t:'danger',l:'Не прийшов',a:'noshow'}
                    ]});
                }
                return;
            }
            
            // Консультація завтра — треба підтвердити!
            if(cd === tm){
                const confirmed = l.confirmedToday || l.confirmedDate === t;
                if(!confirmed){
                    tasks.push({l, p:'warning', icon:'phone', msg:`ЗАВТРА консультація о ${consultTime||'—'} — підтвердити!`, btns:[
                        {t:'success',l:'Підтвердив',a:'confirm'},
                        {t:'secondary',l:'SMS',a:'confirm_sms'}
                    ]});
                } else {
                    tasks.push({l, p:'info', icon:'check', msg:`Завтра о ${consultTime||'—'} (підтверджено)`, btns:[
                        {t:'secondary',l:'Перенести',a:'reschedule'}
                    ]});
                }
                return;
            }
            
            // Консультація пізніше — перевіряємо nextDate для нагадування
            if(cd > tm){
                const daysUntil = Math.floor((new Date(cd) - new Date(t)) / 864e5);
                
                // nextDate прострочено — треба щось робити!
                if(l.nextDate && l.nextDate < t){
                    tasks.push({l, p:'warning', icon:'phone', msg:`${l.nextAction||'Нагадати'} (конс. через ${daysUntil}дн)`, btns:[
                        {t:'success',l:'Зроблено',a:'next_done'},
                        {t:'secondary',l:'+1 день',a:'postpone_1d'}
                    ]});
                }
                // nextDate сьогодні
                else if(l.nextDate === t){
                    tasks.push({l, p:'info', icon:'document', msg:`${l.nextAction||'Нагадати'} (конс. ${fmtDate(cd)})`, btns:[
                        {t:'success',l:'Зроблено',a:'next_done'},
                        {t:'secondary',l:'Завтра',a:'postpone_1d'}
                    ]});
                }
                // Консультація далеко — просто показуємо
                else {
                    tasks.push({l, p:'info', icon:'calendar', msg:`Консультація ${fmtDate(cd)} о ${consultTime||'—'}`, btns:[
                        {t:'secondary',l:'Відкрити',a:'open'}
                    ]});
                }
            }
            return;
        }
        
        // ========== ПРОВЕДЕНА — ЧЕКАЄ ЗВІТ ==========
        if(l.status==='completed'){
            const consultDate = l.consult ? getDateOnly(l.consult) : null;
            const daysSince = consultDate ? Math.floor((new Date(t) - new Date(consultDate)) / 864e5) : 0;
            
            // Звіт прострочений (більше 1 дня)
            if(daysSince > 1){
                tasks.push({l, p:'critical', icon:'overdue', msg:`Звіт прострочено на ${daysSince}дн — НАПИСАТИ!`, btns:[
                    {t:'success',l:'Звіт готовий',a:'send_report'}
                ]});
            } else {
                tasks.push({l, p:'warning', icon:'document', msg:'Написати та відправити звіт!', btns:[
                    {t:'success',l:'Звіт готовий',a:'send_report'}
                ]});
            }
            return;
        }
        
        // ========== ЗВІТ ВІДПРАВЛЕНО — ДОЖИМ ==========
        if(l.status==='report_sent'){
            // 3+3 контактів — критична точка
            if(l.calls>=3 && l.sms>=3){
                tasks.push({l, p:'critical', icon:'alert', msg:'6 контактів без результату — РІШЕННЯ!', btns:[
                    {t:'success',l:'Завдаток',a:'deposit'},
                    {t:'warn',l:'Повторна',a:'repeat'},
                    {t:'danger',l:'Відмова',a:'fail'}
                ]});
                return;
            }
            
            // Прострочено
            if(l.nextDate && l.nextDate < t){
                const daysOverdue = Math.floor((new Date(t) - new Date(l.nextDate)) / 864e5);
                tasks.push({l, p:'critical', icon:'overdue', msg:`Дожим прострочено ${daysOverdue}дн!`, btns:[
                    {t:'success',l:'Завдаток',a:'deposit'},
                    {t:'secondary',l:'Думає',a:'followup'},
                    {t:'warn',l:'Повторна',a:'repeat'}
                ]});
            }
            // Сьогодні
            else if(!l.nextDate || l.nextDate === t){
                tasks.push({l, p:'warning', icon:'phone', msg:`Дожати! (дзв:${l.calls||0}/3, sms:${l.sms||0}/3)`, btns:[
                    {t:'success',l:'Завдаток',a:'deposit'},
                    {t:'secondary',l:'Думає',a:'followup'},
                    {t:'secondary',l:'SMS',a:'send_sms_followup'}
                ]});
            }
            // Завтра
            else if(l.nextDate === tm){
                tasks.push({l, p:'info', icon:'calendar', msg:`Завтра: дожати (${l.calls||0}дзв, ${l.sms||0}sms)`, btns:[
                    {t:'success',l:'Зробити зараз',a:'do_now'},
                    {t:'secondary',l:'OK',a:'open'}
                ]});
            }
            // Пізніше
            else {
                tasks.push({l, p:'info', icon:'calendar', msg:`${fmtDate(l.nextDate)}: ${l.nextAction||'дожати'}`, btns:[
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            return;
        }
        
        // ========== ЗАВДАТОК ==========
        if(l.status==='deposit'){
            const daysSinceDeposit = l.finDepDate ? Math.floor((new Date() - new Date(l.finDepDate)) / 864e5) : 0;
            
            // 14+ днів — критично!
            if(daysSinceDeposit >= 14){
                tasks.push({l, p:'critical', icon:'alert', msg:`Завдаток ${daysSinceDeposit}дн тому — ЗАКРИТИ!`, btns:[
                    {t:'success',l:'Оплатив',a:'paid'},
                    {t:'danger',l:'Повернення',a:'refund'}
                ]});
            }
            // 7+ днів або nextDate прострочено
            else if(daysSinceDeposit >= 7 || (l.nextDate && l.nextDate <= t)){
                tasks.push({l, p:'warning', icon:'money', msg:`Завдаток ${daysSinceDeposit}дн — нагадати про оплату!`, btns:[
                    {t:'success',l:'Оплатив',a:'paid'},
                    {t:'secondary',l:'+тиждень',a:'dep_later'}
                ]});
            }
            // Завтра
            else if(l.nextDate === tm){
                tasks.push({l, p:'info', icon:'calendar', msg:`Завтра: нагадати про оплату (${daysSinceDeposit}дн)`, btns:[
                    {t:'success',l:'Оплатив',a:'paid'},
                    {t:'secondary',l:'OK',a:'open'}
                ]});
            }
            // Пізніше
            else {
                tasks.push({l, p:'info', icon:'calendar', msg:`${fmtDate(l.nextDate)}: оплата (завд. ${daysSinceDeposit}дн)`, btns:[
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            return;
        }
        
        // ========== КАСТОМНІ СТАТУСИ ==========
        // Якщо статус не стандартний — показуємо задачу на основі nextDate/nextAction
        if(l.status && l.status.startsWith('status_')){
            // Прострочено
            if(l.nextDate && l.nextDate < t){
                const daysOverdue = Math.floor((new Date(t) - new Date(l.nextDate)) / 864e5);
                tasks.push({l, p:'critical', icon:'overdue', msg:`Прострочено ${daysOverdue}дн: ${l.nextAction||'виконати'}`, btns:[
                    {t:'success',l:'Виконано',a:'next_done'},
                    {t:'secondary',l:'Відкласти',a:'postpone_1d'},
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            // Сьогодні
            else if(!l.nextDate || l.nextDate === t){
                const timeStr = l.nextTime ? ` о ${l.nextTime}` : '';
                tasks.push({l, p:'warning', icon:'task', msg:`${l.nextAction||'Виконати задачу'}${timeStr}`, btns:[
                    {t:'success',l:'Виконано',a:'next_done'},
                    {t:'secondary',l:'Відкласти',a:'postpone_1d'},
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            // Завтра
            else if(l.nextDate === tm){
                tasks.push({l, p:'info', icon:'calendar', msg:`Завтра: ${l.nextAction||'задача'}`, btns:[
                    {t:'success',l:'Зробити зараз',a:'do_now'},
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            // Пізніше
            else {
                tasks.push({l, p:'info', icon:'calendar', msg:`${fmtDate(l.nextDate)}: ${l.nextAction||'задача'}`, btns:[
                    {t:'secondary',l:'Відкрити',a:'open'}
                ]});
            }
            return;
        }
        
        // ========== FALLBACK — ЛІД БЕЗ ЗАДАЧІ ==========
        // Якщо дійшли сюди — щось не так, лід "загубився"
        if(l.nextDate && l.nextDate < t){
            const daysOverdue = Math.floor((new Date(t) - new Date(l.nextDate)) / 864e5);
            tasks.push({l, p:'critical', icon:'warning', msg:`Загублений лід! Прострочено ${daysOverdue}дн`, btns:[
                {t:'warn',l:'Розібратись',a:'open'}
            ]});
        } else {
            tasks.push({l, p:'warning', icon:'warning', msg:`Лід без чіткої задачі — перевірити!`, btns:[
                {t:'warn',l:'Відкрити',a:'open'}
            ]});
        }
    });
    
    // Сортуємо: critical → warning → info
    tasks.sort((a,b)=>({critical:0,warning:1,info:2}[a.p]??3)-({critical:0,warning:1,info:2}[b.p]??3));
    return tasks;
}

function filterTasks(tasks){
    // Спеціальні фільтри
    if(taskFilter === 'all') return tasks;
    if(taskFilter === 'critical') return tasks.filter(t => t.p === 'critical');
    
    // Фільтр по статусу з Kanban
    return tasks.filter(t => t.l.status === taskFilter);
}

// Рендерить вкладки-фільтри зі статусів Kanban
function renderTaskFilters(){
    const container = document.getElementById('tasks-filters');
    if(!container) return;
    
    const statuses = getOrgStatuses();
    const sortedStatuses = Object.entries(statuses)
        .sort((a, b) => (a[1].order || 0) - (b[1].order || 0));
    
    // Рахуємо кількість лідів в кожному статусі
    const statusCounts = {};
    leads.forEach(l => {
        statusCounts[l.status] = (statusCounts[l.status] || 0) + 1;
    });
    
    let html = `
        <button class="filter-pill ${taskFilter === 'all' ? 'active' : ''}" onclick="setTaskFilter('all')">Всі</button>
        <button class="filter-pill ${taskFilter === 'critical' ? 'active' : ''}" onclick="setTaskFilter('critical')"><span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;"></span>Прострочені</button>
    `;
    
    sortedStatuses.forEach(([id, status]) => {
        // Пропускаємо "failed" та "paid" — вони фінальні
        if(id === 'failed' || id === 'paid') return;
        
        const count = statusCounts[id] || 0;
        const isActive = taskFilter === id ? 'active' : '';
        const color = status.color || '#6b7280';
        
        html += `<button class="filter-pill ${isActive}" onclick="setTaskFilter('${id}')" style="border-left: 3px solid ${color}">
            ${escapeHtml(status.name)} <span style="opacity:0.6;font-size:11px">${count}</span>
        </button>`;
    });
    
    container.innerHTML = html;
}

function getAIHint(l){
    const hints=[];
    
    // По статусу
    if(l.status==='new'){
        if(l.calls>=2)hints.push('Не бере трубку — спробуй SMS або інший час');
        if(l.source==='ref')hints.push('Рекомендація — згадай хто порекомендував');
        if(l.source==='mk_clinic'||l.source==='mk_prod')hints.push('Був на МК — вже теплий, одразу до суті');
    }
    if(l.status==='scheduled'||l.status==='repeat'){
        if(l.noshow>0)hints.push('Вже не приходив — підтверди день в день');
    }
    if(l.status==='report_sent'){
        if(l.calls>=2&&l.sms<2)hints.push('Спробуй SMS — деякі не люблять дзвінки');
        if(l.report && String(l.report).toLowerCase().includes('дорого'))hints.push('Згадував "дорого" — запропонуй розстрочку або ROI');
        if(l.report && String(l.report).toLowerCase().includes('думаю'))hints.push('Сказав "думаю" — дай дедлайн або бонус');
    }
    if(l.status==='deposit'){
        const days=l.finDepDate?Math.floor((new Date()-new Date(l.finDepDate))/864e5):0;
        if(days>=7)hints.push('Завдаток '+days+' днів тому — час закривати');
    }
    
    // По розміру бізнесу
    const bizMatch=l.biz?.match(/(\d+)/);
    if(bizMatch){
        const size=parseInt(bizMatch[1]);
        if(size>=15&&size<=25)hints.push('Ідеальний розмір клініки — акцентуй на швидкому результаті');
        if(size>40)hints.push('Великий бізнес — рішення приймають довше, будь терплячий');
    }
    
    return hints[0]||null;
}

function renderTasks(){
    const allTasks=getTasks();
    const tasks=filterTasks(allTasks);
    tasks.sort((a,b)=>calcScore(b.l)-calcScore(a.l));
    document.getElementById('task-count').textContent=tasks.length;
    const c=document.getElementById('tasks-list');
    
    // Онбординг якщо немає лідів взагалі
    if(!leads.length){
        c.innerHTML=`<div class="onboarding">
            <div class="onboarding-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
            <div class="onboarding-title">Вітаю в TALKO CRM!</div>
            <div class="onboarding-text">Система для закриття угод з AI-підказками. Почни з додавання першого ліда.</div>
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="onboarding-step-num">1</div>
                    <div class="onboarding-step-text"><strong>Додай ліда</strong> — контакт, бізнес, джерело</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-num">2</div>
                    <div class="onboarding-step-text"><strong>Виконуй завдання</strong> — система підкаже що робити</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-num">3</div>
                    <div class="onboarding-step-text"><strong>Використовуй AI</strong> — скрипти, SMS, заперечення</div>
                </div>
            </div>
            <button class="onboarding-btn" onclick="openModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Додати першого ліда</button>
            <div style="margin-top:16px"><button class="btn btn-s" onclick="loadDemo()" style="font-size:12px">або завантажити демо-дані</button></div>
        </div>`;
        return;
    }
    
    if(!tasks.length){
        c.innerHTML=`<div class="tasks-empty">
            <div class="tasks-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
            <div class="tasks-empty-title">${taskFilter==='all'?'Всі завдання виконані':'Немає завдань'}</div>
            <div class="tasks-empty-text">${taskFilter==='all'?'Час для перерви':'Оберіть інший фільтр'}</div>
        </div>`;
        return;
    }
    
    // Сортуємо по даті і часу наступної дії
    tasks.sort((a,b) => {
        const dateA = a.l.nextDate || '9999-99-99';
        const dateB = b.l.nextDate || '9999-99-99';
        const timeA = a.l.nextTime || '23:59';
        const timeB = b.l.nextTime || '23:59';
        return (dateA + timeA).localeCompare(dateB + timeB);
    });
    
    // Групуємо: прострочені, зараз, сьогодні, завтра, пізніше
    const now = new Date();
    const todayStr = today();
    const tomorrowStr = tomorrow();
    const currentHour = now.getHours();
    const currentMin = now.getMinutes();
    
    const overdue = [];
    const nowTasks = [];
    const todayTasks = [];
    const tomorrowTasks = [];
    const later = [];
    
    tasks.forEach(t => {
        const d = t.l.nextDate;
        const time = t.l.nextTime || '09:00';
        const [h, m] = time.split(':').map(Number);
        
        if(!d || d < todayStr) {
            overdue.push(t);
        } else if(d === todayStr) {
            // Перевіряємо чи це зараз (±30 хв)
            const taskMins = h * 60 + m;
            const nowMins = currentHour * 60 + currentMin;
            if(Math.abs(taskMins - nowMins) <= 30) {
                nowTasks.push(t);
            } else if(taskMins > nowMins) {
                todayTasks.push(t);
            } else {
                overdue.push(t);
            }
        } else if(d === tomorrowStr) {
            tomorrowTasks.push(t);
        } else {
            later.push(t);
        }
    });
    
    let html = '<div class="tasks-list">';
    
    if(overdue.length) {
        html += `<div class="section-header"><span class="dot red"></span>Прострочено · ${overdue.length}</div>`;
        overdue.forEach(t => html += renderTaskRow(t, 'overdue'));
    }
    
    if(nowTasks.length) {
        html += `<div class="section-header"><span class="dot blue"></span>Зараз · ${nowTasks.length}</div>`;
        nowTasks.forEach(t => html += renderTaskRow(t, 'now'));
    }
    
    if(todayTasks.length) {
        html += `<div class="section-header"><span class="dot blue"></span>Сьогодні · ${todayTasks.length}</div>`;
        todayTasks.forEach(t => html += renderTaskRow(t, 'today'));
    }
    
    if(tomorrowTasks.length) {
        html += `<div class="section-header"><span class="dot gray"></span>Завтра · ${tomorrowTasks.length}</div>`;
        tomorrowTasks.forEach(t => html += renderTaskRow(t, 'tomorrow'));
    }
    
    if(later.length) {
        html += `<div class="section-header"><span class="dot gray"></span>Пізніше · ${later.length}</div>`;
        later.forEach(t => html += renderTaskRow(t, 'later'));
    }
    
    html += '</div>';
    c.innerHTML = html;
}

function renderTaskRow(t, status) {
    const score = calcScore(t.l);
    const scoreClass = score>=70?'hot':score>=50?'warm':'cold';
    const time = t.l.nextTime || '—';
    const date = t.l.nextDate;
    const action = t.msg || t.l.nextAction || 'Зателефонувати';
    const icon = t.icon ? taskIcon(t.icon) : '';
    
    let dateLabel = '';
    if(date === today()) dateLabel = 'Сьогодні';
    else if(date === tomorrow()) dateLabel = 'Завтра';
    else if(date) dateLabel = fmtDate(date);
    else dateLabel = 'Не вказано';
    
    const timeClass = status === 'overdue' ? 'overdue' : status === 'now' ? 'now' : status === 'today' ? 'today' : '';
    const rowClass = status === 'overdue' ? 'overdue' : status === 'now' ? 'now' : '';
    
    return `
    <div class="task-row ${rowClass}" onclick="openQuickPanel('${t.l.id}')" oncontextmenu="event.preventDefault();openModal('${t.l.id}')">
        <div class="task-time ${timeClass}">
            <div class="task-time-value">${status === 'now' ? '● ЗАРАЗ' : time}</div>
            <div class="task-time-date">${dateLabel}</div>
        </div>
        <div class="task-main-info">
            <span class="task-action-text">${icon}${escapeHtml(action)}</span>
            ${renderPrimaryContact(t.l)}
            ${t.l.biz ? `<span class="task-biz">${escapeHtml(t.l.biz)}</span>` : ''}
            <span class="task-score ${scoreClass}">${score}</span>
        </div>
        <div class="task-status-wrap" onclick="event.stopPropagation()">
            <button class="task-status-btn" style="background:${getStatusColor(t.l.status || 'new')}20;color:${getStatusColor(t.l.status || 'new')};border-color:${getStatusColor(t.l.status || 'new')}" onclick="openStatusPicker('${t.l.id}')">
                ${getStatusName(t.l.status || 'new')}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="task-status-dropdown" id="status-dropdown-${t.l.id}">
                ${getStatusIds().map(key => `
                    <div class="task-status-option" onclick="changeLeadStatus('${t.l.id}', '${key}')">
                        <span class="dot" style="background:${getStatusColor(key)}"></span>
                        ${getStatusName(key)}
                    </div>
                `).join('')}
            </div>
        </div>
        <div class="task-actions">
            <button class="task-action-btn" onclick="event.stopPropagation();openModal('${t.l.id}')" title="Детальніше">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
            </button>
            <button class="task-action-btn ai" onclick="event.stopPropagation();openAIPanel('${t.l.id}')" title="AI підказка">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7z"/><path d="M9 21h6"/></svg>
            </button>
        </div>
    </div>`;
}

async function taskAction(id,a){
    const idx=leads.findIndex(x=>x.id===id);if(idx<0)return;
    const lead = leads[idx]; // Працюємо з оригіналом!
    switch(a){
        case'open':openModal(id);return;
        case'schedule':
            lead.status='scheduled';
            lead.consult=await promptDateTime('Дата консультації:',tomorrow()+'T14:00');
            if(!lead.consult) return; // Скасовано
            lead.noshow=0;
            lead.nextDate=getDayBefore(lead.consult);
            lead.nextTime='10:00';
            lead.nextAction='Підтвердити консультацію';
            addLog(lead,'status','Консультація призначена на '+fmtDT(lead.consult));
            break;
        case'call_later':
            lead.calls=(lead.calls||0)+1;
            lead.nextDate=tomorrow();
            lead.nextTime='10:00';
            lead.nextAction='Подзвонити';
            addLog(lead,'call','Не взяв трубку');
            break;
        case'call':
            lead.calls=(lead.calls||0)+1;
            addLog(lead,'call','Ще спроба');
            break;
        case'fail':
            lead.status='failed';
            lead.failReason = await promptModal('Причина відмови:', '', {
                placeholder: 'Наприклад: дорого, немає бюджету, конкурент...'
            });
            if(lead.failReason === null) return; // Скасовано
            lead.reactDate=addDays(today(), REACTIVATION_DAYS);
            lead.nextDate=lead.reactDate;
            lead.nextAction='Реактивація';
            addLog(lead,'status','Відмова: '+(lead.failReason||'не вказано')+'. Реактивація через 3 міс.');
            break;
        case'freeze':
            lead.status='frozen';
            const freezeMonths = await promptModal('Через скільки місяців повернутися?', '3', {
                type: 'number',
                min: '1',
                max: '12',
                placeholder: '1-12'
            });
            if(freezeMonths === null) return; // Скасовано
            const months = parseInt(freezeMonths) || DEFAULT_FREEZE_MONTHS;
            lead.reactDate=addDays(today(), months * 30);
            lead.nextDate=lead.reactDate;
            lead.nextAction='Реактивація';
            addLog(lead,'status','Заморожено на '+months+' міс.');
            break;
        case'confirm':
            lead.confirmedToday = false;
            // Якщо консультація сьогодні чи завтра - підтвердили і чекаємо
            if(lead.consult){
                const cd = lead.consult.split('T')[0];
                lead.nextDate = cd;
                lead.nextTime = lead.consult.split('T')[1] || '10:00';
                lead.nextAction = 'Провести консультацію';
            }
            addLog(lead,'call','Підтвердив консультацію');
            break;
        case'confirm_today':
            lead.confirmedToday = true;
            lead.confirmedDate = today(); // Зберігаємо дату підтвердження
            lead.nextDate = today();
            if(lead.consult){
                lead.nextTime = lead.consult.split('T')[1] || '10:00';
            }
            lead.nextAction = 'Провести консультацію';
            addLog(lead,'call','Підтвердив на сьогодні');
            break;
        case'confirm_sms':
            lead.sms=(lead.sms||0)+1;
            addLog(lead,'sms','SMS підтвердження');
            break;
        case'complete':
            lead.status='completed';
            lead.calls=0;
            lead.sms=0;
            lead.nextDate=today();
            lead.nextTime='10:00';
            lead.nextAction='Написати звіт';
            addLog(lead,'status','Консультація проведена');
            break;
        case'noshow':
            lead.noshow=(lead.noshow||0)+1;
            const noShowDelay = NOSHOW_DELAYS[Math.min(lead.noshow - 1, NOSHOW_DELAYS.length - 1)];
            lead.nextDate = addDays(today(), noShowDelay);
            lead.nextTime = '10:00';
            lead.nextAction = 'Перепризначити консультацію';
            addLog(lead,'status','Не прийшов ('+lead.noshow+' раз). Наступна спроба через '+noShowDelay+' днів');
            break;
        case'reschedule':
            lead.consult=await promptDateTime('Нова дата консультації:',tomorrow()+'T14:00');
            if(!lead.consult) return; // Скасовано
            lead.noshow=0;
            lead.nextDate=lead.consult?getDayBefore(lead.consult):tomorrow();
            lead.nextTime='10:00';
            lead.nextAction='Підтвердити консультацію';
            addLog(lead,'status','Перенесено на '+fmtDT(lead.consult));
            break;
        case'send_report':
            lead.status='report_sent';
            lead.reportDate=today();
            lead.calls=0;
            lead.sms=0;
            lead.nextDate=addDays(today(),2);
            lead.nextTime='10:00';
            lead.nextAction='Дізнатись реакцію на звіт';
            addLog(lead,'status','Звіт відправлено');
            break;
        case'followup':
            lead.calls=(lead.calls||0)+1;
            lead.nextDate=addDays(today(),2);
            lead.nextTime='10:00';
            lead.nextAction='Дожати рішення';
            addLog(lead,'call','Думає, передзвоню');
            break;
        case'repeat':
            lead.status='repeat';
            lead.repeatCount=(lead.repeatCount||0)+1;
            lead.calls=0;
            lead.sms=0;
            lead.noshow=0;
            lead.consult=await promptDateTime('Дата повторної консультації:',tomorrow()+'T14:00');
            if(!lead.consult) return; // Скасовано
            lead.nextDate=lead.consult?getDayBefore(lead.consult):tomorrow();
            lead.nextTime='10:00';
            lead.nextAction='Підтвердити консультацію';
            addLog(lead,'status','Повторна консультація #'+(lead.repeatCount));
            break;
        case'deposit':
            const amt = await promptModal('Сума завдатку:', '', {type: 'number', placeholder: 'Наприклад: 5000'});
            if(amt && amt !== null){
                lead.status='deposit';
                lead.finDep=+amt;
                lead.finDepDate=today();
                lead.nextDate=addDays(today(), DEPOSIT_REMINDER_DAYS);
                lead.nextTime='10:00';
                lead.nextAction='Нагадати про повну оплату';
                addLog(lead,'status','Завдаток '+amt);
            }else return;
            break;
        case'paid':
            const p = await promptModal('Повна сума:', lead.finTotal || '', {type: 'number', placeholder: 'Наприклад: 50000'});
            if(p && p !== null){
                lead.status='paid';
                lead.finTotal=+p;
                lead.finPaidDate=today();
                lead.nextDate=null;
                lead.nextAction=null;
                addLog(lead,'status','Оплачено '+p);
            }else return;
            break;
        case'dep_later':
            lead.nextDate=addDays(today(), DEPOSIT_REMINDER_DAYS);
            lead.nextTime='10:00';
            addLog(lead,'call','Нагадав, +тиждень');
            break;
        case'react_ok':
            lead.status='new';
            lead.calls=0;
            lead.sms=0;
            lead.noshow=0;
            lead.nextDate=today();
            lead.nextTime='10:00';
            lead.nextAction='Подзвонити';
            addLog(lead,'status','Реактивація — знову в роботі!');
            break;
        case'react_later':
            lead.reactDate=addDays(today(), REACTIVATION_DAYS);
            lead.nextDate=lead.reactDate;
            addLog(lead,'call','Реактивація +3 міс');
            break;
        case'react_year':
            lead.reactDate=addDays(today(),365);
            lead.nextDate=lead.reactDate;
            addLog(lead,'call','Реактивація +1 рік');
            break;
        
        // ========== НОВІ ACTIONS ==========
        case'do_now':
            lead.nextDate=today();
            lead.nextTime=new Date().getHours().toString().padStart(2,'0')+':00';
            addLog(lead,'call','Перенесено на зараз');
            break;
        case'next_done':
            const nextAction = await promptModal('Наступна дія:', lead.nextAction || 'Подзвонити', {
                placeholder: 'Що зробити далі?'
            });
            if(nextAction === null) return;
            const nextDT = await promptDateTime('Коли?', tomorrow() + 'T10:00');
            if(!nextDT) return;
            addLog(lead,'call','Виконано: '+(lead.nextAction||'дія'));
            lead.nextAction = nextAction;
            lead.nextDate = getDateOnly(nextDT);
            lead.nextTime = getTimeOnly(nextDT) || '10:00';
            break;
        case'postpone_1d':
            lead.nextDate = tomorrow();
            addLog(lead,'call','Відкладено на завтра');
            break;
        case'send_sms':
            lead.sms=(lead.sms||0)+1;
            lead.nextDate=tomorrow();
            lead.nextTime='10:00';
            lead.nextAction='Подзвонити після SMS';
            addLog(lead,'sms','SMS надіслано');
            break;
        case'send_sms_followup':
            lead.sms=(lead.sms||0)+1;
            lead.nextDate=addDays(today(),2);
            lead.nextTime='10:00';
            lead.nextAction='Дожати після SMS';
            addLog(lead,'sms','SMS-дожим');
            break;
        case'refund':
            lead.status='failed';
            lead.failReason='Повернення завдатку';
            lead.reactDate=addDays(today(), 180);
            lead.nextDate=lead.reactDate;
            lead.nextAction='Реактивація';
            addLog(lead,'status','Повернення завдатку');
            break;
        case'delete_lead':
            if(await confirmModal('Видалити цього ліда назавжди?')){
                await deleteLead(id);
                render();
                return;
            }
            return;
    }
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    render();
}

// Quick actions from task list
async function quickComplete(id) {
    const idx = leads.findIndex(x => x.id === id);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    
    // Показуємо швидкий діалог для наступної дії
    const nextAction = await promptModal('Що далі? (наступна дія)', lead.nextAction || 'Зателефонувати', {
        placeholder: 'Наприклад: зателефонувати, надіслати КП...'
    });
    if(nextAction === null) return;
    
    const nextDate = await promptDateTime('Коли виконати?', tomorrow() + 'T10:00');
    if(!nextDate) return;
    
    const [date, time] = nextDate.split('T');
    
    lead.calls = (lead.calls || 0) + 1;
    lead.nextAction = nextAction;
    lead.nextDate = date;
    lead.nextTime = time || '10:00';
    addLog(lead, 'call', 'Виконано: ' + (lead.nextAction || 'дзвінок'));
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    render();
}

async function quickReschedule(id) {
    const idx = leads.findIndex(x => x.id === id);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    
    const nextDateTime = await promptDateTime('Перенести на:', tomorrow() + 'T' + (lead.nextTime || '10:00'));
    if(!nextDateTime) return;
    
    const [nextDate, nextTime] = nextDateTime.split('T');
    
    lead.nextDate = nextDate;
    lead.nextTime = nextTime || '10:00';
    addLog(lead, 'status', 'Перенесено на ' + nextDate + ' ' + nextTime);
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    render();
}

function openAIPanel(id) {
    // Відкриваємо модалку ліда і активуємо AI панель
    openModal(id);
    setTimeout(() => {
        toggleAIPanel();
        // Автоматично генеруємо скрипт для поточної дії
        aiAsk('script');
    }, 300);
}

// ===== KANBAN =====

function setFilter(f){
    currentFilter=f;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.filter-btn[onclick="setFilter('${f}')"]`).classList.add('active');
    renderKanban();
}

function filterLeads(arr){
    // Спочатку фільтр по воронці та відповідальному
    let filtered = filterLeadsWithFunnelAndAssignee(arr);
    
    const t=today(),tm=tomorrow();
    switch(currentFilter){
        case'critical':return filtered.filter(l=>getAlert(l)?.crit);
        case'today':return filtered.filter(l=>l.consult&&l.consult.split('T')[0]===t);
        case'tomorrow':return filtered.filter(l=>l.consult&&l.consult.split('T')[0]===tm);
        case'action':return filtered.filter(l=>l.nextDate===t);
        case'money':return filtered.filter(l=>l.status==='deposit'||(l.status==='report_sent'&&l.calls>=2));
        default:return filtered;
    }
}

function renderKanban(){
    const cols = getStatusIds();
    const filtered = filterLeads(leads);
    document.getElementById('kanban').innerHTML = cols.map(s => {
        const items = filtered.filter(l => l.status === s);
        const color = getStatusColor(s);
        // Екрануємо ID для безпечного використання в HTML
        const safeId = escapeHtml(s);
        return `<div class="column" data-status="${safeId}">
            <div class="column-header" style="border-top:3px solid ${color}"><span>${getStatusName(s)}</span><span class="column-count">${items.length}</span></div>
            <div class="column-cards" data-status="${safeId}" ondragover="dOver(event)" ondrop="handleColumnDrop(event)" ondragleave="dLeave(event)">
                ${items.map(l => kCard(l)).join('')}
            </div>
        </div>`;
    }).join('');
}

function getTags(l){
    const t=today(),tm=tomorrow();
    const tags=[];
    
    // Прострочена дія
    if(l.nextDate && l.nextDate < t) {
        tags.push({cls:'overdue',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',text:'Протерміновано'});
    }
    
    // Консультація - безпечний парсинг
    if(l.consult){
        const consultStr = String(l.consult);
        const cd = consultStr.includes('T') ? consultStr.split('T')[0] : consultStr;
        const ct = consultStr.includes('T') ? (consultStr.split('T')[1] || '').slice(0,5) : '';
        
        if(cd === t) {
            tags.push({cls:'consult-today',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',text:'Консульт.' + (ct ? ' ' + ct : ' сьогодні')});
        } else if(cd === tm) {
            tags.push({cls:'consult-tomorrow',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',text:'Консульт. завтра'});
        }
    }
    
    // No-show
    if(l.noshow > 0) {
        tags.push({cls:'noshow',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',text:'Не прийшов '+l.noshow+'x'});
    }
    
    // Завдаток
    if(l.finDep && l.status !== 'paid') {
        tags.push({cls:'has-deposit',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',text:'Завдаток'});
    }
    
    // Дія сьогодні/завтра (якщо немає консультації сьогодні/завтра)
    const consultDate = l.consult ? (String(l.consult).includes('T') ? String(l.consult).split('T')[0] : String(l.consult)) : null;
    const hasConsultSoonTag = consultDate && (consultDate === t || consultDate === tm);
    
    if(!hasConsultSoonTag) {
        if(l.nextDate === t) {
            const actionText = l.nextAction ? l.nextAction.slice(0,15) : 'Дія';
            const timeText = l.nextTime ? ' ' + l.nextTime : '';
            tags.push({cls:'action-today',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',text:actionText + timeText});
        } else if(l.nextDate === tm) {
            const actionText = l.nextAction ? l.nextAction.slice(0,12) : 'Дія';
            tags.push({cls:'action-tomorrow',icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',text:actionText + ' завтра'});
        }
    }
    
    return tags;
}

function kCard(l){
    const days=l.stageDate?Math.floor((new Date()-new Date(l.stageDate))/864e5):0;
    const alert=getAlert(l);
    const amt=l.finTotal||l.finDep;
    const tags=getTags(l);
    const score=calcScore(l);
    const scoreClass=score>=70?'hot':score>=50?'warm':'cold';
    const isSelected = selectedLeadIds.has(l.id);
    return`<div class="k-card ${alert?'has-'+(alert.crit?'critical':'alert'):''} ${isSelected?'selected':''}" draggable="true" ondragstart="dStart(event,'${l.id}')" ondragend="dEnd(event)" onclick="handleCardClick(event,'${l.id}')" ontouchstart="touchStart(event,'${l.id}')" ontouchmove="touchMove(event)" ontouchend="touchEnd(event)" style="position:relative;touch-action:none">
        <div class="select-checkbox" onclick="event.stopPropagation();toggleLeadSelection('${l.id}')"></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <div class="k-card-name">${highlightSearch(l.tg||l.phone||'—')}</div>
            <div class="score ${scoreClass}"><div class="score-bar"><div class="score-fill ${scoreClass}" style="width:${score}%"></div></div>${score}</div>
        </div>
        ${l.biz?`<div class="k-card-biz">${highlightSearch(l.biz)}</div>`:''}
        <div class="k-card-footer">
            <span>${SRC[l.source]||''}</span>
            ${amt?`<span class="k-card-amount">${amt}${CUR[l.finTotalCur||l.finDepCur]||''}</span>`:''}
            <span class="k-card-days ${days>5?'over':''}">${days}д</span>
        </div>
        ${tags.length?`<div class="k-card-tags">${tags.map(tag=>`<span class="k-tag ${tag.cls}">${tag.icon} ${tag.text}</span>`).join('')}</div>`:''}
    </div>`;
}
function getAlert(l){
    if(!l.status)return{crit:true};
    if(l.nextDate&&l.nextDate<today())return{crit:true};
    if(l.status==='new'&&l.calls>=3)return{crit:true};
    if(l.status==='report_sent'&&l.calls>=3&&l.sms>=3)return{crit:true};
    if(l.noshow>=3)return{crit:true};
    return null;
}

// ===== DRAG & DROP =====
let dragId = null;
let dragElement = null;

// Touch drag для мобільних
let touchDragId = null;
let touchStartY = 0;
let touchStartX = 0;
let touchDragElement = null;
let touchDragClone = null;

function dStart(e, id) {
    dragId = id;
    dragElement = e.target;
    e.target.classList.add('dragging');
    
    // Зберігаємо ID в dataTransfer - це надійніше
    if(e.dataTransfer) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', id);
        e.dataTransfer.setData('application/x-lead-id', id);
    }
    
    // Підсвічуємо всі колонки як можливі drop targets
    setTimeout(() => {
        document.querySelectorAll('.column-cards').forEach(col => {
            col.style.minHeight = '120px';
        });
    }, 0);
}

// Touch start - для мобільних
function touchStart(e, id) {
    if(e.touches.length !== 1) return;
    
    touchDragId = id;
    touchDragElement = e.currentTarget;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    
    // Long press detection
    touchDragElement.touchTimeout = setTimeout(() => {
        if(touchDragId) {
            touchDragElement.classList.add('dragging');
            // Показуємо всі колонки
            document.querySelectorAll('.column-cards').forEach(col => {
                col.style.minHeight = '120px';
                col.style.border = '2px dashed #22c55e';
            });
            // Haptic feedback якщо доступно
            if(navigator.vibrate) navigator.vibrate(50);
        }
    }, 300);
}

function touchMove(e) {
    if(!touchDragId || !touchDragElement.classList.contains('dragging')) {
        // Скасовуємо якщо рух до long press
        clearTimeout(touchDragElement?.touchTimeout);
        return;
    }
    
    e.preventDefault();
    
    const touch = e.touches[0];
    
    // Highlight колонки під пальцем
    document.querySelectorAll('.column-cards').forEach(col => {
        const rect = col.getBoundingClientRect();
        if(touch.clientX >= rect.left && touch.clientX <= rect.right &&
           touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
            col.classList.add('drag-over');
        } else {
            col.classList.remove('drag-over');
        }
    });
}

function touchEnd(e) {
    clearTimeout(touchDragElement?.touchTimeout);
    
    if(!touchDragId || !touchDragElement?.classList.contains('dragging')) {
        touchDragId = null;
        touchDragElement = null;
        return;
    }
    
    const touch = e.changedTouches[0];
    
    // Знаходимо колонку під пальцем
    let targetColumn = null;
    document.querySelectorAll('.column-cards').forEach(col => {
        const rect = col.getBoundingClientRect();
        if(touch.clientX >= rect.left && touch.clientX <= rect.right &&
           touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
            targetColumn = col;
        }
        col.classList.remove('drag-over');
        col.style.minHeight = '';
        col.style.border = '';
    });
    
    if(targetColumn) {
        // Отримуємо статус з колонки
        const column = targetColumn.closest('.column');
        const status = column?.dataset?.status;
        if(status && touchDragId) {
            // Викликаємо drop
            handleTouchDrop(touchDragId, status);
        }
    }
    
    touchDragElement?.classList.remove('dragging');
    touchDragId = null;
    touchDragElement = null;
}

async function handleTouchDrop(leadId, status) {
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Організацію не вибрано');
        return;
    }
    
    // FIX: Зберігаємо leadId локально для запобігання race condition
    const localLeadId = leadId;
    if(!localLeadId) {
        showWarning('ID ліда не визначено');
        return;
    }
    
    const idx = leads.findIndex(x => x.id === localLeadId);
    if(idx < 0) {
        showWarning('Лід не знайдено');
        return;
    }
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    
    if(lead.status === status) {
        return; // Статус не змінився
    }
    
    // Валідація
    if(status === 'paid' && !lead.finTotal) {
        showWarning('Вкажіть суму оплати!');
        openModal(lead.id);
        return;
    }
    
    if(status === 'deposit' && !lead.finDep) {
        const a = await promptModal('Сума завдатку:', '', {type: 'number', placeholder: 'Наприклад: 5000'});
        if(!a) { showInfo('Переміщення скасовано'); return; }
        lead.finDep = +a;
        lead.finDepDate = today();
    }
    
    if(status === 'scheduled' && !lead.consult) {
        const dt = await promptDateTime('Оберіть дату та час консультації');
        if(!dt) { showInfo('Переміщення скасовано'); return; }
        lead.consult = dt;
        lead.noshow = 0;
    }
    
    if(status === 'failed' && !lead.failReason) {
        const reason = await promptModal('Причина відмови:', '', {placeholder: 'Наприклад: дорого, не актуально'});
        if(!reason) { showInfo('Переміщення скасовано'); return; }
        lead.failReason = reason;
        lead.reactDate = addDays(today(), REACTIVATION_DAYS);
    }
    
    const old = lead.status;
    lead.status = status;
    lead.stageDate = new Date().toISOString();
    
    if(status === 'completed') { lead.calls = 0; lead.sms = 0; }
    if(status === 'report_sent') { lead.reportDate = today(); lead.calls = 0; lead.sms = 0; lead.nextDate = tomorrow(); }
    
    addLog(lead, 'status', getStatusName(old, lead.funnelId) + ' → ' + getStatusName(status, lead.funnelId));
    
    // FIX: Використовуємо централізовану функцію збереження
    saveLeadToFirebase(lead)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    showToast('Статус змінено');
    render();
}

function dEnd(e) {
    e.target.classList.remove('dragging');
    
    // Знімаємо підсвітку з усіх колонок
    document.querySelectorAll('.column-cards').forEach(col => {
        col.classList.remove('drag-over');
        col.style.minHeight = '';
    });
    
    // Очищуємо з затримкою
    setTimeout(() => {
        dragId = null;
        dragElement = null;
    }, 50);
}

function dOver(e) {
    e.preventDefault();
    if(e.dataTransfer) e.dataTransfer.dropEffect = 'move';
    e.currentTarget.classList.add('drag-over');
}

function dLeave(e) {
    // Перевіряємо чи ми дійсно покинули колонку (а не перейшли на child елемент)
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX;
    const y = e.clientY;
    
    if(x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
        e.currentTarget.classList.remove('drag-over');
    }
}

// Wrapper для безпечного отримання статусу з data-атрибуту
function handleColumnDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    const status = e.currentTarget.dataset.status;
    if(status) {
        dDrop(e, status);
    }
}

async function dDrop(e, status) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget?.classList?.remove('drag-over');
    
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Організацію не вибрано');
        return;
    }
    
    // Отримуємо ID з dataTransfer або з глобальної змінної
    let leadId = null;
    if(e.dataTransfer) {
        leadId = e.dataTransfer.getData('application/x-lead-id') || e.dataTransfer.getData('text/plain');
    }
    if(!leadId) leadId = dragId;
    
    // FIX: Зберігаємо leadId локально для запобігання race condition
    const localLeadId = leadId;
    
    if(!localLeadId){
        showWarning('Оберіть картку для переміщення');
        return;
    }
    
    // Знаходимо індекс ліда
    const idx = leads.findIndex(x => x.id === localLeadId);
    if(idx < 0){
        showWarning('Лід не знайдено');
        return;
    }
    
    const lead = leads[idx];
    const oldStatus = lead.status;
    
    // Якщо статус не змінився - нічого не робимо
    if(oldStatus === status) {
        return;
    }
    
    // Валідація для спеціальних статусів
    if(status === 'paid' && !lead.finTotal){
        showWarning('Вкажіть суму оплати!');
        openModal(lead.id);
        setTimeout(() => document.getElementById('fin-total')?.focus(), 300);
        return;
    }
    
    if(status === 'deposit' && !lead.finDep){
        const a = await promptModal('Сума завдатку:', '', {type: 'number', placeholder: 'Наприклад: 5000'});
        if(!a){ showInfo('Переміщення скасовано'); return; }
        lead.finDep = +a;
        lead.finDepDate = today();
    }
    
    if(status === 'scheduled' && !lead.consult){
        const dt = await promptDateTime('Оберіть дату та час консультації');
        if(!dt){ showInfo('Переміщення скасовано'); return; }
        lead.consult = dt;
        lead.noshow = 0;
    }
    
    if(status === 'failed' && !lead.failReason){
        const reason = await promptModal('Причина відмови:', '', {placeholder: 'Наприклад: дорого, не актуально'});
        if(!reason){ showInfo('Переміщення скасовано'); return; }
        lead.failReason = reason;
        lead.reactDate = addDays(today(), REACTIVATION_DAYS);
    }
    
    // Оновлюємо статус напряму в об'єкті
    lead.status = status;
    lead.stageDate = new Date().toISOString();
    
    if(status === 'completed'){ lead.calls = 0; lead.sms = 0; }
    if(status === 'report_sent'){ lead.reportDate = today(); lead.calls = 0; lead.sms = 0; lead.nextDate = tomorrow(); }
    
    addLog(lead, 'status', getStatusName(oldStatus, lead.funnelId) + ' → ' + getStatusName(status, lead.funnelId));
    
    // FIX: Використовуємо централізовану функцію збереження
    try {
        await saveLeadToFirebase(lead);
        showToast(`${getStatusName(oldStatus)} → ${getStatusName(status)}`);
    } catch(err) {
        // Відкатуємо якщо помилка
        lead.status = oldStatus;
        showError('Помилка збереження: ' + err.message);
        console.error('Save error:', err);
    }
}

// ===== REPORTS =====
function initReportDates(){
    const now=new Date();
    const weekAgo=new Date(now);weekAgo.setDate(now.getDate()-7);
    document.getElementById('date-from').value=weekAgo.toISOString().split('T')[0];
    document.getElementById('date-to').value=now.toISOString().split('T')[0];
}

function setReportPeriod(p, btn){
    // Оновлюємо активну кнопку
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    
    const now = new Date();
    const to = now.toISOString().split('T')[0];
    let from;
    let weeksToShow = 8;
    
    switch(p){
        case 'week':
            const w = new Date(now);
            w.setDate(now.getDate() - 7 * 8); // 8 тижнів
            from = w.toISOString().split('T')[0];
            weeksToShow = 8;
            break;
        case 'month':
            const m = new Date(now);
            m.setMonth(now.getMonth() - 6); // 6 місяців
            from = m.toISOString().split('T')[0];
            break;
        case 'quarter':
            const q = new Date(now);
            q.setMonth(now.getMonth() - 12); // 12 місяців
            from = q.toISOString().split('T')[0];
            break;
    }
    
    document.getElementById('date-from').value = from;
    document.getElementById('date-to').value = to;
    renderReports(p);
}

function renderReports(periodType = 'week'){
    const fromDate = document.getElementById('date-from').value;
    const toDate = document.getElementById('date-to').value;
    
    // Отримуємо статуси
    const statuses = getOrgStatuses();
    const statusIds = Object.entries(statuses)
        .sort((a,b) => (a[1].order||0) - (b[1].order||0))
        .map(([id]) => id);
    
    // Генеруємо періоди (тижні)
    const periods = generatePeriods(fromDate, toDate, periodType);
    
    // Рахуємо дані для кожного періоду
    const tableData = periods.map(period => {
        const periodLeads = getLeadsInPeriod(period.start, period.end);
        const row = { period: period };
        
        // Рахуємо по статусах (коли лід перейшов в цей статус)
        statusIds.forEach(statusId => {
            row[statusId] = periodLeads.filter(l => l.status === statusId).length;
        });
        
        // Сума з оплачених
        const paidLeads = periodLeads.filter(l => l.status === 'paid');
        row.revenue = paidLeads.reduce((sum, l) => sum + toUAH(l.finTotal, l.finTotalCur), 0);
        
        // Конверсія
        const newLeads = periodLeads.filter(l => l.status === 'new').length;
        row.conversion = newLeads > 0 ? Math.round(paidLeads.length / newLeads * 100) : 0;
        
        return row;
    });
    
    // Рендеримо summary cards
    renderReportsSummary(fromDate, toDate);
    
    // Рендеримо графіки
    renderLeadsByDayChart(fromDate, toDate);
    renderConversionFunnel(statusIds, statuses);
    renderRevenueChart(fromDate, toDate);
    renderSourcesChart();
    
    // Рендеримо таблицю
    renderReportsTable(tableData, statusIds, statuses);
    
    // Рендеримо воронку
    renderReportsFunnel(fromDate, toDate, statusIds, statuses);
}

function generatePeriods(fromDate, toDate, type = 'week'){
    const periods = [];
    const from = new Date(fromDate);
    const to = new Date(toDate);
    const today = new Date();
    today.setHours(0,0,0,0);
    
    if(type === 'week'){
        // Тижні (пн-нд)
        let current = new Date(to);
        // Знаходимо понеділок поточного тижня
        const dayOfWeek = current.getDay();
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        current.setDate(current.getDate() + mondayOffset);
        
        while(current >= from && periods.length < 12){
            const weekStart = new Date(current);
            const weekEnd = new Date(current);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const isCurrent = today >= weekStart && today <= weekEnd;
            
            periods.push({
                start: weekStart.toISOString().split('T')[0],
                end: weekEnd.toISOString().split('T')[0],
                label: formatPeriodLabel(weekStart, weekEnd),
                isCurrent: isCurrent
            });
            
            current.setDate(current.getDate() - 7);
        }
    } else if(type === 'month'){
        // Місяці
        let current = new Date(to);
        current.setDate(1);
        
        while(current >= from && periods.length < 12){
            const monthStart = new Date(current);
            const monthEnd = new Date(current);
            monthEnd.setMonth(monthEnd.getMonth() + 1);
            monthEnd.setDate(0);
            
            const isCurrent = today.getMonth() === monthStart.getMonth() && today.getFullYear() === monthStart.getFullYear();
            
            periods.push({
                start: monthStart.toISOString().split('T')[0],
                end: monthEnd.toISOString().split('T')[0],
                label: monthStart.toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' }),
                isCurrent: isCurrent
            });
            
            current.setMonth(current.getMonth() - 1);
        }
    } else {
        // Квартали
        let current = new Date(to);
        const currentQuarter = Math.floor(current.getMonth() / 3);
        current.setMonth(currentQuarter * 3, 1);
        
        while(current >= from && periods.length < 8){
            const quarterStart = new Date(current);
            const quarterEnd = new Date(current);
            quarterEnd.setMonth(quarterEnd.getMonth() + 3);
            quarterEnd.setDate(0);
            
            const q = Math.floor(quarterStart.getMonth() / 3) + 1;
            const isCurrent = today >= quarterStart && today <= quarterEnd;
            
            periods.push({
                start: quarterStart.toISOString().split('T')[0],
                end: quarterEnd.toISOString().split('T')[0],
                label: `Q${q} ${quarterStart.getFullYear()}`,
                isCurrent: isCurrent
            });
            
            current.setMonth(current.getMonth() - 3);
        }
    }
    
    return periods;
}

function formatPeriodLabel(start, end){
    const s = start.getDate().toString().padStart(2,'0') + '.' + (start.getMonth()+1).toString().padStart(2,'0');
    const e = end.getDate().toString().padStart(2,'0') + '.' + (end.getMonth()+1).toString().padStart(2,'0');
    return s + '-' + e;
}

function getLeadsInPeriod(startDate, endDate){
    const from = new Date(startDate + 'T00:00:00');
    const to = new Date(endDate + 'T23:59:59');
    
    return leads.filter(l => {
        // Використовуємо дату створення або stageDate
        const date = new Date(l.createdAt || l.created || l.stageDate);
        return date >= from && date <= to;
    });
}

function renderReportsSummary(fromDate, toDate){
    const fl = filterByDateRange(leads, fromDate, toDate);
    const paid = fl.filter(l => l.status === 'paid');
    const dep = fl.filter(l => l.status === 'deposit');
    const scheduled = fl.filter(l => l.status === 'scheduled');
    
    let revenue = 0;
    paid.forEach(l => { revenue += toUAH(l.finTotal, l.finTotalCur); });
    dep.forEach(l => { revenue += toUAH(l.finDep, l.finDepCur); });
    
    const conversion = fl.length > 0 ? Math.round(paid.length / fl.length * 100) : 0;
    const avgDeal = paid.length > 0 ? Math.round(revenue / paid.length) : 0;
    
    // Порівняння з попереднім періодом
    const periodDays = Math.max(1, Math.round((new Date(toDate) - new Date(fromDate)) / (1000*60*60*24)));
    const prevFrom = new Date(fromDate);
    prevFrom.setDate(prevFrom.getDate() - periodDays);
    const prevLeads = filterByDateRange(leads, prevFrom.toISOString().split('T')[0], fromDate);
    const prevPaid = prevLeads.filter(l => l.status === 'paid');
    
    const leadsChange = prevLeads.length > 0 ? Math.round(((fl.length - prevLeads.length) / prevLeads.length) * 100) : 0;
    const paidChange = prevPaid.length > 0 ? Math.round(((paid.length - prevPaid.length) / prevPaid.length) * 100) : 0;
    
    document.getElementById('reports-summary').innerHTML = `
        <div class="summary-card">
            <div class="summary-card-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <div class="summary-card-label">Нових лідів</div>
            <div class="summary-card-value">${fl.length}</div>
            ${leadsChange !== 0 ? `<div class="summary-card-change ${leadsChange > 0 ? 'up' : 'down'}">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="${leadsChange > 0 ? 'M18 15l-6-6-6 6' : 'M6 9l6 6 6-6'}"/></svg>
                ${Math.abs(leadsChange)}% vs попередній
            </div>` : '<div class="summary-card-change neutral">— немає даних</div>'}
        </div>
        <div class="summary-card">
            <div class="summary-card-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="summary-card-label">Закрито угод</div>
            <div class="summary-card-value">${paid.length}</div>
            ${paidChange !== 0 ? `<div class="summary-card-change ${paidChange > 0 ? 'up' : 'down'}">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="${paidChange > 0 ? 'M18 15l-6-6-6 6' : 'M6 9l6 6 6-6'}"/></svg>
                ${Math.abs(paidChange)}% vs попередній
            </div>` : '<div class="summary-card-change neutral">— немає даних</div>'}
        </div>
        <div class="summary-card">
            <div class="summary-card-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
            <div class="summary-card-label">Виручка</div>
            <div class="summary-card-value">${formatMoneyFull(revenue)}</div>
            <div class="summary-card-change neutral">≈ ${formatMoneyFull(avgDeal)} / угода</div>
        </div>
        <div class="summary-card">
            <div class="summary-card-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
            </div>
            <div class="summary-card-label">Конверсія</div>
            <div class="summary-card-value">${conversion}%</div>
            <div class="summary-card-change neutral">${scheduled.length} записані на консультацію</div>
        </div>
    `;
}

function formatMoneyFull(amount) {
    if(amount >= 1000000) return (amount / 1000000).toFixed(1).replace('.0', '') + ' млн ₴';
    if(amount >= 1000) return Math.round(amount / 1000) + ' тис ₴';
    return Math.round(amount).toLocaleString() + ' ₴';
}

function renderReportsTable(data, statusIds, statuses){
    const thead = document.getElementById('reports-thead');
    const tbody = document.getElementById('reports-tbody');
    
    // Header
    let headerHtml = '<tr><th>Період</th>';
    statusIds.forEach(id => {
        const status = statuses[id];
        headerHtml += `<th><span class="status-dot" style="background:${status.color}"></span>${escapeHtml(status.name)}</th>`;
    });
    headerHtml += '<th>Сума</th></tr>';
    thead.innerHTML = headerHtml;
    
    // Body
    let bodyHtml = '';
    data.forEach(row => {
        const rowClass = row.period.isCurrent ? 'current-row' : '';
        bodyHtml += `<tr class="${rowClass}">`;
        bodyHtml += `<td>${row.period.isCurrent ? '● ' : ''}${row.period.label}</td>`;
        
        statusIds.forEach(id => {
            const val = row[id] || 0;
            const cellClass = val === 0 ? 'cell-zero' : 'cell-value';
            bodyHtml += `<td class="${cellClass}">${val}</td>`;
        });
        
        const revDisplay = row.revenue > 0 ? Math.round(row.revenue).toLocaleString() : '—';
        bodyHtml += `<td class="${row.revenue > 0 ? 'cell-money' : 'cell-zero'}">${revDisplay}</td>`;
        bodyHtml += '</tr>';
    });
    
    tbody.innerHTML = bodyHtml;
}

function renderReportsFunnel(fromDate, toDate, statusIds, statuses){
    const fl = filterByDateRange(leads, fromDate, toDate);
    const byStatus = {};
    fl.forEach(l => { byStatus[l.status] = (byStatus[l.status] || 0) + 1; });
    
    const max = Math.max(...Object.values(byStatus), 1);
    
    let funnelHtml = '<div class="reports-funnel-title">Воронка продажів</div>';
    
    statusIds.forEach(id => {
        const status = statuses[id];
        const count = byStatus[id] || 0;
        const pct = Math.round(count / max * 100);
        
        funnelHtml += `
            <div class="funnel-bar-wrap">
                <div class="funnel-bar-header">
                    <span class="funnel-bar-label">${escapeHtml(status.name)}</span>
                    <span class="funnel-bar-value">${count}</span>
                </div>
                <div class="funnel-progress">
                    <div class="funnel-bar-fill" style="width:${pct}%;background:${status.color}">${count > 0 ? count : ''}</div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('reports-funnel').innerHTML = funnelHtml;
    
    // Render Visual Funnel
    renderVisualFunnel(fl, statusIds, statuses);
}

function renderVisualFunnel(filteredLeads, statusIds, statuses){
    const container = document.getElementById('reports-funnel-visual');
    if(!container) return;
    
    // Count by status
    const byStatus = {};
    filteredLeads.forEach(l => { byStatus[l.status] = (byStatus[l.status] || 0) + 1; });
    
    // Filter only active funnel statuses (exclude failed, frozen)
    const activeStatusIds = statusIds.filter(id => !['failed', 'frozen'].includes(id));
    const totalLeads = filteredLeads.length;
    const maxCount = Math.max(...activeStatusIds.map(id => byStatus[id] || 0), 1);
    
    // Calculate metrics
    const paidLeads = filteredLeads.filter(l => l.status === 'paid');
    const conversionRate = totalLeads > 0 ? ((paidLeads.length / totalLeads) * 100).toFixed(1) : 0;
    const avgDealSize = paidLeads.length > 0 
        ? Math.round(paidLeads.reduce((sum, l) => sum + toUAH(l.finTotal, l.finTotalCur), 0) / paidLeads.length)
        : 0;
    const totalRevenue = paidLeads.reduce((sum, l) => sum + toUAH(l.finTotal, l.finTotalCur), 0);
    
    // Calculate avg cycle time
    let avgCycleTime = 0;
    if(paidLeads.length > 0) {
        const cycleTimes = paidLeads.map(l => {
            const created = new Date(l.createdAt || l.created);
            const paid = new Date(l.finPaidDate || l.stageDate);
            return Math.max(0, Math.round((paid - created) / (1000 * 60 * 60 * 24)));
        }).filter(d => d > 0 && d < 365);
        avgCycleTime = cycleTimes.length > 0 ? Math.round(cycleTimes.reduce((a,b) => a+b, 0) / cycleTimes.length) : 0;
    }
    
    // Failed leads (recent)
    const failedLeads = filteredLeads.filter(l => l.status === 'failed')
        .sort((a,b) => new Date(b.stageDate || b.created) - new Date(a.stageDate || a.created))
        .slice(0, 4);
    
    // Build funnel HTML
    let html = `
        <div class="funnel-visual-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/>
            </svg>
            Воронка продажів
        </div>
        <div class="funnel-visual-container">
            <div class="funnel-shape">
    `;
    
    let prevCount = null;
    const widths = [100, 88, 76, 64, 52, 42, 32]; // Decreasing widths for funnel shape
    
    activeStatusIds.forEach((id, index) => {
        const status = statuses[id];
        const count = byStatus[id] || 0;
        const widthPct = widths[Math.min(index, widths.length - 1)];
        
        // Calculate drop-off
        let dropOff = 0;
        if(prevCount !== null && prevCount > 0) {
            dropOff = Math.round(((prevCount - count) / prevCount) * 100);
        }
        
        html += `
            <div class="funnel-stage">
                <div class="funnel-stage-bar" style="width:${widthPct}%;background:${status.color || '#6366f1'}">
                    <span class="funnel-bar-name">${escapeHtml(status.name)}</span>
                    <span class="funnel-bar-count">${count}</span>
                </div>
                ${dropOff > 0 ? `
                <div class="funnel-stage-dropoff">
                    <span class="funnel-dropoff-pct">${dropOff}%</span>
                    <span class="funnel-dropoff-arrow">↘</span>
                </div>
                ` : '<div class="funnel-stage-dropoff"></div>'}
            </div>
        `;
        
        prevCount = count;
    });
    
    html += `
            </div>
        </div>
    `;
    
    // Metrics Cards - Ukrainian
    html += `
        <div class="funnel-metrics">
            <div class="funnel-metric-card">
                <div class="funnel-metric-label">Скільки лідів стали клієнтами</div>
                <div class="funnel-metric-value ${parseFloat(conversionRate) > 10 ? 'positive' : ''}">${conversionRate}%</div>
            </div>
            <div class="funnel-metric-card">
                <div class="funnel-metric-label">Скільки днів від ліда до оплати</div>
                <div class="funnel-metric-value">${avgCycleTime} дн</div>
            </div>
            <div class="funnel-metric-card">
                <div class="funnel-metric-label">Середня сума однієї угоди</div>
                <div class="funnel-metric-value">${avgDealSize.toLocaleString()} ₴</div>
            </div>
            <div class="funnel-metric-card">
                <div class="funnel-metric-label">Всього заробили за період</div>
                <div class="funnel-metric-value positive">${Math.round(totalRevenue).toLocaleString()} ₴</div>
            </div>
        </div>
    `;
    
    // Recent Failed Deals - Ukrainian
    if(failedLeads.length > 0) {
        html += `
            <div class="funnel-failed">
                <div class="funnel-failed-title">Втрачені угоди</div>
        `;
        failedLeads.forEach(l => {
            const timeAgo = getTimeAgo(l.stageDate || l.created);
            html += `
                <div class="funnel-failed-item">
                    <div class="funnel-failed-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </div>
                    <span class="funnel-failed-name">${escapeHtml(l.tg || l.phone || l.biz || 'Без назви')}</span>
                    <span class="funnel-failed-time">${timeAgo}</span>
                </div>
            `;
        });
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

function getTimeAgo(dateStr) {
    if(!dateStr) return '';
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if(diffHours < 1) return 'щойно';
    if(diffHours < 24) return diffHours + ' год тому';
    if(diffDays === 1) return 'вчора';
    if(diffDays < 7) return diffDays + ' дн тому';
    return Math.floor(diffDays / 7) + ' тиж тому';
}

function filterByDateRange(arr, from, to){
    if(!from && !to) return arr;
    const fromD = from ? new Date(from + 'T00:00:00') : new Date('2000-01-01');
    const toD = to ? new Date(to + 'T23:59:59') : new Date();
    return arr.filter(l => {
        const created = new Date(l.createdAt || l.created);
        return created >= fromD && created <= toD;
    });
}

function toUAH(a, c){ if(!a) return 0; return a * ({UAH:1, USD:41, EUR:45}[c] || 1); }

// ===== ANALYTICS CHARTS =====
function renderLeadsByDayChart(fromDate, toDate) {
    const container = document.getElementById('chart-leads-by-day');
    if(!container) return;
    
    // Збираємо дані по днях за останні 14 днів
    const days = [];
    const to = new Date(toDate || today());
    for(let i = 13; i >= 0; i--) {
        const d = new Date(to);
        d.setDate(d.getDate() - i);
        days.push(d.toISOString().split('T')[0]);
    }
    
    const counts = days.map(day => {
        return leads.filter(l => {
            const created = (l.created || l.createdAt || '').split('T')[0];
            return created === day;
        }).length;
    });
    
    const maxCount = Math.max(...counts, 1);
    
    container.innerHTML = `
        <div class="chart-bar-group">
            ${days.map((day, i) => {
                const height = Math.max((counts[i] / maxCount) * 160, 4);
                const label = new Date(day).toLocaleDateString('uk', { day: 'numeric', month: 'short' }).replace(' ', '');
                return `
                    <div class="chart-bar" style="height:${height}px" title="${label}: ${counts[i]} лідів">
                        ${counts[i] > 0 ? `<span class="chart-bar-value">${counts[i]}</span>` : ''}
                        <span class="chart-bar-label">${label}</span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderConversionFunnel(statusIds, statuses) {
    const container = document.getElementById('chart-conversion-funnel');
    if(!container) return;
    
    // Рахуємо кількість лідів на кожному етапі
    const stages = statusIds.filter(id => !['failed', 'frozen'].includes(id)).slice(0, 5);
    const counts = {};
    stages.forEach(id => {
        counts[id] = leads.filter(l => l.status === id).length;
    });
    
    const firstStageCount = counts[stages[0]] || leads.length || 1;
    
    container.innerHTML = `
        <div class="conversion-funnel">
            ${stages.map((id, i) => {
                const count = counts[id] || 0;
                const pct = Math.round((count / firstStageCount) * 100);
                const width = Math.max(pct, 8);
                const status = statuses[id];
                const color = status?.color || '#22c55e';
                
                let arrow = '';
                if(i < stages.length - 1) {
                    const nextCount = counts[stages[i + 1]] || 0;
                    const dropOff = count > 0 ? Math.round(((count - nextCount) / count) * 100) : 0;
                    if(dropOff > 0) {
                        arrow = `<div class="conversion-arrow">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                            <span style="color:#ef4444">-${dropOff}%</span> відсів
                        </div>`;
                    }
                }
                
                return `
                    <div class="conversion-step">
                        <span class="conversion-label">${status?.name || id}</span>
                        <div class="conversion-bar">
                            <div class="conversion-fill" style="width:${width}%;background:linear-gradient(90deg,${color},${color}dd)">${count}</div>
                        </div>
                        <span class="conversion-percent">${pct}%</span>
                    </div>
                    ${arrow}
                `;
            }).join('')}
        </div>
    `;
}

function renderRevenueChart(fromDate, toDate) {
    const container = document.getElementById('chart-revenue');
    if(!container) return;
    
    // Збираємо виручку по днях
    const days = [];
    const to = new Date(toDate || today());
    for(let i = 13; i >= 0; i--) {
        const d = new Date(to);
        d.setDate(d.getDate() - i);
        days.push(d.toISOString().split('T')[0]);
    }
    
    const revenues = days.map(day => {
        return leads
            .filter(l => l.status === 'paid' && (l.stageDate || '').split('T')[0] === day)
            .reduce((sum, l) => sum + toUAH(l.finTotal, l.finTotalCur), 0);
    });
    
    const maxRevenue = Math.max(...revenues, 1);
    
    container.innerHTML = `
        <div class="chart-bar-group">
            ${days.map((day, i) => {
                const height = Math.max((revenues[i] / maxRevenue) * 160, 4);
                const label = new Date(day).toLocaleDateString('uk', { day: 'numeric', month: 'short' }).replace(' ', '');
                const value = revenues[i] > 0 ? formatMoney(revenues[i]) : '';
                return `
                    <div class="chart-bar" style="height:${height}px;background:#059669" title="${label}: ${formatMoney(revenues[i])}">
                        ${value ? `<span class="chart-bar-value" style="font-size:9px">${value}</span>` : ''}
                        <span class="chart-bar-label">${label}</span>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function renderSourcesChart() {
    const container = document.getElementById('chart-sources');
    if(!container) return;
    
    // Рахуємо ліди по джерелах
    const sourceCounts = {};
    leads.forEach(l => {
        const src = l.source || 'unknown';
        sourceCounts[src] = (sourceCounts[src] || 0) + 1;
    });
    
    const sorted = Object.entries(sourceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
    
    const total = leads.length || 1;
    const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#64748b'];
    
    container.innerHTML = `
        <div class="donut-chart-wrap">
            <div class="donut-chart">
                <svg viewBox="0 0 36 36">
                    ${(() => {
                        let offset = 0;
                        return sorted.map(([src, count], i) => {
                            const pct = (count / total) * 100;
                            const dash = pct * 0.314;
                            const result = `<circle cx="18" cy="18" r="14" fill="none" stroke="${colors[i]}" stroke-width="5" stroke-dasharray="${dash} 100" stroke-dashoffset="-${offset}" style="transition:stroke-dasharray .5s"/>`;
                            offset += dash;
                            return result;
                        }).join('');
                    })()}
                </svg>
                <div class="donut-center">
                    <div class="donut-center-value">${total}</div>
                    <div class="donut-center-label">лідів</div>
                </div>
            </div>
            <div class="donut-legend">
                ${sorted.map(([src, count], i) => {
                    const pct = Math.round((count / total) * 100);
                    return `
                        <div class="donut-legend-item">
                            <div class="donut-legend-dot" style="background:${colors[i]}"></div>
                            <span class="donut-legend-label">${SRC[src] || src}</span>
                            <span class="donut-legend-value">${count}</span>
                            <span class="donut-legend-pct">${pct}%</span>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

function formatMoney(amount) {
    if(amount >= 1000000) return Math.round(amount / 1000000) + 'М';
    if(amount >= 1000) return Math.round(amount / 1000) + 'К';
    return Math.round(amount) + '';
}

function exportReport(){
    const fromDate = document.getElementById('date-from').value;
    const toDate = document.getElementById('date-to').value;
    const statuses = getOrgStatuses();
    const statusIds = Object.entries(statuses)
        .sort((a,b) => (a[1].order||0) - (b[1].order||0))
        .map(([id]) => id);
    
    const periods = generatePeriods(fromDate, toDate, 'week');
    
    // Header row
    const headers = ['Період', ...statusIds.map(id => statuses[id].name), 'Сума (грн)'];
    
    // Data rows
    const rows = periods.map(period => {
        const periodLeads = getLeadsInPeriod(period.start, period.end);
        const row = [period.label];
        
        statusIds.forEach(statusId => {
            row.push(periodLeads.filter(l => l.status === statusId).length);
        });
        
        const paidLeads = periodLeads.filter(l => l.status === 'paid');
        const revenue = paidLeads.reduce((sum, l) => sum + toUAH(l.finTotal, l.finTotalCur), 0);
        row.push(Math.round(revenue));
        
        return row;
    });
    
    const data = [
        ['TALKO CRM Звіт'],
        ['Період:', fromDate + ' — ' + toDate],
        [''],
        headers,
        ...rows
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Звіт');
    XLSX.writeFile(wb, 'TALKO_Report_' + fromDate + '_' + toDate + '.xlsx');
}

// ===== MODAL =====
function openModal(id){
    editing=id||null;
    document.getElementById('modal').classList.add('active');
    document.getElementById('modal-title').textContent=id?'Редагувати':'Новий лід';
    document.getElementById('del-btn').style.display=id?'block':'none';
    
    // Заповнюємо dropdowns для воронок та відповідальних
    populateFunnelDropdown();
    populateAssigneeDropdown();
    populateStatusDropdown();
    populateSourceDropdown();
    
    resetForm();
    if(id){const l=leads.find(x=>x.id===id);if(l)fillForm(l);}
    switchTab('main');
}

function populateFunnelDropdown(){
    const select = document.getElementById('f-funnel');
    if(!select) return;
    
    const funnels = getOrgFunnels();
    select.innerHTML = funnels.map(f => 
        `<option value="${f.id}">${f.name}${f.isDefault ? ' (за замовч.)' : ''}</option>`
    ).join('');
}

function populateAssigneeDropdown(){
    const select = document.getElementById('f-assignee');
    if(!select) return;
    
    select.innerHTML = '<option value="">Не призначено</option>' +
        teamMembers.filter(m => m.role === 'owner' || m.role === 'manager')
            .map(m => `<option value="${m.id}">${m.email}</option>`)
            .join('');
}

function populateStatusDropdown(funnelId){
    const select = document.getElementById('f-status');
    if(!select) return;
    
    const statusIds = getStatusIds(funnelId || document.getElementById('f-funnel')?.value);
    select.innerHTML = '<option value="">—</option>' + 
        statusIds.map(id => `<option value="${id}">${getStatusName(id, funnelId)}</option>`).join('');
}

function populateSourceDropdown(){
    const select = document.getElementById('f-source');
    if(!select) return;
    
    const sources = getOrgSources();
    select.innerHTML = '<option value="">—</option>' + 
        Object.entries(sources)
            .sort((a, b) => a[1].localeCompare(b[1]))
            .map(([code, name]) => `<option value="${code}">${escapeHtml(name)}</option>`)
            .join('');
}

function onFunnelChange(){
    const funnelId = document.getElementById('f-funnel')?.value;
    populateStatusDropdown(funnelId);
    
    // Якщо режим "по воронках" - встановлюємо дефолтного відповідального
    const mode = currentOrg?.settings?.assignmentMode;
    if(mode === 'by-funnel'){
        const funnels = getOrgFunnels();
        const funnel = funnels.find(f => f.id === funnelId);
        if(funnel?.defaultAssignee){
            document.getElementById('f-assignee').value = funnel.defaultAssignee;
        }
    }
}

function closeModal(){document.getElementById('modal').classList.remove('active');editing=null;}
function switchTab(t){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
    document.getElementById('t-'+t).classList.add('active');
}
function resetForm(){
    ['f-id','f-status','f-noshow','f-tg','f-phone','f-viber','f-whatsapp','f-email','f-primary-channel','f-biz','f-source','f-consult','f-repeat','f-calls','f-sms','f-next','f-next-time','f-action','f-fail','f-report','f-notes','l-record','l-report','l-kp','l-contract','fin-dep','fin-dep-cur','fin-dep-date','fin-total','fin-total-cur','fin-paid-date'].forEach(id=>{
        const e=document.getElementById(id);if(e)e.value='';
    });
    document.getElementById('f-next-time').value='10:00';
    document.getElementById('f-primary-channel').value='phone';
    
    // Дефолтна воронка
    const funnels = getOrgFunnels();
    const defaultFunnel = funnels.find(f => f.isDefault) || funnels[0];
    if(defaultFunnel){
        document.getElementById('f-funnel').value = defaultFunnel.id;
        populateStatusDropdown(defaultFunnel.id);
    }
    
    // Автопризначення для нових лідів
    const nextAssignee = getNextAssignee();
    if(nextAssignee){
        document.getElementById('f-assignee').value = nextAssignee;
    } else {
        document.getElementById('f-assignee').value = '';
    }
    
    document.getElementById('comm-log').innerHTML='<div style="color:var(--g);text-align:center;padding:20px">Історія порожня</div>';
    document.getElementById('fail-group').style.display='none';
}
function fillForm(l){
    document.getElementById('f-id').value=l.id;
    document.getElementById('f-funnel').value=l.funnelId||'default';
    populateStatusDropdown(l.funnelId);
    document.getElementById('f-assignee').value=l.assignedTo||'';
    document.getElementById('f-status').value=l.status||'';
    document.getElementById('f-noshow').value=l.noshow||'0';
    document.getElementById('f-tg').value=l.tg||'';
    document.getElementById('f-phone').value=l.phone||'';
    document.getElementById('f-viber').value=l.viber||'';
    document.getElementById('f-whatsapp').value=l.whatsapp||'';
    document.getElementById('f-email').value=l.email||'';
    document.getElementById('f-primary-channel').value=l.primaryChannel||'phone';
    document.getElementById('f-biz').value=l.biz||'';
    document.getElementById('f-source').value=l.source||'';
    document.getElementById('f-consult').value=l.consult||'';
    document.getElementById('f-repeat').value=l.repeatCount||'0';
    document.getElementById('f-calls').value=l.calls||'0';
    document.getElementById('f-sms').value=l.sms||'0';
    document.getElementById('f-next').value=l.nextDate||'';
    document.getElementById('f-next-time').value=l.nextTime||'10:00';
    document.getElementById('f-action').value=l.nextAction||'';
    document.getElementById('f-fail').value=l.failReason||'';
    document.getElementById('f-notes').value=l.notes||'';
    document.getElementById('f-report').value=l.report||'';
    document.getElementById('l-record').value=l.linkRecord||'';
    document.getElementById('l-report').value=l.linkReport||'';
    document.getElementById('l-kp').value=l.linkKP||'';
    document.getElementById('l-contract').value=l.linkContract||'';
    document.getElementById('fin-dep').value=l.finDep||'';
    document.getElementById('fin-dep-cur').value=l.finDepCur||'UAH';
    document.getElementById('fin-dep-date').value=l.finDepDate||'';
    document.getElementById('fin-total').value=l.finTotal||'';
    document.getElementById('fin-total-cur').value=l.finTotalCur||'UAH';
    document.getElementById('fin-paid-date').value=l.finPaidDate||'';
    onStatusChange();
    renderCommLog(l);
}
async function saveLeadForm(){
    const phone=document.getElementById('f-phone').value;
    const tg=document.getElementById('f-tg').value;
    const email=document.getElementById('f-email').value;
    if(!phone&&!tg&&!email){showWarning('Вкажіть хоча б один контакт');return;}
    const status=document.getElementById('f-status').value;
    if(status==='failed'&&!document.getElementById('f-fail').value){showWarning('Вкажіть причину відмови');return;}
    
    const funnelId = document.getElementById('f-funnel')?.value || 'default';
    const assignedTo = document.getElementById('f-assignee')?.value || null;
    
    const data={
        id:document.getElementById('f-id').value||genId(),
        funnelId,
        assignedTo,
        status,
        noshow:+document.getElementById('f-noshow').value||0,
        tg,phone,
        viber:document.getElementById('f-viber').value,
        whatsapp:document.getElementById('f-whatsapp').value,
        email,
        primaryChannel:document.getElementById('f-primary-channel').value||'phone',
        biz:document.getElementById('f-biz').value,
        source:document.getElementById('f-source').value,
        consult:document.getElementById('f-consult').value,
        repeatCount:+document.getElementById('f-repeat').value||0,
        calls:+document.getElementById('f-calls').value||0,
        sms:+document.getElementById('f-sms').value||0,
        nextDate:document.getElementById('f-next').value,
        nextTime:document.getElementById('f-next-time').value||'10:00',
        nextAction:document.getElementById('f-action').value,
        failReason:document.getElementById('f-fail').value,
        report:document.getElementById('f-report').value,
        notes:document.getElementById('f-notes').value,
        linkRecord:document.getElementById('l-record').value,
        linkReport:document.getElementById('l-report').value,
        linkKP:document.getElementById('l-kp').value,
        linkContract:document.getElementById('l-contract').value,
        finDep:+document.getElementById('fin-dep').value||null,
        finDepCur:document.getElementById('fin-dep-cur').value,
        finDepDate:document.getElementById('fin-dep-date').value,
        finTotal:+document.getElementById('fin-total').value||null,
        finTotalCur:document.getElementById('fin-total-cur').value,
        finPaidDate:document.getElementById('fin-paid-date').value
    };
    
    const idx=leads.findIndex(l=>l.id===data.id);
    const isNew = idx < 0;
    
    if(idx>=0){
        data.created=leads[idx].created || new Date().toISOString();
        data.createdAt=leads[idx].createdAt || leads[idx].created || new Date().toISOString();
        data.log=leads[idx].log||[];
        if(leads[idx].status!==data.status){data.stageDate=new Date().toISOString();addLog(data,'status','→ '+getStatusName(data.status, data.funnelId));}
        else data.stageDate=leads[idx].stageDate || new Date().toISOString();
        
        // Якщо змінився відповідальний
        if(leads[idx].assignedTo !== data.assignedTo && data.assignedTo){
            const assignee = teamMembers.find(m => m.id === data.assignedTo);
            addLog(data, 'assign', 'Призначено: ' + (assignee?.email || data.assignedTo));
            data.assignedAt = new Date().toISOString();
        }
    }else{
        data.created=new Date().toISOString();
        data.createdAt=new Date().toISOString();
        data.stageDate=new Date().toISOString();
        data.log=[];
        if(!data.status)data.status='new';
        if(!data.nextDate){data.nextDate=today();data.nextTime='10:00';data.nextAction='Подзвонити';}
        
        // Для round-robin - інкрементуємо індекс
        if(data.assignedTo && currentOrg?.settings?.assignmentMode === 'round-robin'){
            incrementRoundRobinIndex();
        }
        
        if(data.assignedTo){
            data.assignedAt = new Date().toISOString();
        }
    }
    if(data.status==='failed'&&!data.reactDate)data.reactDate=addDays(today(), REACTIVATION_DAYS);
    
    const saveBtn = document.querySelector('.modal-foot .btn-p');
    if(saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Збереження...'; }
    
    try {
        // Оновлюємо локальний масив
        const idx = leads.findIndex(l => l.id === data.id);
        if (idx >= 0) {
            leads[idx] = data;
        } else {
            leads.push(data);
        }
        
        // Зберігаємо в Firebase
        await saveLead(data);
        
        closeModal();
        render();
        showToast(idx >= 0 ? 'Збережено' : 'Ліда додано');
    } catch(err) {
        console.error('Save error:', err);
        showError('Помилка збереження: ' + err.message);
    } finally {
        if(saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Зберегти'; }
    }
}
async function delLeadForm(){
    if(!editing)return;
    const confirmed = await confirmModal('Видалити ліда?\n\nЦю дію неможливо скасувати.', {
        title: 'Видалення ліда',
        okText: 'Видалити',
        danger: true
    });
    if(!confirmed)return;
    try { await deleteLead(editing); closeModal(); }
    catch(err) { console.error('Delete error:', err); showError(err.message); }
}
function onStatusChange(){
    const st=document.getElementById('f-status').value;
    document.getElementById('fail-group').style.display=st==='failed'?'block':'none';
    document.getElementById('report-group').style.display=['completed','report_sent','repeat','deposit','paid'].includes(st)?'block':'none';
}

// ===== LEAD SCORING =====
function calcScore(l){
    // Кешуємо результат на основі ключових полів
    const cacheKey = `${l.status}_${l.source}_${l.noshow}_${l.calls}_${l.finDep}_${l.stageDate}_${l.report?.length||0}`;
    if(l._scoreCache === cacheKey && l._cachedScore !== undefined) {
        return l._cachedScore;
    }
    
    let score=50; // базовий
    
    // Джерело (+/- 15)
    if(l.source==='ref')score+=15; // рекомендація - найкраще
    if(l.source==='mk_clinic')score+=10;
    if(l.source==='mk_prod')score+=10;
    if(l.source==='ads')score+=5;
    if(l.source==='bot')score+=0;
    
    // Розмір бізнесу (+/- 10)
    const bizMatch=l.biz?.match(/(\d+)/);
    if(bizMatch){
        const size=parseInt(bizMatch[1]);
        if(size>=15&&size<=30)score+=10; // sweet spot
        else if(size>=10&&size<=50)score+=5;
        else if(size>50)score+=3; // великі довше закриваються
    }
    
    // Прогрес по воронці (+20)
    if(l.status==='report_sent')score+=10;
    if(l.status==='repeat')score+=15;
    if(l.status==='deposit')score+=20;
    
    // Швидкість реакції (+/- 10)
    if(l.stageDate){
        const days=Math.floor((new Date()-new Date(l.stageDate))/864e5);
        if(days<=2)score+=10; // свіжий
        else if(days<=5)score+=5;
        else if(days>7)score-=10; // застряг
        else if(days>14)score-=20;
    }
    
    // Engagement (+/- 15)
    if(l.noshow>0)score-=l.noshow*10; // кожна неявка -10
    if(l.calls>3&&l.status==='new')score-=15; // не бере трубку
    
    // Фінанси (+15)
    if(l.finDep)score+=15; // є завдаток
    
    // Звіт є (+10)
    if(l.report&&String(l.report).length>50)score+=10;
    
    // Ключові слова в звіті
    if(l.report){
        const r=String(l.report).toLowerCase();
        if(r.includes('готов')||r.includes('хоч'))score+=10;
        if(r.includes('бюджет')||r.includes('грош'))score+=5;
        if(r.includes('терміново')||r.includes('швидк'))score+=10;
        if(r.includes('думаю')||r.includes('порадж'))score-=5;
        if(r.includes('дорого')||r.includes('конкурент'))score-=10;
    }
    
    // Обмежуємо 0-100 та кешуємо
    const result = Math.max(0,Math.min(100,score));
    l._scoreCache = cacheKey;
    l._cachedScore = result;
    return result;
}

// ===== COMM LOG =====
function renderCommLog(l){
    const log=l.log||[];
    const c=document.getElementById('comm-log');
    if(!log.length){c.innerHTML='<div style="color:var(--g);text-align:center;padding:20px">Історія порожня</div>';return;}
    c.innerHTML=log.slice().reverse().map(e=>`
        <div class="comm-item">
            <div class="comm-icon ${e.type}">${{call:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',sms:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',note:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>',status:'<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>'}[e.type]||'•'}</div>
            <div class="comm-body">
                <div class="comm-head"><span class="comm-type">${{call:'Дзвінок',sms:'SMS',note:'Нотатка',status:'Статус'}[e.type]||e.type}</span><span class="comm-date">${fmtDT(e.date)}</span></div>
                <div class="comm-text">${e.text}</div>
            </div>
        </div>
    `).join('');
}
function addComm(){
    if(!editing)return;
    const type=document.getElementById('comm-type').value;
    const text=document.getElementById('comm-text').value;
    if(!text.trim())return;
    const idx=leads.findIndex(x=>x.id===editing);if(idx<0)return;
    const l=leads[idx]; // Працюємо з оригіналом!
    addLog(l,type,text);
    if(type==='call'){l.calls=(l.calls||0)+1;document.getElementById('f-calls').value=l.calls;}
    if(type==='sms'){l.sms=(l.sms||0)+1;document.getElementById('f-sms').value=l.sms;}
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(l, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(l.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    renderCommLog(l);
    document.getElementById('comm-text').value='';
}
function addLog(l,type,text){if(!l.log)l.log=[];l.log.push({type,text,date:new Date().toISOString()});}

function qAction(a){if(!editing)return;closeModal();taskAction(editing,a==='call'?'call_later':a==='sms'?'followup':a==='schedule'?'schedule':'fail');}

// ===== IMPORT/EXPORT =====
function exportXLS(){
    if(!leads.length){showToast('Немає даних для експорту');return;}
    const data=leads.map(l=>({Телеграм:l.tg,Телефон:l.phone,Бізнес:l.biz,Джерело:SRC[l.source]||l.source,Статус:ST[l.status]||l.status,Консультація:l.consult,Дзвінки:l.calls,SMS:l.sms,'Наступна дія':l.nextDate,Завдаток:l.finDep,'Повна сума':l.finTotal,Примітки:l.notes}));
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Leads');
    XLSX.writeFile(wb,'TALKO_CRM_'+today()+'.xlsx');
}
function importXLS(e){
    const file=e.target.files[0];if(!file)return;
    
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Спочатку оберіть організацію');
        e.target.value='';
        return;
    }
    
    const reader=new FileReader();
    reader.onload=async function(ev){
        try{
            const data=new Uint8Array(ev.target.result);
            const wb=XLSX.read(data,{type:'array',cellDates:true});
            const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1,raw:false,defval:''});
            
            // Шукаємо рядок з заголовками (містить 'phone' або 'timestamp')
            let headerRow=-1;
            for(let i=0;i<Math.min(10,rows.length);i++){
                const row=rows[i].map(c=>String(c).toLowerCase());
                if(row.some(c=>c.includes('phone')||c.includes('timestamp')||c.includes('телефон'))){
                    headerRow=i;break;
                }
            }
            
            // Якщо не знайшли заголовки — пробуємо перший рядок
            if(headerRow===-1)headerRow=0;
            
            const headers=rows[headerRow].map(h=>String(h).toLowerCase().trim());
            
            // Маппінг колонок
            const colMap={};
            headers.forEach((h,i)=>{
                if(h.includes('timestamp')||h.includes('дата'))colMap.date=i;
                if(h.includes('clinic')||h.includes('тип')||h.includes('бізнес'))colMap.biz=i;
                if(h.includes('problem')||h.includes('проблем'))colMap.problem=i;
                if(h.includes('goal')||h.includes('ціль'))colMap.goal=i;
                if(h.includes('phone')||h.includes('телефон'))colMap.phone=i;
                if(h.includes('source')||h.includes('джерело'))colMap.source=i;
                if(h.includes('telegram')||h.includes('нік'))colMap.tg=i;
                if(h.includes('mk_name')||h.includes('назва'))colMap.mkName=i;
                if(h.includes('status')||h.includes('статус'))colMap.status=i;
            });
            
            let n=0,skip=0;
            for(let i=headerRow+1;i<rows.length;i++){
                const row=rows[i];
                if(!row||row.length===0)continue;
                
                // Отримуємо телефон
                let phone=colMap.phone!==undefined?String(row[colMap.phone]||''):'';
                phone=phone.replace(/\D/g,''); // тільки цифри
                if(phone.length===9)phone='380'+phone; // 970064026 -> 380970064026
                if(phone.length===10&&phone[0]==='0')phone='38'+phone; // 0970064026 -> 380970064026
                if(phone.length>=10)phone='+'+phone;
                if(phone.length<10){skip++;continue;} // пропускаємо без телефону
                
                // Отримуємо телеграм
                let tg=colMap.tg!==undefined?String(row[colMap.tg]||''):'';
                if(tg&&!tg.startsWith('@'))tg='@'+tg;
                if(tg==='@')tg='';
                
                // Перевіряємо дублікати
                if(leads.some(l=>(phone&&l.phone===phone)||(tg&&l.tg===tg))){skip++;continue;}
                
                // Парсимо проблему (може бути число, текст, або дата-баг)
                let problem=colMap.problem!==undefined?String(row[colMap.problem]||''):'';
                if(problem.includes('1900')||problem.includes('2004'))problem=''; // Excel date bug
                
                // Парсимо ціль
                let goal=colMap.goal!==undefined?String(row[colMap.goal]||''):'';
                if(goal.includes('1900')||goal.includes('2004'))goal=''; // Excel date bug
                
                // Бізнес
                let biz=colMap.biz!==undefined?String(row[colMap.biz]||''):'';
                if(biz==='NaN'||biz==='undefined')biz='';
                
                // Джерело
                let source=colMap.source!==undefined?String(row[colMap.source]||''):'';
                if(!source||source==='NaN'){
                    // Визначаємо по mk_name якщо є
                    const mkName=colMap.mkName!==undefined?String(row[colMap.mkName]||'').toLowerCase():'';
                    if(mkName.includes('клінік'))source='mk_clinic';
                    else if(mkName.includes('виробн'))source='mk_prod';
                    else source='bot';
                }
                
                const newLead = {
                    id:genId(),
                    tg,
                    phone,
                    biz,
                    source,
                    status:'new',
                    problem,
                    goal,
                    calls:0,
                    sms:0,
                    noshow:0,
                    nextDate:today(),
                    nextAction:'Подзвонити',
                    created:new Date().toISOString(),
                    stageDate:new Date().toISOString(),
                    log:[]
                };
                // FIX: Додаємо await для збереження в Firebase
                leads.push(newLead);
                await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(newLead.id).set(newLead);
                n++;
            }
            showToast('Імпортовано: '+n+(skip?' (пропущено: '+skip+')':''));
            render();
        }catch(err){console.error(err);showError(err.message);}
    };
    reader.readAsArrayBuffer(file);
    e.target.value='';
}

// ===== DEMO =====
async function loadDemo(){
    // FIX: Перевірка наявності організації
    if(!currentOrg?.id) {
        showWarning('Спочатку оберіть організацію');
        return;
    }
    
    if(leads.length) {
        const confirmed = await confirmModal('Додати демо-дані?\n\nЦе додасть 5 тестових лідів до вашої бази.', {
            title: 'Демо-дані',
            okText: 'Додати'
        });
        if(!confirmed) return;
    }
    const demoLeads=[
        {id:'d1',tg:'@iryna_dental',phone:'+380501234567',biz:'Стоматологія-15',source:'mk_clinic',status:'new',calls:0,sms:0,noshow:0,nextDate:today(),nextAction:'Подзвонити',created:addDays(today(),-2),stageDate:new Date(Date.now() - 2*86400000).toISOString(),log:[]},
        {id:'d2',tg:'@petro_meble',phone:'+380672345678',biz:'Меблі-25',source:'mk_prod',status:'scheduled',consult:tomorrow()+'T14:00',calls:1,sms:0,noshow:0,nextDate:today(),nextAction:'Підтвердити',created:addDays(today(),-5),stageDate:new Date(Date.now() - 3*86400000).toISOString(),log:[{type:'call',text:'Призначили',date:addDays(today(),-3)}]},
        {id:'d3',tg:'@maria_cosmo',phone:'+380933456789',biz:'Косметологія-8',source:'bot',status:'scheduled',consult:addDays(today(),-1)+'T10:00',calls:2,sms:1,noshow:2,nextDate:today(),created:addDays(today(),-10),stageDate:new Date(Date.now() - 1*86400000).toISOString(),log:[{type:'status',text:'Не прийшла 2/3',date:addDays(today(),-1)}]},
        {id:'d4',tg:'@oleksandr_food',phone:'+380504567890',biz:'Харчування-50',source:'mk_prod',status:'report_sent',calls:1,sms:1,noshow:0,reportDate:addDays(today(),-2),nextDate:today(),linkRecord:'https://youtu.be/ex',linkReport:'https://docs.google.com/ex',created:addDays(today(),-14),stageDate:new Date(Date.now() - 2*86400000).toISOString(),log:[{type:'status',text:'Звіт відправлено',date:addDays(today(),-2)}]},
        {id:'d5',tg:'@natalia_pharm',phone:'+380675678901',biz:'Аптеки-12',source:'ref',status:'deposit',finDep:15000,finDepCur:'UAH',finDepDate:addDays(today(),-10),finTotal:45000,finTotalCur:'UAH',nextDate:addDays(today(),-3),created:addDays(today(),-20),stageDate:new Date(Date.now() - 10*86400000).toISOString(),log:[{type:'status',text:'Завдаток 15000',date:addDays(today(),-10)}]}
    ];
    for(const lead of demoLeads){
        leads.push(lead);
        await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(lead);
    }
    showToast('Демо-дані додано!');
    render();
}

function toggleHelp(){document.getElementById('help').classList.toggle('active');}

// ===== AI ASSISTANT =====
const AI_API_URL = 'https://openai-proxy-1090643937646.europe-central2.run.app'; // Заміни на свій URL після деплою

function toggleAI(){
    document.getElementById('ai-panel').classList.toggle('active');
    updateAILeadSelect();
}

function updateAILeadSelect(){
    const sel = document.getElementById('ai-lead-select');
    sel.innerHTML = '<option value="">— Виберіть ліда —</option>' + 
        leads.map(l => `<option value="${l.id}">${l.tg||l.phone} (${l.biz||'—'})</option>`).join('');
}

function getSelectedLead(){
    const id = document.getElementById('ai-lead-select').value;
    return id ? leads.find(l => l.id === id) : null;
}

function escapeHtml(text) {
    if(text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

/**
 * Підсвічує пошуковий запит в тексті
 */
function highlightSearch(text) {
    if(text === null || text === undefined) return '';
    const escaped = escapeHtml(String(text));
    if(!currentSearchQuery) return escaped;
    
    const regex = new RegExp(`(${escapeRegex(currentSearchQuery)})`, 'gi');
    return escaped.replace(regex, '<mark class="search-highlight">$1</mark>');
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function addAIMessage(text, isUser = false){
    const chat = document.getElementById('ai-chat');
    const msg = document.createElement('div');
    msg.className = `ai-msg ${isUser ? 'ai-msg-user' : 'ai-msg-bot'}`;
    msg.innerHTML = escapeHtml(text).replace(/\n/g, '<br>');
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
    return msg;
}

function showAILoading(){
    const chat = document.getElementById('ai-chat');
    const msg = document.createElement('div');
    msg.className = 'ai-msg ai-msg-loading';
    msg.id = 'ai-loading';
    msg.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Думаю...';
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function hideAILoading(){
    const el = document.getElementById('ai-loading');
    if(el) el.remove();
}

async function aiAsk(type){
    const lead = getSelectedLead();
    if(!lead && type !== 'general'){
        showWarning('Спочатку виберіть ліда');
        return;
    }
    
    // Build lead context for AI
    const leadContext = lead ? `
ІНФОРМАЦІЯ ПРО ЛІДА:
- Контакт: ${lead.tg || ''} ${lead.phone || ''}
- Бізнес: ${lead.biz || 'не вказано'}
- Джерело: ${lead.source || 'не вказано'}
- Статус: ${getStatusName(lead.status, lead.funnelId)}
- Дзвінків: ${lead.calls || 0}, SMS: ${lead.sms || 0}
- No-show: ${lead.noshow || 0}
- Наступна дія: ${lead.nextAction || 'не вказано'}
${lead.consult ? '- Дата консультації: ' + fmtDT(lead.consult) : ''}
${lead.report ? '\nЗВІТ КОНСУЛЬТАЦІЇ:\n' + lead.report : ''}
${lead.notes ? '\nПРИМІТКИ:\n' + lead.notes : ''}
${lead.log && lead.log.length ? '\nОСТАННІ ДІЇ:\n' + lead.log.slice(-5).map(e => '- ' + e.text).join('\n') : ''}
` : '';
    
    const prompts = {
        script: `${leadContext}

Згенеруй детальний скрипт дзвінка для цього ліда. 
Структура:
1. Привітання (з урахуванням як ми познайомились)
2. Причина дзвінка
3. Виявлення болю (2-3 питання)
4. Презентація рішення
5. Робота з запереченнями
6. Закриття на наступний крок`,

        analysis: `${leadContext}

Проаналізуй цього ліда детально:

1. СКОРИНГ (0-100): оціни ймовірність закриття
2. СИЛЬНІ СТОРОНИ: що грає на нашу користь
3. СЛАБКІ СТОРОНИ: що може завадити
4. РЕКОМЕНДОВАНА СТРАТЕГІЯ: конкретні кроки
5. ОПТИМАЛЬНИЙ ЧАС: коли краще дзвонити
6. ПРОГНОЗ: скільки ще контактів до закриття`,

        objections: `${leadContext}

Опрацюй заперечення для цього ліда через методологію СПІН:

СПІН = Ситуаційні → Проблемні → Імплікаційні → Напрямні питання

Для кожного можливого заперечення дай:
1. Саме заперечення
2. С — Ситуаційне питання (розуміємо контекст)
3. П — Проблемне питання (виявляємо біль)
4. І — Імплікаційне питання (показуємо наслідки)
5. Н — Напрямне питання (ведемо до рішення)

Типові заперечення: дорого, немає часу, подумаю, порадюсь, вже є консультант, не вірю в консалтинг.`,

        sms: `${leadContext}

Напиши 3 варіанти SMS для цього ліда (кожен до 160 символів).

Варіант 1: М'який (нагадування)
Варіант 2: Цінність (користь від зустрічі)  
Варіант 3: Терміновість (дедлайн/обмеження)

Мета: підштовхнути до наступного кроку у воронці.`,

        report_analysis: `${leadContext}

Проаналізуй звіт консультації та дай рекомендації:

Визнач:
1. Головний біль клієнта
2. Тригери до покупки
3. Можливі заперечення
4. Рекомендована стратегія дожиму
5. Оптимальна пропозиція (пакет, ціна, умови)`
    };
    
    const userMsg = prompts[type] || type;
    addAIMessage(getShortPromptName(type), true);
    showAILoading();
    
    try {
        const response = await fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: userMsg }],
                lead: lead
            })
        });
        
        const data = await response.json();
        hideAILoading();
        
        if(data.success){
            addAIMessage(data.message);
        } else {
            addAIMessage('Помилка: ' + (data.error || 'Невідома помилка'));
        }
    } catch(err){
        hideAILoading();
        addAIMessage('Помилка з\'єднання: ' + err.message);
    }
}

function getShortPromptName(type){
    const names = {
        script: 'Згенеруй скрипт дзвінка',
        analysis: 'Проаналізуй ліда',
        objections: 'Опрацюй заперечення через СПІН',
        sms: 'Напиши SMS варіанти',
        report_analysis: 'Проаналізуй звіт консультації'
    };
    return names[type] || type;
}

async function aiSend(){
    const input = document.getElementById('ai-input');
    const text = input.value.trim();
    if(!text) return;
    
    input.value = '';
    addAIMessage(text, true);
    showAILoading();
    
    try {
        const lead = getSelectedLead();
        
        // Build lead context
        let fullMessage = text;
        if(lead) {
            const leadContext = `
ІНФОРМАЦІЯ ПРО ЛІДА:
- Контакт: ${lead.tg || ''} ${lead.phone || ''}
- Бізнес: ${lead.biz || 'не вказано'}
- Джерело: ${lead.source || 'не вказано'}
- Статус: ${getStatusName(lead.status, lead.funnelId)}
- Дзвінків: ${lead.calls || 0}, SMS: ${lead.sms || 0}
- No-show: ${lead.noshow || 0}
- Наступна дія: ${lead.nextAction || 'не вказано'}
${lead.consult ? '- Дата консультації: ' + fmtDT(lead.consult) : ''}
${lead.report ? '\nЗВІТ КОНСУЛЬТАЦІЇ:\n' + lead.report : ''}
${lead.notes ? '\nПРИМІТКИ:\n' + lead.notes : ''}
${lead.log && lead.log.length ? '\nОСТАННІ ДІЇ:\n' + lead.log.slice(-5).map(e => '- ' + e.text).join('\n') : ''}

ПИТАННЯ КОРИСТУВАЧА: `;
            fullMessage = leadContext + text;
        }
        
        const response = await fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: [{ role: 'user', content: fullMessage }],
                lead: lead
            })
        });
        
        const data = await response.json();
        hideAILoading();
        
        if(data.success){
            addAIMessage(data.message);
        } else {
            addAIMessage('<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>Помилка: ' + (data.error || 'Невідома помилка'));
        }
    } catch(err){
        hideAILoading();
        addAIMessage('<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="vertical-align:middle;margin-right:4px"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>Помилка з\'єднання: ' + err.message);
    }
}

// Init report dates on load
initReportDates();

// ===== STATUS DROPDOWN =====
let activeDropdown = null;
let statusPickerLeadId = null;

// SVG іконки для статусів
const STATUS_ICONS = {
    'new': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>',
    'contacted': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
    'scheduled': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    'completed': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    'report_sent': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
    'deposit': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>',
    'paid': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
    'failed': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    'frozen': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 7l-5 5-5-5"/><path d="M17 17l-5-5-5 5"/><line x1="2" y1="12" x2="22" y2="12"/></svg>',
    'custom': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
};

// Іконки та описи для статусів
const STATUS_META = {
    'new': { icon: STATUS_ICONS.new, desc: 'Новий лід, потребує першого контакту', group: 'start' },
    'contacted': { icon: STATUS_ICONS.contacted, desc: 'Був контакт, чекаємо відповідь', group: 'start' },
    'scheduled': { icon: STATUS_ICONS.scheduled, desc: 'Призначена консультація', group: 'progress' },
    'completed': { icon: STATUS_ICONS.completed, desc: 'Консультація проведена', group: 'progress' },
    'report_sent': { icon: STATUS_ICONS.report_sent, desc: 'Звіт надісланий клієнту', group: 'progress' },
    'deposit': { icon: STATUS_ICONS.deposit, desc: 'Отримано завдаток', group: 'money' },
    'paid': { icon: STATUS_ICONS.paid, desc: 'Повністю оплачено', group: 'money' },
    'failed': { icon: STATUS_ICONS.failed, desc: 'Відмова від послуг', group: 'end' },
    'frozen': { icon: STATUS_ICONS.frozen, desc: 'Тимчасово заморожено', group: 'end' }
};

const STATUS_GROUPS = {
    'start': { title: 'Початок роботи', icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>', order: 1 },
    'progress': { title: 'В процесі', icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>', order: 2 },
    'money': { title: 'Фінанси', icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>', order: 3 },
    'end': { title: 'Завершення', icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>', order: 4 },
    'custom': { title: 'Кастомні статуси', icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>', order: 5 }
};

function openStatusPicker(leadId) {
    const lead = leads.find(l => l.id === leadId);
    if(!lead) return;
    
    statusPickerLeadId = leadId;
    
    // Закриваємо старі dropdown
    document.querySelectorAll('.task-status-dropdown.active').forEach(d => d.classList.remove('active'));
    
    // Встановлюємо назву ліда
    document.getElementById('status-picker-lead-name').textContent = lead.name || lead.tg || 'Без імені';
    
    // Отримуємо статуси для поточної воронки
    const funnelId = lead.funnelId || currentFunnelId || 'default';
    const statuses = getStatusIds(funnelId);
    
    // Групуємо статуси
    const grouped = {};
    statuses.forEach(statusId => {
        const meta = STATUS_META[statusId] || { icon: STATUS_ICONS.custom, desc: 'Кастомний статус', group: 'custom' };
        const group = meta.group;
        if(!grouped[group]) grouped[group] = [];
        grouped[group].push({
            id: statusId,
            name: getStatusName(statusId, funnelId),
            icon: meta.icon,
            desc: meta.desc,
            color: getStatusColor(statusId, funnelId),
            isCurrent: lead.status === statusId
        });
    });
    
    // Генеруємо HTML
    let html = '';
    const sortedGroups = Object.entries(grouped).sort((a, b) => 
        (STATUS_GROUPS[a[0]]?.order || 99) - (STATUS_GROUPS[b[0]]?.order || 99)
    );
    
    sortedGroups.forEach(([groupKey, items]) => {
        const groupInfo = STATUS_GROUPS[groupKey] || { title: 'Інші', icon: '', order: 99 };
        html += `
            <div class="status-group">
                <div class="status-group-title">${groupInfo.icon || ''} ${groupInfo.title}</div>
                <div class="status-grid">
                    ${items.map(s => `
                        <div class="status-card ${s.isCurrent ? 'current' : ''}" onclick="selectStatus('${s.id}')">
                            <div class="status-card-icon" style="background:${s.color}20;--icon-color:${s.color}">${s.icon.replace('stroke="currentColor"', `stroke="${s.color}"`)}</div>
                            <div class="status-card-name">${s.name}</div>
                            <div class="status-card-desc">${s.desc}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    document.getElementById('status-picker-body').innerHTML = html;
    document.getElementById('status-picker-overlay').classList.add('active');
}

function closeStatusPicker() {
    document.getElementById('status-picker-overlay').classList.remove('active');
    statusPickerLeadId = null;
}

async function selectStatus(newStatus) {
    if(!statusPickerLeadId) return;
    
    const lead = leads.find(l => l.id === statusPickerLeadId);
    if(!lead || lead.status === newStatus) {
        closeStatusPicker();
        return;
    }
    
    const leadId = statusPickerLeadId; // Зберігаємо перед закриттям
    closeStatusPicker();
    
    // Використовуємо існуючу логіку changeLeadStatus
    await changeLeadStatus(leadId, newStatus);
    
    // Оновлюємо UI
    render();
}

function toggleStatusDropdown(leadId, btn) {
    const dropdown = document.getElementById(`status-dropdown-${leadId}`);
    
    // Закрити інші dropdown
    document.querySelectorAll('.task-status-dropdown.active').forEach(d => {
        if(d !== dropdown) {
            d.classList.remove('active');
            d.style.cssText = '';
        }
    });
    
    if(dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
        dropdown.style.cssText = '';
        activeDropdown = null;
        return;
    }
    
    // Показуємо dropdown
    dropdown.classList.add('active');
    activeDropdown = dropdown;
    
    // Перевіряємо чи вистачає місця знизу
    setTimeout(() => {
        const btnRect = btn.getBoundingClientRect();
        const dropRect = dropdown.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // Скидаємо попередні стилі
        dropdown.classList.remove('drop-up');
        dropdown.style.cssText = '';
        
        // Визначаємо чи є місце внизу (300px для dropdown)
        const spaceBelow = viewportHeight - btnRect.bottom;
        const spaceAbove = btnRect.top;
        
        // Якщо внизу менше 320px і вгорі більше місця - показуємо вгору
        if(spaceBelow < 320 && spaceAbove > spaceBelow) {
            dropdown.classList.add('drop-up');
        }
    }, 0);
}

async function changeLeadStatus(leadId, newStatus) {
    const idx = leads.findIndex(x => x.id === leadId);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    const oldStatus = lead.status;
    
    // Якщо статус не змінився - виходимо
    if(oldStatus === newStatus) return;
    
    lead.status = newStatus;
    lead.stageDate = new Date().toISOString();
    
    // Логіка для різних статусів - ЗАВДАННЯ ТА ДАТИ
    switch(newStatus) {
        case 'new':
        case 'contacted':
            lead.nextDate = today();
            lead.nextTime = '10:00';
            lead.nextAction = 'Подзвонити';
            break;
            
        case 'scheduled':
            if(!lead.consult) {
                const dt = await promptDateTime('Дата консультації:', tomorrow() + 'T14:00');
                if(dt) {
                    lead.consult = dt;
                    lead.nextDate = getDayBefore(dt);
                    lead.nextTime = '10:00';
                    lead.nextAction = 'Підтвердити консультацію';
                } else {
                    lead.status = oldStatus; // Відкатуємо
                    return;
                }
            } else {
                lead.nextDate = getDayBefore(lead.consult);
                lead.nextTime = '10:00';
                lead.nextAction = 'Підтвердити консультацію';
            }
            break;
            
        case 'completed':
            lead.nextDate = today();
            lead.nextTime = '10:00';
            lead.nextAction = 'Написати звіт';
            lead.calls = 0;
            lead.sms = 0;
            break;
            
        case 'report_sent':
            lead.nextDate = addDays(today(), 2);
            lead.nextTime = '10:00';
            lead.nextAction = 'Дізнатись реакцію на звіт';
            break;
            
        case 'repeat':
            if(!lead.consult || new Date(lead.consult) < new Date()) {
                const dt = await promptDateTime('Дата повторної консультації:', tomorrow() + 'T14:00');
                if(dt) {
                    lead.consult = dt;
                } else {
                    lead.status = oldStatus;
                    return;
                }
            }
            lead.repeatCount = (lead.repeatCount || 0) + 1;
            lead.nextDate = getDayBefore(lead.consult);
            lead.nextTime = '10:00';
            lead.nextAction = 'Підтвердити консультацію';
            lead.calls = 0;
            lead.sms = 0;
            lead.noshow = 0;
            break;
            
        case 'deposit':
            const amt = await promptModal('Сума завдатку:', '', {
                type: 'number',
                placeholder: 'Наприклад: 5000'
            });
            if(amt && amt !== null) {
                lead.finDep = +amt;
                lead.finDepDate = today();
                lead.nextDate = addDays(today(), DEPOSIT_REMINDER_DAYS);
                lead.nextTime = '10:00';
                lead.nextAction = 'Нагадати про повну оплату';
            } else {
                lead.status = oldStatus;
                return;
            }
            break;
            
        case 'paid':
            const paidAmt = await promptModal('Повна сума:', lead.finTotal || '', {
                type: 'number',
                placeholder: 'Наприклад: 50000'
            });
            if(paidAmt && paidAmt !== null) {
                lead.finTotal = +paidAmt;
                lead.finPaidDate = today();
                lead.nextDate = '';
                lead.nextAction = '';
            } else {
                lead.status = oldStatus;
                return;
            }
            break;
            
        case 'failed':
            const reason = await promptModal('Причина відмови:', '', {
                placeholder: 'Наприклад: дорого, немає бюджету...'
            });
            if(reason === null) {
                lead.status = oldStatus;
                return;
            }
            lead.failReason = reason || '';
            lead.reactDate = addDays(today(), REACTIVATION_DAYS);
            lead.nextDate = lead.reactDate;
            lead.nextTime = '10:00';
            lead.nextAction = 'Реактивація';
            break;
            
        case 'frozen':
            const months = await promptModal('Через скільки місяців повернутися?', '3', {
                type: 'number',
                min: '1',
                max: '12'
            });
            if(months === null) {
                lead.status = oldStatus;
                return;
            }
            const m = parseInt(months) || DEFAULT_FREEZE_MONTHS;
            lead.reactDate = addDays(today(), m * 30);
            lead.nextDate = lead.reactDate;
            lead.nextTime = '10:00';
            lead.nextAction = 'Реактивація';
            break;
            
        default:
            // Кастомні статуси - просто змінюємо статус
            break;
    }
    
    addLog(lead, 'status', `${getStatusName(oldStatus, lead.funnelId)} → ${getStatusName(newStatus, lead.funnelId)}`);
    
    // Зберігаємо в Firebase напряму
    try {
        const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
            value === undefined ? null : value
        ));
        
        await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData);
        showToast(`${getStatusName(oldStatus)} → ${getStatusName(newStatus)}`);
    } catch(err) {
        lead.status = oldStatus; // Відкатуємо при помилці
        showError('Помилка збереження: ' + err.message);
        console.error('Save error:', err);
    }
    
    // Закрити dropdown
    if(activeDropdown) {
        activeDropdown.classList.remove('active');
        activeDropdown = null;
    }
    
    // Оновлюємо UI
    render();
}

// Закрити dropdown при кліку поза ним
document.addEventListener('click', (e) => {
    // Task status dropdown
    if(activeDropdown && !e.target.closest('.task-status-wrap')) {
        activeDropdown.classList.remove('active');
        activeDropdown = null;
    }
    
    // Funnel bar dropdowns
    if(!e.target.closest('.funnel-selector')) {
        closeAllDropdowns();
    }
});

// ===== QUICK ACTION PANEL =====
let quickLeadId = null;
let quickState = {
    outcome: null,
    time: null,
    action: null,
    note: ''
};

// ===== CONTACT LINKS =====
const CONTACT_LINK_CONFIG = {
    tg: {
        getLink: (val) => `https://t.me/${String(val || '').replace('@', '').trim()}`,
        icon: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>`,
        class: 'tg'
    },
    phone: {
        getLink: (val) => `tel:+${String(val || '').replace(/\D/g, '')}`,
        icon: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
        class: 'phone'
    },
    viber: {
        getLink: (val) => `viber://chat?number=%2B${String(val || '').replace(/\D/g, '')}`,
        icon: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M11.398.002C9.473.028 5.331.344 3.014 2.467 1.294 4.182.518 6.792.377 10.967c-.14 4.175-.324 12.001 7.326 14.127h.006l-.006 3.09s-.048.757.47 1.076c.626.386 1.04.169 1.665-.437.345-.334 1.056-1.09 1.497-1.556 4.13.36 7.3-.453 7.657-.562.821-.254 5.469-.863 6.223-7.049.777-6.379-.389-10.413-2.566-12.24-1.276-1.136-6.397-2.81-11.25-3.414z"/></svg>`,
        class: 'viber'
    },
    whatsapp: {
        getLink: (val) => `https://wa.me/${String(val || '').replace(/\D/g, '')}`,
        icon: `<svg viewBox="0 0 24 24" width="12" height="12" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>`,
        class: 'whatsapp'
    },
    email: {
        getLink: (val) => `mailto:${String(val || '')}`,
        icon: `<svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
        class: 'email'
    }
};

function getContactLink(type, value) {
    if(!value) return null;
    const config = CONTACT_LINK_CONFIG[type];
    if(!config) return null;
    return config.getLink(value);
}

// Legacy functions for compatibility
function getTelegramLink(username) {
    return getContactLink('tg', username);
}

function getViberLink(phone) {
    return getContactLink('viber', phone);
}

function getWhatsAppLink(phone) {
    return getContactLink('whatsapp', phone);
}

function getPhoneLink(phone) {
    return getContactLink('phone', phone);
}

function getEmailLink(email) {
    return getContactLink('email', email);
}

// Render primary contact based on primaryChannel setting
function renderPrimaryContact(l) {
    // Визначаємо канал з пріоритетом: якщо є tg - показуємо tg
    let channel = l.primaryChannel || 'phone';
    
    // ВАЖЛИВО: якщо є tg і він заповнений - пріоритет tg
    if(l.tg && String(l.tg).startsWith('@')) {
        channel = 'tg';
    }
    
    // Get contact value based on channel
    const channelValues = {
        tg: l.tg,
        phone: l.phone,
        viber: l.viber || l.phone,
        whatsapp: l.whatsapp || l.phone,
        email: l.email
    };
    
    let value = channelValues[channel] || '';
    
    // Fallback to any available contact
    if(!value) {
        for(const ch of ['tg', 'phone', 'email']) {
            if(channelValues[ch]) {
                value = channelValues[ch];
                channel = ch;
                break;
            }
        }
    }
    
    if(!value || value === 'undefined') {
        return '<span class="task-contact-link">—</span>';
    }
    
    const config = CONTACT_LINK_CONFIG[channel];
    if(!config) return '<span class="task-contact-link">—</span>';
    
    const link = config.getLink(value);
    
    return `<a href="${link || '#'}" target="_blank" class="task-contact-link ${config.class}" onclick="event.stopPropagation()" title="${channel.toUpperCase()}">
        ${config.icon}
        ${escapeHtml(value)}
    </a>`;
}

function renderContactLinks(lead) {
    let html = '';
    
    // Telegram
    if(lead.tg) {
        const link = getTelegramLink(lead.tg);
        html += `<a href="${link}" target="_blank" class="contact-link tg" onclick="event.stopPropagation()" title="Відкрити Telegram">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
            ${lead.tg}
        </a>`;
    }
    
    // Phone with options
    if(lead.phone) {
        const phoneClean = String(lead.phone).replace(/\D/g, '');
        html += `<div class="contact-phone-group" onclick="event.stopPropagation()">
            <a href="${getPhoneLink(lead.phone)}" class="contact-link phone" title="Зателефонувати">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                ${lead.phone}
            </a>
            <div class="contact-messengers">
                <a href="${getWhatsAppLink(lead.phone)}" target="_blank" class="messenger-btn wa" title="WhatsApp">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                </a>
                <a href="${getViberLink(lead.phone)}" target="_blank" class="messenger-btn viber" title="Viber">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.398.002C9.473.028 5.331.344 3.014 2.467 1.294 4.182.518 6.792.377 10.967c-.14 4.175-.324 12.001 7.326 14.127h.006l-.006 3.09s-.048.757.47 1.076c.626.386 1.04.169 1.665-.437.345-.334 1.056-1.09 1.497-1.556 4.13.36 7.3-.453 7.657-.562.821-.254 5.469-.863 6.223-7.049.777-6.379-.389-10.413-2.566-12.24-1.276-1.136-6.397-2.81-11.25-3.414zm.175 1.843c4.44.536 8.856 1.866 9.863 2.715 1.73 1.456 2.752 5.072 2.092 10.485-.606 5.033-4.178 5.473-4.883 5.69-.296.09-3.054.787-6.573.554 0 0-2.602 3.144-3.413 3.96-.126.126-.277.178-.376.152-.14-.035-.179-.2-.177-.44l.02-4.294c-6.277-1.655-5.902-8.037-5.79-11.39.112-3.353.702-5.523 2.076-6.882 1.755-1.67 5.261-2.45 7.16-2.55zm.083 2.842c-.186.012-.186.286 0 .299 1.478.084 2.802.567 3.827 1.481 1.026.915 1.639 2.203 1.77 3.736.016.185.282.195.299 0 .07-1.655-.656-3.1-1.793-4.11-1.138-1.012-2.676-1.47-4.103-1.406zm-2.46.652c-.202-.002-.39.086-.56.235L7.7 6.468c-.246.222-.337.542-.396.85-.058.31-.069.653.017 1.048.168.784.637 1.85 1.609 3.19.972 1.341 2.327 2.853 4.312 4.148 1.095.683 1.9.963 2.606 1.076.353.057.68.066.996.003.316-.064.626-.2.864-.425.162-.152.347-.428.537-.722.19-.294.387-.619.457-.783.136-.313.098-.601-.089-.82-.185-.216-.49-.356-.756-.46l-1.435-.554c-.258-.1-.622-.166-.926.103l-.742.657c-.143.126-.39.115-.39.115s-1.655-.394-2.791-1.658c-1.135-1.264-1.413-2.92-1.413-2.92s-.022-.241.105-.378l.604-.784c.23-.322.151-.67.066-.929l-.515-1.532c-.093-.277-.222-.588-.437-.776a.857.857 0 00-.556-.216zm2.754 1.018c-.189-.011-.2.282 0 .297a3.48 3.48 0 012.403 1.12 3.479 3.479 0 01.882 2.507c.001.185.273.2.295 0 .105-1.04-.215-2.053-.893-2.8-.678-.748-1.635-1.147-2.687-1.124zm.287 1.474c-.192-.015-.21.267 0 .293.66.082 1.2.6 1.268 1.336.017.185.285.186.296 0 .004-.465-.17-.879-.483-1.185-.313-.307-.718-.438-1.08-.444z"/></svg>
                </a>
            </div>
        </div>`;
    }
    
    return html || '<span class="no-contact">Немає контакту</span>';
}

function openQuickPanel(id) {
    const l = leads.find(x => x.id === id);
    if(!l) return;
    
    quickLeadId = id;
    quickState = { outcome: null, time: null, action: null, note: '' };
    
    // Fill lead info
    document.getElementById('quick-lead-name').textContent = l.tg || l.phone || '—';
    document.getElementById('quick-lead-biz').textContent = l.biz || '—';
    document.getElementById('quick-lead-contacts').innerHTML = renderContactLinks(l);
    document.getElementById('quick-lead-task').textContent = 'Завдання: ' + (l.nextAction || 'Подзвонити');
    
    // Показуємо примітки якщо є
    const notesEl = document.getElementById('quick-lead-notes');
    const notesTextEl = document.getElementById('quick-lead-notes-text');
    if(l.notes && String(l.notes).trim()) {
        notesTextEl.textContent = l.notes;
        notesEl.style.display = 'block';
    } else if(l.report && String(l.report).trim()) {
        notesTextEl.textContent = l.report;
        notesEl.style.display = 'block';
    } else {
        notesEl.style.display = 'none';
    }
    
    // Reset sections
    document.getElementById('quick-outcome-section').style.display = 'block';
    document.getElementById('quick-comment-section').style.display = 'none';
    document.getElementById('quick-next-section').style.display = 'none';
    document.getElementById('quick-action-section').style.display = 'none';
    document.getElementById('quick-final-section').style.display = 'none';
    document.getElementById('quick-confirm-btn').style.display = 'none';
    document.getElementById('quick-note').value = '';
    document.getElementById('quick-comment').value = '';
    
    // Show/hide confirm consultation button based on task
    const confirmConsultSection = document.getElementById('quick-confirm-consult-section');
    if(confirmConsultSection) {
        const taskLower = (l.nextAction || '').toLowerCase();
        const isConfirmTask = taskLower.includes('підтвердити') && (taskLower.includes('консультац') || taskLower.includes('зустріч'));
        confirmConsultSection.style.display = isConfirmTask ? 'block' : 'none';
    }
    
    // Clear selections
    document.querySelectorAll('.quick-btn.selected, .time-btn.selected').forEach(b => b.classList.remove('selected'));
    
    // Show panel
    document.getElementById('quick-panel').classList.add('active');
    document.querySelector('.quick-panel-overlay').classList.add('active');
    
    // Reset notes expand state
    const notesText = document.getElementById('quick-lead-notes-text');
    const expandBtn = document.getElementById('notes-expand-btn');
    if(notesText && expandBtn) {
        notesText.style.maxHeight = '80px';
        expandBtn.textContent = 'Розгорнути ▼';
        expandBtn.dataset.expanded = 'false';
    }
}

let notesExpanded = false;
function toggleNotesExpand() {
    const notesText = document.getElementById('quick-lead-notes-text');
    const btn = document.getElementById('notes-expand-btn');
    if(!notesText || !btn) return;
    
    notesExpanded = !notesExpanded;
    
    if(notesExpanded) {
        notesText.style.maxHeight = '300px';
        notesText.style.overflowY = 'auto';
        btn.textContent = 'Згорнути ▲';
    } else {
        notesText.style.maxHeight = '80px';
        notesText.style.overflowY = 'hidden';
        btn.textContent = 'Розгорнути ▼';
    }
}

function closeQuickPanel() {
    document.getElementById('quick-panel').classList.remove('active');
    document.querySelector('.quick-panel-overlay').classList.remove('active');
    quickLeadId = null;
}

function confirmConsultation() {
    const idx = leads.findIndex(x => x.id === quickLeadId);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    lead.confirmedToday = true;
    lead.calls = (lead.calls || 0) + 1;
    
    // Встановлюємо наступне завдання на день консультації
    if(lead.consult) {
        const consultDate = lead.consult.split('T')[0];
        lead.nextDate = consultDate;
        lead.nextTime = lead.consult.split('T')[1] || '10:00';
        lead.nextAction = 'Провести консультацію';
    }
    
    addLog(lead, 'call', 'Консультація підтверджена');
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    closeQuickPanel();
    render();
}

function setQuickOutcome(outcome) {
    quickState.outcome = outcome;
    
    // Highlight selected
    document.querySelectorAll('#quick-outcome-buttons .quick-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.quick-btn').classList.add('selected');
    
    // Always show comment section
    document.getElementById('quick-comment-section').style.display = 'block';
    
    // Show next section based on outcome
    if(outcome === 'answered') {
        // Взяв - показуємо фінальні дії + час
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'block';
        document.getElementById('quick-action-section').style.display = 'none';
    } else if(outcome === 'no_answer' || outcome === 'callback') {
        // Не взяв / Передзвонить - показуємо тільки час
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'none';
        document.getElementById('quick-action-section').style.display = 'none';
        quickState.action = outcome === 'callback' ? 'Чекаю дзвінок' : 'Подзвонити';
    } else if(outcome === 'sms') {
        // SMS - показуємо час
        document.getElementById('quick-next-section').style.display = 'block';
        document.getElementById('quick-final-section').style.display = 'none';
        document.getElementById('quick-action-section').style.display = 'none';
        quickState.action = 'Подзвонити (після SMS)';
    }
    
    // Scroll to comment section
    setTimeout(() => {
        document.getElementById('quick-comment-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function setQuickTime(time) {
    quickState.time = time;
    
    // Hide custom picker if was shown
    document.getElementById('custom-datetime-picker').style.display = 'none';
    
    // Highlight selected
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.time-btn').classList.add('selected');
    
    // Show action section if answered
    if(quickState.outcome === 'answered') {
        document.getElementById('quick-action-section').style.display = 'block';
        setTimeout(() => {
            document.getElementById('quick-action-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    } else {
        // For no_answer/sms/callback - show confirm button directly
        document.getElementById('quick-confirm-btn').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('quick-confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function showCustomDateTime() {
    const picker = document.getElementById('custom-datetime-picker');
    const dateInput = document.getElementById('quick-custom-date');
    const timeInput = document.getElementById('quick-custom-time');
    
    // Set default to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateInput.value = tomorrow.toISOString().split('T')[0];
    dateInput.min = new Date().toISOString().split('T')[0]; // Мінімум - сьогодні
    timeInput.value = '10:00';
    
    picker.style.display = 'block';
    dateInput.focus();
    
    // Scroll to picker
    setTimeout(() => {
        picker.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

function confirmCustomDateTime() {
    const dateInput = document.getElementById('quick-custom-date');
    const timeInput = document.getElementById('quick-custom-time');
    
    if(!dateInput.value) {
        showWarning('Оберіть дату');
        return;
    }
    
    // Store as custom datetime
    quickState.time = 'custom';
    quickState.customDate = dateInput.value;
    quickState.customTime = timeInput.value || '10:00';
    
    // Hide picker
    document.getElementById('custom-datetime-picker').style.display = 'none';
    
    // Highlight the custom button
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
    document.querySelector('.time-btn-custom').classList.add('selected');
    
    // Format for display
    const dateObj = new Date(dateInput.value + 'T' + (timeInput.value || '10:00'));
    const formattedDate = dateObj.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
    const formattedTime = timeInput.value || '10:00';
    
    showToast(`Обрано: ${formattedDate} о ${formattedTime}`);
    
    // Show action section if answered
    if(quickState.outcome === 'answered') {
        document.getElementById('quick-action-section').style.display = 'block';
        setTimeout(() => {
            document.getElementById('quick-action-section').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    } else {
        document.getElementById('quick-confirm-btn').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('quick-confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
    }
}

function setQuickAction(action) {
    quickState.action = action;
    
    // Highlight selected
    document.querySelectorAll('#quick-action-buttons .quick-btn').forEach(b => b.classList.remove('selected'));
    event.target.closest('.quick-btn').classList.add('selected');
    
    // Show confirm button
    document.getElementById('quick-confirm-btn').style.display = 'flex';
    setTimeout(() => {
        document.getElementById('quick-confirm-btn').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 100);
}

async function setQuickFinal(finalAction) {
    const idx = leads.findIndex(x => x.id === quickLeadId);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    
    if(finalAction === 'scheduled') {
        const dt = await promptDateTime('Дата і час консультації:', tomorrow() + 'T14:00');
        if(!dt) return;
        lead.status = 'scheduled';
        lead.consult = dt;
        lead.noshow = 0;
        lead.nextDate = getDayBefore(dt);
        lead.nextTime = '10:00';
        lead.nextAction = 'Підтвердити консультацію';
        addLog(lead, 'status', 'Консультація призначена на ' + fmtDT(dt));
    } else if(finalAction === 'completed') {
        lead.status = 'completed';
        lead.calls = 0;
        lead.sms = 0;
        lead.nextDate = today();
        lead.nextTime = '10:00';
        lead.nextAction = 'Написати звіт';
        addLog(lead, 'status', 'Консультація проведена');
    } else if(finalAction === 'failed') {
        const reason = await promptModal('Причина відмови:', '', {
            placeholder: 'Наприклад: дорого, немає бюджету...'
        });
        if(reason === null) return;
        lead.status = 'failed';
        lead.failReason = reason || '';
        lead.reactDate = addDays(today(), REACTIVATION_DAYS);
        addLog(lead, 'status', 'Відмова: ' + (reason || 'не вказано'));
    }
    
    // Зберігаємо напряму в Firebase
    try {
        const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
            value === undefined ? null : value
        ));
        await db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData);
    } catch(err) {
        showError('Помилка збереження: ' + err.message);
    }
    
    closeQuickPanel();
    render();
}

function confirmQuickAction() {
    const idx = leads.findIndex(x => x.id === quickLeadId);
    if(idx < 0) return;
    
    const lead = leads[idx]; // Працюємо з оригіналом!
    const comment = document.getElementById('quick-comment')?.value.trim() || '';
    const note = document.getElementById('quick-note')?.value.trim() || '';
    const combinedNote = comment || note;
    
    // Calculate next date/time
    const nextDateTime = calculateNextDateTime(quickState.time);
    lead.nextDate = nextDateTime.date;
    lead.nextTime = nextDateTime.time;
    lead.nextAction = quickState.action || 'Подзвонити';
    
    // Update counters based on outcome
    if(quickState.outcome === 'no_answer') {
        lead.calls = (lead.calls || 0) + 1;
        addLog(lead, 'call', 'Не взяв трубку' + (combinedNote ? ': ' + combinedNote : ''));
    } else if(quickState.outcome === 'sms') {
        lead.sms = (lead.sms || 0) + 1;
        addLog(lead, 'sms', 'SMS надіслано' + (combinedNote ? ': ' + combinedNote : ''));
    } else if(quickState.outcome === 'callback') {
        addLog(lead, 'call', 'Чекаю дзвінок' + (combinedNote ? ': ' + combinedNote : ''));
    } else if(quickState.outcome === 'answered') {
        lead.calls = (lead.calls || 0) + 1;
        const logText = combinedNote || quickState.action || 'Розмова';
        addLog(lead, 'call', logText);
    }
    
    // Save comment to notes if it's meaningful
    if(combinedNote && combinedNote.length > 10) {
        const dateStr = new Date().toLocaleDateString('uk-UA');
        const existingNotes = String(lead.notes || '');
        lead.notes = (existingNotes + '\n[' + dateStr + '] ' + combinedNote).trim();
    }
    
    // Зберігаємо напряму в Firebase
    const cleanData = JSON.parse(JSON.stringify(lead, (key, value) => 
        value === undefined ? null : value
    ));
    db.collection('organizations').doc(currentOrg.id).collection('leads').doc(lead.id).set(cleanData)
        .catch(err => showError('Помилка збереження: ' + err.message));
    
    closeQuickPanel();
    render();
}

function calculateNextDateTime(timeCode) {
    const now = new Date();
    let targetDate = new Date();
    let targetTime = '10:00';
    
    // Handle custom datetime
    if(timeCode === 'custom' && quickState.customDate) {
        return {
            date: quickState.customDate,
            time: quickState.customTime || '10:00'
        };
    }
    
    switch(timeCode) {
        case '30m':
            targetDate.setMinutes(targetDate.getMinutes() + 30);
            targetTime = targetDate.getHours().toString().padStart(2,'0') + ':' + 
                         Math.round(targetDate.getMinutes()/5)*5 .toString().padStart(2,'0');
            break;
        case '2h':
            targetDate.setHours(targetDate.getHours() + 2);
            targetTime = targetDate.getHours().toString().padStart(2,'0') + ':00';
            break;
        case 'tomorrow_10':
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '10:00';
            break;
        case 'tomorrow_14':
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '14:00';
            break;
        case '2d':
            targetDate.setDate(targetDate.getDate() + 2);
            targetTime = '10:00';
            break;
        case 'week':
            targetDate.setDate(targetDate.getDate() + 7);
            targetTime = '10:00';
            break;
        default:
            targetDate.setDate(targetDate.getDate() + 1);
            targetTime = '10:00';
    }
    
    return {
        date: targetDate.toISOString().split('T')[0],
        time: targetTime
    };
}

// ===== ADMIN FULL PANEL =====
function openAdminFullPanel(){
    // Створюємо модалку якщо її немає
    let modal = document.getElementById('admin-full-modal');
    if(!modal){
        const modalHtml = `
            <div class="team-modal" id="admin-full-modal">
                <div class="team-modal-content" style="max-width:700px;max-height:85vh">
                    <div class="team-modal-header">
                        <div class="team-modal-title">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="#8b5cf6" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            Панель Super Admin
                        </div>
                        <button class="btn btn-s" onclick="closeAdminFullPanel()">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div class="team-modal-body" style="padding:0;overflow-y:auto;max-height:calc(85vh - 60px)">
                        <div style="padding:16px;background:#f9fafb;border-bottom:1px solid #e5e7eb">
                            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                                <div>
                                    <div style="font-weight:600;font-size:15px">Організації клієнтів</div>
                                    <div style="font-size:12px;color:#6b7280">Всього: <span id="admin-orgs-count">0</span></div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn" onclick="openDiagnosticsPanel()" title="Діагностика даних">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                                        Діагностика
                                    </button>
                                    <button class="btn btn-p" onclick="createOrganization();closeAdminFullPanel()">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                        Нова організація
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="admin-orgs-list" style="padding:8px"></div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modal = document.getElementById('admin-full-modal');
    }
    
    // Рендеримо список організацій
    renderAdminOrgsList();
    modal.classList.add('active');
}

function closeAdminFullPanel(){
    document.getElementById('admin-full-modal')?.classList.remove('active');
}

function renderAdminOrgsList(){
    const list = document.getElementById('admin-orgs-list');
    const count = document.getElementById('admin-orgs-count');
    if(!list) return;
    
    count.textContent = organizations.length;
    
    if(organizations.length === 0){
        list.innerHTML = `
            <div style="text-align:center;padding:40px;color:#6b7280">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#d1d5db" stroke-width="1.5" style="margin:0 auto 16px"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                <div>Немає організацій</div>
            </div>
        `;
        return;
    }
    
    list.innerHTML = organizations.map(org => `
        <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #f3f4f6;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
                <div style="font-weight:600;font-size:14px;margin-bottom:2px">${org.name}</div>
                <div style="font-size:12px;color:#6b7280">${org.ownerEmail || 'Без власника'}</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                <span style="font-size:11px;color:#6b7280;padding:4px 8px;background:#f3f4f6;border-radius:4px">
                    ${org.leadsCount || 0} лідів
                </span>
                <button class="btn btn-s" onclick="copyOrgId('${org.id}')" title="Копіювати ID">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    ID
                </button>
                <button class="btn btn-s" onclick="downloadScript('${org.id}', '${org.name}')" title="Завантажити скрипт">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Скрипт
                </button>
                <button class="btn btn-s" onclick="copyClientInstructions('${org.id}', '${org.name}', '${org.ownerEmail || ''}')" title="Копіювати інструкцію для клієнта">
                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    Інструкція
                </button>
            </div>
        </div>
    `).join('');
}

function copyOrgId(orgId){
    navigator.clipboard.writeText(orgId).then(() => {
        showToast('ID скопійовано: ' + orgId);
    }).catch(() => {
        const tempInput = document.createElement('input');
        tempInput.value = orgId;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showToast('ID скопійовано: ' + orgId);
    });
}

function downloadScript(orgId, orgName){
    const safeName = orgName.replace(/[^a-zA-Zа-яА-ЯіІїЇєЄ0-9]/g, '_');
    
    const scriptContent = generateSyncScript(orgId);
    
    const blob = new Blob([scriptContent], { type: 'text/javascript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `TALKO_CRM_Sync_${safeName}.js`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Скрипт завантажено');
}

function generateSyncScript(orgId){
    const script = [
        '// ===== TALKO CRM - Google Sheets Sync Script =====',
        '// Організація ID: ' + orgId,
        '// Згенеровано: ' + new Date().toLocaleDateString('uk-UA'),
        '',
        'const CONFIG = {',
        "  FIREBASE_PROJECT_ID: 'talko-crm',",
        "  ORGANIZATION_ID: '" + orgId + "',",
        '  ',
        '  // Листи для синхронізації',
        '  SHEETS: [',
        "    { name: 'consult_clinic', source: 'consult_clinic' },",
        "    { name: 'consult_production', source: 'consult_production' }",
        '  ],',
        '  ',
        '  // Колонки (A=1, B=2, C=3...)',
        '  COLUMNS: {',
        '    DATE: 1,      // A - Дата',
        '    TELEGRAM: 2,  // B - Telegram/Нік',
        '    PHONE: 3      // C - Телефон',
        '  }',
        '};',
        '',
        '// ===== ГОЛОВНА ФУНКЦІЯ =====',
        'function syncToFirestore() {',
        '  let totalSynced = 0, totalSkipped = 0;',
        '  CONFIG.SHEETS.forEach(s => {',
        '    const r = syncSheet(s.name, s.source);',
        '    totalSynced += r.synced; totalSkipped += r.skipped;',
        '  });',
        '  Logger.log("✅ ВСЬОГО: " + totalSynced + " нових, " + totalSkipped + " пропущено");',
        '}',
        '',
        'function syncSheet(sheetName, sourceName) {',
        '  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);',
        '  if (!sheet) { Logger.log("❌ Лист не знайдено: " + sheetName); return {synced:0,skipped:0}; }',
        '  const data = sheet.getDataRange().getValues();',
        '  let synced = 0, skipped = 0;',
        '  for (let i = 1; i < data.length; i++) {',
        '    const row = data[i];',
        '    const telegram = normalizeTelegram(row[CONFIG.COLUMNS.TELEGRAM - 1]);',
        '    const phone = normalizePhone(row[CONFIG.COLUMNS.PHONE - 1]);',
        '    if (!telegram && !phone) continue;',
        '    if (leadExists(telegram, phone)) { skipped++; continue; }',
        '    const lead = {',
        '      id: "l" + Date.now() + Math.random().toString(36).substr(2,5),',
        '      tg: telegram || "", phone: phone || "",',
        '      viber: "", whatsapp: "", email: "",',
        '      primaryChannel: (telegram && telegram.startsWith("@")) ? "tg" : "phone",',
        '      source: sourceName, status: "new",',
        '      nextAction: "Подзвонити", nextDate: getToday(), nextTime: "10:00",',
        '      name: "", biz: "", notes: "",',
        '      createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),',
        '      calls: 0, noshow: 0, deposit: 0, amount: 0,',
        '      consult: "", consultDate: "", consultTime: "",',
        '      paidAt: "", failReason: "", reactDate: "",',
        '      log: [{date: new Date().toISOString(), type: "system", text: "Створено з Google Sheets"}]',
        '    };',
        '    if (saveLeadToFirestore(lead)) synced++;',
        '  }',
        '  Logger.log("📊 " + sheetName + ": " + synced + " нових, " + skipped + " пропущено");',
        '  return {synced, skipped};',
        '}',
        '',
        '// ===== FIRESTORE =====',
        'function saveLeadToFirestore(lead) {',
        '  const url = "https://firestore.googleapis.com/v1/projects/" + CONFIG.FIREBASE_PROJECT_ID + "/databases/(default)/documents/organizations/" + CONFIG.ORGANIZATION_ID + "/leads/" + lead.id;',
        '  const firestoreData = {',
        '    fields: {',
        '      id: {stringValue: lead.id}, tg: {stringValue: lead.tg}, phone: {stringValue: lead.phone},',
        '      viber: {stringValue: lead.viber}, whatsapp: {stringValue: lead.whatsapp}, email: {stringValue: lead.email},',
        '      primaryChannel: {stringValue: lead.primaryChannel}, source: {stringValue: lead.source},',
        '      status: {stringValue: lead.status}, nextAction: {stringValue: lead.nextAction},',
        '      nextDate: {stringValue: lead.nextDate}, nextTime: {stringValue: lead.nextTime},',
        '      name: {stringValue: lead.name}, biz: {stringValue: lead.biz}, notes: {stringValue: lead.notes},',
        '      createdAt: {stringValue: lead.createdAt}, updatedAt: {stringValue: lead.updatedAt},',
        '      calls: {integerValue: lead.calls}, noshow: {integerValue: lead.noshow},',
        '      deposit: {integerValue: lead.deposit}, amount: {integerValue: lead.amount},',
        '      consult: {stringValue: lead.consult}, consultDate: {stringValue: lead.consultDate},',
        '      consultTime: {stringValue: lead.consultTime}, paidAt: {stringValue: lead.paidAt},',
        '      failReason: {stringValue: lead.failReason}, reactDate: {stringValue: lead.reactDate},',
        '      log: {arrayValue: {values: lead.log.map(e => ({mapValue: {fields: {date: {stringValue: e.date}, type: {stringValue: e.type}, text: {stringValue: e.text}}}}))}}',
        '    }',
        '  };',
        '  const options = {',
        '    method: "patch", contentType: "application/json",',
        '    headers: {"Authorization": "Bearer " + ScriptApp.getOAuthToken()},',
        '    payload: JSON.stringify(firestoreData), muteHttpExceptions: true',
        '  };',
        '  try {',
        '    const response = UrlFetchApp.fetch(url, options);',
        '    if (response.getResponseCode() === 200) { Logger.log("✅ " + (lead.tg || lead.phone)); return true; }',
        '    Logger.log("❌ " + response.getContentText()); return false;',
        '  } catch (e) { Logger.log("❌ " + e.toString()); return false; }',
        '}',
        '',
        'function leadExists(telegram, phone) {',
        '  if (telegram && checkField("tg", telegram)) return true;',
        '  if (phone && checkField("phone", phone)) return true;',
        '  return false;',
        '}',
        '',
        'function checkField(field, value) {',
        '  const url = "https://firestore.googleapis.com/v1/projects/" + CONFIG.FIREBASE_PROJECT_ID + "/databases/(default)/documents:runQuery";',
        '  const options = {',
        '    method: "post", contentType: "application/json",',
        '    headers: {"Authorization": "Bearer " + ScriptApp.getOAuthToken()},',
        '    payload: JSON.stringify({',
        '      structuredQuery: {',
        '        from: [{collectionId: "leads"}],',
        '        where: {fieldFilter: {field: {fieldPath: field}, op: "EQUAL", value: {stringValue: value}}},',
        '        limit: 1',
        '      },',
        '      parent: "projects/" + CONFIG.FIREBASE_PROJECT_ID + "/databases/(default)/documents/organizations/" + CONFIG.ORGANIZATION_ID',
        '    }),',
        '    muteHttpExceptions: true',
        '  };',
        '  try {',
        '    const results = JSON.parse(UrlFetchApp.fetch(url, options).getContentText());',
        '    return results && results.length > 0 && results[0].document;',
        '  } catch (e) { return false; }',
        '}',
        '',
        '// ===== ДОПОМІЖНІ =====',
        'function normalizeTelegram(value) {',
        '  if (!value) return "";',
        '  let tg = String(value).trim();',
        '  if (tg && !tg.startsWith("@") && !tg.match(/^\\\\d+$/)) tg = "@" + tg;',
        '  return tg;',
        '}',
        '',
        'function normalizePhone(value) {',
        '  if (!value) return "";',
        '  let phone = String(value).replace(/[^\\\\d+]/g, "");',
        '  if (phone.length === 9) phone = "+380" + phone;',
        '  else if (phone.length === 10 && phone.startsWith("0")) phone = "+38" + phone;',
        '  else if (phone.length === 12 && phone.startsWith("380")) phone = "+" + phone;',
        '  if (phone.length >= 10 && !phone.startsWith("+")) phone = "+" + phone;',
        '  return phone;',
        '}',
        '',
        'function getToday() {',
        '  const now = new Date();',
        '  return now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0");',
        '}',
        '',
        '// ===== ТРИГЕРИ =====',
        'function createTimeTrigger() {',
        '  ScriptApp.getProjectTriggers().forEach(t => { if (t.getHandlerFunction() === "syncToFirestore") ScriptApp.deleteTrigger(t); });',
        '  ScriptApp.newTrigger("syncToFirestore").timeBased().everyMinutes(5).create();',
        '  Logger.log("✅ Автосинхронізація: кожні 5 хвилин");',
        '}',
        '',
        'function removeAllTriggers() {',
        '  ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));',
        '  Logger.log("✅ Тригери видалено");',
        '}',
        '',
        '// ===== МЕНЮ =====',
        'function onOpen() {',
        '  SpreadsheetApp.getUi()',
        '    .createMenu("🚀 TALKO CRM")',
        '    .addItem("▶️ Синхронізувати", "syncToFirestore")',
        '    .addSeparator()',
        '    .addItem("⏰ Увімкнути автосинхронізацію", "createTimeTrigger")',
        '    .addItem("🛑 Вимкнути автосинхронізацію", "removeAllTriggers")',
        '    .addToUi();',
        '}'
    ];
    return script.join('\n');
}

function copyClientInstructions(orgId, orgName, ownerEmail){
    const instructions = `Привіт! Ось інструкція для підключення TALKO CRM:

📋 КРОК 1: Google Sheet
1. Створи нову таблицю Google Sheets
2. Назви листи: consult_clinic, consult_production
3. Колонки: A=Дата, B=Telegram/Нік, C=Телефон

📋 КРОК 2: Встановити скрипт
1. Меню: Розширення → Apps Script
2. Видали весь код
3. Встав код зі скрипта який я надішлю
4. Збережи (Ctrl+S)

📋 КРОК 3: Запустити
1. Вибери функцію: syncToFirestore
2. Натисни "Запустити"
3. Дозволь всі права (безпечно, це доступ до твоєї таблиці)

📋 КРОК 4: Увійти в CRM
1. Відкрий: https://talko-crm.vercel.app
2. Натисни "Увійти з Google"
3. Використай email: \${ownerEmail || '[твій email]'}

✅ Готово! Тепер ліди з таблиці автоматично синхронізуються в CRM.

Організація: \${orgName}
ID (для скрипта): \${orgId}

Питання — пиши!`;

    navigator.clipboard.writeText(instructions).then(() => {
        showToast('Інструкцію скопійовано');
    }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = instructions;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Інструкцію скопійовано');
    });
}

// ===== TOAST NOTIFICATIONS =====
const TOAST_CONFIG = {
    success: {
        bg: '#059669',
        icon: `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>`
    },
    error: {
        bg: '#dc2626',
        icon: `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`
    },
    warning: {
        bg: '#d97706',
        icon: `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`
    },
    info: {
        bg: '#1f2937',
        icon: `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`
    }
};

/**
 * Показує toast повідомлення
 * @param {string} message - Текст повідомлення
 * @param {string} type - Тип: 'success' | 'error' | 'warning' | 'info'
 * @param {number} duration - Тривалість в мс (default: 3000, error: 5000)
 */
function showToast(message, type = 'success', duration = null) {
    // Видаляємо старий toast якщо є
    const oldToast = document.querySelector('.toast-message');
    if(oldToast) oldToast.remove();
    
    const config = TOAST_CONFIG[type] || TOAST_CONFIG.info;
    const displayDuration = duration || (type === 'error' ? 5000 : 3000);
    
    const toast = document.createElement('div');
    toast.className = 'toast-message toast-' + type;
    toast.innerHTML = `${config.icon}<span>${escapeHtml(message)}</span>`;
    toast.style.cssText = `
        position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
        background:${config.bg};color:#fff;padding:12px 20px;border-radius:8px;
        font-size:14px;z-index:9999;display:flex;align-items:center;gap:10px;
        box-shadow:0 4px 12px rgba(0,0,0,0.3);animation:fadeInUp .3s ease;
        max-width:90%;text-align:left;
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOutDown .3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, displayDuration);
}

/**
 * Shortcut для error toast
 */
function showError(message) {
    showToast(message, 'error');
}

/**
 * Shortcut для warning toast
 */
function showWarning(message) {
    showToast(message, 'warning');
}

/**
 * Shortcut для info toast (нейтральне повідомлення)
 */
function showInfo(message) {
    showToast(message, 'info');
}

// ===== OFFLINE DETECTION =====
let wasOffline = false;

function updateOnlineStatus() {
    const banner = document.getElementById('offline-banner');
    if(!banner) return;
    
    if(!navigator.onLine) {
        // Offline
        banner.classList.remove('online-restored');
        banner.classList.add('active');
        banner.querySelector('span').textContent = "Немає з'єднання з інтернетом";
        wasOffline = true;
        setSyncStatus('error', 'Офлайн');
    } else if(wasOffline) {
        // Back online
        banner.classList.add('online-restored');
        banner.querySelector('span').textContent = "З'єднання відновлено!";
        setSyncStatus('synced', 'Синхронізовано');
        
        // Hide after 3 seconds
        setTimeout(() => {
            banner.classList.remove('active', 'online-restored');
            wasOffline = false;
        }, 3000);
    }
}

// Listen for online/offline events
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Check on page load
document.addEventListener('DOMContentLoaded', () => {
    updateOnlineStatus();
});

// ===== GLOBAL KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', (e) => {
    // Ignore if typing in input/textarea
    const activeEl = document.activeElement;
    const isTyping = activeEl && (
        activeEl.tagName === 'INPUT' || 
        activeEl.tagName === 'TEXTAREA' || 
        activeEl.isContentEditable
    );
    
    // ESC - Close modals (works even when typing)
    if(e.key === 'Escape') {
        e.preventDefault();
        
        // Priority order: close the topmost modal first
        
        // 1. Confirm modal
        if(document.getElementById('confirm-modal')?.classList.contains('active')) {
            closeConfirmModal(false);
            return;
        }
        
        // 2. Input modal (prompt)
        if(document.getElementById('input-modal')?.classList.contains('active')) {
            closeInputModal();
            return;
        }
        
        // 3. DateTime modal
        if(document.getElementById('datetime-modal')?.classList.contains('active')) {
            closeDateTimePicker();
            return;
        }
        
        // 4. Quick action panel
        if(document.getElementById('quick-panel')?.classList.contains('active')) {
            closeQuickPanel();
            return;
        }
        
        // 5. Lead edit modal
        if(document.getElementById('modal')?.classList.contains('active')) {
            closeModal();
            return;
        }
        
        // 6. Settings panel
        if(document.getElementById('settings-panel')?.classList.contains('active')) {
            closeSettingsPanel();
            return;
        }
        
        // 7. Team modal
        if(document.getElementById('team-modal')?.classList.contains('active')) {
            closeTeamModal();
            return;
        }
        
        // 8. AI Assistant
        if(document.getElementById('ai-assistant')?.classList.contains('active')) {
            toggleAI();
            return;
        }
        
        // 9. Mobile menu
        if(document.getElementById('mobile-menu')?.classList.contains('active')) {
            closeMobileMenu();
            return;
        }
        
        // 10. Auth modal
        if(document.getElementById('auth-modal')?.classList.contains('active')) {
            closeAuthModal();
            return;
        }
        
        // 11. Diagnostics modal
        if(document.getElementById('diagnostics-modal')?.classList.contains('active')) {
            closeDiagnosticsPanel();
            return;
        }
    }
    
    // Don't process other shortcuts if typing
    if(isTyping) return;
    
    // Ctrl/Cmd + K - Focus search
    if((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = document.getElementById('search-input');
        if(searchInput && document.getElementById('app-screen')?.style.display !== 'none') {
            searchInput.focus();
            searchInput.select();
        }
        return;
    }
    
    // Ctrl/Cmd + N - New lead
    if((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        if(document.getElementById('app-screen')?.style.display !== 'none') {
            openModal();
        }
        return;
    }
    
    // Ctrl/Cmd + Shift + D - Diagnostics (for admins)
    if((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        if(currentRole === 'owner' || SUPER_ADMIN_EMAILS.includes(currentUser?.email)) {
            openDiagnosticsPanel();
        }
        return;
    }
    
    // Ctrl/Cmd + Z - Undo
    if((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
        return;
    }
    
    // Ctrl/Cmd + Shift + Z or Ctrl+Y - Redo
    if(((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') || ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
        e.preventDefault();
        redo();
        return;
    }
    
    // Ctrl/Cmd + E - Export
    if((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        exportLeadsToCSV();
        return;
    }
    
    // ? - Show help
    if(e.key === '?' && !e.shiftKey) {
        e.preventDefault();
        toggleHelp();
        return;
    }
});
</script>
<!-- Status Picker Modal -->
<div class="status-picker-overlay" id="status-picker-overlay" onclick="if(event.target===this)closeStatusPicker()">
    <div class="status-picker">
        <div class="status-picker-header">
            <div>
                <div class="status-picker-title">Змінити статус</div>
                <div class="status-picker-subtitle" id="status-picker-lead-name"></div>
            </div>
            <button class="status-picker-close" onclick="closeStatusPicker()">×</button>
        </div>
        <div class="status-picker-body" id="status-picker-body">
            <!-- Заповнюється динамічно -->
        </div>
    </div>
</div>

</body>
</html>
